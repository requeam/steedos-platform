function module(e,t,n){"use strict";var i=e("../../core/renderer"),a=e("../../events/core/events_engine"),o=e("../../core/component_registrator"),r=e("../../core/guid"),s=e("../../core/utils/common"),l=e("../../core/utils/type"),u=e("../../core/element_data"),d=e("../../core/utils/iterator").each,c=e("../../core/utils/array").inArray,h=e("../../core/utils/extend").extend,m=e("../../core/utils/string"),p=e("../../core/utils/browser"),f=e("../../core/utils/dom"),g=e("../../localization/message"),_=e("../widget/ui.widget"),b=e("../../core/utils/window"),C=e("../validation_engine"),y=e("./ui.form.layout_manager"),v=e("./ui.form.items_runtime_info").default,I=e("../tab_panel"),x=e("../scroll_view/ui.scrollable"),L=e("../../core/utils/deferred").Deferred,T=e("../themes");e("../validation_summary"),e("../validation_group");var B="dx-form",D="dx-field-item",S="dx-field-item-label-text",F="dx-form-group",O="dx-form-group-content",M="dx-form-group-with-caption",w="dx-form-group-caption",W="dx-layout-manager-hidden-label",k="dx-field-item-label",E="dx-field-item-label-content",G="dx-field-item-tab",R="dx-col-",V="dx-group-colcount-",$="dx-field-item-content",P="dx-form-validation-summary",q="dx-widget",N="dx-state-focused",A=_.inherit({_init:function(){this.callBase(),this._cachedColCountOptions=[],this._itemsRunTimeInfo=new v,this._groupsColCount=[],this._attachSyncSubscriptions()},_initOptions:function(e){"screenByWidth"in e||(e.screenByWidth=b.defaultScreenFactorFunc),this.callBase(e)},_getDefaultOptions:function(){return h(this.callBase(),{formID:"dx-"+new r,formData:{},colCount:1,screenByWidth:null,colCountByScreen:void 0,labelLocation:"left",readOnly:!1,onFieldDataChanged:null,customizeItem:null,onEditorEnterKey:null,minColWidth:200,alignItemLabels:!0,alignItemLabelsInAllGroups:!0,showColonAfterLabel:!0,showRequiredMark:!0,showOptionalMark:!1,requiredMark:"*",optionalMark:g.format("dxForm-optionalMark"),requiredMessage:g.getFormatter("dxForm-requiredMessage"),showValidationSummary:!1,items:void 0,scrollingEnabled:!1,validationGroup:void 0,stylingMode:void 0})},_defaultOptionsRules:function(){return this.callBase().concat([{device:function(){return T.isMaterial()},options:{showColonAfterLabel:!1,labelLocation:"top"}}])},_setOptionsByReference:function(){this.callBase(),h(this._optionsByReference,{formData:!0,validationGroup:!0})},_getColCount:function(e){for(var t,n=0,i=!0;i;)(t=e.find(".dx-col-"+n)).length?n++:i=!1;return n},_createHiddenElement:function(e){this._$hiddenElement=i("<div>").addClass("dx-widget").addClass(W).appendTo("body");var t=e._renderLabel({text:" ",location:this.option("labelLocation")}).appendTo(this._$hiddenElement);this._hiddenLabelText=t.find(".dx-field-item-label-text")[0]},_removeHiddenElement:function(){this._$hiddenElement.remove(),this._hiddenLabelText=null},_getLabelWidthByText:function(e){return this._hiddenLabelText.innerHTML=e,this._hiddenLabelText.offsetWidth},_getLabelsSelectorByCol:function(e,t){var n,i,a;return"."+((t=t||{}).inOneColumn?"dx-field-item":"dx-col-"+e)+(t.excludeTabbed?":not(.dx-field-item-tab)":"")+"> .dx-field-item-label > .dx-field-item-label-content"},_getLabelText:function(e){var t,n,i=e.children.length,a="";for(n=0;n<i;n++)t=e.children[n],a+=m.isEmpty(t.innerText)?t.innerHTML:t.innerText;return a},_applyLabelsWidthByCol:function(e,t,n){var i,a,o=e.find(this._getLabelsSelectorByCol(t,n)),r=o.length,s=0;for(a=0;a<r;a++)(i=this._getLabelWidthByText(this._getLabelText(o[a])))>s&&(s=i);for(a=0;a<r;a++)o[a].style.width=s+"px"},_applyLabelsWidth:function(e,t,n,i){i=n?1:i||this._getColCount(e);var a,o={excludeTabbed:t,inOneColumn:n};for(a=0;a<i;a++)this._applyLabelsWidthByCol(e,a,o)},_getGroupElementsInColumn:function(e,t,n){var i,a=".dx-col-"+t+" > .dx-field-item-content > .dx-form-group"+(l.isDefined(n)?".dx-group-colcount-"+n:"");return e.find(a)},_applyLabelsWidthWithGroups:function(e,t,n){var i;if(this.option("alignItemLabelsInAllGroups"))this._applyLabelsWidthWithNestedGroups(e,t,n);else{var a,o=this.$element().find(".dx-form-group");for(a=0;a<o.length;a++)this._applyLabelsWidth(o.eq(a),n)}},_applyLabelsWidthWithNestedGroups:function(e,t,n){var i,a,o,r,s={excludeTabbed:n};for(i=0;i<t;i++)for(r=this._getGroupElementsInColumn(e,i),this._applyLabelsWidthByCol(r,0,s),a=0;a<this._groupsColCount.length;a++){r=this._getGroupElementsInColumn(e,i,this._groupsColCount[a]);var l=this._getColCount(r);for(o=1;o<l;o++)this._applyLabelsWidthByCol(r,o,s)}},_alignLabelsInColumn:function(e){b.hasWindow()&&(this._createHiddenElement(e.layoutManager),e.inOneColumn?this._applyLabelsWidth(e.$container,e.excludeTabbed,!0):this._checkGrouping(e.items)?this._applyLabelsWidthWithGroups(e.$container,e.layoutManager._getColCount(),e.excludeTabbed):this._applyLabelsWidth(e.$container,e.excludeTabbed,!1,e.layoutManager._getColCount()),this._removeHiddenElement())},_prepareFormData:function(){l.isDefined(this.option("formData"))||this.option("formData",{})},_initMarkup:function(){C.addGroup(this._getValidationGroup()),this._clearCachedInstances(),this._prepareFormData(),this.$element().addClass("dx-form"),this.callBase(),this.setAria("role","form",this.$element()),this.option("scrollingEnabled")&&this._renderScrollable(),this._renderLayout(),this._renderValidationSummary(),this._lastMarkupScreenFactor=this._targetScreenFactor||this._getCurrentScreenFactor()},_getCurrentScreenFactor:function(){return b.hasWindow()?b.getCurrentScreenFactor(this.option("screenByWidth")):"lg"},_clearCachedInstances:function(){this._itemsRunTimeInfo.clear(),this._cachedLayoutManagers=[]},_alignLabels:function(e,t){this._alignLabelsInColumn({$container:this.$element(),layoutManager:e,excludeTabbed:!0,items:this.option("items"),inOneColumn:t})},_clean:function(){this.callBase(),this._groupsColCount=[],this._cachedColCountOptions=[],this._lastMarkupScreenFactor=void 0},_renderScrollable:function(){var e=this.option("useNativeScrolling");this._scrollable=new x(this.$element(),{useNative:!!e,useSimulatedScrollbar:!e,useKeyboard:!1,direction:"both",bounceEnabled:!1})},_getContent:function(){return this.option("scrollingEnabled")?this._scrollable.$content():this.$element()},_renderValidationSummary:function(){var e=this.$element().find("."+P);e.length>0&&e.remove(),this.option("showValidationSummary")&&i("<div>").addClass(P).dxValidationSummary({validationGroup:this._getValidationGroup()}).appendTo(this._getContent())},_prepareItems:function(e,t){if(e){for(var n=[],i=0;i<e.length;i++){var a=e[i],o=this._itemsRunTimeInfo.add(a);if(l.isObject(a)){var r=h({},a);r.guid=o,this._tryPrepareGroupItem(r),this._tryPrepareTabbedItem(r),this._tryPrepareItemTemplate(r),t&&(r.cssItemClass="dx-field-item-tab"),r.items&&(r.items=this._prepareItems(r.items,t)),n.push(r)}else n.push(a)}return n}},_tryPrepareGroupItem:function(e){"group"===e.itemType&&(e.alignItemLabels=s.ensureDefined(e.alignItemLabels,!0),e.template&&(e.groupContentTemplate=this._getTemplate(e.template)),e.template=this._itemGroupTemplate.bind(this,e))},_tryPrepareTabbedItem:function(e){"tabbed"===e.itemType&&(e.template=this._itemTabbedTemplate.bind(this,e),e.tabs=this._prepareItems(e.tabs,!0))},_tryPrepareItemTemplate:function(e){e.template&&(e.template=this._getTemplate(e.template))},_checkGrouping:function(e){if(e)for(var t=0;t<e.length;t++){var n;if("group"===e[t].itemType)return!0}},_renderLayout:function(){var e=this,t=e.option("items"),n=e._getContent();t=e._prepareItems(t),e._rootLayoutManager=e._renderLayoutManager(t,n,{colCount:e.option("colCount"),alignItemLabels:e.option("alignItemLabels"),screenByWidth:this.option("screenByWidth"),colCountByScreen:this.option("colCountByScreen"),onLayoutChanged:function(t){e._alignLabels.bind(e)(e._rootLayoutManager,t)},onContentReady:function(t){e._alignLabels(t.component,t.component.isSingleColumnMode())}})},_tryGetItemsForTemplate:function(e){return e.items||[]},_itemTabbedTemplate:function(e,t,n){var a=this,o=i("<div>").appendTo(n),r=h({},e.tabPanelOptions,{dataSource:e.tabs,onItemRendered:function(e){f.triggerShownEvent(e.itemElement)},itemTemplate:function(e,t,n){var o,r=i(n),l=s.ensureDefined(e.alignItemLabels,!0);o=a._renderLayoutManager(a._tryGetItemsForTemplate(e),r,{colCount:e.colCount,alignItemLabels:l,screenByWidth:this.option("screenByWidth"),colCountByScreen:e.colCountByScreen,cssItemClass:e.cssItemClass,onLayoutChanged:function(t){a._alignLabelsInColumn.bind(a)({$container:r,layoutManager:o,items:e.items,inOneColumn:t})}}),l&&a._alignLabelsInColumn.bind(a)({$container:r,layoutManager:o,items:e.items,inOneColumn:o.isSingleColumnMode()})}});a._createComponent(o,I,r)},_itemGroupTemplate:function(e,t,n){var a,o,r,s=i("<div>").toggleClass("dx-form-group-with-caption",l.isDefined(e.caption)&&e.caption.length).addClass("dx-form-group").appendTo(n);if(e.caption&&i("<span>").addClass("dx-form-group-caption").text(e.caption).appendTo(s),a=i("<div>").addClass("dx-form-group-content").appendTo(s),e.groupContentTemplate){var u={formData:this.option("formData"),component:this};e.groupContentTemplate.render({model:u,container:f.getPublicElement(a)})}else o=(r=this._renderLayoutManager(this._tryGetItemsForTemplate(e),a,{colCount:e.colCount,colCountByScreen:e.colCountByScreen,alignItemLabels:e.alignItemLabels,cssItemClass:e.cssItemClass}))._getColCount(),-1===c(o,this._groupsColCount)&&this._groupsColCount.push(o),s.addClass("dx-group-colcount-"+o)},_renderLayoutManager:function(e,t,n){var a,o=i("<div>"),r=this,s=r._getLayoutManagerConfig(e,n),l={lg:n.colCount,md:n.colCount,sm:n.colCount,xs:1};return r._cachedColCountOptions.push({colCountByScreen:h(l,n.colCountByScreen)}),o.appendTo(t),(a=r._createComponent(o,"dxLayoutManager",s)).on("autoColCountChanged",(function(){r._refresh()})),r._cachedLayoutManagers.push(a),a},_getValidationGroup:function(){return this.option("validationGroup")||this},_getLayoutManagerConfig:function(e,t){var n=this,i={form:n,validationGroup:n._getValidationGroup(),showRequiredMark:n.option("showRequiredMark"),showOptionalMark:n.option("showOptionalMark"),requiredMark:n.option("requiredMark"),optionalMark:n.option("optionalMark"),requiredMessage:n.option("requiredMessage"),screenByWidth:n.option("screenByWidth"),layoutData:n.option("formData"),labelLocation:n.option("labelLocation"),customizeItem:n.option("customizeItem"),minColWidth:n.option("minColWidth"),showColonAfterLabel:n.option("showColonAfterLabel"),onEditorEnterKey:n.option("onEditorEnterKey"),onFieldDataChanged:function(e){n._isDataUpdating||n._triggerOnFieldDataChanged(e)},validationBoundary:n.option("scrollingEnabled")?n.$element():void 0};return h(i,{items:e,onContentReady:function(e){n._itemsRunTimeInfo.addItemsOrExtendFrom(e.component._itemsRunTimeInfo),t.onContentReady&&t.onContentReady(e)},colCount:t.colCount,alignItemLabels:t.alignItemLabels,cssItemClass:t.cssItemClass,colCountByScreen:t.colCountByScreen,onLayoutChanged:t.onLayoutChanged,width:t.width})},_createComponent:function(e,t,n){var i=this;return n=n||{},this._extendConfig(n,{readOnly:this.option("readOnly")}),this.callBase(e,t,n)},_attachSyncSubscriptions:function(){var e=this;e.on("optionChanged",(function(t){var n=t.fullName;"formData"===n&&(l.isDefined(t.value)||(e._options.formData=t.value={}),e._triggerOnFieldDataChangedByDataSet(t.value)),e._cachedLayoutManagers.length&&d(e._cachedLayoutManagers,(function(i,a){"formData"===n&&(e._isDataUpdating=!0,a.option("layoutData",t.value),e._isDataUpdating=!1),"readOnly"!==t.name&&"disabled"!==t.name||a.option(n,t.value)}))}))},_optionChanged:function(e){var t=this._getRootLevelOfExpectedComplexOption(e.fullName,["formData","items"]);if(t)this._customHandlerOfComplexOption(e,t);else switch(e.name){case"formData":this.option("items")?l.isEmptyObject(e.value)&&this._resetValues():this._invalidate();break;case"items":case"colCount":case"onFieldDataChanged":case"onEditorEnterKey":case"labelLocation":case"alignItemLabels":case"showColonAfterLabel":case"customizeItem":case"alignItemLabelsInAllGroups":case"showRequiredMark":case"showOptionalMark":case"requiredMark":case"optionalMark":case"requiredMessage":case"scrollingEnabled":case"formID":case"colCountByScreen":case"screenByWidth":case"stylingMode":this._invalidate();break;case"showValidationSummary":this._renderValidationSummary();break;case"minColWidth":"auto"===this.option("colCount")&&this._invalidate();break;case"readOnly":break;case"width":this.callBase(e),this._rootLayoutManager.option(e.name,e.value),this._alignLabels(this._rootLayoutManager,this._rootLayoutManager.isSingleColumnMode());break;case"visible":this.callBase(e),e.value&&f.triggerShownEvent(this.$element());break;case"validationGroup":C.removeGroup(e.previousValue||this),this._invalidate();break;default:this.callBase(e)}},_getRootLevelOfExpectedComplexOption:function(e,t){var n,i=e.split(".");if(i.length>1){var a,o=i[0];for(a=0;a<t.length;a++)-1!==o.search(t[a])&&(n=t[a])}return n},_customHandlerOfComplexOption:function(e,t){var n=e.fullName.split(".");switch(t){case"items":var i=this._getItemPath(n),a=this.option(i),o=this._itemsRunTimeInfo.findWidgetInstanceByItem(a),r=this._itemsRunTimeInfo.findItemContainerByItem(a),s=e.fullName;if(o){if(-1!==s.search("buttonOptions")){o.option(a.buttonOptions);break}if(o&&-1!==s.search("editorOptions")){o.option(a.editorOptions);break}if(-1!==s.search("validationRules")){var l=u.data(o.$element()[0],"dxValidator");if(l){var d=function(e){return"required"===e.type},c=(l.option("validationRules")||[]).some(d),h=(a.validationRules||[]).some(d);if(!c&&!h||c&&h){l.option("validationRules",a.validationRules);break}}}else if(r&&"cssClass"===s.substring(s.length-8,s.length)){r.removeClass(e.previousValue).addClass(e.value);break}}if(a){var m,p=e.fullName.replace(i+".","");this._changeItemOption(a,p,e.value),m=this._generateItemsFromData(this.option("items")),this.option("items",m)}break;case"formData":var f=n.slice(1).join("."),g=this.getEditor(f);g?g.option("value",e.value):this._triggerOnFieldDataChanged({dataField:f,value:e.value})}},_getItemPath:function(e){var t,n=e[0];for(t=1;t<e.length&&-1!==e[t].search("items|tabs");t++)n+="."+e[t];return n},_triggerOnFieldDataChanged:function(e){this._createActionByOption("onFieldDataChanged")(e)},_triggerOnFieldDataChangedByDataSet:function(e){var t=this;e&&l.isObject(e)&&d(e,(function(e,n){t._triggerOnFieldDataChanged({dataField:e,value:n})}))},_updateFieldValue:function(e,t){if(l.isDefined(this.option("formData"))){var n=this.getEditor(e),i;if(this.option("formData."+e,t),n)n.option("value")!==t&&n.option("value",t)}},_generateItemsFromData:function(e){var t=this.option("formData"),n=[];return!e&&l.isDefined(t)&&d(t,(function(e){n.push({dataField:e})})),e&&d(e,(function(e,t){l.isObject(t)?n.push(t):n.push({dataField:t})})),n},_getItemByField:function(e,t){var n,i=this,a=l.isObject(e)?e:i._getFieldParts(e),o=a.fieldName,r=a.fieldPath;return t.length&&d(t,(function(e,t){var a=t.itemType;if(r.length){var s=r.slice();t=i._getItemByFieldPath(s,o,t)}else if("group"===a&&!t.caption&&!t.name||"tabbed"===a){var l=i._getSubItemField(a);t.items=i._generateItemsFromData(t.items),t=i._getItemByField({fieldName:o,fieldPath:r},t[l])}if(i._isExpectedItem(t,o))return n=t,!1})),n},_getFieldParts:function(e){for(var t=".",n=e,i=n.indexOf("."),a=[];-1!==i;)a.push(n.substr(0,i)),i=(n=n.substr(i+1)).indexOf(".");return{fieldName:n,fieldPath:a.reverse()}},_getItemByFieldPath:function(e,t,n){var i,a=this,o=n.itemType,r=this._getSubItemField(o),s="group"===o||"tabbed"===o||n.title;do{if(!s)break;var u,d=n.name||n.caption||n.title,c=l.isDefined(d),h=this._getTextWithoutSpaces(d);if(n[r]=this._generateItemsFromData(n[r]),c&&(u=e.pop()),!e.length&&(i=this._getItemByField(t,n[r])))break;(!c||c&&h===u)&&e.length&&(i=this._searchItemInEverySubItem(e,t,n[r]))}while(e.length&&!l.isDefined(i));return i},_getSubItemField:function(e){return"tabbed"===e?"tabs":"items"},_searchItemInEverySubItem:function(e,t,n){var i,a=this;return d(n,(function(n,o){if(i=a._getItemByFieldPath(e.slice(),t,o))return!1})),i||(i=!1),i},_getTextWithoutSpaces:function(e){return e?e.replace(/\s/g,""):void 0},_isExpectedItem:function(e,t){return e&&(e.dataField===t||e.name===t||this._getTextWithoutSpaces(e.title)===t||"group"===e.itemType&&this._getTextWithoutSpaces(e.caption)===t)},_changeItemOption:function(e,t,n){l.isObject(e)&&(e[t]=n)},_dimensionChanged:function(){var e=this._getCurrentScreenFactor();this._lastMarkupScreenFactor!==e&&(this._isColCountChanged(this._lastMarkupScreenFactor,e)&&(this._targetScreenFactor=e,this._refresh(),this._targetScreenFactor=void 0),this._lastMarkupScreenFactor=e)},_isColCountChanged:function(e,t){var n=!1;return d(this._cachedColCountOptions,(function(i,a){if(a.colCountByScreen[e]!==a.colCountByScreen[t])return n=!0,!1})),n},_refresh:function(){var e=".dx-state-focused input, .dx-state-focused textarea";a.trigger(this.$element().find(e),"change"),this.callBase()},_resetValues:function(){var e=this._getValidationGroup(),t=C.getGroupConfig(e);t&&t.reset(),this._itemsRunTimeInfo.each((function(e,t){l.isDefined(t.widgetInstance)&&l.isDefined(t.item)&&"button"!==t.item.itemType&&(t.widgetInstance.reset(),t.widgetInstance.option("isValid",!0))}))},_updateData:function(e,t,n){var i=this,a=n?t:e;l.isObject(a)?d(a,(function(t,a){i._updateData(n?e+"."+t:t,a,l.isObject(a))})):l.isString(e)&&i._updateFieldValue(e,t)},registerKeyHandler:function(e,t){this.callBase(e,t),this._itemsRunTimeInfo.each((function(n,i){l.isDefined(i.widgetInstance)&&i.widgetInstance.registerKeyHandler(e,t)}))},_focusTarget:function(){return this.$element().find(".dx-field-item-content [tabindex]").first()},_visibilityChanged:function(e){e&&p.msie&&this._refresh()},_dispose:function(){C.removeGroup(this._getValidationGroup()),this.callBase()},resetValues:function(){this._resetValues()},updateData:function(e,t){this._updateData(e,t)},getEditor:function(e){return this._itemsRunTimeInfo.findWidgetInstanceByDataField(e)||this._itemsRunTimeInfo.findWidgetInstanceByName(e)},getButton:function(e){return this._itemsRunTimeInfo.findWidgetInstanceByName(e)},updateDimensions:function(){var e=this,t=new L;return e._scrollable?e._scrollable.update().done((function(){t.resolveWith(e)})):t.resolveWith(e),t.promise()},itemOption:function(e,t,n){var i=this,a=arguments.length,o=i._generateItemsFromData(i.option("items")),r=i._getItemByField(e,o);switch(a){case 1:return r;case 3:i._changeItemOption(r,t,n);break;default:l.isObject(t)&&d(t,(function(e,t){i._changeItemOption(r,e,t)}))}this.option("items",o)},validate:function(){return C.validateGroup(this._getValidationGroup())},getItemID:function(e){return"dx_"+this.option("formID")+"_"+(e||new r)},getTargetScreenFactor:function(){return this._targetScreenFactor}});o("dxForm",A),n.exports=A}

