function module(t,e){"use strict";var r,a=O(t("../../core/renderer")),n=t("../../core/utils/common"),o=t("../../core/utils/type"),s=t("../../core/utils/iterator"),u=t("../../core/utils/extend"),i=t("../../core/utils/data"),l,m=O(t("../widget/ui.errors")),g,d=O(t("./ui.data_grid.core")),c,p=O(t("../../localization/message")),h,f=O(t("./ui.data_grid.data_source_adapter")),y,C=O(t("../grid_core/ui.grid_core.columns_view")),_,v=O(t("./aggregate_calculator")),x,I=O(t("../../data/query")),S=t("../../data/store_helper"),G=t("../../data/utils");function O(t){return t&&t.__esModule?t:{default:t}}var w="dx-datagrid-total-footer",A="dx-datagrid-summary-item",B="dx-datagrid-text-content",D="dx-datagrid-group-footer",F="dx-datagrid-group-text-content",V="dx-datagrid-nowrap",T="groupFooter",b=function(t,e){var r,n,o=(0,a.default)(t),s=e.column,u=e.summaryItems,i=[];if(!s.command&&u){for(r=0;r<u.length;r++)n=u[r],i.push((0,a.default)("<div>").css("textAlign",n.alignment||s.alignment).addClass("dx-datagrid-summary-item").addClass("dx-datagrid-text-content").addClass(n.cssClass).toggleClass("dx-datagrid-group-text-content","group"===e.rowType).text(d.default.getSummaryText(n,e.summaryTexts)));o.append(i)}},L=function(t,e){var r=t.option("summary.texts")||{};return{totalItem:e.row,summaryItems:e.row.summaryCells[e.columnIndex],summaryTexts:r}},E=function(t){return t.summary||t.aggregates||[]},k=function(t){return t.option("summary.recalculateWhileEditing")};e.FooterView=C.default.ColumnsView.inherit({_getRows:function(){return this._dataController.footerItems()},_getCellOptions:function(t){return(0,u.extend)(this.callBase(t),L(this,t))},_renderCellContent:function(t,e){b(t,e),this.callBase(t,e)},_renderCore:function(t){var e=this._dataController.footerItems()[0];t&&t.columnIndices||this.element().empty().addClass("dx-datagrid-total-footer").toggleClass("dx-datagrid-nowrap",!this.option("wordWrapEnabled")),e&&e.summaryCells&&e.summaryCells.length&&this._updateContent(this._renderTable({change:t}),t)},_updateContent:function(t,e){if(!e||"update"!==e.changeType||!e.columnIndices)return this.callBase.apply(this,arguments);var r=this._getTableElement().find(".dx-row"),a=t.find(".dx-row");this._updateCells(r,a,e.columnIndices[0])},_rowClick:function(t){var e=this._dataController.footerItems()[t.rowIndex]||{};this.executeAction("onRowClick",(0,u.extend)({},t,e))},_columnOptionChanged:function(t){var e=t.optionNames;t.changeTypes.grouping||(e.width||e.visibleWidth)&&this.callBase(t)},_handleDataChanged:function(t){var e=t.changeType;"update"===t.changeType&&t.repaintChangesOnly?t.totalColumnIndices?t.totalColumnIndices.length&&this.render(null,{changeType:"update",columnIndices:[t.totalColumnIndices]}):this.render():"refresh"!==e&&"append"!==e&&"prepend"!==e||this.render()},getHeight:function(){return this.getElementHeight()},isVisible:function(){return!!this._dataController.footerItems().length}});var P=function(){function t(e,r,a,n){n=n||[];for(var o=0;o<e.length;o++)n.push(e[o].key),1===r?a(n,e[o].items):t(e[o].items,r-1,a,n),n.pop()}return{init:function(){this.callBase.apply(this,arguments),this._totalAggregates=[],this._summaryGetter=n.noop},summaryGetter:function(t){if(!arguments.length)return this._summaryGetter;(0,o.isFunction)(t)&&(this._summaryGetter=t)},summary:function(t){if(!arguments.length)return this._summaryGetter();this._summaryGetter=function(){return t}},totalAggregates:function(){return this._totalAggregates},isLastLevelGroupItemsPagingLocal:function(){var t=this.summary(),e=t&&t.sortByGroups();return e&&e.length},sortLastLevelGroupItems:function(e,r,a){var n=(0,S.multiLevelGroup)((0,I.default)(e),r).toArray(),o=[];return a.forEach((function(e){t(n,r.length,(function(t,r){e.toString()===t.toString()&&(o=o.concat(r))}))})),o}}}(),z=(M=function t(e,r,a){return a?t(e,r.map((function(t){return{items:[t]}}),a-1)):e.concat(r)},N=function t(e,r,a){return a?e.map((function(e){var n={},o=t(e.items||[],r,a-1);return Object.defineProperty(n,"aggregates",{get:function(){return e.aggregates},set:function(t){e.aggregates=t}}),(0,u.extend)(n,e,{items:o})})):e.filter((function(t){return r.indexOf(t)<0}))},R=function(t,e,r,a){var n;if(k(t)){var o=t.getController("editing");if(o){var s=o.getInsertedData();s.length&&(r=M(r,s,a));var u=o.getRemovedData();u.length&&(r=N(r,u,a))}}return e&&(n=new v.default({totalAggregates:e.totalAggregates,groupAggregates:e.groupAggregates,data:r,groupLevel:a})).calculate(),n?n.totalAggregates():[]},W=function t(e,r,a){if(!e||!r.length)return e;var n,o=r[0],u=a[0];return o&&u&&u.length&&(n=(0,I.default)(e),(0,s.each)(u,(function(t){n=0===t?n.sortBy(this.selector,this.desc):n.thenBy(this.selector,this.desc)})),n.enumerate().done((function(t){e=t}))),r=r.slice(1),a=a.slice(1),r.length&&a.length&&(0,s.each)(e,(function(){this.items=t(this.items,r,a)})),e},j=function(t,e,r){var a=r&&r.sortByGroups&&r.sortByGroups();return a&&a.length?W(t,e,a):t},{_customizeRemoteOperations:function(t){var e=this.summary();e&&(t.remoteOperations.summary?t.isCustomLoading&&!t.storeLoadOptions.isLoadingAll||(t.storeLoadOptions.group&&(t.remoteOperations.grouping?t.storeLoadOptions.groupSummary=e.groupAggregates:e.groupAggregates.length&&(t.remoteOperations.paging=!1)),t.storeLoadOptions.totalSummary=e.totalAggregates):(e.totalAggregates.length||e.groupAggregates.length&&t.storeLoadOptions.group)&&(t.remoteOperations.paging=!1)),this.callBase.apply(this,arguments);var r=t.cachedPagesData.extra;r&&r.summary&&!t.isCustomLoading&&(t.storeLoadOptions.totalSummary=void 0)},_handleDataLoadedCore:function(t){var e,r=this,a=(0,G.normalizeSortingInfo)(t.storeLoadOptions.group||t.loadOptions.group||[]),n=t.remoteOperations||{},s=this.summaryGetter()(n);t.isCustomLoading&&!t.storeLoadOptions.isLoadingAll||(n.summary?!n.paging&&a.length&&s&&(n.grouping||R(this,{groupAggregates:s.groupAggregates},t.data,a.length),t.data=j(t.data,a,s)):n.paging||(e=R(this,s,t.data,a.length),t.data=j(t.data,a,s),t.extra=(0,o.isPlainObject)(t.extra)?t.extra:{},t.extra.summary=e)),t.isCustomLoading||(this._totalAggregates=t.extra&&t.extra.summary||this._totalAggregates),this.callBase(t)}}),M,N,R,W,j;f.default.extend(P),f.default.extend(z),e.renderSummaryCell=b,d.default.registerModule("summary",{defaultOptions:function(){return{summary:{groupItems:void 0,totalItems:void 0,calculateCustomSummary:void 0,skipEmptyValues:!0,recalculateWhileEditing:!1,texts:{sum:p.default.getFormatter("dxDataGrid-summarySum"),sumOtherColumn:p.default.getFormatter("dxDataGrid-summarySumOtherColumn"),min:p.default.getFormatter("dxDataGrid-summaryMin"),minOtherColumn:p.default.getFormatter("dxDataGrid-summaryMinOtherColumn"),max:p.default.getFormatter("dxDataGrid-summaryMax"),maxOtherColumn:p.default.getFormatter("dxDataGrid-summaryMaxOtherColumn"),avg:p.default.getFormatter("dxDataGrid-summaryAvg"),avgOtherColumn:p.default.getFormatter("dxDataGrid-summaryAvgOtherColumn"),count:p.default.getFormatter("dxDataGrid-summaryCount")}},sortByGroupSummaryInfo:void 0}},views:{footerView:e.FooterView},extenders:{controllers:{data:{_isDataColumn:function(t){return t&&(!(0,o.isDefined)(t.groupIndex)||t.showWhenGrouped)},_isGroupFooterVisible:function(){var t,e,r,a=this.option("summary.groupItems")||[];for(r=0;r<a.length;r++)if(t=a[r],e=this._columnsController.columnOption(t.showInColumn||t.column),t.showInGroupFooter&&this._isDataColumn(e))return!0;return!1},_processGroupItems:function(t,e,r){var a=r&&r.data,n=this.callBase.apply(this,arguments);return r&&(void 0===r.isGroupFooterVisible&&(r.isGroupFooterVisible=this._isGroupFooterVisible()),a&&a.items&&r.isGroupFooterVisible&&(r.collectContinuationItems||!a.isContinuationOnNextPage)&&n.push({rowType:"groupFooter",key:r.path.slice(),data:a,groupIndex:r.path.length-1,values:[]})),n},_processGroupItem:function(t,e){var r=this;if(e.summaryGroupItems||(e.summaryGroupItems=r.option("summary.groupItems")||[]),"group"===t.rowType){var a=-1,n=-1;(0,s.each)(e.visibleColumns,(function(r){var o=e.visibleColumns[r-1];t.groupIndex===this.groupIndex&&(a=this.index),r>0&&"expand"===o.command&&"expand"!==this.command&&(n=this.index)})),t.summaryCells=this._calculateSummaryCells(e.summaryGroupItems,E(t.data),e.visibleColumns,(function(t,e){return t.showInGroupFooter?-1:t.alignByColumn&&e&&!(0,o.isDefined)(e.groupIndex)&&e.index!==n?e.index:a}))}return"groupFooter"===t.rowType&&(t.summaryCells=this._calculateSummaryCells(e.summaryGroupItems,E(t.data),e.visibleColumns,(function(t,e){return t.showInGroupFooter&&r._isDataColumn(e)?e.index:-1}))),t},_calculateSummaryCells:function(t,e,r,a){var n=this,i=[],l={};return(0,s.each)(t,(function(t,r){var s,i=n._columnsController.columnOption(r.column),m=r.showInColumn&&n._columnsController.columnOption(r.showInColumn)||i,g=a(r,m),c;g>=0&&(l[g]||(l[g]=[]),(s=e[t])==s&&((0,o.isDefined)(r.valueFormat)?c=r.valueFormat:"count"!==r.summaryType&&(c=d.default.getFormatByDataType(i&&i.dataType)),l[g].push((0,u.extend)({},r,{value:(0,o.isString)(s)&&i&&i.deserializeValue?i.deserializeValue(s):s,valueFormat:c,columnCaption:i&&i.index!==g?i.caption:void 0}))))})),(0,o.isEmptyObject)(l)||(0,s.each)(r,(function(){i.push(l[this.index]||[])})),i},_getSummaryCells:function(t,e){var r=this,a=r._columnsController;return r._calculateSummaryCells(t,e,a.getVisibleColumns(),(function(t,e){return r._isDataColumn(e)?e.index:-1}))},_updateItemsCore:function(t){var e,r,a=this,n=this._dataSource,o=this._footerItems,s=o&&o[0]&&o[0].summaryCells,u=this.option("summary.totalItems");this._footerItems=[],n&&u&&u.length&&(r=n.totalAggregates(),e=this._getSummaryCells(u,r),t&&t.repaintChangesOnly&&s&&(t.totalColumnIndices=e.map((function(t,e){return JSON.stringify(t)!==JSON.stringify(s[e])?e:-1})).filter((function(t){return t>=0}))),e.length&&this._footerItems.push({rowType:"totalFooter",summaryCells:e})),this.callBase(t)},_prepareUnsavedDataSelector:function(t){var e=this;if(k(this)){var r=this.getController("editing");if(r)return function(e){return e=r.getUpdatedData(e),t(e)}}return t},_prepareAggregateSelector:function(t,e){return t=this._prepareUnsavedDataSelector(t),"avg"===e||"sum"===e?function(e){var r=t(e);return(0,o.isDefined)(r)?Number(r):r}:t},_getAggregates:function(t,e){var r=this,a=r.getController("columns"),n=r.option("summary.calculateCustomSummary"),u=r.option("summary.skipEmptyValues");return(0,s.map)(t||[],(function(t){var s,l=a.columnOption(t.column),g=l&&l.calculateCellValue?l.calculateCellValue.bind(l):(0,i.compileGetter)(l?l.dataField:t.column),d=t.summaryType||"count",c=t.column,p=(0,o.isDefined)(t.skipEmptyValues)?t.skipEmptyValues:u;return e?{selector:t.column,summaryType:d}:(c=r._prepareAggregateSelector(g,d),"custom"===d&&(n||(m.default.log("E1026"),n=function(){}),s={component:r.component,name:t.name},n(s),s.summaryProcess="calculate",d={seed:function(t){return s.summaryProcess="start",s.totalValue=void 0,s.groupIndex=t,delete s.value,n(s),s.totalValue},step:function(t,e){return s.summaryProcess="calculate",s.totalValue=t,s.value=e,n(s),s.totalValue},finalize:function(t){return s.summaryProcess="finalize",s.totalValue=t,delete s.value,n(s),s.totalValue}}),{selector:c,aggregator:d,skipEmptyValues:p})}))},_addSortInfo:function(t,e,r,a){var n;e&&(n=e.groupIndex,a=a||e.sortOrder,(0,o.isDefined)(n)&&(t[n]=t[n]||[],t[n].push({selector:r,desc:"desc"===a})))},_findSummaryItem:function(t,e){var r=-1,a=function(t){var e=t.summaryType,r=t.column;return e&&r&&e+"_"+r};return(0,o.isDefined)(e)&&(0,s.each)(t||[],(function(t){if(this.name===e||t===e||this.summaryType===e||this.column===e||a(this)===e)return r=t,!1})),r},_getSummarySortByGroups:function(t,e){var r=this,a=r._columnsController,n=a.getGroupColumns(),u=[];if(e&&e.length)return(0,s.each)(t||[],(function(){var t=this.sortOrder,i=this.groupColumn,l=r._findSummaryItem(e,this.summaryItem);if(!(l<0)){var m=function(t){return E(t)[l]};(0,o.isDefined)(i)?(i=a.columnOption(i),r._addSortInfo(u,i,m,t)):(0,s.each)(n,(function(e,a){r._addSortInfo(u,a,m,t)}))}})),u},_createDataSourceAdapterCore:function(t,e){var r=this,a=this.callBase(t,e);return a.summaryGetter((function(t){return r._getSummaryOptions(t||e)})),a},_getSummaryOptions:function(t){var e=this,r=e.option("summary.groupItems"),a=e.option("summary.totalItems"),n=e.option("sortByGroupSummaryInfo"),o=e._getAggregates(r,t&&t.grouping&&t.summary),s=e._getAggregates(a,t&&t.summary),u=function(){return e._getSummarySortByGroups(n,r)};if(o.length||s.length)return{groupAggregates:o,totalAggregates:s,sortByGroups:u}},publicMethods:function(){var t=this.callBase();return t.push("getTotalSummaryValue"),t},getTotalSummaryValue:function(t){var e=this._findSummaryItem(this.option("summary.totalItems"),t),r=this._dataSource.totalAggregates();if(r.length&&e>-1)return r[e]},optionChanged:function(t){"summary"!==t.name&&"sortByGroupSummaryInfo"!==t.name||(t.name="dataSource"),this.callBase(t)},init:function(){this._footerItems=[],this.callBase()},footerItems:function(){return this._footerItems}},editing:{_refreshSummary:function(){k(this)&&this._dataController.refresh({load:!0,changesOnly:!0})},_addEditData:function(t){var e=this.callBase.apply(this,arguments);return t.type&&this._refreshSummary(),e},_removeEditDataItem:function(){var t=this.callBase.apply(this,arguments);return this._refreshSummary(),t},cancelEditData:function(){var t=this.callBase.apply(this,arguments);return this._refreshSummary(),t}}},views:{rowsView:{_createRow:function(t){var e=this.callBase(t);return t&&e.addClass("groupFooter"===t.rowType?"dx-datagrid-group-footer":""),e},_renderCells:function(t,e){this.callBase.apply(this,arguments),"group"===e.row.rowType&&e.row.summaryCells&&e.row.summaryCells.length&&this._renderGroupSummaryCells(t,e)},_hasAlignByColumnSummaryItems:function(t,e){return!(0,o.isDefined)(e.columns[t].groupIndex)&&e.row.summaryCells[t].length},_getAlignByColumnCellCount:function(t,e){for(var r,a=0,n=1;n<t;n++)r=e.row.summaryCells.length-n,a=this._hasAlignByColumnSummaryItems(r,e)?n:a;return a},_renderGroupSummaryCells:function(t,e){var r=t.children().last(),a=Number(r.attr("colSpan"))||1,n=this._getAlignByColumnCellCount(a,e);this._renderGroupSummaryCellsCore(r,e,a,n)},_renderGroupSummaryCellsCore:function(t,e,r,a){if(a>0){t.attr("colSpan",r-a);for(var n=0;n<a;n++){var o=e.columns.length-a+n;this._renderCell(t.parent(),(0,u.extend)({column:e.columns[o],columnIndex:this._getSummaryCellIndex(o,e.columns)},e))}}},_getSummaryCellIndex:function(t){return t},_getCellTemplate:function(t){return!t.column.command&&!(0,o.isDefined)(t.column.groupIndex)&&t.summaryItems&&t.summaryItems.length?b:this.callBase(t)},_getCellOptions:function(t){var e=this,r=this.callBase(t);return t.row.summaryCells?(0,u.extend)(r,L(this,t)):r}}}}})}

