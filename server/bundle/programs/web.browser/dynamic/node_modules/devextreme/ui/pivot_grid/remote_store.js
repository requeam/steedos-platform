function module(e,t,n){"use strict";var r=e("../../core/utils/type"),o,a=m(e("../../core/class")),l=e("../../core/utils/extend"),u=e("../../core/utils/iterator"),s,i=m(e("../../data/data_source/data_source")),c=e("../../core/utils/deferred"),d=e("./ui.pivot_grid.utils"),f=m(d),h=e("../../core/utils/date_serialization");function m(e){return e&&e.__esModule?e:{default:e}}function g(e){var t=[];return(0,u.each)(e,(function(n,r){t.push({selector:r.dataField,groupInterval:r.groupInterval,isExpanded:n<e.length-1})})),t}function v(e){var t=e.dataField,n=e.groupInterval;return"date"===e.dataType&&"string"==typeof n&&("quarter"===n.toLowerCase()&&(n="Month"),t=t+"."+f.default.capitalizeFirstLetter(n)),t}function p(e,t,n,r){var o,a;return[[e,r?"<":">=",n],r?"or":"and",[e,r?">=":"<",n+t]]}function w(e,t){var n=v(e),o="exclude"===e.filterType,a=[n,o?"<>":"=",t];return(0,r.isDefined)(e.groupInterval)&&("string"==typeof e.groupInterval&&"quarter"===e.groupInterval.toLowerCase()?a=p(n,3,3*(t-1)+1,o):"number"==typeof e.groupInterval&&"date"!==e.dataType&&(a=p(n,e.groupInterval,t,o))),a}function y(e,t){var n=[];return t="exclude"===e.filterType?t||"and":t||"or",(0,u.each)(e.filterValues,(function(r,o){var a=[],l=e.levels?e.levels[r]:e,u;Array.isArray(o)?e.levels&&e.levels.length&&(a=y({filterValues:o,filterType:l.filterType,levels:e.levels},"and")):a=w(l,o);a.length&&(n.length&&n.push(t),n.push(a))})),n}function x(e){var t=[];return(0,u.each)(e,(function(e,n){var r=y(n);if(!r.length)return[];t.length&&t.push("and"),t.push(r)})),1===t.length&&(t=t[0]),t}function T(e,t){var n,r=function(e){return e&&e.length};return n=r(e)&&r(t)?[e,"and",t]:r(e)?e:t}function I(e,t){var n=x(e.filters),r=g(e.rows).concat(g(e.columns)),o={groupSummary:[],totalSummary:[],group:r.length?r:void 0,take:r.length?void 0:1};return t&&(n=T(n,t)),n.length&&(o.filter=n),(0,u.each)(e.values,(function(t,n){var r={selector:n.dataField,summaryType:n.summaryType||"count"};o.groupSummary.push(r),e.includeTotalSummary&&o.totalSummary.push(r)})),o}function S(e,t,n){e=e||[],n=n||0,(0,u.each)(e,(function(e,r){t(r,n),r.items&&r.items.length&&S(r.items,t,n+1)}))}function _(e,t,n,o,a){e[n]=e[n]||[],e[n][o]=e[n][o]||[],(0,r.isDefined)(e[n][o][a])||(e[n][o][a]=t)}function D(e,t){return t&&"number"===t.dataType&&(0,r.isString)(e)?Number(e):!t||"date"!==t.dataType||t.groupInterval||e instanceof Date?e:(0,h.deserializeDate)(e)}function F(e,t,n,r){var o=[],a=[],l=r.rowHash,s=r.columnHash;function i(e,t,n,o,a){var l,u,s,i,c=r[t+"Hash"],d=n.slice(0,o+1).join("/");return void 0!==c[d]?s=c[d]:(s={value:D(e.key,a),index:r[t+"Index"]++},i=n.slice(0,o).join("/"),(u=o>0&&void 0!==c[i]?(l=c[i]).children=l.children||[]:r[t+"s"]).push(s),c[d]=s),s}return t&&t.summary&&(0,u.each)(t.summary,(function(e,t){_(r.values,t,r.grandTotalRowIndex,r.grandTotalColumnIndex,e)})),S(e,(function(e,t){var c,d,f=t>=n.rows.length?n.rows.length:t,h=t>=n.rows.length?t-n.rows.length:0;if(!(t>=n.rows.length&&h>=n.columns.length)){t<n.rows.length&&(a=[]),t>=n.rows.length?(a[h]=e.key+"",c=i(e,"column",a,h,n.columns[a.length-1]),d=l[o.slice(0,f+1).join("/")]):(o[f]=e.key+"",d=i(e,"row",o,f),c=s[a.slice(0,h+1).join("/")]);var m=d&&d.index||r.grandTotalRowIndex,g=c&&c.index||r.grandTotalColumnIndex;(0,u.each)(e.summary||[],(function(e,t){_(r.values,t,m,g,e)}))}})),r}function P(e){return(e||[]).filter((function(e){return e.filterValues&&e.filterValues.length}))}function k(e,t){return t===e.headerName?e.path.length:0}function C(e){return(0,d.getFiltersByPath)(e[e.headerName],e.path)}function j(e,t,n,r){var o=[],a=n>r?0:r,s=e.headerName!==t?e[t].slice(a,n):[],i="rows"===t?e.rowExpandedPaths:e.columnExpandedPaths;return(0,u.each)(s,(function(e,t){var r=[];(0,u.each)(i,(function(t,o){o=o.slice(a,n),e<o.length&&r.push(o[e])})),r.length&&o.push((0,l.extend)({},t,{filterType:"include",filterValues:r}))})),o}function E(e,t,n,r,o,a){var u,s=("columns"===t?e.columnExpandedPaths:e.rowExpandedPaths)||[],i="columns"===t?"rows":"columns",c=e[t],d=[];if(s.length)for(var f=n;f<r+1;f++)(u={filters:o.concat(j(e,t,f,a))})[t]=c.slice(n,f+1),u[i]=[],d.push((0,l.extend)({},e,u));else(u={filters:o})[t]=c.slice(n,r+1),u[i]=[],d.push((0,l.extend)({},e,u));return d[0].includeTotalSummary=!0,d}function V(e){var t=0;return(0,u.each)(e,(function(e,n){if(!n.expanded)return t=e,!1})),t}function H(e){var t,n=f.default.getExpandedLevel(e,"rows"),r=f.default.getExpandedLevel(e,"columns"),o=e.filters||[],a=k(e,"columns"),u=V(e.columns),s=V(e.rows),i=k(e,"rows"),c=[];if(t=E(e,"columns",a,r,o=o.concat(P(e.rows)).concat(P(e.columns)).concat(C(e)),u),e.rows.length&&e.columns.length){"rows"!==e.headerName&&(c=c.concat(t));for(var d=i;d<n+1;d++)for(var h=e.rows.slice(i,d+1),m=j(e,"rows",d,s),g=a;g<r+1;g++){var v=(0,l.extend)({},e,{columns:e.columns.slice(a,g+1),rows:h,filters:o.concat(j(e,"columns",g,u)).concat(m)});c.push(v)}}else c=e.columns.length?t:E(e,"rows",i,n,o,s);return c}function L(e){(0,u.each)(e||[],(function(e,t){var n=t.levels;n&&L(n),f.default.setDefaultFieldValueFormatting(t)}))}n.exports=a.default.inherit({ctor:function(e){this._dataSource=new i.default.DataSource(e),this._store=this._dataSource.store()},getFields:function(e){var t=new c.Deferred;return this._store.load({skip:0,take:20}).done((function(n){t.resolve(f.default.discoverObjectFields(n,e))})).fail(t.reject),t},key:function(){return this._store.key()},load:function(e){var t=this,n=new c.Deferred,r={rows:[],columns:[],values:[[[]]],grandTotalRowIndex:0,grandTotalColumnIndex:0,rowHash:{},columnHash:{},rowIndex:1,columnIndex:1},o=H(e),a=[];return L(e.rows),L(e.columns),L(e.filters),(0,u.each)(o,(function(e,n){a.push(t._store.load(I(n,t.filter())))})),c.when.apply(null,a).done((function(){var e=a.length>1?arguments:[arguments];(0,u.each)(e,(function(e,t){F(t[0],t[1],o[e],r)})),n.resolve({rows:r.rows,columns:r.columns,values:r.values,grandTotalRowIndex:r.grandTotalRowIndex,grandTotalColumnIndex:r.grandTotalColumnIndex})})).fail(n.reject),n},filter:function(){return this._dataSource.filter.apply(this._dataSource,arguments)},supportSorting:function(){return!1},createDrillDownDataSource:function(e,t){e=e||{},t=t||{};var n=this._store,r,o=x((0,d.getFiltersByPath)(e.rows,t.rowPath).concat((0,d.getFiltersByPath)(e.columns,t.columnPath)).concat(P(e.rows)).concat(e.filters||[]).concat(P(e.columns)));return new i.default.DataSource({load:function(e){return n.load((0,l.extend)({},e,{filter:T(o,e.filter),select:t.customColumns}))}})}})}

