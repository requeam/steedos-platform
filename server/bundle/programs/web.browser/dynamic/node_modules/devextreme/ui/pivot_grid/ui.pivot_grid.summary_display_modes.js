function module(e,n){"use strict";var t=e("../../core/utils/type"),i=e("../../core/utils/extend").extend,r=e("../../core/utils/array").inArray,a=t.isDefined,l=e("./ui.pivot_grid.utils"),u=l.findField,o=l.foreachTree,s="column",c="row",h=null,d=function(e,n){var t=e/n;return a(e)&&!isNaN(t)||(t=h),t},f=function(e,n){return d(e.value(),e.grandTotal(n).value())},v=function(e,n){var t=e.parent(n),i=t?t.value():e.value();return d(e.value(),i)},p=function(e){return function(n){var t=n.prev(s,e),i=t&&t.value();return a(i)&&a(n.value())?n.value()-i:h}},_=function(e){var n=p(e);return function(t){var i=n(t),r=t.prev(s,e),a=r&&r.value();return i!==h&&a?i/a:h}},g={percentOfColumnTotal:function(e){return v(e,c)},percentOfRowTotal:function(e){return v(e,s)},percentOfColumnGrandTotal:function(e){return f(e,c)},percentOfRowGrandTotal:function(e){return f(e,s)},percentOfGrandTotal:function(e){return f(e)}},m=function e(n,t){if(n&&n.parent(t)){var i=n.prev(t);return i||(i=e(n.parent(t),t)),i}},x=function(e){if(e.runningTotal){var n=e.runningTotal===s?c:s;return function(t){var i=e.allowCrossGroupCalculation?m(t,n):t.prev(n,!1),r=t.value(!0),l=i&&i.value(!0);return a(l)&&a(r)?r=l+r:a(l)&&(r=l),r}}};function y(){return{fields:{},positions:{}}}function w(e,n,i){var a,l,o={index:-1};if(t.isObject(n)||(i.fields[n]?n=i[n]:(l=e.columns.concat(e.rows).concat(e.values),a=u(l,n),n=i[n]=l[a])),n){var s=n.area||"data";o=i.positions[n.index]=i.positions[n.index]||{area:s,index:r(n,e["data"===s?"values":s+"s"])}}return o}function C(e){return e===c?"_rowPath":"_columnPath"}var P=function(e,n,t,i,r,a){this._columnPath=e,this._rowPath=n,this._fieldIndex=r,this._fieldsCache=a||{fields:{},positions:{}},this._data=t,this._descriptions=i;var l=t.values&&t.values[n[0].index]&&t.values[n[0].index][e[0].index];l&&(l.originalCell=l.originalCell||l.slice(),this._cell=l)};function T(e){var n=e.summaryDisplayMode,i=e.allowCrossGroupCalculation,r=h;return t.isFunction(e.calculateSummaryValue)?r=e.calculateSummaryValue:n&&(r="absoluteVariation"===n?p(i):"percentVariation"===n?_(i):g[n])&&!e.format&&-1!==n.indexOf("percent")&&l.setFieldProperty(e,"format","percent"),r}function E(e,n,t,i){var r=e.values[n][t]=e.values[n][t]||[],a=r.originalCell;a&&(!r.allowResetting&&i||(e.values[n][t]=a.slice()),e.values[n][t].allowResetting=i)}P.prototype=i(P.prototype,{_getPath:function(e){return this[C(e)]},_getDimension:function(e){return e=e===c?"rows":"columns",this._descriptions[e]},_createCell:function(e){var n=this;return new P(e._columnPath||this._columnPath,e._rowPath||this._rowPath,this._data,this._descriptions,this._fieldIndex)},parent:function(e){var n=this._getPath(e).slice(),t={};return n.shift(),n.length?(t[C(e)]=n,this._createCell(t)):h},children:function(e){var n=this._getPath(e).slice(),t=n[0],i=[],r={};if(t.children)for(var a=0;a<t.children.length;a++)r[C(e)]=[t.children[a]].concat(n.slice()),i.push(this._createCell(r));return i},grandTotal:function(e){var n={},t=this._rowPath,i=this._columnPath,r=this._getPath(e),a=C(e);return e?n[a]=[r[r.length-1]]:(n._rowPath=[t[t.length-1]],n._columnPath=[i[i.length-1]]),this._createCell(n)},next:function(e,n){var t,i,a=this._getPath(e),l=a[0],u=this.parent(e);if(u&&(i=r(l,a[1].children),(t=u.children(e))[i+1]))return t[i+1];if(n&&u){do{t=(u=u.next(e,n))?u.children(e):[]}while(u&&!t.length);return t[0]||h}return h},prev:function(e,n){var t,i,a=this._getPath(e),l=a[0],u=this.parent(e);if(u&&(i=r(l,a[1].children),(t=u.children(e))[i-1]))return t[i-1];if(n&&u){do{t=(u=u.prev(e,n))?u.children(e):[]}while(u&&!t.length);return t[t.length-1]||h}return h},cell:function(){return this._cell},field:function e(n){if("data"===n)return this._descriptions.values[this._fieldIndex];var t=this._getPath(n),i,e=this._getDimension(n)[t.length-2];return e||h},child:function(e,n){for(var t,i=this.children(e),r=0;r<i.length;r++)if(t=t||i[r].field(e),i[r].value(t)===n)return i[r];return h},slice:function(e,n){var t,i,r,a,l=this,u={},o=w(this._descriptions,e,this._fieldsCache),d=o.area,f=o.index,v=h,p=[];if((d===c||d===s)&&(i=this._getPath(d).slice())[a=-1!==f&&i.length-2-f]){p[i.length-1]=i[i.length-1];for(var _=a;_>=0;_--){if(i[_+1]){t=i[_+1].children||[],r=_===a?n:i[_].value,i[_]=void 0;for(var g=0;g<t.length;g++)if(t[g].value===r){i[_]=t[g];break}}if(void 0===i[_])return v}u[C(d)]=i,v=this._createCell(u)}return v},value:function(e,n){var t,i,r=this._cell,l=this._fieldIndex,u=!0===e||!1===e,o=u?h:e,s=u&&e||n;if(a(o)){var c=w(this._descriptions,o,this._fieldsCache);if(l=c.index,"data"!==c.area)return(t=this._getPath(c.area))[i=-1!==l&&t.length-2-l]&&t[i].value}return r&&r.originalCell?s?r[l]:r.originalCell[l]:h}}),n.applyDisplaySummaryMode=function(e,n){var t=[],i=[{index:n.grandTotalColumnIndex,children:n.columns}],r=[{index:n.grandTotalRowIndex,children:n.rows}],a=e.values,l={fields:{},positions:{}};n.values=n.values||[],o(r,(function(r){var u=r[0];u.isEmpty=[],n.values[u.index]=n.values[u.index]||[],o(i,(function(i){var o,s,c,h,d,f,v=i[0];v.isEmpty=v.isEmpty||[],E(n,u.index,v.index,!1);for(var p=0;p<a.length;p++)h=a[p],d=!1,(o=t[p]=void 0===t[p]?T(h):t[p])&&(d=null==(f=(c=(s=new P(i,r,n,e,p,l)).cell())[p]=o(s))),void 0===v.isEmpty[p]&&(v.isEmpty[p]=!0),void 0===u.isEmpty[p]&&(u.isEmpty[p]=!0),d||(u.isEmpty[p]=v.isEmpty[p]=!1)}),!1)}),!1),n.isEmptyGrandTotalRow=r[0].isEmpty,n.isEmptyGrandTotalColumn=i[0].isEmpty},n.applyRunningTotal=function(e,n){var t=[],i=[{index:n.grandTotalColumnIndex,children:n.columns}],r=[{index:n.grandTotalRowIndex,children:n.rows}],a=e.values,l={fields:{},positions:{}};n.values=n.values||[],o(r,(function(r){var u=r[0];n.values[u.index]=n.values[u.index]||[],o(i,(function(i){var o,s,c,h,d=i[0];E(n,u.index,d.index,!0);for(var f=0;f<a.length;f++)h=a[f],(o=t[f]=void 0===t[f]?x(h):t[f])&&((c=(s=new P(i,r,n,e,f,l)).cell())[f]=o(s))}),!1)}),!1)},n.createMockSummaryCell=function(e,n,t){var i=new P([],[],{},e,0);return i.value=function(i){if(a(i)){var r=u(n,i),l=n[r];t[r]||!l||a(l.area)||(e.values.push(l),t[r]=!0)}},i.grandTotal=function(){return this},i.children=function(){return[]},i}}

