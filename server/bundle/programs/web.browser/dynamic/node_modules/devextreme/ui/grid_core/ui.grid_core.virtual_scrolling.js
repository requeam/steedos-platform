function module(e,t,n){"use strict";var o,i=m(e("../../core/renderer")),r=e("../../core/utils/window"),a=e("../../core/utils/common"),l,s=m(e("./ui.grid_core.virtual_scrolling_core")),d,u=m(e("./ui.grid_core.utils")),c=e("../../core/utils/iterator"),p=e("../../core/utils/deferred"),h,g=m(e("../../animation/translator")),f,_=m(e("../load_indicator"));function m(e){return e&&e.__esModule?e:{default:e}}var v="table",C="bottom-load-panel",w="table-content",S="group-space",I="content",y="dx-row",x="dx-freespace-row",T="dx-column-lines",z="dx-virtual-row",P="infinite",b="virtual",R="standard",B=25e4,L=function(e){return"virtual"===e.option("scrolling.mode")},E=function(e){return"infinite"===e.option("scrolling.mode")},V=function(e){var t=e.option("scrolling.rowRenderingMode");return"virtual"===t||"standard"!==t&&void 0},D=function(e,t,n,o){for(var i=n?0:1,r=0;r<t+i;r++){var a=e[n?e.length-1-r:r];a&&!o(a,r===t)&&t++}return t},H=(O=function(e){var t=e._virtualScrollController.beginPageIndex(-1);L(e)&&(t<0||e.viewportSize()>=0&&e.getViewportItemIndex()>=0&&(t*e.pageSize()>e.getViewportItemIndex()||t*e.pageSize()+e.itemsCount()<e.getViewportItemIndex()+e.viewportSize())&&e._dataSource.isLoading()?e._isLoading||(e._isLoading=!0,e.loadingChanged.fire(!0)):e._isLoading&&(e._isLoading=!1,e.loadingChanged.fire(!1)))},M={init:function(e){var t=this;t.callBase.apply(t,arguments),t._items=[],t._isLoaded=!0,t._virtualScrollController=new s.default.VirtualScrollController(t.component,{pageSize:function(){return t.pageSize()},totalItemsCount:function(){return t.totalItemsCount()},hasKnownLastPage:function(){return t.hasKnownLastPage()},pageIndex:function(t){return e.pageIndex(t)},isLoading:function(){return e.isLoading()&&!t.isCustomLoading()},pageCount:function(){return t.pageCount()},load:function(){return e.load()},updateLoading:function(){O(t)},itemsCount:function(){return t.itemsCount(!0)},items:function(){return e.items()},viewportItems:function(e){return e&&(t._items=e),t._items},onChanged:function(e){t.changed.fire(e)},changingDuration:function(e){return t._renderTime||0}})},_handleLoadingChanged:function(e){var t=this;L(t)||(t._isLoading=e,t.callBase.apply(t,arguments))},_handleLoadError:function(){var e=this;e._isLoading=!1,e.loadingChanged.fire(!1),e.callBase.apply(e,arguments)},_handleDataChanged:function(e){var t=this.callBase.bind(this);this._virtualScrollController.handleDataChanged(t,e)},_customizeRemoteOperations:function(e,t,n){var o=this;!o.option("legacyRendering")&&L(o)&&!n.reload&&!t&&n.skip&&o._renderTime<o.option("scrolling.renderingThreshold")&&(e.delay=void 0),o.callBase.apply(o,arguments)},items:function(){return this._items},itemsCount:function(e){return e?this.callBase():this._virtualScrollController.itemsCount()},load:function(e){return e?this.callBase(e):this._virtualScrollController.load()},isLoading:function(){return this._isLoading},isLoaded:function(){return this._dataSource.isLoaded()&&this._isLoaded},resetPagesCache:function(){this._virtualScrollController.reset(),this.callBase.apply(this,arguments)},_changeRowExpandCore:function(){var e=this.callBase.apply(this,arguments);return this.resetPagesCache(),O(this),e},reload:function(){this._dataSource.pageIndex(this.pageIndex());var e=this._virtualScrollController;if(e){var t=new p.Deferred;return this.callBase.apply(this,arguments).done((function(n){var o=e._delayDeferred;o?o.done(t.resolve).fail(t.reject):t.resolve(n)})).fail(t.reject),t}return this.callBase.apply(this,arguments)},refresh:function(e,t,n){var o=this,i=e.storeLoadOptions,r=o._dataSource;return(t||n.reload)&&(o._virtualScrollController.reset(),r.items().length=0,o._isLoaded=!1,O(o),o._isLoaded=!0,E(o)?(o.pageIndex(0),r.pageIndex(0),i.pageIndex=0,e.pageIndex=0,i.skip=0):(r.pageIndex(o.pageIndex()),r.paginate()&&(i.skip=o.pageIndex()*o.pageSize()))),o.callBase.apply(o,arguments)},dispose:function(){this._virtualScrollController.dispose(),this.callBase.apply(this,arguments)}},["virtualItemsCount","getContentOffset","getVirtualContentSize","setContentSize","setViewportPosition","getViewportItemIndex","setViewportItemIndex","getItemIndexByPosition","viewportSize","viewportItemSize","getItemSize","getItemSizes","pageIndex","beginPageIndex","endPageIndex","loadIfNeed"].forEach((function(e){M[e]=function(){var t=this._virtualScrollController;return t[e].apply(t,arguments)}})),M),O,M,W=(N=function(e,t){var n,o=e.parent("."+t);o.length&&(e=o),n=t===x?e.length-1:e.length;for(var i=0;i<n;i++)e.eq(i).remove()},{init:function(){var e=this,t=e.getController("data");if(e.callBase(),t.pageChanged.add((function(){e.scrollToPage(t.pageIndex())})),!e.option("legacyRendering")&&t.pageIndex()>0){var n=function n(){e.resizeCompleted.remove(n),e.scrollToPage(t.pageIndex())};e.resizeCompleted.add(n)}},scrollToPage:function(e){var t,n=this,o=this._dataController,i=o?o.pageSize():0;if(L(this)||E(this)){var r=o.getItemSize(),a=o.getItemSizes(),l=e*i;for(var s in t=l*r,a)s<=l&&(t+=a[s]-r)}else t=0;this.scrollTo({y:t,x:this._scrollLeft})},renderDelayedTemplates:function(e){this._updateContentPosition(!0),this.callBase.apply(this,arguments)},_renderCore:function(e){var t=this,n=new Date;t.callBase.apply(t,arguments);var o=t._dataController._dataSource;if(o&&e){var i=e.items?e.items.length:20,r=t._dataController.viewportSize()||20;V(t)?o._renderTime=(new Date-n)*r/i:o._renderTime=new Date-n}},_getRowElements:function(e){var t=this.callBase(e);return t&&t.not(".dx-virtual-row")},_renderContent:function(e,t){var n=this,o=n._dataController.virtualItemsCount();return o&&n.option("legacyRendering")?((0,r.hasWindow)()&&t.addClass(n.addWidgetPrefix("table-content")),e.children().length?e.children().first().replaceWith(t):e.append(t),1===e.children("table").length&&(e.append(n._createTable()),n._contentHeight=0),e):n.callBase.apply(n,arguments)},_removeRowsElements:function(e,t,n){var o=this._getRowElements(e).toArray();o="append"===n?o.slice(0,t):o.slice(-t);var r=this.getController("errorHandling");o.map((function(e){var t=(0,i.default)(e);r&&r.removeErrorRow(t.next()),t.remove()}))},_restoreErrorRow:function(e){var t=this.getController("editing");t&&t.hasChanges()&&this._getRowElements(e).each((function(e,n){var o=(0,i.default)(n).data("options");if(o){var r=t.getEditDataByKey(o.key);r&&t._showErrorRow(r)}}))},_updateContent:function(e,t){var n,o,i=this,r=i._findContentElement(),a=t&&t.changeType;if("append"===a||"prepend"===a){n=r.children().first();var l=i._getBodies(e);i.option("legacyRendering")||1!==l.length?l["append"===a?"appendTo":"prependTo"](n):i._getBodies(n)["append"===a?"append":"prepend"](l.children()),e.remove(),o=i._getFreeSpaceRowElements(n),N(o,x),t.removeCount&&i._removeRowsElements(n,t.removeCount,a),i._restoreErrorRow(n)}else i.callBase.apply(i,arguments);i._updateBottomLoading()},_addVirtualRow:function(e,t,n,o){if(o){var i=this._createEmptyRow("dx-virtual-row",t,o);i=this._wrapRowIfNeed(e,i),this._appendEmptyRow(e,i,n)}},_updateContentPosition:function(e){var t=this,n=t._dataController,o=t._rowHeight||20;if(n.viewportItemSize(o),t.option("legacyRendering")||!L(t)&&!V(t))(0,a.deferUpdate)((function(){t._updateContentPositionCore()}));else{if(!e){var r=t._getRowElements(t._tableElement).toArray().map((function(e){return e.getBoundingClientRect().height}));n.setContentSize(r)}var l=n.getContentOffset("begin"),s=n.getContentOffset("end"),d=t.getTableElements(),u=d.children("tbody").children(".dx-virtual-row");N(u,"dx-virtual-row"),d.each((function(e){var n=e>0;t._isFixedTableRendering=n,t._addVirtualRow((0,i.default)(this),n,"top",l),t._addVirtualRow((0,i.default)(this),n,"bottom",s),t._isFixedTableRendering=!1})),!e&&t._updateScrollTopPosition(l)}},_updateScrollTopPosition:function(e){this._scrollTop<e&&!this._isScrollByEvent&&this._dataController.pageIndex()>0&&this.scrollTo({top:e,left:this._scrollLeft})},_updateContentPositionCore:function(){var e,t,n,o,i,r,l,s=this,d=s._rowHeight||20,u;s._dataController.virtualItemsCount()&&(o=(e=s._findContentElement()).children(),i=o.eq(0),r=o.eq(1),s._contentTableHeight=i[0].offsetHeight,s._dataController.viewportItemSize(d),s._dataController.setContentSize(s._contentTableHeight),t=s._dataController.getVirtualContentSize(),n=s._dataController.getContentOffset(),(0,a.deferRender)((function(){g.default.move(i,{left:0,top:n}),(l=s._contentHeight!==t||0===t||!s._isTableLinesDisplaysCorrect(r)||!s._isColumnElementsEqual(i.find("col"),r.find("col")))&&(s._contentHeight=t,s._renderVirtualTableContent(r,t)),s._updateScrollTopPosition(n)})))},_isTableLinesDisplaysCorrect:function(e){var t;return e.find(".dx-column-lines").length>0===this.option("showColumnLines")},_isColumnElementsEqual:function(e,t){var n=e.length===t.length;return n&&(0,c.each)(e,(function(e,o){if(o.style.width!==t[e].style.width)return n=!1})),n},_renderVirtualTableContent:function(e,t){var n,o=this,i=this._columnsController.getVisibleColumns(),r=this._createColGroup(i).prop("outerHTML"),a="",l=this.option("showColumnLines")?"dx-column-lines":"",s=function(e){return"<tr style='height:"+e+"px;' class='"+x+" dx-row "+l+"' >"+a+"</tr>"};for(n=0;n<i.length;n++){var d=this._getCellClasses(i[n]),u=d.length?" class='"+d.join(" ")+"'":"";a+="<td"+u+"/>"}for(;t>25e4;)r+=s(25e4),t-=25e4;r+=s(t),e.addClass(this.addWidgetPrefix("table")),e.html(r)},_getCellClasses:function(e){var t=[],n=e.cssClass,o="expand"===e.command;return n&&t.push(n),o&&t.push(this.addWidgetPrefix("group-space")),t},_findBottomLoadPanel:function(e){var t=e||this.element(),n=t&&t.find("."+this.addWidgetPrefix("bottom-load-panel"));if(n&&n.length)return n},_updateBottomLoading:function(){var e=this,t=this.option("scrolling.mode"),n="virtual"===t,o="infinite"===t,r=!this._dataController.hasKnownLastPage()&&this._dataController.isLoaded()&&(n||o),a=this._findContentElement(),l=this._findBottomLoadPanel(a);r?l||(0,i.default)("<div>").addClass(this.addWidgetPrefix("bottom-load-panel")).append(this._createComponent((0,i.default)("<div>"),_.default).$element()).appendTo(a):l&&l.remove()},_handleScroll:function(e){var t=this;t._hasHeight&&t._rowHeight&&t._dataController.setViewportPosition(e.scrollOffset.top),t.callBase.apply(t,arguments)},_needUpdateRowHeight:function(e){var t=this;return t.callBase.apply(t,arguments)||e>0&&"infinite"===t.option("scrolling.mode")&&"virtual"!==t.option("scrolling.rowRenderingMode")},_updateRowHeight:function(){var e,t=this;t.callBase.apply(t,arguments),t._rowHeight&&(t._updateContentPosition(),e=t._hasHeight?t.element().outerHeight():(0,i.default)((0,r.getWindow)()).outerHeight(),t._dataController.viewportSize(Math.ceil(e/t._rowHeight)))},updateFreeSpaceRowHeight:function(){var e=this.callBase.apply(this,arguments);return e&&this._updateContentPosition(),e},setLoading:function(e,t){var n=this,o=this.callBase,i=this._dataController,r;i.pageIndex()>0&&i.isLoaded()&&!!this._findBottomLoadPanel()&&(e=!1),o.call(this,e,t)},_resizeCore:function(){var e=this,t=e.element();e.callBase(),e.component.$element()&&!e._windowScroll&&t.closest((0,r.getWindow)().document).length&&(e._windowScroll=s.default.subscribeToExternalScrollers(t,(function(t){!e._hasHeight&&e._rowHeight&&e._dataController.setViewportPosition(t)}),e.component.$element()),e.on("disposing",(function(){e._windowScroll.dispose()}))),e.loadIfNeed()},loadIfNeed:function(){var e=this._dataController;e&&e.loadIfNeed&&e.loadIfNeed()},setColumnWidths:function(e){var t,n=this.getScrollable();this.callBase.apply(this,arguments),"virtual"===this.option("scrolling.mode")&&(t=n?n.$content():this.element(),this.callBase(e,t.children("."+this.addWidgetPrefix("content")).children(":not(."+this.addWidgetPrefix("table-content")+")")))},dispose:function(){clearTimeout(this._scrollTimeoutID),this.callBase()}}),N,k;n.exports={defaultOptions:function(){return{scrolling:{timeout:300,updateTimeout:300,minTimeout:0,renderingThreshold:100,removeInvisiblePages:!0,rowPageSize:5,mode:"standard",preloadEnabled:!1,rowRenderingMode:"standard"}}},extenders:{dataSourceAdapter:H,controllers:{data:(k={_refreshDataSource:function(){var e=this.callBase.apply(this,arguments)||(new p.Deferred).resolve().promise();return e.done(this.initVirtualRows.bind(this)),e},getRowPageSize:function(){var e=this.option("scrolling.rowPageSize"),t=this.pageSize();return t&&t<e?t:e},reload:function(){var e=this,t=e._rowsScrollController||e._dataSource,n=t&&t.getItemIndexByPosition(),o=this.callBase.apply(this,arguments);return o&&o.done((function(){if(L(e)||V(e)){var t=e.getRowIndexOffset(),o=Math.floor(n)-t,r=e.component,a=r.getScrollable&&r.getScrollable();if(a&&!e.option("legacyRendering")){var l=r.getRowElement(o),s=l&&l[0]&&(0,i.default)(l[0]),d=s&&s.position().top;d>0&&(d=Math.round(d+s.outerHeight()*(n%1)),a.scrollTo({y:d}))}}}))},initVirtualRows:function(){var e=this,t=V(e);if("virtual"!==e.option("scrolling.mode")&&!0!==t||!1===t||e.option("legacyRendering")||!e.option("scrolling.rowPageSize"))return e._visibleItems=null,void(e._rowsScrollController=null);e._rowPageIndex=Math.ceil(e.pageIndex()*e.pageSize()/e.getRowPageSize()),e._visibleItems=[];var n=function(t){return"data"===t.rowType||"group"===t.rowType&&e._dataSource.isGroupItemCountable(t.data)};e._rowsScrollController=new s.default.VirtualScrollController(e.component,{pageSize:function(){return e.getRowPageSize()},totalItemsCount:function(){return L(e)?e.totalItemsCount():e._items.filter(n).length},hasKnownLastPage:function(){return!0},pageIndex:function(t){return void 0!==t&&(e._rowPageIndex=t),e._rowPageIndex},isLoading:function(){return e.isLoading()},pageCount:function e(){var e=Math.ceil(this.totalItemsCount()/this.pageSize());return e||1},load:function(){e._rowsScrollController.pageIndex()>=this.pageCount()&&(e._rowPageIndex=this.pageCount()-1,e._rowsScrollController.pageIndex(e._rowPageIndex)),!e._rowsScrollController._dataSource.items().length&&this.totalItemsCount()||e._rowsScrollController.handleDataChanged((function(t){(t=t||{}).changeType=t.changeType||"refresh",t.items=t.items||e._visibleItems,e._visibleItems.forEach((function(e,t){e.rowIndex=t})),e._fireChanged(t)}))},updateLoading:function(){},itemsCount:function(){return e._rowsScrollController._dataSource.items().filter(n).length},correctCount:function(e,t,o){return D(e,t,o,n)},items:function(t){var o=e.dataSource(),i=o&&o.virtualItemsCount(),r=i?i.begin:0,a=e.getRowPageSize(),l=e._rowPageIndex*a-r,s=a,d=e._items;return l<0?[]:(l&&(l=this.correctCount(d,l),d=d.slice(l)),s&&(s=this.correctCount(d,s),d=d.slice(0,s)),t?d.filter(n):d)},viewportItems:function(t){return t&&(e._visibleItems=t),e._visibleItems},onChanged:function(){},changingDuration:function(t){var n=e.dataSource();return n&&n._renderTime||0}},!0),e.isLoaded()&&e._rowsScrollController.load()},_updateItemsCore:function(e){var t=this,n=this.getRowIndexDelta();this.callBase.apply(this,arguments);var o=this._rowsScrollController;if(o){var i=this._visibleItems,r="refresh"===e.changeType||e.isLiveUpdate;if("append"===e.changeType&&e.items&&!e.items.length)return;r||"append"===e.changeType||"prepend"===e.changeType?(e.cancel=!0,r&&o.reset(),o.load()):("update"===e.changeType?e.rowIndices.forEach((function(t,n){var o=e.changeTypes[n],r=e.items[n];"update"===o?i[t]=r:"insert"===o?i.splice(t,0,r):"remove"===o&&i.splice(t,1)})):(i.forEach((function(e,o){i[o]=t._items[o+n]||i[o]})),e.items=i),i.forEach((function(e,t){e.rowIndex=t})))}},_applyChange:function(e){var t=this,n=e.items,o=e.changeType,i=e.removeCount;if(i){var r="prepend"===o;i=D(t._items,i,r,(function(e,n){return"data"===e.rowType||"group"===e.rowType&&(t._dataSource.isGroupItemCountable(e.data)||n)})),e.removeCount=i}switch(o){case"prepend":t._items.unshift.apply(t._items,n),i&&t._items.splice(-i);break;case"append":t._items.push.apply(t._items,n),i&&t._items.splice(0,i);break;default:t.callBase(e)}},items:function(e){return e?this._items:this._visibleItems||this._items},getRowIndexDelta:function(){var e=this._visibleItems,t=0;return e&&e[0]&&(t=this._items.indexOf(e[0])),t<0?0:t},getRowIndexOffset:function(){var e=0,t=this.dataSource(),n=this._rowsScrollController;return n?e=n.beginPageIndex()*n._dataSource.pageSize():"virtual"===this.option("scrolling.mode")&&t&&(e=t.beginPageIndex()*t.pageSize()),e},viewportSize:function(){var e=this._rowsScrollController;e&&e.viewportSize.apply(e,arguments);var t=this._dataSource;return t&&t.viewportSize.apply(t,arguments)},viewportItemSize:function(){var e=this._rowsScrollController;e&&e.viewportItemSize.apply(e,arguments);var t=this._dataSource;return t&&t.viewportItemSize.apply(t,arguments)},setViewportPosition:function(){var e=this._rowsScrollController,t=this._dataSource;e?e.setViewportPosition.apply(e,arguments).done((function(){t&&t.setViewportItemIndex(e.getViewportItemIndex())})):t&&t.setViewportPosition.apply(t,arguments)},setContentSize:function(e){var t=this._rowsScrollController;t&&t.setContentSize(e);var n=this._dataSource;return n&&n.setContentSize(e)},loadIfNeed:function(){var e=this._rowsScrollController;e&&e.loadIfNeed();var t=this._dataSource;return t&&t.loadIfNeed()},getItemSize:function(){var e=this._rowsScrollController;if(e)return e.getItemSize.apply(e,arguments);var t=this._dataSource;return t&&t.getItemSize.apply(t,arguments)},getItemSizes:function(){var e=this._rowsScrollController;if(e)return e.getItemSizes.apply(e,arguments);var t=this._dataSource;return t&&t.getItemSizes.apply(t,arguments)},getContentOffset:function(){var e=this._rowsScrollController;if(e)return e.getContentOffset.apply(e,arguments);var t=this._dataSource;return t&&t.getContentOffset.apply(t,arguments)},dispose:function(){var e=this._rowsScrollController;e&&e.dispose(),this.callBase.apply(this,arguments)}},u.default.proxyMethod(k,"virtualItemsCount"),u.default.proxyMethod(k,"getVirtualContentSize"),u.default.proxyMethod(k,"setViewportItemIndex"),k),resizing:{resize:function(){var e,t=this,n=t.callBase;if(t.option("legacyRendering")||!L(t)&&!V(t))e=n.apply(t);else{clearTimeout(t._resizeTimeout);var o=new Date-t._lastTime,i=t.option("scrolling.updateTimeout");t._lastTime&&o<i?(e=new p.Deferred,t._resizeTimeout=setTimeout((function(){n.apply(t).done(e.resolve).fail(e.reject),t._lastTime=new Date}),i),t._lastTime=new Date):(e=n.apply(t),t._dataController.isLoaded()&&(t._lastTime=new Date))}return e},dispose:function(){this.callBase.apply(this,arguments),clearTimeout(this._resizeTimeout)}}},views:{rowsView:W}}}}

