function module(e,t,a){"use strict";var n,i=w(e("../../core/renderer")),r,o=w(e("./ui.grid_core.modules")),s,l=w(e("./ui.grid_core.utils")),d,u=w(e("../../data/array_store")),c,h=w(e("../../data/custom_store")),g,p=w(e("../widget/ui.errors")),f=e("../../core/utils/common"),_=e("../../core/utils/iterator"),m,y=w(e("../../core/utils/type")),C=e("../../core/utils/extend"),v,S=w(e("../../data_helper")),D=e("../../core/utils/deferred"),I=e("../../core/utils/array_compare"),O,x;function w(e){return e&&e.__esModule?e:{default:e}}a.exports={defaultOptions:function(){return{loadingTimeout:0,dataSource:null,cacheEnabled:!0,repaintChangesOnly:!1,highlightChanges:!1,onDataErrorOccurred:null,remoteOperations:"auto",paging:{enabled:!0,pageSize:void 0,pageIndex:void 0}}},controllers:{data:o.default.Controller.inherit({}).include(S.default).inherit((O=function(e,t,a){var n=e._dataSource;return n?void 0!==a?n[t]()!==a?("pageSize"===t&&n.pageIndex(0),n[t](a),e._skipProcessingPagingChange=!0,e.option("paging."+t,a),e._skipProcessingPagingChange=!1,n["pageIndex"===t?"load":"reload"]().done(e.pageChanged.fire.bind(e.pageChanged))):(0,D.Deferred)().resolve().promise():n[t]():0},x={init:function(){var e=this;e._items=[],e._columnsController=e.getController("columns"),e._columnsChangedHandler=e._handleColumnsChanged.bind(e),e._dataChangedHandler=e._handleDataChanged.bind(e),e._loadingChangedHandler=e._handleLoadingChanged.bind(e),e._loadErrorHandler=e._handleLoadError.bind(e),e._customizeStoreLoadOptionsHandler=e._handleCustomizeStoreLoadOptions.bind(e),e._changingHandler=e._handleChanging.bind(e),e._columnsController.columnsChanged.add(e._columnsChangedHandler),e._isLoading=!1,e._isCustomLoading=!1,e._repaintChangesOnly=void 0,e._changes=[],e.createAction("onDataErrorOccurred"),e.dataErrorOccurred.add((function(t){return e.executeAction("onDataErrorOccurred",{error:t})})),e._refreshDataSource()},callbackNames:function(){return["changed","loadingChanged","dataErrorOccurred","pageChanged","dataSourceChanged"]},callbackFlags:function(e){if("dataErrorOccurred"===e)return{stopOnFalse:!0}},publicMethods:function(){return["beginCustomLoading","endCustomLoading","refresh","filter","clearFilter","getCombinedFilter","keyOf","byKey","getDataByKeys","pageIndex","pageSize","pageCount","totalCount","_disposeDataSource","getKeyByRowIndex","getRowIndexByKey","getDataSource","getVisibleRows","repaintRows"]},reset:function(){this._columnsController.reset(),this._items=[],this._refreshDataSource()},optionChanged:function(e){var t,a=this;function n(){e.handled=!0}if("dataSource"===e.name&&e.name===e.fullName&&(e.value===e.previousValue||this.option("columns")&&Array.isArray(e.value)&&Array.isArray(e.previousValue))){if(e.value!==e.previousValue){var i=this.store();i&&(i._array=e.value)}return n(),void this.refresh(this.option("repaintChangesOnly"))}switch(e.name){case"cacheEnabled":case"repaintChangesOnly":case"highlightChanges":case"loadingTimeout":case"remoteOperations":n();break;case"keyExpr":case"dataSource":case"scrolling":n(),this.skipProcessingPagingChange(e.fullName)||this.reset();break;case"paging":(t=this.dataSource())&&this._setPagingOptions(t)&&t.load().done(this.pageChanged.fire.bind(this.pageChanged)),n();break;case"rtlEnabled":this.reset();break;case"columns":(t=this.dataSource())&&t.isLoading()&&e.name===e.fullName&&t.load();break;default:this.callBase(e)}},isReady:function(){return!this._isLoading},getDataSource:function(){return this._dataSource&&this._dataSource._dataSource},getCombinedFilter:function(e){return this.combinedFilter(void 0,e)},combinedFilter:function(e,t){var a,n=this,i=this._dataSource,r=this._columnsController;return i&&(void 0===e&&(e=i.filter()),(a=this._calculateAdditionalFilter())&&(r.isDataSourceApplied()||r.isAllDataTypesDefined())&&(e=l.default.combineFilters([a,e])),e=r.updateFilter(e,t||i.remoteOperations().filtering)),e},waitReady:function(){return this._updateLockCount?(this._readyDeferred=new D.Deferred,this._readyDeferred):(0,D.when)()},_endUpdateCore:function(){var e=this._changes;if(e.length){this._changes=[];var t=e.every((function(e){return e.repaintChangesOnly}));this.updateItems(1===e.length?e[0]:{repaintChangesOnly:t})}this._readyDeferred&&(this._readyDeferred.resolve(),this._readyDeferred=null)},_handleCustomizeStoreLoadOptions:function(e){var t=this._columnsController,a=this._dataSource,n=e.storeLoadOptions;e.isCustomLoading&&!n.isLoadingAll||(n.filter=this.combinedFilter(n.filter),t.isDataSourceApplied()||t.updateColumnDataTypes(a),this._columnsUpdating=!0,t.updateSortingGrouping(a,!this._isFirstLoading),this._columnsUpdating=!1,n.sort=t.getSortDataSourceParameters(),n.group=t.getGroupDataSourceParameters(),a.sort(n.sort),a.group(n.group),n.sort=t.getSortDataSourceParameters(!a.remoteOperations().sorting),e.group=t.getGroupDataSourceParameters(!a.remoteOperations().grouping))},_handleColumnsChanged:function(e){var t,a,n,i=this,r=e.changeTypes,o=e.optionNames,s=function e(){i._columnsController.columnsChanged.remove(e),i.updateItems()};if(r.sorting||r.grouping)i._dataSource&&!i._columnsUpdating&&(i._dataSource.group(i._columnsController.getGroupDataSourceParameters()),i._dataSource.sort(i._columnsController.getSortDataSourceParameters()),i.reload());else if(r.columns&&((o.filterValues||o.filterValue||o.selectedFilterOperation)&&(t=i._columnsController.columnOption(e.columnIndex,"filterValue"),a=i._columnsController.columnOption(e.columnIndex,"filterValues"),(Array.isArray(a)||void 0===e.columnIndex||y.default.isDefined(t)||!o.selectedFilterOperation||o.filterValue)&&(i._applyFilter(),n=!0)),i._needApplyFilter||l.default.checkChanges(o,["width","visibleWidth","filterValue","bufferedFilterValue","selectedFilterOperation","filterValues","filterType"])||i._columnsController.columnsChanged.add(s),y.default.isDefined(o.visible))){var d=i._columnsController.columnOption(e.columnIndex);d&&(y.default.isDefined(d.filterValue)||y.default.isDefined(d.filterValues))&&(i._applyFilter(),n=!0)}!n&&r.filtering&&i.reload()},_handleDataChanged:function(e){var t=this,a=t._dataSource,n=t._columnsController,i=!1;this._isFirstLoading=!1,a&&!t._isDataSourceApplying&&(t._isDataSourceApplying=!0,(0,D.when)(t._columnsController.applyDataSource(a)).done((function(){t._isLoading&&t._handleLoadingChanged(!1),i&&e&&e.isDelayed&&(e.isDelayed=!1),t._isDataSourceApplying=!1;var a=function(){var e=t._calculateAdditionalFilter();return e&&e.length},n=t._needApplyFilter;t._needApplyFilter=!1,n&&!t._isAllDataTypesDefined&&a()?(p.default.log("W1005",t.component.NAME),t._applyFilter()):t.updateItems(e,!0)})).fail((function(){t._isDataSourceApplying=!1})),t._isDataSourceApplying&&(i=!0,t._handleLoadingChanged(!0)),t._needApplyFilter=!t._columnsController.isDataSourceApplied(),t._isAllDataTypesDefined=n.isAllDataTypesDefined())},_handleLoadingChanged:function(e){this._isLoading=e,this._fireLoadingChanged()},_handleLoadError:function(e){this.dataErrorOccurred.fire(e)},fireError:function(){this.dataErrorOccurred.fire(p.default.Error.apply(p.default,arguments))},_setPagingOptions:function(e){var t=this.option("paging.pageIndex"),a=this.option("paging.pageSize"),n=this.option("paging.enabled"),i=this.option("scrolling.mode"),r="infinite"===i,o,s=n||"virtual"===i||r,l=!1;return e.requireTotalCount(!r),void 0!==n&&e.paginate()!==s&&(e.paginate(s),l=!0),void 0!==a&&e.pageSize()!==a&&(e.pageSize(a),l=!0),void 0!==t&&e.pageIndex()!==t&&(e.pageIndex(t),l=!0),l},_getSpecificDataSourceOption:function(){var e=this.option("dataSource");return Array.isArray(e)?{store:{type:"array",data:e,key:this.option("keyExpr")}}:e},_initDataSource:function(){var e=this,t=this.option("dataSource"),a=this._dataSource;this.callBase(),t=this._dataSource,this._isFirstLoading=!0,t?(this._setPagingOptions(t),this.setDataSource(t)):a&&this.updateItems()},_loadDataSource:function(){var e=this,t=this._dataSource,a=new D.Deferred;return(0,D.when)(this._columnsController.refresh(!0)).always((function(){t?t.load().done(a.resolve).fail(a.reject):a.resolve()})),a.promise()},_beforeProcessItems:function(e){return e.slice(0)},getRowIndexDelta:function(){return 0},_processItems:function(e,t){var a=this,n=a.getRowIndexDelta(),i=a._columnsController.getVisibleColumns(null,"loadingAll"===t),r=a._items,o,s={visibleColumns:i,dataIndex:"append"===t&&r.length>0?r[r.length-1].dataIndex+1:0},l=[];return(0,_.each)(e,(function(e,t){y.default.isDefined(t)&&(s.rowIndex=e-n,t=a._processItem(t,s),l.push(t))})),l},_processItem:function(e,t){return e=this._generateDataItem(e,t),(e=this._processDataItem(e,t)).dataIndex=t.dataIndex++,e},_generateDataItem:function(e){return{rowType:"data",data:e,key:this.keyOf(e)}},_processDataItem:function(e,t){return e.values=this.generateDataValues(e.data,t.visibleColumns),e},generateDataValues:function(e,t,a){for(var n,i,r=[],o=0;o<t.length;o++)i=a?void 0:null,(n=t[o]).command||(n.calculateCellValue?i=n.calculateCellValue(e):n.dataField&&(i=e[n.dataField])),r.push(i);return r},_applyChange:function(e){var t=this;"update"===e.changeType?this._applyChangeUpdate(e):this.items().length&&e.repaintChangesOnly&&"refresh"===e.changeType?this._applyChangesOnly(e):"refresh"===e.changeType&&this._applyChangeFull(e)},_applyChangeFull:function(e){this._items=e.items.slice(0)},_applyChangeUpdate:function(e){var t,a=this,n=e.items,i=e.rowIndices.slice(0),r=a.getRowIndexDelta(),o=a.option("repaintChangesOnly"),s=-1,l=0;i.sort((function(e,t){return e-t}));for(var d=0;d<i.length;d++)i[d]<0&&(i.splice(d,1),d--);e.items=[],e.rowIndices=[],e.columnIndices=[],e.changeTypes=[];var u=function(e,t,a){var n=e&&t&&(0,f.equalByValue)(e.key,t.key);return n&&a&&(n=e.rowType===t.rowType&&("detail"!==t.rowType||e.isEditing===t.isEditing)),n};(0,_.each)(i,(function(i,d){var c,h,g,p,f,_;if(s!==(d+=l+r)){if(s=d,c=a._items[d],g=a._items[d+1],h=n[d],p=n[d+1],f=u(c,g)||u(h,p),h&&(h.rowIndex=d,e.items.push(h)),c&&h&&u(c,h,f))t="update",a._items[d]=h,c.visible!==h.visible?e.items.splice(-1,1,{visible:h.visible}):o&&!e.isFullUpdate&&(h.cells=c.cells,_=a._getChangedColumnIndices(c,h,d));else if(h&&!c||p&&u(c,p,f))t="insert",a._items.splice(d,0,h),l++;else if(c&&!h||g&&u(h,g,f))t="remove",a._items.splice(d,1),l--,s=-1;else{if(!h)return;t="update",a._items[d]=h}e.rowIndices.push(d-r),e.changeTypes.push(t),e.columnIndices.push(_)}}))},_isCellChanged:function(e,t,a,n,i){if(JSON.stringify(e.values[n])!==JSON.stringify(t.values[n]))return!0;function r(e,t){return!!e.modifiedValues&&void 0!==e.modifiedValues[t]}return r(e,n)!==r(t,n)},_getChangedColumnIndices:function(e,t,a,n){if(e.rowType===t.rowType&&"group"!==t.rowType&&"groupFooter"!==t.rowType){for(var i=[],r=0;r<e.values.length;r++)if(this._isCellChanged(e,t,a,r,n))i.push(r);else{var o=e.cells&&e.cells[r];o&&o.update&&o.update(t)}return e.update&&e.update(t),i}},_applyChangesOnly:function(e){var t=this,a=[],n=[],i=[],r=[],o={};function s(e){if(e)return e.rowType+","+JSON.stringify(e.key)}function l(e,t){return JSON.stringify(e.values)===JSON.stringify(t.values)&&e.modified===t.modified&&e.inserted===t.inserted&&e.removed===t.removed&&("group"!==e.rowType&&"groupFooter"!==e.rowType||e.isExpanded===t.isExpanded&&JSON.stringify(e.summaryCells)===JSON.stringify(t.summaryCells))&&(e.cells&&(e.update&&e.update(t),e.cells.forEach((function(e){e&&e.update&&e.update(t)}))),!0)}var d=this._items.slice();e.items.forEach((function(e,t){var a=s(e);o[a]=t,e.rowIndex=t}));var u=(0,I.findChanges)(d,e.items,s,l);u?(u.forEach((function(e){switch(e.type){case"update":var o=e.index,s=e.data,l=e.oldItem,d=t._getChangedColumnIndices(l,s,o,!0);a.push(o),i.push("update"),r.push(s),t._items[o]=s,s.cells=l.cells,s.oldValues=l.values,n.push(d);break;case"insert":a.push(e.index),i.push("insert"),r.push(e.data),n.push(void 0),t._items.splice(e.index,0,e.data);break;case"remove":a.push(e.index),i.push("remove"),t._items.splice(e.index,1),r.push(e.oldItem),n.push(void 0)}})),e.repaintChangesOnly=!0,e.changeType="update",e.rowIndices=a,e.columnIndices=n,e.changeTypes=i,e.items=r,d.length&&(e.isLiveUpdate=!0),this._correctRowIndices((function(e){var t,a=s(d[e]),n=o[a];return n>=0?n-e:0}))):this._applyChangeFull(e)},_correctRowIndices:f.noop,_updateItemsCore:function(e){var t,a,n=this,i=this._dataSource,r=e.changeType||"refresh";e.changeType=r,i?(t=e.items||i.items(),t=this._beforeProcessItems(t),t=this._processItems(t,r),e.items=t,a=this._items.length===t.length&&this._items,this._applyChange(e),(0,_.each)(this._items,(function(e,t){t.rowIndex=e,a&&(t.cells=a[e].cells)}))):this._items=[]},_handleChanging:function(e){var t=this,a=this.getVisibleRows(),n;this.dataSource()&&e.changes.forEach((function(e){if("insert"===e.type&&e.index>=0){for(var t,n=0,i=0;i<e.index;i++)!(t=a[i])||"data"!==t.rowType&&"group"!==t.rowType||n++;e.index=n}}))},updateItems:function(e,t){e=e||{};var a=this;if(void 0!==this._repaintChangesOnly)e.repaintChangesOnly=this._repaintChangesOnly;else if(e.changes)e.repaintChangesOnly=this.option("repaintChangesOnly");else if(t){var n=this.dataSource().operationTypes();e.repaintChangesOnly=n&&!n.grouping&&!n.filtering&&this.option("repaintChangesOnly"),e.isDataChanged=!0,n&&(n.reload||n.paging||n.groupExpanding)&&(e.needUpdateDimensions=!0)}this._updateLockCount?this._changes.push(e):(this._updateItemsCore(e),e.cancel||this._fireChanged(e))},_fireChanged:function(e){var t=this;(0,f.deferRender)((function(){t.changed.fire(e)}))},isLoading:function(){return this._isLoading||this._isCustomLoading},_fireLoadingChanged:function(){this.loadingChanged.fire(this.isLoading(),this._loadingText)},_calculateAdditionalFilter:function(){return null},_applyFilter:function(){var e=this,t=this._dataSource;if(t)return t.pageIndex(0),this.reload().done(this.pageChanged.fire.bind(this.pageChanged))},filter:function e(t){var a=this._dataSource,e=a.filter();if(0===arguments.length)return a?a.filter():void 0;t=arguments.length>1?Array.prototype.slice.call(arguments,0):t,l.default.equalFilterParameters(e,t)||(a&&a.filter(t),this._applyFilter())},clearFilter:function(e){var t=this,a=t._columnsController,n=function(e){var t,n=a.columnCount();for(t=0;t<n;t++)a.columnOption(t,e,void 0)};if(t.component.beginUpdate(),arguments.length>0)switch(e){case"dataSource":t.filter(null);break;case"search":t.searchByText("");break;case"header":n("filterValues");break;case"row":n("filterValue")}else t.filter(null),t.searchByText(""),n("filterValue"),n("filterValues");t.component.endUpdate()},_fireDataSourceChanged:function(){var e=this,t=function t(){e.changed.remove(t),e.dataSourceChanged.fire()};e.changed.add(t)},_getDataSourceAdapter:f.noop,_createDataSourceAdapterCore:function(e,t){var a,n=this._getDataSourceAdapter().create(this.component);return n.init(e,t),n},isLocalStore:function(e){return(e=e||this.store())instanceof u.default},isCustomStore:function(e){return(e=e||this.store())instanceof h.default},_createDataSourceAdapter:function(e){var t=this.option("remoteOperations"),a=e.store(),n={filtering:!0,sorting:!0,paging:!0,grouping:!0,summary:!0};return t&&t.groupPaging&&(t=(0,C.extend)({},n,t)),"auto"===t&&(t=this.isLocalStore(a)||this.isCustomStore(a)?{}:{filtering:!0,sorting:!0,paging:!0}),!0===t&&(t=n),this._createDataSourceAdapterCore(e,t)},setDataSource:function(e){var t=this,a=this._dataSource;!e&&a&&(a.changed.remove(this._dataChangedHandler),a.loadingChanged.remove(this._loadingChangedHandler),a.loadError.remove(this._loadErrorHandler),a.customizeStoreLoadOptions.remove(this._customizeStoreLoadOptionsHandler),a.changing.remove(this._changingHandler),a.cancelAll(),a.dispose(this._isSharedDataSource)),e&&(e=this._createDataSourceAdapter(e)),this._dataSource=e,e&&(this._fireDataSourceChanged(),this._isLoading=!e.isLoaded(),this._needApplyFilter=!0,this._isAllDataTypesDefined=this._columnsController.isAllDataTypesDefined(),e.changed.add(this._dataChangedHandler),e.loadingChanged.add(this._loadingChangedHandler),e.loadError.add(this._loadErrorHandler),e.customizeStoreLoadOptions.add(this._customizeStoreLoadOptionsHandler),e.changing.add(this._changingHandler))},items:function(){return this._items},isEmpty:function(){return!this.items().length},pageCount:function(){return this._dataSource?this._dataSource.pageCount():1},dataSource:function(){return this._dataSource},store:function(){var e=this._dataSource;return e&&e.store()},loadAll:function(e){var t=this,a=new D.Deferred,n=t._dataSource;if(n)if(e){var i={data:e,isCustomLoading:!0,storeLoadOptions:{isLoadingAll:!0},loadOptions:{filter:t.getCombinedFilter(),group:n.group(),sort:n.sort()}};n._handleDataLoaded(i),(0,D.when)(i.data).done((function(e){e=t._beforeProcessItems(e),a.resolve(t._processItems(e,"loadingAll"),i.extra&&i.extra.summary)})).fail(a.reject)}else if(n.isLoading())a.reject();else{var r=(0,C.extend)({},n.loadOptions(),{isLoadingAll:!0,requireTotalCount:!1});n.load(r).done((function(e,n){e=t._beforeProcessItems(e),e=t._processItems(e,"loadingAll"),a.resolve(e,n&&n.summary)})).fail(a.reject)}else a.resolve([]);return a},getKeyByRowIndex:function(e){var t=this.items()[e];if(t)return t.key},getRowIndexByKey:function(e){return l.default.getIndexByKey(e,this.items())},keyOf:function(e){var t=this.store();if(t)return t.keyOf(e)},byKey:function(e){var t,a=this.store(),n=this.getRowIndexByKey(e);if(a)return n>=0&&(t=(new D.Deferred).resolve(this.items()[n].data)),t||a.byKey(e)},key:function(){var e=this.store();if(e)return e.key()},getRowIndexOffset:function(){return 0},getDataByKeys:function(e){var t=this,a=new D.Deferred,n=[],r=[];return(0,_.each)(e,(function(e,a){n.push(t.byKey(a).done((function(t){r[e]=t})))})),D.when.apply(i.default,n).always((function(){a.resolve(r)})),a},pageIndex:function(e){return O(this,"pageIndex",e)},pageSize:function(e){return O(this,"pageSize",e)},beginCustomLoading:function(e){this._isCustomLoading=!0,this._loadingText=e||"",this._fireLoadingChanged()},endCustomLoading:function(){this._isCustomLoading=!1,this._loadingText=void 0,this._fireLoadingChanged()},refresh:function(e){!0===e?e={reload:!0,changesOnly:!0}:e||(e={lookup:!0,selection:!0,reload:!0});var t=this,a=t.getDataSource(),n=e.changesOnly,i=new D.Deferred,r=function(){t._repaintChangesOnly=!!n};return(0,D.when)(!e.lookup||t._columnsController.refresh()).always((function(){e.load||e.reload?(a&&a.on("customizeLoadResult",r),(0,D.when)(t.reload(e.reload,n)).always((function(){a&&a.off("customizeLoadResult",r),t._repaintChangesOnly=void 0})).done(i.resolve).fail(i.reject)):(t.updateItems({repaintChangesOnly:e.changesOnly}),i.resolve())})),i.promise()},getVisibleRows:function(){return this.items()},_disposeDataSource:function(){this.setDataSource(null)},repaintRows:function(e,t){((e=Array.isArray(e)?e:[e]).length>1||y.default.isDefined(e[0]))&&this.updateItems({changeType:"update",rowIndices:e,isFullUpdate:!t})},skipProcessingPagingChange:function(e){return this._skipProcessingPagingChange&&("paging.pageIndex"===e||"paging.pageSize"===e)},getUserState:function(){return{searchText:this.option("searchPanel.text"),pageIndex:this.pageIndex(),pageSize:this.pageSize()}},getCachedStoreData:function(){return this._dataSource&&this._dataSource.getCachedStoreData()}},l.default.proxyMethod(x,"load"),l.default.proxyMethod(x,"reload"),l.default.proxyMethod(x,"push"),l.default.proxyMethod(x,"itemsCount",0),l.default.proxyMethod(x,"totalItemsCount",0),l.default.proxyMethod(x,"hasKnownLastPage",!0),l.default.proxyMethod(x,"isLoaded",!0),l.default.proxyMethod(x,"totalCount",0),x))}}}

