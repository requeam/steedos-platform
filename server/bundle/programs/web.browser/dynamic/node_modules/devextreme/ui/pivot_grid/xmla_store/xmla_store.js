function module(e,r){"use strict";var n=e("../../../core/renderer"),t=e("../../../core/utils/window").getWindow(),a=e("../../../core/class"),i=e("../../../core/utils/string").format,l=e("../../../data/errors").errors,o=e("../../../core/utils/common").noop,s=e("../../../core/utils/type"),u=e("../../../core/utils/iterator"),c=e("../../../core/utils/array").inArray,h=e("../ui.pivot_grid.utils"),d=e("../../../core/utils/deferred"),m=d.when,g=d.Deferred,p=e("../../../localization/language_codes").getLanguageId;r.XmlaStore=a.inherit(function(){var e='<Envelope xmlns="http://schemas.xmlsoap.org/soap/envelope/"><Body><Discover xmlns="urn:schemas-microsoft-com:xml-analysis"><RequestType>{2}</RequestType><Restrictions><RestrictionList><CATALOG_NAME>{0}</CATALOG_NAME><CUBE_NAME>{1}</CUBE_NAME></RestrictionList></Restrictions><Properties><PropertyList><Catalog>{0}</Catalog>{3}</PropertyList></Properties></Discover></Body></Envelope>',r='<Envelope xmlns="http://schemas.xmlsoap.org/soap/envelope/"><Body><Execute xmlns="urn:schemas-microsoft-com:xml-analysis"><Command><Statement>{0}</Statement></Command><Properties><PropertyList><Catalog>{1}</Catalog><ShowHiddenCubes>True</ShowHiddenCubes><SspropInitAppName>Microsoft SQL Server Management Studio</SspropInitAppName><Timeout>3600</Timeout>{2}</PropertyList></Properties></Execute></Body></Envelope>',a="SELECT {2} FROM {0} {1} CELL PROPERTIES VALUE, FORMAT_STRING, LANGUAGE, BACK_COLOR, FORE_COLOR, FONT_FLAGS",d="(SELECT {0} FROM {1})",E="{0} {1} as {2}",N="WHERE ({0})",f="NonEmpty({0}, {1})",v="{0} DIMENSION PROPERTIES PARENT_UNIQUE_NAME,HIERARCHY_UNIQUE_NAME, MEMBER_VALUE ON {1}",y="CrossJoin({0})",A="{{0}}",T=u.each,M="DX_MEASURES",_="2";function x(e,r){var n=new g,a=e.beforeSend,i={url:e.url,dataType:"text",data:r,headers:{"Content-Type":"text/xml"},xhrFields:{},method:"POST"};return s.isFunction(a)&&a(i),h.sendRequest(i).fail((function(){n.reject(arguments)})).done((function(e){var r=new t.DOMParser,a;try{try{a=r.parseFromString(e,"text/xml")}catch(i){a=void 0}if(!a||a.getElementsByTagName("parsererror").length||0===a.childNodes.length)throw new l.Error("E4023",e)}catch(i){n.reject({statusText:i.message,stack:i.stack,responseText:e})}n.resolve(a)})),n}function S(){var e=p();return void 0!==e?i("<LocaleIdentifier>{0}</LocaleIdentifier>",e):""}function I(e,r,n){var t;return"Descendants({"+(r||e)+"}, "+n+", SELF_AND_BEFORE)"}function R(e){return(e.hierarchyName||e.dataField)+".[All]"}function C(e){return e.dataField+".allMembers"}function L(e){var r=e.join(",");return e.length>1?i(y,r):r}function F(e){var r=e.join(",");return e.length>1?"Union("+r+")":r}function O(e,r,n,t,a,l,o){var s,u,c,h,d,m,g,p,E,N,f,v,y=[],T=l[o],M=[];for(v=t;v<=r;v++)s=(N=T[v]).dataField,m=T[v-1]&&T[v-1].hierarchyName,g=!(c=N.hierarchyName)||!T[v+1]||T[v+1].hierarchyName!==c,E=e.length+n+t,h=null,M.push(N),v<e.length?g&&(h="("+s+"."+J(e[v],s)+")"):v<=E?0===v&&0===n?(u=R(T[t]),h=c?u+","+T[t].dataField:C(T[t])):c?(f=J(a[a.length-1]),(g||v===E)&&(m===c?(a.length&&(d=T[a.length-1]),d&&d.hierarchyName===c||(d=T[v-1],f=""),h=I(d.dataField,f,s)):h=C(N))):h=C(N):(p=!c||m!==c)&&(h="("+R(N)+")"),h&&(h=i(A,h),y.push(h));return L(y)}function U(e,r,n,t,a,l,o,s){var u,c=-1,h=l[o];do{c++,u=r.length+c+t,e.push(i(f,O(r,n,c,t,a,l,o),s))}while(h[u]&&h[u+1]&&h[u].expanded)}function w(e,r,n,t){return n=n||"[DX_Set_"+r.length+"]",t=t||"set",r.push(i(E,t,n,e)),n}function D(e,r,n,t,a){var l=e[r],o=[],s=[],u=[],c=0,d=0,m=[],g=i(A,n.join(","));if(l&&l.length){e.headerName===r?(s=e.path,c=s.length):u=("columns"===r?e.columnExpandedPaths:e.rowExpandedPaths)||u,d=h.getExpandedLevel(e,r),U(o,[],d,c,s,e,r,g),T(u,(function(n,t){U(o,t,d,c,t,e,r,g)}));for(var p=d;p>=s.length;p--)l[p].hierarchyName&&(a.visibleLevels[l[p].hierarchyName]=a.visibleLevels[l[p].hierarchyName]||[],a.visibleLevels[l[p].hierarchyName].push(l[p].dataField))}return o.length&&m.push(w(F(o),t,"[DX_"+r+"]")),"columns"===r&&n.length&&!e.skipValues&&m.push(g),i(v,L(m),r)}function H(e){var r=[];return T(e,(function(e,n){var t,a=n.dataField,l=[],o=n.filterValues||[];n.hierarchyName&&s.isNumeric(n.groupIndex)||(T(o,(function(e,r){var t=a+"."+J(Array.isArray(r)?r[r.length-1]:r,a);"exclude"===n.filterType&&(l.push(t+".parent"),t="Descendants("+t+")"),l.push(t)})),o.length&&(t=i(A,l.join(",")),"exclude"===n.filterType&&(t="Except("+C(n)+","+t+")"),r.push(t)))})),r.length?L(r):""}function P(e,r,n,t){var a="["+t+"]";return T([e,r,n],(function(e,r){r&&(a=i(d,r+"on 0",a))})),a}function B(e,r,n,t,l,o,s){var u="",c=(r.length?"with "+r.join(" "):"")+" ";return e.length&&(u=c+i(a,P(H(n),H(t),H(l||[]),s),o.length?i(N,o.join(",")):"",e.join(","))),u}function b(e,r){return u.map(r,(function(r){return s.isString(r.expression)&&w(r.expression,e,r.dataField,"member"),r.dataField}))}function j(e,r,n){var t=e.columns||[],a=e.rows||[],i=e.values&&e.values.length?e.values:[{dataField:"[Measures]"}],l=[],o=[],s=[],u=b(o,i);return n.measureCount=e.skipValues?1:i.length,n.visibleLevels={},e.headerName&&e.path&&T(e.path,(function(r,n){var t=e[e.headerName][r];t.hierarchyName&&t.hierarchyName===e[e.headerName][r+1].hierarchyName||l.push(t.dataField+"."+J(n,t.dataField))})),(t.length||u.length)&&s.push(D(e,"columns",u,o,n)),a.length&&s.push(D(e,"rows",u,o,n)),B(s,o,t,a,e.filters,l,r)}function V(e,r,n){T(n,(function(n,t){var a=r[n];a.hierarchyName&&(r[n+1]||{}).hierarchyName===a.hierarchyName||e.push(a.dataField+"."+J(t,a.dataField))}))}function k(e,r,n){var t,a=e.columns||[],i=e.rows||[],l,o=[],s=[],u=[],c=b(s,e.values&&e.values.length?e.values:[{dataField:"[Measures]"}]),h=n.maxRowCount,d=n.customColumns||[],m=d.length>0?" return "+d.join(","):"";return V(o,a,n.columnPath||[]),V(o,i,n.rowPath||[]),(a.length||a.length||c.length)&&u.push([(c[n.dataIndex]||c[0])+" on 0"]),(t=B(u,s,a,i,e.filters,o,r))?"drillthrough"+(h>0?" maxrows "+h:"")+t+m:t}function G(e){return parseInt(e,10)}function Q(e){return s.isNumeric(e)?parseFloat(e):e}function Y(e,r){return(e.getElementsByTagName(r)||[])[0]}function X(e,r){return W(Y(e,r))}function q(e,r){var n=[];for(T(e.getElementsByTagName("Axis"),(function(e,t){var a=t.getAttribute("name"),i=[],l=0;0===a.indexOf("Axis")&&s.isNumeric(G(a.substr(4)))&&(n.push(i),T(t.getElementsByTagName("Tuple"),(function(e,t){var a,o,s,u=t.childNodes,c=0,h=[],d=r?u.length:u.length-1,m;for(1===n.length&&d--,i.push(h),s=d;s>=0;s--)o=G(X(a=u[s],"LNum")),h[s]={caption:X(a,"Caption"),value:Q(X(a,"MEMBER_VALUE")),level:o,index:l++,hasValue:!(c||!o&&0!==s),name:X(a,"UName"),hierarchyName:u[s].getAttribute("Hierarchy"),parentName:X(a,"PARENT_UNIQUE_NAME"),levelName:X(a,"LName")},c+=o})))}));n.length<2;)n.push([[{level:0}]]);return n}function W(e){return e&&e&&(e.textContent||e.text||e.innerHTML)||""}function z(e,r,n){for(var t,a,i=[],o=[],s=0,u=[],c=e.getElementsByTagName("Cell"),h={},d=0;d<c.length;d++){var m=c[d],g=m.getElementsByTagName("Value")[0],p=g&&g.getElementsByTagName("Error")||[],E=0===p.length?W(g):"#N/A",N=parseFloat(E),f=E-N+1>0,v=G(m.getAttribute("CellOrdinal"));p.length&&(h[W(p[0].getElementsByTagName("ErrorCode")[0])]=W(p[0].getElementsByTagName("Description")[0])),u[v]={value:f?N:E||null}}return T(r[1],(function(){a=[],i.push(a),T(r[0],(function(){0===(t=s%n)&&(o=[],a.push(o)),o.push(u[s]?u[s].value:null),s++}))})),Object.keys(h).forEach((function(e){l.log("W4002",h[e])})),i}function J(e,r){return e&&(e=s.isString(e)&&-1!==e.indexOf("&")?e:"["+e+"]",r&&0===e.indexOf(r+".")&&(e=e.slice(r.length+1,e.length))),e}function K(e,r,n,t){var a=e[r];return a||(a={},e[r]=a),!s.isDefined(a.value)&&n&&(a.text=n.caption,a.value=n.value,a.key=r||"",a.levelName=n.levelName,a.hierarchyName=n.hierarchyName,a.parentName=n.parentName,a.index=t,a.level=n.level),a}function $(e,r){var n=[],t=e.children&&(e.children.length?e.children:Object.keys(e.children.grandTotalHash||{}).reduce((function(r,n){return r.concat(e.children.grandTotalHash[n].children)}),[])),a=t&&t[0];if(a&&(r[a.hierarchyName]&&-1!==c(a.levelName,r[a.hierarchyName])||!r[a.hierarchyName]||0===a.level)){var i=t.filter((function(e){return e.hierarchyName===a.hierarchyName}));return i.grandTotalHash=t.grandTotalHash,i}if(a)for(var l=0;l<t.length;l++)t[l].hierarchyName===a.hierarchyName&&n.push.apply(n,$(t[l],r));return n}function Z(e,r,n){var t,a=n.children=n.children||[],i=a.hash=a.hash||{},l=a.grandTotalHash=a.grandTotalHash||{};return r.parentName&&(a=(n=K(i,r.parentName)).children=n.children||[]),t=K(i,r.name,r,e),r.hasValue&&!t.added&&(t.index=e,t.added=!0,a.push(t)),n.value&&n.parentName||!r.parentName?l[n.name]&&delete l[r.parentName]:l[r.parentName]=n,t}function ee(e,r){var n;if(1===e.children.length&&""===e.children[0].parentName){n=e.children[0].index;var t=e.children.grandTotalHash;e.children=e.children[0].children||[],e.children.grandTotalHash=t,e.children=$(e,r)}else 0===e.children.length&&(n=0);return n}function re(e,r,n,t){var a,i=[];T(r,(function(e,r){var t={children:i},a=s.isDefined(n)?Math.floor(e/n):e;T(r,(function(e,r){t=Z(a,r,t)}))}));var l={children:i};return l.children=$(l,t),a=ee(l,t),h.foreachTree(l.children,(function(e){var r=e[0],n=$(r,t);n.length?r.children=n:delete r.children,delete r.levelName,delete r.hierarchyName,delete r.added,delete r.parentName,delete r.level}),!0),T(l.children||[],(function(r,n){e.push(n)})),a}function ne(e){var r,t,a=e.getElementsByTagName("soap:Fault"),i=e.getElementsByTagName("Fault"),o=n([].slice.call(i.length?i:a)).find("Error");return o.length?(r=o.attr("Description"),t=new l.Error("E4000",r),l.log("E4000",r),t):null}function te(e,r){var n,t={columns:[],rows:[]},a=r.measureCount;return n=q(e,r.skipValues),t.grandTotalColumnIndex=re(t.columns,n[0],a,r.visibleLevels),t.grandTotalRowIndex=re(t.rows,n[1],void 0,r.visibleLevels),t.values=z(e,n,a),t}function ae(e,r,n,t){var a=[],i="MEASURE"===r,l=i?"MEASUREGROUP_NAME":r+"_DISPLAY_FOLDER";return T(e.getElementsByTagName("row"),(function(e,o){var s="LEVEL"===r?X(o,"HIERARCHY_UNIQUE_NAME"):void 0,u=X(o,"LEVEL_NUMBER"),c=X(o,l);if(i&&(c=t[c]||c),("0"!==u||"true"!==X(o,r+"_IS_VISIBLE"))&&X(o,"DIMENSION_TYPE")!==_){var h=i?M:X(o,"DIMENSION_UNIQUE_NAME"),d=X(o,r+"_UNIQUE_NAME");a.push({dimension:n.names[h]||h,groupIndex:u?G(u)-1:void 0,dataField:d,caption:X(o,r+"_CAPTION"),hierarchyName:s,groupName:s,displayFolder:c,isMeasure:i,isDefault:!!n.defaultHierarchies[d]})}})),a}function ie(e){var r={};return T(e.getElementsByTagName("row"),(function(e,n){r[X(n,"MEASUREGROUP_NAME")]=X(n,"MEASUREGROUP_CAPTION")})),r}function le(e){var r={names:{},defaultHierarchies:{}};return T(n(e).find("row"),(function(){var e=n(this),t,a=e.children("DIMENSION_TYPE").text()===_?M:e.children("DIMENSION_UNIQUE_NAME").text();r.names[a]=e.children("DIMENSION_CAPTION").text(),r.defaultHierarchies[e.children("DEFAULT_HIERARCHY").text()]=!0})),r}function oe(e){var r=(e=e.replace(/_x(....)_/g,(function(e,r){return String.fromCharCode(parseInt(r,16))}))).match(/\[.+?\]/gi);return r&&r.length&&(e=r[r.length-1]),e.replace(/\[/gi,"").replace(/\]/gi,"").replace(/\$/gi,"").replace(/\./gi," ")}function se(e){for(var r=e.getElementsByTagName("row"),n=[],t={},a=0;a<r.length;a++){for(var i=r[a].childNodes,l={},o=0;o<i.length;o++){var s=i[o].tagName,u;l[t[s]=t[s]||oe(s)]=W(i[o])}n.push(l)}return n}function ue(e,t){return t=n("<div>").text(t).html(),x(e,i(r,t,e.catalog,S()))}return{ctor:function(e){this._options=e},getFields:function(){var r=this._options,n=r.catalog,t=r.cube,a=S(),l=x(r,i(e,n,t,"MDSCHEMA_DIMENSIONS",a)),o=x(r,i(e,n,t,"MDSCHEMA_MEASURES",a)),s=x(r,i(e,n,t,"MDSCHEMA_HIERARCHIES",a)),u=x(r,i(e,n,t,"MDSCHEMA_LEVELS",a)),c=new g;return m(l,o,s,u).then((function(l,o,s,u){x(r,i(e,n,t,"MDSCHEMA_MEASUREGROUPS",a)).done((function(e){var r=le(l),n=ae(s,"HIERARCHY",r),t=ae(u,"LEVEL",r),a=ie(e),i=ae(o,"MEASURE",r,a).concat(n),h={};T(t,(function(e,r){h[r.hierarchyName]=h[r.hierarchyName]||[],h[r.hierarchyName].push(r)})),T(n,(function(e,r){h[r.dataField]&&h[r.dataField].length>1&&(r.groupName=r.hierarchyName=r.dataField,i.push.apply(i,h[r.hierarchyName]))})),c.resolve(i)})).fail(c.reject)})).fail(c.reject),c},load:function(e){var r=new g,n=this._options,t={skipValues:e.skipValues},a=j(e,n.cube,t);return a?m(ue(n,a)).done((function(e){var n=ne(e);n?r.reject(n):r.resolve(te(e,t))})).fail(r.reject):r.resolve({columns:[],rows:[],values:[],grandTotalColumnIndex:0,grandTotalRowIndex:0}),r},supportSorting:function(){return!0},getDrillDownItems:function(e,r){var n=new g,t=this._options,a=k(e,t.cube,r);return a?m(ue(t,a)).done((function(e){var r=ne(e);r?n.reject(r):n.resolve(se(e))})).fail(n.reject):n.resolve([]),n},key:o,filter:o}}()).include(h.storeDrillDownMixin)}

