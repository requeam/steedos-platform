function module(t,o){"use strict";var e=t("../../core/utils/extend"),n=t("../../core/utils/iterator"),i=t("./ui.data_grid.core"),r=t("./ui.data_grid.grouping.core"),a=t("./ui.data_grid.utils"),s,u=g(t("../widget/ui.errors")),p=t("../../data/errors"),l=t("../../core/utils/deferred");function g(t){return t&&t.__esModule?t:{default:t}}o.GroupingHelper=r.GroupingHelper.inherit(function(){var t=function(t,o,e){return t.foreachGroups((function(t,e){if(t.isExpanded)return o(t,e)}),!0,!1,e,e)},o=function t(o,e,n,i,r,a,s){var u,p,l,g;if(i.items=i.items||[],i.paths=i.paths||[],i.count=i.count||0,i.lastCount=i.lastCount||0,n)for(u=0;u<e.length;u++)void 0!==(p=e[u]).items&&(r.push(p.key),(g=!!a||(l=o.findGroupInfo(r))&&l.isExpanded)?p.items?t(o,p.items,n-1,i,r,a,s):1!==n||!p.count||a&&!s||(i.items.push(p),i.paths.push(r.slice(0)),i.count+=i.lastCount,i.lastCount=p.count):(p.collapsedItems=p.items,p.items=null),r.pop())},s=function(t,o,e,n,i){var r,a=t.findGroupInfo(n);a?(e?a.count=o.count>0?o.count:o.items&&o.items.length||0:o.count=a.count||o.count,a.offset=i):(e&&(r=o.count>0?o.count:o.items.length),t.addGroupInfo({isExpanded:t._isGroupExpanded(n.length-1),path:n.slice(0),offset:i,count:r||0}))},g=function t(o,e,n,i,r,a,u){var p,l,g,c,h=(e.group?e.group.length:0)===i,d,f=0,k=0;if(r=r||0,a=a||[],e.remoteOperations.paging&&!u&&(f=0===r?e.skip||0:e.skips[r-1]||0),r>=i)return n.length;for(g=0;g<n.length;g++)if(p=n[g]){if(a.push(p.key),!p.count&&!p.items||void 0===p.items)return-1;if(s(o,p,h,a,f+g),(l=p.items?t(o,e,p.items,i,r+1,a,g):p.count||-1)<0)return-1;k+=l,a.pop()}return k},c=function(t,o){return t&&t.length&&t[o]&&!!t[o].isExpanded},h=function(t,o,e){var n,i,r=e;for(n=0;n<t.length;n++)i=t[n].offset+1,n>0&&(i+=t[n-1].childrenTotalCount,o&&(i+=d(r,o,i,n-1)*n)),r+=i;return r},d=function(t,o,e,n){if(n=n||0,o>1&&e>0){var i=t-Math.floor(t/o)*o||o;return(i+=e-n-2)<0&&(i+=o),Math.floor(i/(o-n-1))}return 0};function f(t,o,e,n){var i=o.items[n],r=t.skips&&t.skips[e],a=t.takes&&t.takes[e],s=n===o.items.length-1,u=0===n,p=u&&r||0,l=i.count>a+p;u&&void 0!==r&&(i.isContinuation=!0),s&&void 0!==a&&l&&(i.isContinuationOnNextPage=!0)}function k(t,o,e){var n=e-1,i=t.group?t.group.length:0;o.skip=t.skips&&t.skips[n],t.takes&&void 0!==t.takes[n]&&(o.take=i===e&&o.count?o.count-(o.skip||0):0,o.take+=t.takes[n])}function m(t){return!Array.isArray(t)}function C(t){m(t.data)||(t.data=new l.Deferred)}function v(t,e,n,i,r,a){e.isCustomLoading||(o(t,a,n,i={},[]),k(e,i,n));var s=e.group?e.group.length:0;i.paths.length&&s-n>0?(C(e),L(t,e,i,n,r,a)):i.paths.length&&e.storeLoadOptions.group?(C(e),O(t,e,i,a)):m(e.data)&&e.data.resolve(a)}function L(t,o,e,i,r,s){var u=o.group||[],p=u[r+1],c=[];(0,n.each)(e.paths,(function(n){var i={requireTotalCount:!1,requireGroupCount:!0,group:[p],groupSummary:o.storeLoadOptions.groupSummary,filter:(0,a.createGroupFilter)(e.paths[n],{filter:o.storeLoadOptions.filter,group:u})};0===n&&(i.skip=e.skip||0),n===e.paths.length-1&&(i.take=e.take);var s=0===i.take?[]:t._dataSource.loadFromStore(i);(0,l.when)(s).done((function(t){var i=e.items[n];f(o,e,r,n),i.items=t})),c.push(s)})),l.when.apply(null,c).done((function(){g(t,o,s,i+1),v(t,o,i+1,e,r+1,s)}))}function O(t,o,r,s){var u=[],p=o.group||[];(0,n.each)(r.paths,(function(t,e){u.push((0,a.createGroupFilter)(e,{group:o.isCustomLoading?o.storeLoadOptions.group:p}))}));var g=o.storeLoadOptions.filter;o.storeLoadOptions.isLoadingAll||(g=(0,i.combineFilters)([g,(0,i.combineFilters)(u,"or")]));var c=(0,e.extend)({},o.storeLoadOptions,{requireTotalCount:!1,requireGroupCount:!1,group:null,sort:p.concat((0,i.normalizeSortingInfo)(o.storeLoadOptions.sort||[])),filter:g}),h=t._dataSource.isLastLevelGroupItemsPagingLocal();h||(c.skip=r.skip,c.take=r.take),(0,l.when)(0===r.take?[]:t._dataSource.loadFromStore(c)).done((function(e,i){h&&(e=t._dataSource.sortLastLevelGroupItems(e,p,r.paths),e=r.skip?e.slice(r.skip):e,e=r.take?e.slice(0,r.take):e),(0,n.each)(r.items,(function(t,n){var i=n.count-(0===t&&r.skip||0),a=e.splice(0,i);f(o,r,p.length-1,t),n.items=a})),o.data.resolve(s)})).fail(o.data.reject)}var _=function(t,o){var n=new l.Deferred,i=!(!o.group||!o.group.length),r=(0,e.extend)({skip:0,take:1,requireGroupCount:i,requireTotalCount:!i},o,{group:i?o.group:null});return t.load(r).done((function(t,o){var e=o&&(i?o.groupCount:o.totalCount);if(!isFinite(e))throw p.errors.Error(i?"E4022":"E4021");n.resolve(e)})).fail(n.reject.bind(n)),n};return{updateTotalItemsCount:function(o){var e=0,n=o.extra&&o.extra.totalCount||0,i=o.extra&&o.extra.groupCount||0,r=this._dataSource.pageSize(),a=this._isVirtualPaging();t(this,(function(t){t.childrenTotalCount=0})),t(this,(function(t,o){var n=h(o,a?0:r,e),i=t.count+t.childrenTotalCount;a||(i+=d(n,r,i,o.length-1)),o[o.length-2]?o[o.length-2].childrenTotalCount+=i:e+=i})),this.callBase(e-n+i)},_isGroupExpanded:function(t){var o=this._dataSource.group();return c(o,t)},_updatePagingOptions:function(o,e){var n=this,i=this._isVirtualPaging(),r=this._dataSource.pageSize(),a=[],s=[],u=0,p=0;o.take&&(t(this,(function(t){t.childrenTotalCount=0,t.skipChildrenTotalCount=0})),t(this,(function(t,n){var l,g,c=0,f=0,k=h(n,i?0:r,p),m=0,C=0,v=t.count+t.childrenTotalCount,L=v;e&&e(t,k),l=o.skip-k,k<=o.skip+o.take&&v&&(g=o.take,i||(v+=(m=d(k,r,v,n.length-1))*n.length,L+=m,r&&l>=0&&(c=n.length,f=n.length-1,C=Math.floor(l/r))),l>=0?(k+v>o.skip&&a.unshift(l-C*c-t.skipChildrenTotalCount),k+v>=o.skip+g&&s.unshift(g-c-t.childrenTotalCount+t.skipChildrenTotalCount)):k+v>=o.skip+g&&s.unshift(g+l-t.childrenTotalCount)),k<=o.skip&&(n[n.length-2]?n[n.length-2].skipChildrenTotalCount+=Math.min(L,l+1-C*f):u+=Math.min(L,l+1)),k<=o.skip+g&&(v=Math.min(L,l+g-(C+1)*f),n[n.length-2]?n[n.length-2].childrenTotalCount+=v:p+=v)})),o.skip-=u,o.take-=p-u),o.skips=a,o.takes=s},changeRowExpand:function(t){var o=this,e=this.findGroupInfo(t),n=this._dataSource,r=n.remoteOperations().groupPaging,s=(0,i.normalizeSortingInfo)(n.group());return e?(e.isExpanded=!e.isExpanded,r&&e.isExpanded&&t.length<s.length?_(n,{filter:(0,a.createGroupFilter)(t,{filter:n.filter(),group:n.group()}),group:[s[t.length]]}).done((function(t){e.count=t})):(new l.Deferred).resolve()):(new l.Deferred).reject()},handleDataLoading:function(t){var o=this,e=t.storeLoadOptions,n=(0,i.normalizeSortingInfo)(e.group||t.loadOptions.group);if(!t.isCustomLoading&&n.length){if(t.remoteOperations.grouping){var r=this._dataSource.remoteOperations().paging;e.group=(0,i.normalizeSortingInfo)(e.group),e.group.forEach((function(t,o){var n=o===e.group.length-1;t.isExpanded=!r||!n}))}t.group=t.group||n,t.remoteOperations.paging?(t.skip=e.skip,t.take=e.take,e.requireGroupCount=!0,e.group=n.slice(0,1),this._updatePagingOptions(t),e.skip=t.skip,e.take=t.take):this.foreachGroups((function(t){t.count=0}))}},handleDataLoadedCore:function(t,e){var n,r=this,a=(0,i.normalizeSortingInfo)(t.storeLoadOptions.group||t.loadOptions.group).length,s=t.group?t.group.length:0,l={};if(t.isCustomLoading)e(t),o(this,t.data,a,l,[],t.isCustomLoading,t.storeLoadOptions.isLoadingAll);else{if((n=g(this,t,t.data,a))<0)throw u.default.Error("E1037");if(t.remoteOperations.paging||a&&t.extra&&t.loadOptions.requireTotalCount&&(t.extra.totalCount=n,t.extra.groupCount=t.data.length),s&&t.storeLoadOptions.requireGroupCount&&!isFinite(t.extra.groupCount))throw p.errors.Error("E4022");this.updateTotalItemsCount(t),t.remoteOperations.paging||this._updatePagingOptions(t),e(t),t.remoteOperations.paging||this._processPaging(t,a)}v(this,t,a,l,0,t.data)},_processSkips:function(t,o,e){if(e){var n=t[0],i=o[0],r=n&&n.items;void 0!==i&&(n.isContinuation=!0,r&&(n.items=r.slice(i),this._processSkips(n.items,o.slice(1),e-1)))}},_processTakes:function(t,o,e,n,i){if(n&&t){i=i||[];var r=t[t.length-1],a=r&&r.items,s=e[0],u=o[0];if(r){var p=r.count-(r.isContinuation&&u||0)||a.length;void 0!==s&&p>s&&(r.isContinuationOnNextPage=!0,i.forEach((function(t){t.isContinuationOnNextPage=!0})),a&&(a=a.slice(0,s),r.items=a)),i.push(r),this._processTakes(a,o.slice(1),e.slice(1),n-1,i)}}},_processPaging:function(t,o){this._processSkips(t.data,t.skips,o),this._processTakes(t.data,t.skips,t.takes,o)},isLastLevelGroupItemsPagingLocal:function(){return!1},sortLastLevelGroupItems:function(t){return t},refresh:function(o,e,n){var s,u,p=this,g=p._dataSource,h=o.storeLoadOptions,d=o.group||o.storeLoadOptions.group,f=(0,i.normalizeSortingInfo)(p._group);function k(t,o){o.length===u+1&&(t.isExpanded=s)}for(u=0;u<f.length;u++)s=c(d,u),c(p._group,u)!==s&&p.foreachGroups(k);if(p.callBase.apply(this,arguments),d&&o.remoteOperations.paging&&(e||n.reload))return t(p,(function(t){var e=_(g,{filter:(0,a.createGroupFilter)(t.path,{filter:h.filter,group:d}),group:d.slice(t.path.length)}),n=_(g,{filter:(0,r.createOffsetFilter)(t.path,{filter:h.filter,group:d}),group:d.slice(t.path.length-1,1)});return(0,l.when)(n,e).done((function(e,n){e=parseInt(e.length?e[0]:e),n=parseInt(n.length?n[0]:n),t.offset=e,t.count!==n&&(t.count=n,p.updateTotalItemsCount(o))}))}),!0)}}}())}

