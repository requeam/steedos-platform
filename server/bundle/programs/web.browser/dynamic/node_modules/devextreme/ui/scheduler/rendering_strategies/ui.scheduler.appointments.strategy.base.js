function module(t,e,n){"use strict";var i=t("../../../core/utils/common").noop,o=t("../../../core/class"),r=t("../../../core/utils/extend").extend,a=t("../../widget/ui.errors"),s=t("../../../core/utils/date"),u=t("../../../core/utils/type").isNumeric,p=t("../../../core/utils/type"),l=t("../../themes"),h=s.dateToMilliseconds,f=o.abstract,c=1,m=2,g=15,d=20,_=40,A=18,C=22,D=3,x=24,v=o.inherit({ctor:function(t){this.instance=t},getAppointmentMinSize:function(){return 2},keepAppointmentSettings:function(){return!1},getDeltaTime:f,getAppointmentGeometry:function(t){return t},needCorrectAppointmentDates:function(){return!0},getDirection:function(){return"horizontal"},createTaskPositionMap:function(t){delete this._maxAppointmentCountPerCell;var e=t&&t.length;if(e){this._defaultWidth=this.instance._cellWidth,this._defaultHeight=this.instance._cellHeight,this._allDayHeight=this.instance._allDayCellHeight;for(var n=[],i=0;i<e;i++){var o=this._getItemPosition(t[i]);this._isRtl()&&(o=this._correctRtlCoordinates(o)),n.push(o)}var r=this._getSortedPositions(n),a=this._getResultPositions(r);return this._getExtendedPositionMap(n,a)}},_getDeltaWidth:function(t,e){var n=this.instance.fire("getResizableStep")||this.getAppointmentMinSize(),i=e.width;return Math.round((t.width-i)/n)},_correctRtlCoordinates:function(t){for(var e=t[0].width||this._getAppointmentMaxWidth(),n=0;n<t.length;n++){var i=t[n];i.appointmentReduced||(i.left-=e)}return t},_getAppointmentMaxWidth:function(){return this._defaultWidth},_getItemPosition:function(t){for(var e=this._getAppointmentCoordinates(t),n=this.isAllDay(t),i=[],o=new Date(this.instance.fire("getField","startDate",t)),a=!!this.instance.fire("getField","recurrenceRule",t),s=0;s<e.length;s++){var u=this.calculateAppointmentHeight(t,e[s],a),p=this.calculateAppointmentWidth(t,e[s],a),l=p,h=null,f=[],c=e[s].rowIndex,m=e[s].cellIndex;if(this._needVerifyItemSize()||n){var g=e[s].hMax;this.isAppointmentGreaterThan(g,{left:e[s].left,width:p})&&(h="head",c=e[s].rowIndex,m=e[s].cellIndex,l=this._reduceMultiWeekAppointment(p,{left:e[s].left,right:g}),f=this._getAppointmentParts({sourceAppointmentWidth:p,reducedWidth:l,height:u},e[s],o),this._isRtl()&&(e[s].left=g))}r(e[s],{height:u,width:l,allDay:n,rowIndex:c,cellIndex:m,appointmentReduced:h}),i=this._getAppointmentPartsPosition(f,e[s],i)}return i},_getAppointmentPartsPosition:function(t,e,n){return t.length?(t.unshift(e),n=n.concat(t)):n.push(e),n},_getAppointmentCoordinates:function(t){var e=[{top:0,left:0}];return this.instance.fire("needCoordinates",{startDate:this.startDate(t),originalStartDate:this.startDate(t,!0),appointmentData:t,callback:function(t){e=t}}),e},_isRtl:function(){return this.instance.option("rtlEnabled")},_getAppointmentParts:function(){return[]},_getCompactAppointmentParts:function(t){var e=this._defaultWidth||this.getAppointmentMinSize();return Math.round(t/e)},_reduceMultiWeekAppointment:function(t,e){return t=this._isRtl()?Math.floor(e.left-e.right):e.right-Math.floor(e.left)},calculateAppointmentHeight:function(){return 0},calculateAppointmentWidth:function(){return 0},isAppointmentGreaterThan:function(t,e){var n=e.left+e.width-t;return this._isRtl()&&(n=t+e.width-e.left),n>this._defaultWidth/2},isAllDay:function(){return!1},cropAppointmentWidth:function(t,e){return this.instance.fire("isGroupedByDate")&&(t=e),t},_getSortedPositions:function(t){for(var e=[],n=function(t){return Math.round(100*t)/100},i=function(t,e,i,o,r,a,s,u){return{i:t,j:e,top:n(i),left:n(o),cellPosition:r,isStart:a,allDay:s,__tmpIndex:u}},o=0,r=0,a=t.length;r<a;r++)for(var s=0,u=t[r].length;s<u;s++){var p=t[r][s],l=p.top,h=p.left,f=p.height,c=p.width,m=p.cellPosition,g=p.allDay,d=i(r,s,l,h,m,!0,g,o),_=i(r,s,l+f,h+c,m,!1,g,++o);o++,e.push(d,_)}return e.sort(function(t,e){return this._sortCondition(t,e)}.bind(this))},_fixUnstableSorting:function(t,e,n){if(0===t){if(e.__tmpIndex<n.__tmpIndex)return-1;if(e.__tmpIndex>n.__tmpIndex)return 1}return t},_sortCondition:f,_rowCondition:function(t,e){var n=this._isSomeEdge(t,e),i=this._normalizeCondition(t.left,e.left,n),o=this._normalizeCondition(t.top,e.top,n);return i||(o||t.isStart-e.isStart)},_columnCondition:function(t,e){var n=this._isSomeEdge(t,e),i=this._normalizeCondition(t.left,e.left,n),o=this._normalizeCondition(t.top,e.top,n);return o||(i||t.isStart-e.isStart)},_isSomeEdge:function(t,e){return t.i===e.i&&t.j===e.j},_normalizeCondition:function(t,e,n){var i=t-e;return n||Math.abs(i)>1?i:0},_getResultPositions:function(t){for(var e,n=[],i=[],o=[],r=[],a=0,s=0,u=0;u<t.length;u++){var p,l=t[u];if(l.isStart){for(e=void 0,p=0;p<i.length;p++)if(!i[p]){e=p,i[p]=!0;break}if(void 0===e)for(e=i.length,i.push(!0),p=0;p<n.length;p++)n[p].count++;n.push({index:e,count:i.length,i:l.i,j:l.j,sortedIndex:this._skipSortedIndex(e)?null:s++}),a<i.length&&(a=i.length)}else{var h=this._findIndexByKey(n,"i","j",l.i,l.j),f=n[h];if(n.splice(h,1),i[f.index]=!1,r.push(f),!n.length){i=[];for(var c=0;c<r.length;c++)r[c].count=a;r=[],a=0}o.push(f)}}return o.sort((function(t,e){var n=t.j-e.j,i=t.i-e.i;return i||n}))},_skipSortedIndex:function(t){return this.instance.fire("getMaxAppointmentsPerCell")&&t>this._getMaxAppointmentCountPerCell()-1},_findIndexByKey:function(t,e,n,i,o){for(var r=0,a=0,s=t.length;a<s;a++)if(t[a][e]===i&&t[a][n]===o){r=a;break}return r},_getExtendedPositionMap:function(t,e){for(var n=0,i=[],o=0,r=t.length;o<r;o++){for(var a=[],s=0,u=t[o].length;s<u;s++)t[o][s].index=e[n].index,t[o][s].sortedIndex=e[n].sortedIndex,t[o][s].count=e[n++].count,a.push(t[o][s]),this._checkLongCompactAppointment(t[o][s],a);i.push(a)}return i},_checkLongCompactAppointment:i,_splitLongCompactAppointment:function(t,e){var n=this._getMaxAppointmentCountPerCellByType(t.allDay),i=0;if(void 0!==n&&t.index>n-1){t.isCompact=!0,i=this._getCompactAppointmentParts(t.width);for(var o=1;o<i;o++){var a=r(!0,{},t);a.left=this._getCompactLeftCoordinate(t.left,o),a.cellIndex=a.cellIndex+o,a.sortedIndex=null,e.push(a)}}return e},startDate:function t(e,n,i){var t=i&&i.startDate,o=this.instance._getStartDate(e,n),r=this.instance.fire("getField","text",e);if((t&&o>t||!t)&&(t=o),isNaN(t.getTime()))throw a.Error("E1032",r);return t},endDate:function t(e,n,i){var t=this.instance._getEndDate(e),o=this.startDate(e,!0),r=this.startDate(e,!1,n);if(r.getTime()>t.getTime()||i){var a=n?n.initialStartDate||n.startDate:o,u=n?n.startDate:o,p=t.getTime()-o.getTime();if(p=this._adjustDurationByDaylightDiff(p,o,t),t=new Date(r.getTime()>=a.getTime()?a.getTime():r.getTime()),i&&(t=new Date(t.getTime()+p)),!s.sameDate(o,t)&&u.getTime()<r.getTime()){var l,h=p-(s.trimTime(t).getTime()-u.getTime())||p;t=new Date(s.trimTime(r).getTime()+h)}}if(!this.isAllDay(e)){var f=s.roundToHour(this.instance.fire("getEndViewDate"));t>f&&(t=f)}return t},_adjustDurationByDaylightDiff:function(t,e,n){var i=this.instance.fire("getDaylightOffset",e,n);return this._needAdjustDuration(i)?this._calculateDurationByDaylightDiff(t,i):t},_needAdjustDuration:function(t){return 0!==t},_calculateDurationByDaylightDiff:function(t,e){return t+e*h("minute")},_getAppointmentDurationInMs:function(t,e,n){var i;return this.instance.fire("getAppointmentDurationInMs",{startDate:t,endDate:e,allDay:n,callback:function(t){i=t}}),i},_getMaxNeighborAppointmentCount:function(){var t;if(this.instance.fire("getMaxAppointmentsPerCell"))return 0;var e=this.getCompactAppointmentDefaultSize()+this.getCompactAppointmentDefaultOffset();return Math.floor(this.getCompactAppointmentGroupMaxWidth()/e)},_markAppointmentAsVirtual:function(t,e){var n=this._getMaxAppointmentCountPerCellByType(e);t.count-n>this._getMaxNeighborAppointmentCount()&&(t.virtual={top:t.top,left:t.left,index:"tail"===t.appointmentReduced?t.groupIndex+"-"+t.rowIndex+"-"+t.cellIndex:t.groupIndex+"-"+t.rowIndex+"-"+t.cellIndex+"-tail",isAllDay:e})},_getMaxAppointmentCountPerCellByType:function(t){var e=this._getMaxAppointmentCountPerCell();return p.isObject(e)?t?this._getMaxAppointmentCountPerCell().allDay:this._getMaxAppointmentCountPerCell().simple:e},getCompactAppointmentGroupMaxWidth:function(t,e){if(e||!p.isDefined(e)){var n=75;return 75*this.getDefaultCellWidth()/100}return 24},getDefaultCellWidth:function(){return this._defaultWidth},getCompactAppointmentDefaultSize:function(){return 15},getCompactAppointmentDefaultOffset:function(){return 3},getAppointmentDataCalculator:i,_customizeCoordinates:function(t,e,n,i,o){var r,a,s=t.index,u=e/n,p,l=t.top+s*u+i,h=t.width,f=t.left;return t.isCompact&&(r=this.getCompactAppointmentDefaultSize(),a=this.getCompactAppointmentDefaultOffset(),l=t.top+a,f=t.left+(s-n)*(r+a)+a,u=r,h=r,this._markAppointmentAsVirtual(t,o)),{height:u,width:h,top:l,left:f,empty:this._isAppointmentEmpty(e,h)}},convertToPercents:function(t,e){return{x:100*t/(this.instance.fire("getDateTableWidth")-e)}},_isAppointmentEmpty:function(t,e){return t<this._getAppointmentMinHeight()||e<this._getAppointmentMinWidth()},_calculateGeometryConfig:function(t){var e=this.instance.fire("getMaxAppointmentsPerCell"),n=this._getOffsets(),i=this._getAppointmentDefaultOffset(),o=this._getAppointmentCount(e,t),r=this._getDefaultRatio(t,o),a=this._getMaxHeight();u(o)||(o=t.count,r=(a-n.unlimited)/a);var s=(1-r)*a;return("auto"===e||u(e))&&(r=1,a-=i,s=i),{height:r*a,appointmentCountPerCell:o,offset:s}},_getAppointmentCount:i,_getDefaultRatio:i,_getOffsets:i,_getMaxHeight:i,_needVerifyItemSize:function(){return!1},needSeparateAppointment:function(t){return this.instance.fire("isGroupedByDate")&&t},_getMaxAppointmentCountPerCell:function(){if(!this._maxAppointmentCountPerCell){var t,e=this.instance.fire("getMaxAppointmentsPerCell");e||(t=2),u(e)&&(t=e),"auto"===e&&(t=this._getDynamicAppointmentCountPerCell()),"unlimited"===e&&(t=void 0),this._maxAppointmentCountPerCell=t}return this._maxAppointmentCountPerCell},_getDynamicAppointmentCountPerCell:function(){var t=this.instance.fire("getCellHeight");return Math.floor((t-this._getAppointmentDefaultOffset())/this._getAppointmentDefaultHeight())||this._getAppointmentMinCount()},_getAppointmentMinCount:function(){return 1},_isCompactTheme:function(){return"compact"===(l.current()||"").split(".")[2]},_getAppointmentDefaultOffset:function(){return this._isCompactTheme()?22:this.instance.option("_appointmentOffset")},_getAppointmentDefaultHeight:function(){return this._getAppointmentHeightByTheme()},_getAppointmentMinHeight:function(){return this._getAppointmentDefaultHeight()},_getAppointmentHeightByTheme:function(){return this._isCompactTheme()?18:20},_getAppointmentDefaultWidth:function(){return 40},_getAppointmentMinWidth:function(){return this._getAppointmentDefaultWidth()},_needVerticalGroupBounds:function(){return!1},_needHorizontalGroupBounds:function(){return!1}});n.exports=v}

