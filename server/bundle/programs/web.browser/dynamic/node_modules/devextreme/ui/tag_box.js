function module(e,t,i){"use strict";var s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},a,n=k(e("../core/renderer")),l,o=k(e("../core/devices")),r,u=k(e("../core/element_data")),c,h=k(e("../events/core/events_engine")),d,_=k(e("../core/component_registrator")),g,p=k(e("../core/utils/browser")),f=e("../core/utils/common"),m=e("../core/utils/selection_filter"),v=e("../core/utils/deferred"),T=e("../core/utils/dom"),x=e("../core/utils/type"),b=e("../core/utils/window"),C=e("../core/utils/extend"),y=e("../core/utils/array"),S=e("../core/utils/iterator"),E,V=k(e("../localization/message")),B=e("../events/utils"),I=e("../events/click"),F,D=k(e("./text_box/utils.caret")),A=e("../data/data_source/data_source"),$,w=k(e("./select_box")),M,P=k(e("./widget/bindable_template"));function k(e){return e&&e.__esModule?e:{default:e}}var H="dxTagData",L="dx-tagbox",O="dx-tag-container",G="dx-tag",R="dx-tagbox-multi-tag",W="dx-tag-custom",N="dx-tag-remove-button",z="dx-tagbox-only-select",j="dx-tagbox-single-line",K="dx-tagbox-popup-wrapper",q="dx-list-select-all-checkbox",J="dx-tag-content",U="dx-tagbox-default-template",Q="dx-tagbox-custom-template",X="dx-native-click",Y="dx-texteditor-container",Z=-.3,ee=w.default.inherit({_supportedKeys:function(){var e=this.callBase();return(0,C.extend)(e,{backspace:function(e){if(this._isCaretAtTheStart()){e.preventDefault(),e.stopPropagation(),this._isTagRemoved=!0;var t=this._$focusedTag||this._tagElements().last();this._$focusedTag&&this._moveTagFocus("prev",!0),0!==t.length&&(this._preserveFocusedTag=!0,this._removeTagElement(t),delete this._preserveFocusedTag)}},del:function(e){if(this._$focusedTag&&this._isCaretAtTheStart()){e.preventDefault(),e.stopPropagation(),this._isTagRemoved=!0;var t=this._$focusedTag;this._moveTagFocus("next",!0),this._preserveFocusedTag=!0,this._removeTagElement(t),delete this._preserveFocusedTag}},enter:function(e){var t=this._list&&null!==this._list.option("focusedElement"),i;if(this.option("acceptCustomValue")&&!t)return e.preventDefault(),void(""!==this._searchValue()&&this._customItemAddedHandler());this.option("opened")&&(e.preventDefault(),this._keyboardProcessor._childProcessors[0].process(e))},space:function(e){var t=this.option("opened"),i=this._shouldRenderSearchEvent();t&&!i&&(e.preventDefault(),this._keyboardProcessor._childProcessors[0].process(e))},leftArrow:function(e){if(this._isCaretAtTheStart()){var t=this.option("rtlEnabled");if(!this._isEditable()||!t||this._$focusedTag){e.preventDefault();var i=t?"next":"prev";this._moveTagFocus(i),!this.option("multiline")&&this._scrollContainer(i)}}},rightArrow:function(e){if(this._isCaretAtTheStart()){var t=this.option("rtlEnabled");if(!this._isEditable()||t||this._$focusedTag){e.preventDefault();var i=t?"prev":"next";this._moveTagFocus(i),!this.option("multiline")&&this._scrollContainer(i)}}}})},_allowSelectItemByTab:function(){return!1},_isCaretAtTheStart:function(){var e=(0,D.default)(this._input());return 0===e.start&&0===e.end},_moveTagFocus:function(e,t){if(!this._$focusedTag){var i=this._tagElements();return this._$focusedTag="next"===e?i.first():i.last(),void this._toggleFocusClass(!0,this._$focusedTag)}var s=this._$focusedTag[e](".dx-tag");s.length>0?this._replaceFocusedTag(s):(t||"next"===e&&this._isEditable())&&this._clearTagFocus()},_replaceFocusedTag:function(e){this._toggleFocusClass(!1,this._$focusedTag),this._$focusedTag=e,this._toggleFocusClass(!0,this._$focusedTag)},_clearTagFocus:function(){this._$focusedTag&&(this._toggleFocusClass(!1,this._$focusedTag),delete this._$focusedTag)},_focusClassTarget:function(e){return e&&e.length&&e[0]!==this._focusTarget()[0]?e:this.callBase()},_scrollContainer:function(e){if(!this.option("multiline")&&(0,b.hasWindow)()&&this._$tagsContainer){var t=this._getScrollPosition(e);this._$tagsContainer.scrollLeft(t)}},_getScrollPosition:function(e){return"start"===e||"end"===e?this._getBorderPosition(e):this._$focusedTag?this._getFocusedTagPosition(e):this._getBorderPosition("end")},_getBorderPosition:function(e){var t=this.option("rtlEnabled"),i="end"===e^t,s=t&&!p.default.webkit,a=!t||p.default.webkit||p.default.msie?1:-1;return i^!s?0:a*(this._$tagsContainer.get(0).scrollWidth-this._$tagsContainer.outerWidth())},_getFocusedTagPosition:function(e){var t=this.option("rtlEnabled"),i="next"===e^t,s,a=this._$focusedTag.position().left,n=this._$tagsContainer.scrollLeft(),l;(i&&(a+=this._$focusedTag.outerWidth(!0)-this._$tagsContainer.outerWidth()),i^a<0)&&(n+=a*(t&&p.default.msie?-1:1));return n},_setNextValue:f.noop,_getDefaultOptions:function(){return(0,C.extend)(this.callBase(),{value:[],showDropDownButton:!1,maxFilterLength:1500,tagTemplate:"tag",selectAllText:V.default.format("dxList-selectAll"),hideSelectedItems:!1,selectedItems:[],selectAllMode:"page",onSelectAllValueChanged:null,maxDisplayedTags:void 0,showMultiTagOnly:!0,onMultiTagPreparing:null,multiline:!0,useSubmitBehavior:!0})},_init:function(){this.callBase(),this._selectedItems=[],this._initSelectAllValueChangedAction()},_initActions:function(){this.callBase(),this._initMultiTagPreparingAction()},_initMultiTagPreparingAction:function(){this._multiTagPreparingAction=this._createActionByOption("onMultiTagPreparing",{beforeExecute:function(e){this._multiTagPreparingHandler(e.args[0])}.bind(this),excludeValidators:["disabled","readOnly"]})},_multiTagPreparingHandler:function(e){var t,i=this._getValue().length;this.option("showMultiTagOnly")?e.text=V.default.getFormatter("dxTagBox-selected")(i):e.text=V.default.getFormatter("dxTagBox-moreSelected")(i-this.option("maxDisplayedTags")+1)},_initDynamicTemplates:function(){this.callBase(),this._defaultTemplates.tag=new P.default((function(e,t){var i=(0,n.default)("<div>").addClass("dx-tag-content");(0,n.default)("<span>").text(t.text||t).appendTo(i),(0,n.default)("<div>").addClass("dx-tag-remove-button").appendTo(i),e.append(i)}),["text"],this.option("integrationOptions.watchMethod"),{text:this._displayGetter})},_toggleSubmitElement:function(e){e?(this._renderSubmitElement(),this._setSubmitValue()):(this._$submitElement&&this._$submitElement.remove(),delete this._$submitElement)},_renderSubmitElement:function(){this.option("useSubmitBehavior")&&(this._$submitElement=(0,n.default)("<select>").attr("multiple","multiple").css("display","none").appendTo(this.$element()))},_setSubmitValue:function(){if(this.option("useSubmitBehavior")){for(var e=this._getValue(),t="this"===this.option("valueExpr"),i=[],s=0,a=e.length;s<a;s++)i.push((0,n.default)("<option>").val(t?this._displayGetter(e[s]):e[s]).attr("selected","selected"));this._$submitElement.empty(),this._$submitElement.append(i)}},_initMarkup:function(){this._tagElementsCache=(0,n.default)();var e=!this.option("multiline");this.$element().addClass("dx-tagbox").toggleClass("dx-tagbox-only-select",!(this.option("searchEnabled")||this.option("acceptCustomValue"))).toggleClass("dx-tagbox-single-line",e),this._initTagTemplate(),this.callBase()},_render:function(){this.callBase(),this._renderTagRemoveAction(),this._renderSingleLineScroll(),this._scrollContainer("start")},_initTagTemplate:function(){this._tagTemplate=this._getTemplateByOption("tagTemplate")},_renderField:function(){var e=!(0,x.isDefined)(this.option("fieldTemplate"));this.$element().toggleClass("dx-tagbox-default-template",e).toggleClass("dx-tagbox-custom-template",!e),this.callBase()},_renderTagRemoveAction:function(){var e=this._createAction(this._removeTagHandler.bind(this)),t=(0,B.addNamespace)(I.name,"dxTagBoxTagRemove");h.default.off(this._$tagsContainer,t),h.default.on(this._$tagsContainer,t,".dx-tag-remove-button",(function(t){e({event:t})})),this._renderTypingEvent()},_renderSingleLineScroll:function(){var e=(0,B.addNamespace)("dxmousewheel",this.NAME),t=this.$element(),i=this.option("multiline");h.default.off(t,e),"desktop"===o.default.real().deviceType?i||h.default.on(t,e,this._tagContainerMouseWheelHandler.bind(this)):this._$tagsContainer&&this._$tagsContainer.css("overflowX",i?"":"auto")},_tagContainerMouseWheelHandler:function(e){var t=e.delta,i=this._$tagsContainer.scrollLeft();return this._$tagsContainer.scrollLeft(i+-.3*t),!1},_renderTypingEvent:function(){var e=this;h.default.on(this._input(),(0,B.addNamespace)("keydown",this.NAME),(function(t){var i=(0,B.normalizeKeyName)(t);!e._isControlKey(i)&&e._isEditable()&&e._clearTagFocus()}))},_popupWrapperClass:function(){return this.callBase()+" dx-tagbox-popup-wrapper"},_renderInput:function(){this.callBase(),this._renderPreventBlur(this._inputWrapper())},_renderInputValueImpl:function(){return this._renderMultiSelect()},_loadInputValue:function(){return(0,v.when)()},_clearTextValue:function(){this._input().val(""),this._toggleEmptinessEventHandler()},_focusInHandler:function(e){this.callBase(e),this._scrollContainer("end")},_restoreInputText:function(){this._clearTextValue()},_focusOutHandler:function(e){this.callBase(e),this._clearTagFocus(),this._scrollContainer("start")},_getFirstPopupElement:function(){return this.option("showSelectionControls")?this._popup._wrapper().find(".dx-list-select-all-checkbox"):this.callBase()},_initSelectAllValueChangedAction:function(){this._selectAllValueChangeAction=this._createActionByOption("onSelectAllValueChanged")},_renderList:function(){if(this.callBase(),this._setListDataSourceFilter(),this.option("showSelectionControls")){var e,t=this._list.$element().find(".dx-list-select-all-checkbox").dxCheckBox("instance");t.registerKeyHandler("tab",this._popupElementTabHandler.bind(this)),t.registerKeyHandler("escape",this._popupElementEscHandler.bind(this))}},_listConfig:function(){var e=this,t=this.option("showSelectionControls")?"all":"multiple";return(0,C.extend)(this.callBase(),{selectionMode:t,selectAllText:this.option("selectAllText"),onSelectAllValueChanged:function(t){var i=t.value;e._selectAllValueChangeAction({value:i})},selectAllMode:this.option("selectAllMode"),selectedItems:this._selectedItems,onFocusedItemChanged:null})},_renderMultiSelect:function(){var e=this,t=new v.Deferred;return this._$tagsContainer=this.$element().find(".dx-texteditor-container").addClass("dx-tag-container").addClass("dx-native-click"),this._renderInputSize(),this._renderTags().done((function(){e._popup&&e._popup.refreshPosition(),t.resolve()})).fail(t.reject),t.promise()},_listItemClickHandler:function(e){!this.option("showSelectionControls")&&this._clearTextValue(),"useButtons"!==this.option("applyValueMode")&&this.callBase(e)},_shouldClearFilter:function(){var e=this.callBase(),t;return!this.option("showSelectionControls")&&e},_renderInputSize:function(){var e=this._input(),t=e.val(),i=5,s="",a="",n=this.option("searchEnabled")||this.option("acceptCustomValue");if(t&&n){var l=(0,T.createTextElementHiddenCopy)(e,t,{includePaddings:!0});l.insertAfter(e),s=l.outerWidth()+5,l.remove()}else t||(a=1);e.css("width",s),e.attr("size",a)},_renderInputSubstitution:function(){this.callBase(),this._renderInputSize()},_getValue:function(){return this.option("value")||[]},_multiTagRequired:function(){var e=this._getValue(),t=this.option("maxDisplayedTags");return(0,x.isDefined)(t)&&e.length>t},_renderMultiTag:function(e){var t=(0,n.default)("<div>").addClass("dx-tag").addClass("dx-tagbox-multi-tag"),i={multiTagElement:(0,T.getPublicElement)(t),selectedItems:this.option("selectedItems")};return this._multiTagPreparingAction(i),!i.cancel&&(t.data("dxTagData",i.text),t.insertBefore(e),this._tagTemplate.render({model:i.text,container:(0,T.getPublicElement)(t)}),t)},_getFilteredItems:function(e){var t=this,i=new m.SelectionFilterCreator(e),s=this._list&&this._list.option("selectedItems")||this.option("selectedItems"),a=i.getLocalFilter(this._valueGetter),n=s.filter(a),l=n.length===e.length,o=new v.Deferred;if(l)return o.resolve(n).promise();var r=this._dataSource,u=r.filter(),c=i.getCombinedFilter(this.option("valueExpr"),u),h,d=encodeURI(JSON.stringify(c)).length>this.option("maxFilterLength")?void 0:c,_=r.loadOptions(),g=_.customQueryParams,p=_.expand;return r.store().load({filter:d,customQueryParams:g,expand:p}).done((function(e,i){if(t._disposed)o.reject();else{var s,n=(0,A.normalizeLoadResult)(e,i).data,l=r._applyMapFunction(n);o.resolve(l.filter(a))}})).fail(o.reject),o.promise()},_createTagsData:function(e,t){var i=this,s=[],a={},n="this"===this._valueGetterExpr(),l={};t.forEach((function(e){var t=n?JSON.stringify(e):i._valueGetter(e);l[t]=e}));var o=[];e.forEach((function(e,t){var r=l[n?JSON.stringify(e):e];if(n&&!(0,x.isDefined)(r))o.push(i._loadItem(e,a).always((function(a){var n=i._createTagData(s,a,e,t);s.splice(t,0,n)})));else{var u=i._createTagData(s,r,e,t);s.splice(t,0,u)}}));var r=new v.Deferred;return v.when.apply(this,o).always((function(){r.resolve(s)})),r.promise()},_createTagData:function(e,t,i,s){if((0,x.isDefined)(t))return this._selectedItems.push(t),t;var a=this.option("selectedItem"),n;return this._valueGetter(a)===i?a:i},_loadTagsData:function(){var e=this,t=this._getValue(),i=new v.Deferred;return this._selectedItems=[],this._getFilteredItems(t).done((function(s){var a;e._createTagsData(t,s).always((function(e){i.resolve(e)}))})).fail(i.reject.bind(this)),i.promise()},_renderTags:function(){var e=this,t=new v.Deferred;return this._loadTagsData().always((function(i){e._disposed?t.reject():(e._renderTagsCore(i),e._renderEmptyState(),e._preserveFocusedTag||e._clearTagFocus(),t.resolve())})),t.promise()},_renderTagsCore:function(e){var t=this;this._renderInputAddons(),this.option("selectedItems",this._selectedItems.slice()),this._cleanTags();var i=this._multiTagRequired()&&this._renderMultiTag(this._input()),s=this.option("showMultiTagOnly"),a=this.option("maxDisplayedTags");e.forEach((function(e,n){if(i&&s||i&&!s&&n-a>=-1)return!1;t._renderTag(e,i||t._input())})),this._scrollContainer("end"),this._refreshTagElements()},_cleanTags:function(){if(this._multiTagRequired())this._tagElements().remove();else{var e=this._tagElements(),t=this._getValue();(0,S.each)(e,(function(e,i){var s=(0,n.default)(i),a;(0,y.inArray)(s.data("dxTagData"),t)<0&&s.remove()}))}},_renderEmptyState:function(){var e=!(this._getValue().length||this._selectedItems.length||this._searchValue());this._toggleEmptiness(e),this._renderDisplayText()},_renderDisplayText:function(){this._renderInputSize()},_refreshTagElements:function(){this._tagElementsCache=this.$element().find(".dx-tag")},_tagElements:function(){return this._tagElementsCache},_applyTagTemplate:function(e,t){this._tagTemplate.render({model:e,container:(0,T.getPublicElement)(t)})},_renderTag:function(e,t){var i=this._valueGetter(e);if((0,x.isDefined)(i)){var s=this._getTag(i),a=this._displayGetter(e),n=this._getItemModel(e,a);s?((0,x.isDefined)(a)&&(s.empty(),this._applyTagTemplate(n,s)),s.removeClass("dx-tag-custom")):(s=this._createTag(i,t),(0,x.isDefined)(e)?this._applyTagTemplate(n,s):(s.addClass("dx-tag-custom"),this._applyTagTemplate(i,s)))}},_getItemModel:function(e,t){return(0,x.isObject)(e)&&t?e:(0,f.ensureDefined)(t,"")},_getTag:function(e){for(var t=this._tagElements(),i=t.length,s=!1,a=0;a<i;a++){var l=t[a],o=u.default.data(l,"dxTagData");if(e===o||(0,f.equalByValue)(e,o)){s=(0,n.default)(l);break}}return s},_createTag:function(e,t){return(0,n.default)("<div>").addClass("dx-tag").data("dxTagData",e).insertBefore(t)},_toggleEmptinessEventHandler:function(){this._toggleEmptiness(!this._getValue().length&&!this._searchValue().length)},_customItemAddedHandler:function(e){this.callBase(e),this._input().val("")},_removeTagHandler:function(e){var t=e.event;t.stopPropagation(),this._saveValueChangeEvent(t);var i=(0,n.default)(t.target).closest(".dx-tag");this._removeTagElement(i)},_removeTagElement:function(e){if(e.hasClass("dx-tagbox-multi-tag"))this.option("showMultiTagOnly")?this.reset():this.option("value",this._getValue().slice(0,this.option("maxDisplayedTags")));else{var t=e.data("dxTagData");this._removeTagWithUpdate(t),this._refreshTagElements()}},_updateField:f.noop,_removeTagWithUpdate:function(e){var t=this._getValue().slice();this._removeTag(t,e),this.option("value",t),0===t.length&&this._clearTagFocus()},_getCurrentValue:function(){return this._lastValue()},_selectionChangeHandler:function(e){var t=this;if("useButtons"!==this.option("applyValueMode")){var i=this._getValue().slice();(0,S.each)(e.removedItems||[],(function(e,s){t._removeTag(i,t._valueGetter(s))})),(0,S.each)(e.addedItems||[],(function(e,s){t._addTag(i,t._valueGetter(s))})),this._updateWidgetHeight(),this.option("value",i)}},_removeTag:function(e,t){var i=this._valueIndex(t,e);i>=0&&e.splice(i,1)},_addTag:function(e,t){var i;this._valueIndex(t)<0&&e.push(t)},_fieldRenderData:function(){return this._selectedItems.slice()},_completeSelection:function(e){this.option("showSelectionControls")||this._setValue(e)},_setValue:function(e){if(null!==e){var t="useButtons"===this.option("applyValueMode"),i=this._valueIndex(e),s=(t?this._list.option("selectedItemKeys"):this._getValue()).slice();i>=0?s.splice(i,1):s.push(e),"useButtons"===this.option("applyValueMode")?this._list.option("selectedItemKeys",s):this.option("value",s)}},_isSelectedValue:function(e,t){return this._valueIndex(e,null,t)>-1},_valueIndex:function(e,t,i){var a=this,n=-1;return i&&"object"!==(void 0===e?"undefined":s(e))&&(i.indexByValues||(i.indexByValues={},(t=t||this._getValue()).forEach((function(e,t){i.indexByValues[e]=t}))),e in i.indexByValues)?i.indexByValues[e]:(t=t||this._getValue(),(0,S.each)(t,(function(t,i){if(a._isValueEquals(e,i))return n=t,!1})),n)},_lastValue:function(){var e=this._getValue(),t=e[e.length-1];return(0,x.isDefined)(t)?t:null},_valueChangeEventHandler:f.noop,_shouldRenderSearchEvent:function(){return this.option("searchEnabled")||this.option("acceptCustomValue")},_searchHandler:function(e){this.option("searchEnabled")&&e&&!this._isTagRemoved&&this.callBase(e),this._updateWidgetHeight(),delete this._isTagRemoved},_updateWidgetHeight:function(){var e=this.$element(),t=e.height();this._renderInputSize();var i=e.height();this._popup&&this.option("opened")&&this._isEditable()&&i!==t&&this._popup.repaint()},_refreshSelected:function(){this._list&&this._list.option("selectedItems",this._selectedItems)},_resetListDataSourceFilter:function(){var e=this._getDataSource();e&&(delete this._userFilter,e.filter(null),e.reload())},_setListDataSourceFilter:function(){if(this.option("hideSelectedItems")&&this._list){var e=this._getDataSource();if(e){var t=this._valueGetterExpr();if((0,x.isString)(t)&&"this"!==t){var i=this._dataSourceFilterExpr();void 0===this._userFilter&&(this._userFilter=e.filter()||null),this._userFilter&&i.push(this._userFilter),i.length?e.filter(i):e.filter(null)}else e.filter(this._dataSourceFilterFunction.bind(this));e.load()}}},_dataSourceFilterExpr:function(){var e=this,t=[];return(0,S.each)(this._getValue(),(function(i,s){t.push(["!",[e._valueGetterExpr(),s]])})),t},_dataSourceFilterFunction:function(e){var t=this,i=this._valueGetter(e),s=!0;return(0,S.each)(this._getValue(),(function(e,a){if(t._isValueEquals(a,i))return s=!1,!1})),s},_applyButtonHandler:function(){this.option("value",this._getSortedListValues()),this._clearTextValue(),this._clearFilter(),this.callBase()},_getSortedListValues:function(){var e=this._getListValues(),t=this.option("value")||[],i=e.length?t.filter((function(t){return-1!==e.indexOf(t)})):[],s=i.length?e.filter((function(e){return-1===t.indexOf(e)})):e;return i.concat(s)},_getListValues:function(){var e=this;if(!this._list)return[];var t=this._getPlainItems(this._list.option("selectedItems")),i=[];return(0,S.each)(t,(function(t,s){i[t]=e._valueGetter(s)})),i},_renderOpenedState:function(){this.callBase(),"useButtons"!==this.option("applyValueMode")||this.option("opened")||this._refreshSelected()},reset:function(){this._restoreInputText(),this.callBase()},_clean:function(){this.callBase(),delete this._defaultTagTemplate,delete this._tagTemplate},_removeDuplicates:function(e,t){var i=this,s=[];return(0,S.each)(e,(function(e,a){var n;t.filter((function(e){return i._valueGetter(a)===i._valueGetter(e)})).length||s.push(a)})),s},_optionChanged:function(e){switch(e.name){case"onSelectAllValueChanged":this._initSelectAllValueChangedAction();break;case"onMultiTagPreparing":this._initMultiTagPreparingAction(),this._renderTags();break;case"hideSelectedItems":e.value?this._setListDataSourceFilter():this._resetListDataSourceFilter();break;case"useSubmitBehavior":this._toggleSubmitElement(e.value);break;case"displayExpr":this.callBase(e),this._initTemplates(),this._invalidate();break;case"tagTemplate":this._initTagTemplate(),this._invalidate();break;case"selectAllText":this._setListOption("selectAllText",this.option("selectAllText"));break;case"value":this.callBase(e),this._setListDataSourceFilter();break;case"maxDisplayedTags":case"showMultiTagOnly":this._renderTags();break;case"selectAllMode":this._setListOption(e.name,e.value);break;case"selectedItem":break;case"selectedItems":this._selectionChangedAction({addedItems:this._removeDuplicates(e.value,e.previousValue),removedItems:this._removeDuplicates(e.previousValue,e.value)});break;case"multiline":this.$element().toggleClass("dx-tagbox-single-line",!e.value),this._renderSingleLineScroll();break;case"maxFilterLength":break;default:this.callBase(e)}},_getActualSearchValue:function(){return this.callBase()||this._searchValue()},_popupHidingHandler:function(){this.callBase(),this._clearFilter()}});(0,_.default)("dxTagBox",ee),i.exports=ee,i.exports.default=i.exports}

