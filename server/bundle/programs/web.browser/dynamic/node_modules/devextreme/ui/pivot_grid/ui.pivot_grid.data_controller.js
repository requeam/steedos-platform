function module(e,n){"use strict";var t=e("../../core/utils/callbacks"),o=e("../../core/utils/deferred"),r=o.when,a=o.Deferred,i=e("../../core/utils/extend").extend,l=e("../../core/utils/array").inArray,s=e("../../core/utils/iterator"),d=e("../../core/class"),h=e("../../core/utils/string"),u=e("../../core/utils/common"),c=e("../../core/utils/type"),g=e("../grid_core/ui.grid_core.virtual_scrolling_core"),p=e("../grid_core/ui.grid_core.virtual_columns_core"),f=e("../grid_core/ui.grid_core.state_storing_core"),w=e("./data_source"),_=e("./ui.pivot_grid.utils"),C=_.foreachTree,m=_.foreachTreeAsync,S=_.createPath,x=_.formatValue,v=Math,y="GT",I="T",P="D",T="#N/A",z=function(e,n,t){e[n]||(e[n]=function(){var e=this._dataSource;return e?e[n].apply(e,arguments):t})};n.DataController=d.inherit(function(){function e(e,n,t){var o=e.text;return c.isDefined(e.displayText)?o=e.displayText:c.isDefined(e.caption)?o=e.caption:e.type===y&&(o=t.texts.grandTotal),e.isAdditionalTotal&&(o=h.format(t.texts.total||"",o)),o}function n(e,n,t){return e===T?t:x(e,n)}var o=function(){var n=function(e){var n=0;return C(e,(function(e){n=v.max(n,e.length)})),n},t=function(e,n,t,o){var r={type:e.type,text:e.text};return e.path&&(r.path=e.path),e.width&&(r.width=e.width),c.isDefined(e.wordWrapEnabled)&&(r.wordWrapEnabled=e.wordWrapEnabled),e.isLast&&(r.isLast=!0),e.sorted&&(r.sorted=!0),e.isMetric&&(r.dataIndex=e.dataIndex),c.isDefined(e.expanded)&&(r.expanded=e.expanded),n>1&&(r[t?"colspan":"rowspan"]=n),e.depthSize&&e.depthSize>1&&(r[t?"rowspan":"colspan"]=e.depthSize),e.index>=0&&(r.dataSourceIndex=e.index),o&&e.children&&e.children.length&&!e.children[0].isMetric&&(r.width=null,r.isWhiteSpace=!0),r},o=function(e,n){var o,r=n.lastIndex-n.index||1,a;return function(e,n,t,o,r){for(var a=r?o:t;!e[a];)e.push([]);r?e[a].push(n):e[a].unshift(n)}(e,o=t(n.headerItem,r,n.isHorizontal,n.isTree),n.index,n.depth,n.isHorizontal),n.headerItem.children&&0!==n.headerItem.children.length?n.lastIndex:n.lastIndex+1},d=function(e,n){var t,o=e[0],r=c.isString(n[0]),a=o.dataIndex>=0?e[1]:o;return t=r&&-1!==n[0].indexOf("&[")&&a.key||!a.key?S(e):s.map(e,(function(e){return e.dataIndex>=0?e.value:e.text})).reverse(),o.type===y&&(t=t.slice(1)),t.join("/")===n.join("/")},h=function(n,t,o,i,h){var u=o.length,w=g(n,t),C=h.dataFields,S=new a;return r(w).done((function(n){h.notifyProgress(.5),h.showGrandTotals&&n[h.showTotalsPrior?"unshift":"push"]({type:y,isEmpty:h.isEmptyGrandTotal});var a=!1===h.showTotals||C.length>0&&C.length===h.hiddenTotals.length,g=C.length>0&&h.hiddenValues.length===C.length;g&&a&&(i=1),a&&"tree"!==h.layout||f(n,t,h.showTotalsPrior,"tree"===h.layout),r(m(n,(function(e){var n=e[0];n.children&&0!==n.children.length||(n.depthSize=i-e.length+1)}))).done((function(){u>1&&p(n,o,h),!h.showEmpty&&_(n),h.notifyProgress(.75),r(m(n,(function(r){var a=r[0],i=a.isMetric,u=t[r.length-1]||{};if(a.type!==P||i||(a.width=u.width),!0!==g||a.type!==P)a.wordWrapEnabled=i?o[a.dataIndex].wordWrapEnabled:u.wordWrapEnabled,a.isLast=!a.children||!a.children.length,a.isLast&&s.each(h.sortBySummaryPaths,(function(e,n){if(c.isDefined(a.dataIndex)||(n=n.slice(0)).pop(),d(r,n))return a.sorted=!0,!1})),a.text=e(a,u,h);else{var p=(r[1]?r[1].children:n)||[];p.splice(l(a,p),1)}}))).done((function(){n.length||n.push({}),h.notifyProgress(1),S.resolve(n)}))}))})),S};function u(e,n,t){var o,r=(e[n]=e[n]||[])[t]={};if(e[n+1]){r.children=e[n+1];for(var a=n+1;a<e.length;a++)e[a]=void 0;e.length=n+1}return r}function g(e,n){var t,o=n&&n.length||0,i=[],l=new a;return r(m(e,(function(e,n){var r=e[0],a=S(e);(t=u(i,a.length,n)).type=P,t.value=r.value,t.path=a,t.text=r.text,t.index=r.index,t.displayText=r.displayText,t.key=r.key,t.isEmpty=r.isEmpty,a.length<o&&(!r.children||0!==r.children.length)&&(t.expanded=!!r.children)}))).done((function(){l.resolve(u(i,0,0).children||[])})),l}var p=function(e,n,t){C(e,(function(e){var o,r=e[0];if(!r.children||0===r.children.length)for(r.children=[],o=0;o<n.length;o++){var a=r.type===y,i="T"===r.type,s=r.type===P,d;!1===n[o].visible||a&&-1!==l(o,t.hiddenGrandTotals)||i&&-1!==l(o,t.hiddenTotals)||s&&-1!==l(o,t.hiddenValues)||r.children.push({caption:n[o].caption,path:r.path,type:r.type,value:o,index:r.index,dataIndex:o,isMetric:!0,isEmpty:r.isEmpty&&r.isEmpty[o]})}}))},f=function(e,n,t,o){t=t||o,C(e,(function(r,a){var l=r[0],s=(r[1]?r[1].children:e)||[],d=n[r.length-1];l.type===P&&l.expanded&&(!1!==d.showTotals||o)&&(-1!==a&&s.splice(t?a:a+1,0,i({},l,{children:null,type:"T",expanded:!!t||null,isAdditionalTotal:!0})),t&&(l.expanded=null))}))},w=function e(n,t){var o=n[t+1];!n[t].children.length&&o&&o.children&&(o.children.splice(l(n[t],o.children),1),e(n,t+1))},_=function(e){C([{children:e}],(function(n,t){var o=n[0],r=(n[1]?n[1].children:e)||[],a=o.isEmpty;a&&a.length&&(a=o.isEmpty.filter((function(e){return e})).length===a.length),o&&!o.children&&a&&(r.splice(t,1),w(n,1))}))},x=function(e,n,t,r,a){var i,l,s=0,d=[0];C(n,(function(n){var h=n[0];for(l=h.isMetric?t:n.length-1;d.length-1<l;)d.push(d[d.length-1]);i=d[l]||0,s=o(e,{headerItem:h,index:i,lastIndex:s,depth:l,isHorizontal:r,isTree:a}),d.length=l,d.push(s)}))};return function(e,t,o,r,i){var l=[],s=n(e)||1,d=new a;return h(e,t,o,s,i).done((function(e){x(l,e,s,r,"tree"===i.layout),i.notifyProgress(1),d.resolve(l)})),d}}();function d(e,n){var t=[];return s.each(e,(function(e,o){var r=_.findField(n,o.sortBySummaryField);r>=0&&t.push((o.sortBySummaryPath||[]).concat([r]))})),t}function I(e,n){for(var t=0,o=[],r=0;r<e.length;r++)for(var a=0;a<e[r].length;a++){var i,l=r+((e[r][a].rowspan||1)-1);if(o[r]&&(t-=o[r],o[r]=0),!1===n(e[r][a],l,r,a,t))break;o[r+(e[r][a].rowspan||1)]=(o[r+(e[r][a].rowspan||1)]||0)+1,t++}}function E(e,t,o,r,a,i){var l=[],s="row"===a,d=o.values;return d.length&&I(e,(function(e,a){var h=l[a]=[],u=d[e.dataSourceIndex>=0?e.dataSourceIndex:o.grandTotalRowIndex]||[];e.isLast&&p.foreachColumnInfo(t,(function(t,a){var l=(s?e.dataIndex:t.dataIndex)||0,d=r[l];if(t.isLast&&d){var c,g=u[t.dataSourceIndex>=0?t.dataSourceIndex:o.grandTotalColumnIndex];Array.isArray(g)||(g=[g]),c=g[l],h[a]={text:n(c,d,i),value:c,format:d.format,dataType:d.dataType,columnType:t.type,rowType:e.type,rowPath:e.path||[],columnPath:t.path||[],dataIndex:l},d.width&&(h[a].width=d.width)}}))})),l}function D(e,n){var t=0,o=[];return C(e,(function(e){var r=e[0],a=S(e);if(!r.children||!1!==n.showTotals){var l=i(!0,{},r,{visibleIndex:t++,path:a});c.isDefined(l.index)?o[l.index]=l:o.push(l)}})),o}function V(e,n,t){if(n&&"virtual"===n.option("scrolling.mode"))return new g.VirtualScrollController(n,i({hasKnownLastPage:function(){return!0},pageCount:function(){return v.ceil(this.totalItemsCount()/this.pageSize())},updateLoading:function(){},itemsCount:function(){return this.pageIndex()<this.pageCount()-1?this.pageSize():this.totalItemsCount()%this.pageSize()},items:function(){return[]},viewportItems:function(){return[]},onChanged:function(){},isLoading:function(){return e.isLoading()},changingDuration:function(){return e._changingDuration||0}},t))}function b(e){var n=[];return s.each(e,(function(e,t){!1===t.showTotals&&n.push(e)})),n}function L(e){var n=[];return e.forEach((function(e,t){(void 0===e.showValues&&!1===e.showTotals||!1===e.showValues)&&n.push(t)})),n}function H(e,n){var t=[];return s.each(e,(function(e,n){!1===n.showGrandTotals&&t.push(e)})),0===n.length&&t.length===e.length&&(t=[]),t}var F={ctor:function(e){var n=this,o=n._fireChanged.bind(n);e=n._options=e||{},n.dataSourceChanged=t(),n._dataSource=n._createDataSource(e),n._rowsScrollController=V(n,e.component,{totalItemsCount:function(){return n.totalRowCount()},pageIndex:function(e){return n.rowPageIndex(e)},pageSize:function(){return n.rowPageSize()},load:function(){return n._rowsScrollController.pageIndex()>=this.pageCount()&&n._rowsScrollController.pageIndex(this.pageCount()-1),n._rowsScrollController.handleDataChanged(o)}}),n._columnsScrollController=V(n,e.component,{totalItemsCount:function(){return n.totalColumnCount()},pageIndex:function(e){return n.columnPageIndex(e)},pageSize:function(){return n.columnPageSize()},load:function(){return n._columnsScrollController.pageIndex()>=this.pageCount()&&n._columnsScrollController.pageIndex(this.pageCount()-1),n._columnsScrollController.handleDataChanged(o)}}),n._stateStoringController=new f.StateStoringController(e.component).init(),n._columnsInfo=[],n._rowsInfo=[],n._cellsInfo=[],n.expandValueChanging=t(),n.loadingChanged=t(),n.progressChanged=t(),n.scrollChanged=t(),n.load(),n._update(),n.changed=t()},_fireChanged:function(){var e=this,n=new Date;this.changed&&!this._lockChanged&&this.changed.fire(),this._changingDuration=new Date-n},load:function(){var e=this,n=this._stateStoringController;n.isEnabled()&&!n.isLoaded()?n.load().always((function(n){n?e._dataSource.state(n):e._dataSource.load()})):e._dataSource.load()},calculateVirtualContentParams:function(e){var n,t,o,r,a=this,i=this._rowsScrollController,l=this._columnsScrollController,s=e.contentHeight/e.rowCount,d=e.contentWidth/e.columnCount;if(i&&l)return n=l.viewportItemSize(),t=i.viewportItemSize(),i.viewportItemSize(s),l.viewportItemSize(d),i.viewportSize(e.viewportHeight/i.viewportItemSize()),i.setContentSize(e.contentHeight),l.viewportSize(e.viewportWidth/l.viewportItemSize()),l.setContentSize(e.contentWidth),u.deferUpdate((function(){l.loadIfNeed(),i.loadIfNeed()})),o=l.getViewportPosition()*d/n,r=i.getViewportPosition()*s/t,this.setViewportPosition(o,r),this.scrollChanged.fire({left:o,top:r}),{contentTop:i.getContentOffset(),contentLeft:l.getContentOffset(),width:l.getVirtualContentSize(),height:i.getVirtualContentSize()}},setViewportPosition:function(e,n){this._rowsScrollController.setViewportPosition(n||0),this._columnsScrollController.setViewportPosition(e||0)},subscribeToWindowScrollEvents:function(e){this._rowsScrollController&&this._rowsScrollController.subscribeToWindowScrollEvents(e)},updateWindowScrollPosition:function(e){this._rowsScrollController&&this._rowsScrollController.scrollTo(e)},updateViewOptions:function(e){i(this._options,e),this._update()},_handleExpandValueChanging:function(e){this.expandValueChanging.fire(e)},_handleLoadingChanged:function(e){this.loadingChanged.fire(e)},_handleProgressChanged:function(e){this.progressChanged.fire(e)},_handleFieldsPrepared:function(e){this._options.onFieldsPrepared&&this._options.onFieldsPrepared(e)},_createDataSource:function(e){var n,t=this,o=e.dataSource;return t._isSharedDataSource=o instanceof w,n=t._isSharedDataSource?o:new w(o),t._expandValueChangingHandler=t._handleExpandValueChanging.bind(t),t._loadingChangedHandler=t._handleLoadingChanged.bind(t),t._progressChangedHandler=function(e){t._handleProgressChanged(.8*e)},t._fieldsPreparedHandler=t._handleFieldsPrepared.bind(t),t._changedHandler=function(){t._update(),t.dataSourceChanged.fire()},n.on("changed",t._changedHandler),n.on("expandValueChanging",t._expandValueChangingHandler),n.on("loadingChanged",t._loadingChangedHandler),n.on("progressChanged",t._progressChangedHandler),n.on("fieldsPrepared",t._fieldsPreparedHandler),n},getDataSource:function(){return this._dataSource},isLoading:function(){return this._dataSource.isLoading()},beginLoading:function(){this._dataSource.beginLoading()},endLoading:function(){this._dataSource.endLoading()},_update:function(){var e=this,n=e._dataSource,t=e._options,a=n.getAreaFields("column"),i=n.getAreaFields("row"),l=n.getAreaFields("data"),s="row"===t.dataFieldArea?l:[],h="row"!==t.dataFieldArea?l:[],u=n.getData(),g=b(l),p=L(l),f=H(l,a),w=!(l.length>0)||f.length!==l.length,_=function(n){this.progress=n,e._handleProgressChanged(.8+.1*C.progress+.1*m.progress)},C={isEmptyGrandTotal:u.isEmptyGrandTotalRow,texts:t.texts||{},hiddenTotals:g,hiddenValues:p,hiddenGrandTotals:[],showTotals:t.showRowTotals,showGrandTotals:!1!==t.showRowGrandTotals&&w,sortBySummaryPaths:d(a,l),showTotalsPrior:"rows"===t.showTotalsPrior||"both"===t.showTotalsPrior,showEmpty:!t.hideEmptySummaryCells,layout:t.rowHeaderLayout,fields:i,dataFields:l,progress:0,notifyProgress:_},m={isEmptyGrandTotal:u.isEmptyGrandTotalColumn,texts:t.texts||{},hiddenTotals:g,hiddenValues:p,hiddenGrandTotals:f,showTotals:t.showColumnTotals,showTotalsPrior:"columns"===t.showTotalsPrior||"both"===t.showTotalsPrior,showGrandTotals:!1!==t.showColumnGrandTotals&&w,sortBySummaryPaths:d(i,l),showEmpty:!t.hideEmptySummaryCells,fields:a,dataFields:l,progress:0,notifyProgress:_};c.isDefined(u.grandTotalRowIndex)||(u.grandTotalRowIndex=D(u.rows,C).length),c.isDefined(u.grandTotalColumnIndex)||(u.grandTotalColumnIndex=D(u.columns,m).length),n._changeLoadingCount(1),r(o(u.columns,a,h,!0,m),o(u.rows,i,s,!1,C)).always((function(){n._changeLoadingCount(-1)})).done((function(n,t){e._columnsInfo=n,e._rowsInfo=t,e._rowsScrollController&&e._columnsScrollController&&e.changed&&(e._rowsScrollController.reset(),e._columnsScrollController.reset(),e._lockChanged=!0,e._rowsScrollController.load(),e._columnsScrollController.load(),e._lockChanged=!1)})).done((function(){e._fireChanged(),e._stateStoringController.isEnabled()&&!e._dataSource.isLoading()&&(e._stateStoringController.state(e._dataSource.state()),e._stateStoringController.save())}))},getRowsInfo:function(e){var n,t,o=this,r=this._rowsInfo,a=this._rowsScrollController;if(a&&!e){var l=a.beginPageIndex()*this.rowPageSize(),s=a.endPageIndex()*this.rowPageSize()+this.rowPageSize(),d=[],h=1;return I(r,(function(e,o,r,a,u){var c,g=r<l?0:r-l,p=e;if(o>=l&&r<s)d[g]=d[g]||[],n=r<l?e.rowspan-(l-r)||1:e.rowspan,l+g+n>s&&(n=s-(g+l)||1),n!==e.rowspan&&(p=i({},p,{rowspan:n})),d[g].push(p),h=v.max(h,u+1);else if(t>s)return!1})),I(d,(function(e,n,t,o,r){var a;r+(e.colspan||1)>h&&(d[t][o]=i({},e,{colspan:h-r||1}))})),d}return r},getColumnsInfo:function(e){var n=this,t=this._columnsInfo,o=this._columnsScrollController;if(o&&!e){var r=o.beginPageIndex()*this.columnPageSize(),a=o.endPageIndex()*this.columnPageSize()+this.columnPageSize();t=p.createColumnsInfo(t,r,a)}return t},totalRowCount:function(){return this._rowsInfo.length},rowPageIndex:function(e){return void 0!==e&&(this._rowPageIndex=e),this._rowPageIndex||0},totalColumnCount:function(){var e=0;if(this._columnsInfo&&this._columnsInfo.length)for(var n=0;n<this._columnsInfo[0].length;n++)e+=this._columnsInfo[0][n].colspan||1;return e},rowPageSize:function(e){return void 0!==e&&(this._rowPageSize=e),this._rowPageSize||20},columnPageSize:function(e){return void 0!==e&&(this._columnPageSize=e),this._columnPageSize||20},columnPageIndex:function(e){return void 0!==e&&(this._columnPageIndex=e),this._columnPageIndex||0},getCellsInfo:function(e){var n=this.getRowsInfo(e),t=this.getColumnsInfo(e),o=this._dataSource.getData(),r=this._options.texts||{};return E(n,t,o,this._dataSource.getAreaFields("data"),this._options.dataFieldArea,r.dataNotAvailable)},dispose:function(){var e=this;this._isSharedDataSource?(this._dataSource.off("changed",this._changedHandler),this._dataSource.off("expandValueChanging",this._expandValueChangingHandler),this._dataSource.off("loadingChanged",this._loadingChangedHandler),this._dataSource.off("progressChanged",this._progressChangedHandler)):this._dataSource.dispose(),this._columnsScrollController&&this._columnsScrollController.dispose(),this._rowsScrollController&&this._rowsScrollController.dispose(),this._stateStoringController.dispose(),this.expandValueChanging.empty(),this.changed.empty(),this.loadingChanged.empty(),this.progressChanged.empty(),this.scrollChanged.empty(),this.dataSourceChanged.empty()}};return z(F,"applyPartialDataSource"),z(F,"collapseHeaderItem"),z(F,"expandHeaderItem"),z(F,"getData"),z(F,"isEmpty"),F}())}

