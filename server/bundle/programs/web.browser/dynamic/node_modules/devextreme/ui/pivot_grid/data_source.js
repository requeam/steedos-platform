function module(e,n,t){"use strict";var r=e("../../data/data_source/data_source"),a=e("../../data/abstract_store"),i=e("../../core/utils/common"),o=e("../../core/utils/type"),s=e("../../core/utils/extend").extend,d=e("../../core/utils/array").inArray,l=e("../../core/utils/iterator"),u=o.isDefined,c=l.each,f=e("../../core/utils/deferred"),h=f.when,p=f.Deferred,m=e("../../core/class"),v=e("../../core/events_mixin"),g=e("../../core/utils/inflector"),_=e("../../core/utils/array").normalizeIndexes,x=e("./local_store"),y=e("./remote_store"),w=e("./xmla_store/xmla_store"),C=e("./ui.pivot_grid.summary_display_modes"),T=e("./ui.pivot_grid.utils"),F=T.foreachTree,P=T.foreachTreeAsync,I=T.findField,D=T.formatValue,E=T.getCompareFunction,S=T.createPath,L=T.foreachDataLevel,B=T.setFieldProperty,O={row:"rows",column:"columns",data:"values",filter:"filters"},b=["area","areaIndex","sortOrder","filterType","filterValues","sortBy","sortBySummaryField","sortBySummaryPath","expanded","summaryType","summaryDisplayMode"],A=["format","selector","customizeText","caption"],N=A.concat(["allowSorting","allowSortingBySummary","allowFiltering","allowExpandAll"]);function V(e){var n=e.dataField||e.groupName||"",t=(e.summaryType||"").toLowerCase();return o.isString(e.groupInterval)&&(n+="_"+e.groupInterval),t&&"custom"!==t?(t=t.replace(/^./,t[0].toUpperCase()),n.length&&(t=" ("+t+")")):t="",g.titleize(n)+t}function j(e,n){var t=e._initProperties||{};l.each(n,(function(n,r){t.hasOwnProperty(r)&&(e[r]=t[r])}))}function M(e,n){j(e,n),u(e.caption)||B(e,"caption",V(e))}function R(e){return e.some((function(e){return e.summaryDisplayMode||e.calculateSummaryValue}))}function k(e){return e.some((function(e){return!!e.runningTotal}))}t.exports=m.inherit(function(){var e=function(e,n){if(e._cacheByPath)return e._cacheByPath[n.join(".")]||null},n=function e(n,t){var r,a,i=-1;if(n)for(r=0;r<n.length;r++)a=n[r],i=Math.max(i,a.index),a.children?i=Math.max(i,e(a.children)):a.collapsedChildren&&(i=Math.max(i,e(a.collapsedChildren)));return u(t)&&(i=Math.max(i,t)),i},t=function(e,t,r,a){var i,o=n(r)+1,s=n(e,a)+1,d=[],l=new p;for(i=0;i<o;i++)d[i]=s++;return t.children=r,h(P(t.children,(function(e){e[0].index=d[e[0].index]}))).done((function(){l.resolve(d)})),l},f=function(n,t){var r=new p,a=[];return h(P(n,(function(e){delete e[0].collapsedChildren}))).done((function(){h(P(t,(function(t){var r=e(n,S(t));r&&(a[t[0].index]=r.index)}))).done((function(){r.resolve(a)}))})),r},v=function(e,n,t,r){var a,i,o,s,d,l,c=e.values;if(n)for(a=0;a<=n.length;a++)if(o=n[a],d=t[a],u(d)||(d=e.grandTotalRowIndex),o&&u(d))for(c[d]||(c[d]=[]),i=0;i<=o.length;i++)s=o[i],l=r[i],u(l)||(l=e.grandTotalColumnIndex),u(s)&&u(l)&&(c[d][l]=s)};function g(e,n){var t;return new(e.remoteOperations?y:x.LocalStore)(s(r.normalizeDataSourceOptions(e),{onChanged:null,onLoadingChanged:null,onProgressChanged:n}))}function V(e,n){var t,r;return o.isPlainObject(e)&&e.load?t=g(e,n):(e&&!e.store&&(e={store:e}),"xmla"===(r=e.store).type?t=new w.XmlaStore(r):o.isPlainObject(r)&&r.type||r instanceof a||Array.isArray(r)?t=g(e,n):r instanceof m&&(t=r)),t}function G(e,n,t){for(var r=0;r<t;r++)if(!e[r]||!n[r]||e[r].index!==n[r].index)return!1;return!0}function z(e,n,t,r){var a=[],i=n&&n[t]||[],o=r&&r[t]||[];return F(e[t],(function(e){var n=e[0],t=S(e);n.children&&i[t.length-1]&&!i[t.length-1].expanded&&t.length<i.length&&(!r||G(i,o,t.length))&&a.push(t.slice())}),!0),a}function H(e,n,t,r){return n?c(r,(function(r,a){if(t)e[a]=n[a];else{if(("summaryType"===a||"summaryDisplayMode"===a)&&void 0===n[a])return;B(e,a,n[a])}})):j(e,r),e}function U(e,n){var t=[];return c(e,(function(e,r){t.push(H({dataField:r.dataField,name:r.name},r,!0,n))})),t}function X(e){return e.name?e.name:e.dataField+""}function q(e,n){var t=[];return c(e||[],(function(e,r){X(r)===n&&t.push(r)})),t}function J(e,n){return e=e||[],c(n,(function(n,t){H(t,e[n],!1,b),M(t,A)})),n}function K(e,n){e=e||[];var t,r={};return c(n,(function(e,a){t=X(a),r[t]||(r[t]=q(n,X(a)))})),c(r,(function(n,t){J(q(e,n),t)})),n}function Q(e,n){return e.filter((function(e){return e.groupName===n.groupName&&o.isNumeric(e.groupIndex)&&!1!==e.visible})).map((function(e){return s(e,{areaIndex:n.areaIndex,area:n.area,expanded:u(e.expanded)?e.expanded:n.expanded,dataField:e.dataField||n.dataField,dataType:e.dataType||n.dataType,sortBy:e.sortBy||n.sortBy,sortOrder:e.sortOrder||n.sortOrder,sortBySummaryField:e.sortBySummaryField||n.sortBySummaryField,sortBySummaryPath:e.sortBySummaryPath||n.sortBySummaryPath,visible:e.visible||n.visible,showTotals:u(e.showTotals)?e.showTotals:n.showTotals,showGrandTotals:u(e.showGrandTotals)?e.showGrandTotals:n.showGrandTotals})})).sort((function(e,n){return e.groupIndex-n.groupIndex}))}function W(e){e.sort((function(e,n){return e.areaIndex-n.areaIndex||e.groupIndex-n.groupIndex}))}function Y(e,n){var t="data"===n||!1!==e.visible;return e.area===n&&!u(e.groupIndex)&&t}function Z(e,n){var t=e.groupName||"";return(e.dataField||t)+(e.groupInterval?t+e.groupInterval:"NOGROUP")+(n?"":t)}function $(e,n,t){var r=[],a={},i={},o=[],d=T.getFieldsDataType(e);return n?(c(n,(function(e,n){a[Z(n,t)]=n})),c(e,(function(e,n){var o,l=Z(n,t),u=a[l]||i[l];u?(u._initProperties&&j(u,N),o=s({},u,n,{_initProperties:null})):a[l]=o=n,s(o,{dataType:d[n.dataField]}),delete a[l],i[l]=u,r.push(o)})),t&&c(a,(function(e,n){r.push(n)}))):r=e,r.push.apply(r,o),r}function ee(e){var n,t=new p,r=e._store,a=r&&r.getFields(e._fields);return h(a).done((function(r){e._storeFields=r,n=$(e._fields,r,e._retrieveFields),t.resolve(n)})).fail(t.reject),t}function ne(e,n){var t=null,r=(n||[]).join(".");return r.length&&F(e,(function(e){var n=e[0],a=S(e).join("."),i=l.map(e,(function(e){return e.text})).reverse().join(".");if(r===a||n.key&&i===r)return t=e[0].index,!1})),t}function te(e,n,t,r){var a=n.values,i=I(t.values,e.sortBySummaryField),o="rows"===r,s=o?n.columns:n.rows,d=o?n.grandTotalRowIndex:n.grandTotalColumnIndex,l=e.sortBySummaryPath||[],c=l.length?ne(s,l):d;if(a&&a.length&&i>=0&&u(c))return function(e){var n=o?e.index:c,t=o?c:e.index,r=((a[n]||[[]])[t]||[])[i];return u(r)?r:null}}function re(e,n){var t="text";return"none"===e?t="index":(n||"displayText"!==e)&&(t="value"),t}function ae(e,n,t,r,a){var i=a?"asc":e.sortOrder,o=re(e.sortBy,a),s=e.sortingMethod?function(n,t){return e.sortingMethod(n,t)}:E((function(e){return e[o]})),d=!a&&te(e,n,t,r),l=d&&E(d),u;return function(e,n){var t=l&&l(e,n)||s(e,n);return"desc"===i?-t:t}}function ie(e,n,t,r){var a=n[t]||[],i=n.headerName===t?n.path.length:0,o=[];L(e[t],(function(i,s){var d=a[s]||{},l=o[s]=o[s]||ae(d,e,n,t,r);i.sort(l)}),i)}function oe(e,n,t){ie(n,e,"rows",t),ie(n,e,"columns",t)}function se(e,n,t){return P(e[t],(function(e){var r=e[0];r.text=r.text||D(r.value,n[t][S(e).length-1])}))}function de(e,n){return h(se(n,e,"columns"),se(n,e,"rows"))}function le(e){var n=new p,t={};return h(P(e,(function(e){var n=S(e).join(".");t[n]=e[0]}))).done(n.resolve),e._cacheByPath=t,n}function ue(e,n){var t=[];return c(e,(function(){Y(this,n)&&t.push(this)})),t}return{ctor:function(e){var n=this,t=V(e=e||{},(function(e){n.fireEvent("progressChanged",[e])}));n._store=t,n._data={rows:[],columns:[],values:[]},n._loadingCount=0,c(["changed","loadError","loadingChanged","progressChanged","fieldsPrepared","expandValueChanging"],function(n,t){var r="on"+t[0].toUpperCase()+t.slice(1);e.hasOwnProperty(r)&&this.on(t,e[r])}.bind(this)),n._retrieveFields=!u(e.retrieveFields)||e.retrieveFields,n._fields=e.fields||[],n._descriptions=e.descriptions?s(n._createDescriptions(),e.descriptions):void 0,t||s(!0,n._data,e.store||e)},getData:function(){return this._data},getAreaFields:function(e,n){var t,r=[];return n||"data"===e?W(r=ue(this._fields,e)):r=(t=this._descriptions||{})[O[e]]||[],r},fields:function(e){var n=this;return e&&(this._fields=$(e,this._storeFields,this._retrieveFields),this._fieldsPrepared(this._fields)),this._fields},field:function e(n,t){var r,a=this,i=this._fields,e=i&&i[o.isNumeric(n)?n:I(i,n)];return e&&t&&(c(t,(function(n,t){var a=d(n,b)<0;if(B(e,n,t,a),"sortOrder"===n){r=e.levels||[];for(var i=0;i<r.length;i++)r[i][n]=t}})),M(e,A),this._descriptions=this._createDescriptions(e)),e},getFieldValues:function(e){var n=this,t=this._fields&&this._fields[e],r=this.store(),a=[],i={columns:a,rows:[],values:this.getAreaFields("data"),filters:[],skipValues:!0},o=new p;return t&&r?(c(t.levels||[t],(function(){a.push(s({},this,{expanded:!0,filterValues:null,sortOrder:"asc",sortBySummaryField:null}))})),r.load(i).done((function(e){de(i,e),n._sort(i,e),o.resolve(e.columns)})).fail(o)):o.reject(),o},reload:function(){return this.load({reload:!0})},filter:function(){var e=this._store;return e.filter.apply(e,arguments)},load:function(e){var n=this,t=new p;function r(){n._delayedLoadTask=void 0,n._descriptions?n._loadCore(e,t):h(ee(n)).done((function(r){n._fieldsPrepared(r),n._loadCore(e,t)})).fail(t.reject).fail(n._loadErrorHandler)}return e=e||{},n.beginLoading(),t.fail((function(e){n.fireEvent("loadError",[e])})).always((function(){n.endLoading()})),n.store()?n._delayedLoadTask=i.executeAsync(r):r(),t},createDrillDownDataSource:function(e){return this._store.createDrillDownDataSource(this._descriptions,e)},_createDescriptions:function(e){var n=this,t=this.fields(),r={rows:[],columns:[],values:[],filters:[]};c(["row","column","data","filter"],(function(n,r){_(ue(t,r),"areaIndex",e)})),c(t||[],(function(e,n){var a=O[n.area],i=r[a],s=n.groupName;s&&!o.isNumeric(n.groupIndex)&&(n.levels=Q(t,n)),!i||s&&o.isNumeric(n.groupIndex)||!1===n.visible&&"data"!==n.area&&"filter"!==n.area||(n.levels&&i!==r.filters&&i!==r.values?(i.push.apply(i,n.levels),n.filterValues&&n.filterValues.length&&r.filters.push(n)):i.push(n))})),c(r,(function(e,n){W(n)}));var a={};return c(r.values,(function(e,n){var i=n.calculateSummaryValue,s;o.isFunction(i)&&i(C.createMockSummaryCell(r,t,a))})),r},_fieldsPrepared:function(e){var n=this;this._fields=e,c(e,(function(e,n){n.index=e,M(n,N)}));var t=U(e,["caption"]);this.fireEvent("fieldsPrepared",[e]);for(var r=0;r<e.length;r++)e[r].caption!==t[r].caption&&B(e[r],"caption",e[r].caption,!0);this._descriptions=this._createDescriptions()},isLoading:function(){return this._loadingCount>0},state:function(e,n){var t=this;if(!arguments.length)return{fields:U(t._fields,b),columnExpandedPaths:z(t._data,t._descriptions,"columns"),rowExpandedPaths:z(t._data,t._descriptions,"rows")};e=s({rowExpandedPaths:[],columnExpandedPaths:[]},e),t._descriptions?(t._fields=K(e.fields,t._fields),t._descriptions=t._createDescriptions(),!n&&t.load(e)):(t.beginLoading(),h(ee(t)).done((function(r){t._fields=K(e.fields,r),t._fieldsPrepared(r),!n&&t.load(e)})).always((function(){t.endLoading()})))},beginLoading:function(){this._changeLoadingCount(1)},endLoading:function(){this._changeLoadingCount(-1)},_changeLoadingCount:function(e){var n,t=this.isLoading();this._loadingCount+=e,t^(n=this.isLoading())&&this.fireEvent("loadingChanged",[n])},_loadCore:function(e,n){var t=this,r=this._store,a=this._descriptions,i=O[e.area];e=e||{},r?(s(e,a),e.columnExpandedPaths=e.columnExpandedPaths||z(this._data,e,"columns",t._lastLoadOptions),e.rowExpandedPaths=e.rowExpandedPaths||z(this._data,e,"rows",t._lastLoadOptions),i&&(e.headerName=i),t.beginLoading(),n.always((function(){t.endLoading()})),h(r.load(e)).done((function(r){e.path?t.applyPartialDataSource(e.area,e.path,r,n):(s(t._data,r),t._lastLoadOptions=e,t._update(n))})).fail(n.reject)):t._update(n)},_sort:function(e,n,t){var r;this._store&&oe(e,n,t)},isEmpty:function(){var e=this.getAreaFields("data"),n=this.getData();return!e.length||!n.values.length},_update:function(e){var n=this,t=n._descriptions,r=n._data,a=t.values,i=R(a);return h(de(t,r),le(r.rows),le(r.columns)).done((function(){i&&(n._sort(t,r,i),!n.isEmpty()&&C.applyDisplaySummaryMode(t,r)),n._sort(t,r),!n.isEmpty()&&k(a)&&C.applyRunningTotal(t,r),n._data=r,h(e).done((function(){n.fireEvent("changed"),u(n._data.grandTotalRowIndex)&&(r.grandTotalRowIndex=n._data.grandTotalRowIndex),u(n._data.grandTotalColumnIndex)&&(r.grandTotalColumnIndex=n._data.grandTotalColumnIndex)})),e&&e.resolve(n._data)})),e},store:function(){return this._store},collapseHeaderItem:function(n,t){var r=this,a="column"===n?this._data.columns:this._data.rows,i=e(a,t),o=this.getAreaFields(n)[t.length-1];return!(!i||!i.children)&&(this.fireEvent("expandValueChanging",[{area:n,path:t,expanded:!1}]),o&&(o.expanded=!1),i.collapsedChildren=i.children,delete i.children,this._update(),!0)},collapseAll:function(e){var n=this,t=!1,r=this.field(e)||{},a=[d(r,this.getAreaFields(r.area))];r.expanded=!1,r&&r.levels&&(a=[],r.levels.forEach((function(e){a.push(d(e,n.getAreaFields(r.area))),e.expanded=!1}))),F(this._data[r.area+"s"],(function(e){var n=e[0],r=S(e);n&&n.children&&-1!==a.indexOf(r.length-1)&&(n.collapsedChildren=n.children,delete n.children,t=!0)}),!0),t&&this._update()},expandAll:function(e){var n=this.field(e);n&&n.area&&(n.expanded=!0,n&&n.levels&&n.levels.forEach((function(e){e.expanded=!0})),this.load())},expandHeaderItem:function(n,t){var r,a,i=this,o="column"===n?this._data.columns:this._data.rows,s=e(o,t);return!(!s||s.children)&&(a={area:n,path:t,expanded:!0,needExpandData:!(r=!!s.collapsedChildren)},this.fireEvent("expandValueChanging",[a]),r?(s.children=s.collapsedChildren,delete s.collapsedChildren,this._update()):this.load(a),r)},applyPartialDataSource:function(n,r,a,i){var o,s,d,l=this,u=l._data,c="column"===n?u.columns:u.rows;a&&a.values&&(a.rows=a.rows||[],a.columns=a.columns||[],(o=e(c,r))&&("column"===n?(d=t(c,o,a.columns,u.grandTotalColumnIndex),s=f(u.rows,a.rows)):(s=t(c,o,a.rows,u.grandTotalRowIndex),d=f(u.columns,a.columns)),h(s,d).done((function(e,t){("row"===n&&e.length||"column"===n&&t.length)&&v(u,a.values,e,t),l._update(i)}))))},dispose:function(){var e=this,n=this._delayedLoadTask;this._disposeEvents(),n&&n.abort(),this._isDisposed=!0},isDisposed:function(){return!!this._isDisposed}}}()).include(v),t.exports.default=t.exports}

