function module(e,t,a){"use strict";var n=e("../../core/renderer"),i=e("../../core/utils/icon"),r=e("../../core/utils/window").hasWindow(),s=e("../../core/utils/type").isDefined,o=e("../../core/utils/extend").extend,d=e("../../core/utils/array").inArray,l=e("../../core/utils/iterator"),c=e("../../localization/message"),u=e("../../core/component_registrator"),h=e("./ui.pivot_grid.utils"),p=e("../tree_view"),f=e("../context_menu"),_=e("./ui.pivot_grid.field_chooser_base"),x=l.each,m="<div>";e("./data_source");var v="dx-pivotgridfieldchooser",g="dx-pivotgridfieldchooser-container",C="dx-pivotgrid-fields-container",S="dx-pivotgrid-drag-action";function T(e,t){var a=[];if(e.items)for(var n=0;n<e.items.length;n++)a.push.apply(a,T(e.items[n],t));else s(e.index)&&a.push(t[e.index]);return a}function y(e,t){if(e.items)for(var a=0;a<e.items.length;a++){var n=y(e.items[a],t);if(n)return n}if(t(e))return e}var A=[function(e,t){var a,n;return-!!e.isMeasure+ +!!t.isMeasure},function(e,t){var a,n;return-!(!e.items||!e.items.length)+ +!(!t.items||!t.items.length)},function(e,t){var a,n;return+!!(!1===e.isMeasure&&e.field&&e.field.levels&&e.field.levels.length)+-!!(!1===t.isMeasure&&t.field&&t.field.levels&&t.field.levels.length)},h.getCompareFunction((function(e){return e.text}))];function M(e,t){for(var a=0,n=0;!a&&A[n];)a=A[n++](e,t);return a}function w(e){return e.find(".dx-scrollable").dxScrollable("instance")}var F=_.inherit({_getDefaultOptions:function(){return o(this.callBase(),{height:400,layout:0,dataSource:null,onContextMenuPreparing:null,allowSearch:!1,searchTimeout:500,texts:{columnFields:c.format("dxPivotGrid-columnFields"),rowFields:c.format("dxPivotGrid-rowFields"),dataFields:c.format("dxPivotGrid-dataFields"),filterFields:c.format("dxPivotGrid-filterFields"),allFields:c.format("dxPivotGrid-allFields")}})},_refreshDataSource:function(){var e=this;e._expandedPaths=[],e._changedHandler=e._changedHandler||function(){x(e._dataChangedHandlers,(function(e,t){t()})),e._fireContentReadyAction(),e._skipStateChange=!0,e.option("state",e._dataSource.state()),e._skipStateChange=!1},e._dataSource&&(e._dataSource.off("changed",e._changedHandler),e._dataSource=void 0),e.callBase(),e._dataSource&&e._dataSource.on("changed",e._changedHandler)},_init:function(){this.callBase(),this._refreshDataSource(),this._dataChangedHandlers=[],this._initActions()},_initActions:function(){this._actions={onContextMenuPreparing:this._createActionByOption("onContextMenuPreparing")}},_trigger:function(e,t){this._actions[e](t)},_setOptionsByReference:function(){this.callBase(),o(this._optionsByReference,{dataSource:!0})},_optionChanged:function(e){var t=this;switch(e.name){case"dataSource":this._refreshDataSource(),this._invalidate();break;case"layout":case"texts":case"allowSearch":case"searchTimeout":this._invalidate();break;case"onContextMenuPreparing":this._actions[e.name]=this._createActionByOption(e.name);break;default:this.callBase(e)}},_clean:function(e){!e&&this._dataSource&&this.option("state",this._dataSource.state()),this.$element().children("."+g).remove()},_renderLayout0:function(e){var t,a,i,r,s,o,d=this;e.addClass("dx-layout-0"),s=n(m).addClass("dx-row").appendTo(e),o=n(m).addClass("dx-row").appendTo(e),t=n(m).addClass("dx-col").appendTo(s),a=n(m).addClass("dx-col").appendTo(s),i=n(m).addClass("dx-col").appendTo(o),r=n(m).addClass("dx-col").appendTo(o),this._renderArea(t,"all"),this._renderArea(a,"row"),this._renderArea(a,"column"),this._renderArea(i,"filter"),this._renderArea(r,"data")},_renderLayout1:function(e){var t,a,i=this;t=n(m).addClass("dx-col").appendTo(e),a=n(m).addClass("dx-col").appendTo(e),this._renderArea(t,"all"),this._renderArea(a,"filter"),this._renderArea(a,"row"),this._renderArea(a,"column"),this._renderArea(a,"data")},_renderLayout2:function(e){var t,a,i,r,s=this;e.addClass("dx-layout-2"),i=n(m).addClass("dx-row").appendTo(e),this._renderArea(i,"all"),r=n(m).addClass("dx-row").appendTo(e),t=n(m).addClass("dx-col").appendTo(r),a=n(m).addClass("dx-col").appendTo(r),this._renderArea(t,"filter"),this._renderArea(t,"row"),this._renderArea(a,"column"),this._renderArea(a,"data")},_initMarkup:function(){var e=this,t=this.$element(),a=n(m).addClass(g).appendTo(t),i=this.option("layout");this.callBase(),t.addClass(v).addClass(C),this._dataChangedHandlers=[];var r=this._dataSource,s="instantly"!==this.option("applyChangesMode")&&r&&r.state();s&&this.option("state")&&r.state(this.option("state"),!0),0===i?this._renderLayout0(a):1===i?this._renderLayout1(a):this._renderLayout2(a),s&&r.state(s,!0)},_renderContentImpl:function(){this.callBase(),this.renderSortable(),this._renderContextMenu(),this.updateDimensions()},_fireContentReadyAction:function(){this._dataSource&&this._dataSource.isLoading()||this.callBase()},_getContextMenuArgs:function(e){var t,a,i=n(e.target).closest(".dx-area-field"),r=n(e.target).closest(".dx-area-fields");return i.length&&(t=i.data("field")),r.length&&(a=r.attr("group")),{event:e,field:t,area:a,items:[]}},_renderContextMenu:function(){var e=this,t=e.$element();e._contextMenu&&e._contextMenu.$element().remove(),e._contextMenu=e._createComponent(n(m).appendTo(t),f,{onPositioning:function(t){var a,n=t.event;n&&(a=e._getContextMenuArgs(n),e._trigger("onContextMenuPreparing",a),a.items&&a.items.length?t.component.option("items",a.items):t.cancel=!0)},target:t,onItemClick:function(e){e.itemData.onItemClick&&e.itemData.onItemClick(e)},cssClass:"dx-pivotgridfieldchooser-context-menu"})},_createTreeItems:function(e,t,a){var n,i=this,r=[],o=[],l=t[0],c={};return l?(x(e,(function(e,t){var a=t[l]||"";c[a]=c[a]||[],c[a].push(t),void 0===n&&(n=!0),n=n&&!0===t.isMeasure})),x(c,(function(e,n){var s=a?a+"."+e:e,l=i._createTreeItems(n,t.slice(1),s);e?o.push({key:e,text:e,path:s,isMeasure:l.isMeasure,expanded:d(s,i._expandedPaths)>=0,items:l}):r=l})),(r=o.concat(r)).isMeasure=n):x(e,(function(e,t){var a;!0===t.isMeasure&&(a="measure"),!1===t.isMeasure&&(a=t.groupName?"hierarchy":"dimension"),r.push({index:t.index,field:t,key:t.dataField,selected:s(t.area),text:t.caption||t.dataField,icon:a,isMeasure:t.isMeasure,isDefault:t.isDefault})})),r},_createFieldsDataSource:function(e){var t,a=e&&e.fields()||[];return a=a.filter((function(e){return!1!==e.visible&&!s(e.groupIndex)})),t=this._createTreeItems(a,["dimension","displayFolder"]),h.foreachDataLevel(t,(function(e){e.sort(M)}),0,"items"),t},_renderFieldsTreeView:function(e){var t=this,a=t._dataSource,r=t._createComponent(e,p,{dataSource:t._createFieldsDataSource(a),showCheckBoxesMode:"normal",searchEnabled:t.option("allowSearch"),searchTimeout:t.option("searchTimeout"),itemTemplate:function(e,t,a){e.icon&&i.getImageContainer(e.icon).appendTo(a),n("<span>").toggleClass("dx-area-field",!e.items).data("field",e.field).text(e.text).appendTo(a)},onItemCollapsed:function(e){var a=d(e.itemData.path,t._expandedPaths);a>=0&&t._expandedPaths.splice(a,1)},onItemExpanded:function(e){var a;d(e.itemData.path,t._expandedPaths)<0&&t._expandedPaths.push(e.itemData.path)},onItemSelectionChanged:function(e){var n,i,o,d=e.itemData,l=!0;if(d.items){if(d.selected)return void r.unselectItem(d);if(t._processDemandState((function(){i=T(d,a.fields());for(var e=0;e<i.length;e++)if(i[e].area){l=!1;break}})),l){var c=y(d,(function(e){return e.isDefault}))||y(d,(function(e){return s(e.index)}));return void(c&&r.selectItem(c))}}else n=a.fields()[d.index],d.selected&&(o=n.isMeasure?"data":"column"),n&&(i=[n]);t._applyChanges(i,{area:o,areaIndex:void 0})}}),o=function(){var n=w(e),i=n?n.scrollTop():0;r.option({dataSource:t._createFieldsDataSource(a)}),(n=w(e))&&(n.scrollTo({y:i}),n.update())};t._dataChangedHandlers.push(o)},_renderAreaFields:function(e,t){var a=this,n=a._dataSource,i=n?o(!0,[],n.getAreaFields(t,!0)):[];e.empty(),x(i,(function(t,n){!1!==n.visible&&a.renderField(n,!0).appendTo(e)}))},_renderArea:function(e,t){var a,i,r,s=this,o=n(m).addClass("dx-area").appendTo(e),d=n(m).addClass("dx-area-fields-header").appendTo(o),l=s.option("texts."+t+"Fields");n("<span>").addClass("dx-area-icon").addClass("dx-area-icon-"+t).appendTo(d),n("<span>").html("&nbsp;").appendTo(d),n("<span>").addClass("dx-area-caption").text(l).appendTo(d),a=n(m).addClass("dx-area-fields").addClass(S).appendTo(o),"all"!==t?(a.attr("group",t).attr("allow-scrolling",!0),i=n(m).addClass("dx-area-field-container").appendTo(a),r=function(){s._renderAreaFields(i,t)},s._dataChangedHandlers.push(r),r(),a.dxScrollable()):(o.addClass("dx-all-fields"),a.addClass("dx-treeview-border-visible"),s._renderFieldsTreeView(a))},_getSortableOptions:function(){return{}},_adjustSortableOnChangedArgs:function(){},resetTreeView:function(){var e=this.$element().find(".dx-treeview").dxTreeView("instance");e&&(e.option("searchValue",""),e.collapseAll())},applyChanges:function(){var e=this.option("state");s(e)&&this._dataSource.state(e)},cancelChanges:function(){var e=this._dataSource;return!e.isLoading()&&(this.option("state",e.state()),!0)},getDataSource:function(){return this._dataSource},updateDimensions:function(){var e;this.$element().find(".dx-area .dx-scrollable").dxScrollable("update")},_visibilityChanged:function(e){e&&r&&this.updateDimensions()}});u("dxPivotGridFieldChooser",F),a.exports=F}

