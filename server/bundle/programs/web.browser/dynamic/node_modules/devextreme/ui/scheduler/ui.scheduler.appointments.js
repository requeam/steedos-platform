function module(t,e,n){"use strict";var i,a=L(t("../../core/renderer")),o,s=L(t("../../core/dom_adapter")),r,l=L(t("../../events/core/events_engine")),p,c=L(t("../../core/element_data")),d,u=L(t("../../animation/translator")),h,m=L(t("../../core/utils/date")),f,g=L(t("../../core/utils/common")),_,D=L(t("../../core/utils/type")),v=t("../../core/utils/iterator"),A,b=L(t("../../core/utils/object")),y,k=L(t("../../core/utils/array")),C=t("../../core/utils/extend"),T=t("../../core/utils/dom"),x,w=L(t("./utils.recurrence")),E,I=L(t("../../core/component_registrator")),S,B=L(t("./ui.scheduler.publisher_mixin")),R,O=L(t("./ui.scheduler.appointment")),z,H=L(t("../../events/utils")),F,$=L(t("../../events/double_click")),P,j=L(t("../../localization/date")),M,V=L(t("../../localization/message")),K,N=L(t("../collection/ui.collection_widget.edit")),W,Z=L(t("../draggable")),G=t("../../core/utils/deferred");function L(t){return t&&t.__esModule?t:{default:t}}var q="dxAppointmentSettings",X="dx-scheduler-scrollable-appointments",J="dx-scheduler-appointment",Q="dx-scheduler-appointment-title",U="dx-scheduler-appointment-content-details",Y="dx-scheduler-appointment-content-date",tt="dx-scheduler-appointment-recurrence-icon",et="dx-scheduler-appointment-content-allday",nt=H.default.addNamespace($.default.name,"dxSchedulerAppointment"),it=m.default.dateToMilliseconds,at=N.default.inherit({_supportedKeys:function(){var t=this.callBase(),e=function(t){var e=this._getAccessAppointments(),n,i=e.filter(".dx-state-focused").data("dxAppointmentSettings").sortedIndex,a=e.length-1;if(i>0&&t.shiftKey||i<a&&!t.shiftKey){t.preventDefault(),t.shiftKey?i--:i++;var o=this._getAppointmentByIndex(i);this._resetTabIndex(o),l.default.trigger(o,"focus")}};return(0,C.extend)(t,{escape:function(){this.moveAppointmentBack(),this._escPressed=!0}.bind(this),del:function(t){if(this.option("allowDelete")){t.preventDefault();var e=this._getItemData(t.target);this.notifyObserver("deleteAppointment",{data:e,target:t.target}),this.notifyObserver("hideAppointmentTooltip")}}.bind(this),tab:e})},_getAppointmentByIndex:function(t){var e;return this._getAccessAppointments().filter((function(e,n){return c.default.data(n,"dxAppointmentSettings").sortedIndex===t})).eq(0)},_getAccessAppointments:function(){return this._itemElements().filter(":visible").not(".dx-state-disabled")},_resetTabIndex:function(t){this._focusTarget().attr("tabIndex",-1),t.attr("tabIndex",this.option("tabIndex"))},_moveFocus:g.default.noop,_focusTarget:function(){return this._itemElements()},_renderFocusTarget:function(){var t=this._getAppointmentByIndex(0);this._resetTabIndex(t)},_focusInHandler:function(t){if(this._targetIsDisabled(t))t.stopPropagation();else{clearTimeout(this._appointmentFocusedTimeout),this.callBase.apply(this,arguments),this._$currentAppointment=(0,a.default)(t.target),this.option("focusedElement",(0,T.getPublicElement)((0,a.default)(t.target)));var e=this;this._appointmentFocusedTimeout=setTimeout((function(){e.notifyObserver("appointmentFocused")}))}},_targetIsDisabled:function(t){return(0,a.default)(t.currentTarget).is(".dx-state-disabled, .dx-state-disabled *")},_focusOutHandler:function(){var t=this._getAppointmentByIndex(0);this.option("focusedElement",(0,T.getPublicElement)(t)),this.callBase.apply(this,arguments)},_eventBindingTarget:function(){return this._itemContainer()},_getDefaultOptions:function(){return(0,C.extend)(this.callBase(),{noDataText:null,activeStateEnabled:!0,hoverStateEnabled:!0,tabIndex:0,fixedContainer:null,allDayContainer:null,allowDrag:!0,allowResize:!0,allowAllDayResize:!0,onAppointmentDblClick:null,_appointmentGroupButtonOffset:0})},_optionChanged:function(t){switch(t.name){case"items":this._cleanFocusState(),this._clearDropDownItems(),this._clearDropDownItemsElements(),this._repaintAppointments(t.value),this._renderDropDownAppointments(),this._attachAppointmentsEvents();break;case"fixedContainer":case"allDayContainer":case"onAppointmentDblClick":break;case"allowDrag":case"allowResize":case"allowAllDayResize":this._invalidate();break;case"focusedElement":this._resetTabIndex((0,a.default)(t.value)),this.callBase(t);break;case"allowDelete":break;case"focusStateEnabled":this._clearDropDownItemsElements(),this._renderDropDownAppointments(),this.callBase(t);break;default:this.callBase(t)}},_isAllDayAppointment:function(t){return t.settings.length&&t.settings[0].allDay||!1},_isRepaintAppointment:function(t){return!D.default.isDefined(t.needRepaint)||!0===t.needRepaint},_isRepaintAll:function(t){if(this.invoke("isCurrentViewAgenda"))return!0;for(var e=0;e<t.length;e++){var n=t[e];if(!this._isRepaintAppointment(n))return!1}return!0},_applyFragment:function(t,e){t.children().length>0&&this._getAppointmentContainer(e).append(t)},_onEachAppointment:function(t,e,n,i){t&&!0===t.needRemove?this._clearItem(t):this._isRepaintAppointment(t)&&(t.needRepaint=!1,!i&&this._clearItem(t),this._renderItem(e,t,n))},_repaintAppointments:function(t){var e=this,n=this._isRepaintAll(t),i=(0,a.default)(this._getAppointmentContainer(!0)),o=(0,a.default)(this._getAppointmentContainer(!1));n&&(this._getAppointmentContainer(!0).html(""),this._getAppointmentContainer(!1).html("")),!t.length&&this._cleanItemContainer(),t.forEach((function(t,a){var s=e._isAllDayAppointment(t)?i:o;e._onEachAppointment(t,a,s,n)})),this._applyFragment(i,!0),this._applyFragment(o,!1)},_attachAppointmentsEvents:function(){this._attachClickEvent(),this._attachHoldEvent(),this._attachContextMenuEvent(),this._attachAppointmentDblClick(),this._renderFocusState(),this._attachFeedbackEvents(),this._attachHoverEvents()},_clearItem:function(t){var e=this._findItemElementByItem(t.itemData);e.length&&(0,v.each)(e,(function(t,e){e.detach(),e.remove()}))},_clearDropDownItems:function(){this._virtualAppointments={}},_clearDropDownItemsElements:function(){var t=this._getDropDownAppointments();t.length&&(0,v.each)(t,(function(t,e){(0,a.default)(e).detach(),(0,a.default)(e).remove()}))},_getDropDownAppointments:function(){return this._itemContainer().find(".dx-scheduler-dropdown-appointments")},_findItemElementByItem:function(t){var e=[],n=this;return this.itemElements().each((function(){var i=(0,a.default)(this);i.data(n._itemDataKey())===t&&e.push(i)})),e},_itemClass:function(){return J},_itemContainer:function(){var t=this.callBase(),e=t,n=this.option("allDayContainer");return n&&(e=t.add(n)),e},_cleanItemContainer:function(){this.callBase();var t=this.option("allDayContainer");t&&t.empty(),this._virtualAppointments={}},_clean:function(){this.callBase(),delete this._$currentAppointment,delete this._initialSize,delete this._initialCoordinates},_init:function(){this.callBase(),this.$element().addClass(X),this._preventSingleAppointmentClick=!1},_renderAppointmentTemplate:function(t,e,n){var i=n.settings?new Date(this.invoke("getField","startDate",n.settings)):e.startDate,o=n.settings?new Date(this.invoke("getField","endDate",n.settings)):e.endDate;(isNaN(i)||isNaN(o))&&(i=e.startDate,o=e.endDate),(0,a.default)("<div>").text(this._createAppointmentTitle(e)).addClass(Q).appendTo(t),D.default.isPlainObject(e)&&e.html&&t.html(e.html);var s=e.recurrenceRule,r=e.allDay,l=(0,a.default)("<div>").addClass(U),p=e.startDateTimeZone,c=e.endDateTimeZone;i=this.invoke("convertDateByTimezone",i,p),o=this.invoke("convertDateByTimezone",o,c),(0,a.default)("<div>").addClass(Y).text(j.default.format(i,"shorttime")).appendTo(l),(0,a.default)("<div>").addClass(Y).text(" - ").appendTo(l),(0,a.default)("<div>").addClass(Y).text(j.default.format(o,"shorttime")).appendTo(l),l.appendTo(t),s&&(0,a.default)("<span>").addClass(tt+" dx-icon-repeat").appendTo(t),r&&(0,a.default)("<div>").text(" "+V.default.format("dxScheduler-allDay")+": ").addClass(et).prependTo(l)},_createAppointmentTitle:function(t){return D.default.isPlainObject(t)?t.text:String(t)},_executeItemRenderAction:function(t,e,n){var i=this._getItemRenderAction();i&&i({appointmentElement:n,appointmentData:e,targetedAppointmentData:this.invoke("getTargetedAppointmentData",e,n,t)}),delete this._currentAppointmentSettings},_itemClickHandler:function(t){this.callBase(t,{},{afterExecute:function(t){this._processItemClick(t.args[0].event)}.bind(this)})},_processItemClick:function(t){var e=(0,a.default)(t.currentTarget),n=this._getItemData(e);this._targetIsDisabled(t)?t.stopPropagation():"keydown"===t.type||H.default.isFakeClickEvent(t)?this.notifyObserver("showEditAppointmentPopup",{data:n,target:e}):this._appointmentClickTimeout=setTimeout(function(){!this._preventSingleAppointmentClick&&s.default.getBody().contains(e[0])&&this.notifyObserver("showAppointmentTooltip",{data:n,target:e}),this._preventSingleAppointmentClick=!1}.bind(this),300)},_extendActionArgs:function(){var t=this.callBase.apply(this,arguments);return this.invoke("mapAppointmentFields",t)},_render:function(){this.callBase.apply(this,arguments),this._attachAppointmentDblClick()},_attachAppointmentDblClick:function(){var t=this,e=t._itemSelector(),n=this._itemContainer();l.default.off(n,nt,e),l.default.on(n,nt,e,(function(e){t._itemDXEventHandler(e,"onAppointmentDblClick",{},{afterExecute:function(e){t._dblClickHandler(e.args[0].event)}})}))},_dblClickHandler:function(t){var e=(0,a.default)(t.currentTarget),n=this._getItemData(e);clearTimeout(this._appointmentClickTimeout),this._preventSingleAppointmentClick=!0,this.notifyObserver("showEditAppointmentPopup",{data:n,target:e})},_renderItem:function(t,e,n){for(var i=e.itemData,a=0;a<e.settings.length;a++){var o=e.settings[a],s;this._currentAppointmentSettings=o,this.callBase(t,i,n).data("dxAppointmentSettings",o)}},_getItemContent:function(t){var e;return t.data("dxAppointmentSettings",this._currentAppointmentSettings),this.callBase(t)},_createItemByTemplate:function(t,e){return t.render({model:e.itemData,container:e.container,index:e.index})},_getAppointmentContainer:function(t){var e=this.option("allDayContainer"),n=this.itemsContainer().not(e);return t&&e&&(n=e),n},_postprocessRenderItem:function(t){this._renderAppointment(t.itemElement,this._currentAppointmentSettings)},_renderAppointment:function(t,e){t.data("dxAppointmentSettings",e),this._applyResourceDataAttr(t);var n=this._getItemData(t),i=this.invoke("getAppointmentGeometry",e),a=!e.isCompact&&this.option("allowResize")&&(!D.default.isDefined(e.skipResizing)||D.default.isString(e.skipResizing)),o=this.option("allowDrag"),s=e.allDay;this.invoke("setCellDataCacheAlias",this._currentAppointmentSettings,i);var r=this._getAppointmentColor(t,e.groupIndex);e.virtual?this._processVirtualAppointment(e,t,n,r):(this._createComponent(t,O.default,{observer:this.option("observer"),data:n,geometry:i,direction:e.direction||"vertical",allowResize:a,allowDrag:o,allDay:s,reduced:e.appointmentReduced,isCompact:e.isCompact,startDate:new Date(e.startDate),cellWidth:this.invoke("getCellWidth"),cellHeight:this.invoke("getCellHeight"),resizableConfig:this._resizableConfig(n,e)}),r.done((function(e){e&&t.css("backgroundColor",e)})),this._renderDraggable(t,s))},_applyResourceDataAttr:function(t){this.notifyObserver("getResourcesFromItem",{itemData:this._getItemData(t),callback:function(e){e&&(0,v.each)(e,(function(e,n){for(var i="data-"+g.default.normalizeKey(e.toLowerCase())+"-",a=0;a<n.length;a++)t.attr(i+g.default.normalizeKey(n[a]),!0)}))}})},_resizableConfig:function(t,e){return{area:this._calculateResizableArea(e,t),onResizeStart:function(t){if(this._$currentAppointment=(0,a.default)(t.element),this.invoke("needRecalculateResizableArea")){var e=this._calculateResizableArea(this._$currentAppointment.data("dxAppointmentSettings"),this._$currentAppointment.data("dxItemData"));t.component.option("area",e),t.component._renderDragOffsets(t.event)}this._initialSize={width:t.width,height:t.height},this._initialCoordinates=u.default.locate(this._$currentAppointment)}.bind(this),onResizeEnd:function(t){this._escPressed?t.event.cancel=!0:this._resizeEndHandler(t)}.bind(this)}},_calculateResizableArea:function(t,e){var n=this.$element().closest(".dx-scrollable-content");return this.notifyObserver("getResizableAppointmentArea",{coordinates:{left:t.left,top:0,groupIndex:t.groupIndex},allDay:t.allDay,callback:function(t){t&&(n=t)}}),n},_resizeEndHandler:function(t){var e=(0,a.default)(t.element),n=this._getItemData(e),i=this.invoke("getStartDate",n,!0),o=this.invoke("getEndDate",n,!0),s=this._getDateRange(t,i,o),r={};this.invoke("setField","startDate",r,new Date(s[0])),this.invoke("setField","endDate",r,new Date(s[1]));var l=(0,C.extend)({},n,r);this.notifyObserver("updateAppointmentAfterResize",{target:n,data:l,$appointment:e})},_getDateRange:function(t,e,n){var i,a,o=this._getItemData(t.element),s=this.invoke("getDeltaTime",t,this._initialSize,o),r=this.invoke("getRenderingStrategyDirection"),l=!1,p=this.invoke("isAllDay",o),c=this.invoke("needCorrectAppointmentDates")&&!p;return(l="vertical"!==r||p?this.option("rtlEnabled")?t.handles.right:t.handles.left:t.handles.top)?(i=c?this._correctStartDateByDelta(e,s):e.getTime()-s,a=n.getTime()):(i=e.getTime(),a=c?this._correctEndDateByDelta(n,s):n.getTime()+s),[i,a]},_correctEndDateByDelta:function(t,e){var n=this.invoke("getEndDayHour"),i=this.invoke("getStartDayHour"),a=t.getTime()+e,o=(n-i)*it("hour"),s=Math.ceil(e/o),r=new Date(t);if(r.setHours(n,0,0,0),a>r.getTime()){var l,p=e-(r.getTime()-t.getTime()),c=new Date(t.setDate(t.getDate()+s));c.setHours(i),a=c.getTime()+p-o*(s-1)}return a},_correctStartDateByDelta:function(t,e){var n=this.invoke("getEndDayHour"),i=this.invoke("getStartDayHour"),a=t.getTime()-e,o=(n-i)*it("hour"),s=Math.ceil(e/o),r=new Date(t);if(r.setHours(i,0,0,0),a<r.getTime()){var l,p=e-(t.getTime()-r.getTime()),c=new Date(t.setDate(t.getDate()-s));c.setHours(n),a=c.getTime()-p+o*(s-1)}return a},_getAppointmentColor:function(t,e){var n=new G.Deferred;return this.notifyObserver("getAppointmentColor",{itemData:this._getItemData(t),groupIndex:e,callback:function(t){t.done((function(t){n.resolve(t)}))}}),n.promise()},_renderDraggable:function(t,e){if(this.option("allowDrag")){var n,i=this,o=this.option("fixedContainer"),s=function(n,o){var s=u.default.locate((0,a.default)(n));i.notifyObserver("correctAppointmentCoordinates",{coordinates:s,allDay:e,isFixedContainer:o,callback:function(t){t&&(s=t)}}),u.default.move(t,s)};this.notifyObserver("getDraggableAppointmentArea",{callback:function(t){t&&(n=t)}}),this._createComponent(t,Z.default,{area:n,boundOffset:i._calculateBoundOffset(),immediate:!1,onDragStart:function(e){var n=e.event;i._skipDraggableRestriction(n),i.notifyObserver("hideAppointmentTooltip"),o.append(t),i._$currentAppointment=(0,a.default)(e.element),i._initialSize={width:e.width,height:e.height},i._initialCoordinates=u.default.locate(i._$currentAppointment)},onDrag:function(t){s(t.element)},onDragEnd:function(n){var a;s(n.element,!0),i._getAppointmentContainer(e).append(t),this._escPressed?n.event.cancel=!0:i._dragEndHandler(n)}})}},_calculateBoundOffset:function(){var t={top:0};return this.notifyObserver("getBoundOffset",{callback:function(e){t=e}}),t},_skipDraggableRestriction:function(t){this.option("rtlEnabled")?t.maxLeftOffset=null:t.maxRightOffset=null,t.maxBottomOffset=null},_dragEndHandler:function(t){var e=(0,a.default)(t.element),n=this._getItemData(e),i=this._initialCoordinates;this.notifyObserver("updateAppointmentAfterDrag",{data:n,$appointment:e,coordinates:i})},_virtualAppointments:{},_processVirtualAppointment:function(t,e,n,i){var a=t.virtual,o=a.index;D.default.isDefined(this._virtualAppointments[o])||(this._virtualAppointments[o]={coordinates:{top:a.top,left:a.left},items:{data:[],colors:[]},isAllDay:!!a.isAllDay,buttonColor:i}),n.settings=[t],this._virtualAppointments[o].items.data.push(n),this._virtualAppointments[o].items.colors.push(i),e.remove()},_renderContentImpl:function(){this.callBase(),this._renderDropDownAppointments()},_renderDropDownAppointments:function(){(0,v.each)(this._virtualAppointments,function(t){var e=this._virtualAppointments[t],n=e.items,i=e.coordinates,a=e.isAllDay?this.option("allDayContainer"):this.$element(),o=i.left,s=this.invoke("getCompactAppointmentGroupMaxWidth",e.isAllDay),r=0;this.option("rtlEnabled")&&(r=s),this.notifyObserver("renderDropDownAppointments",{$container:a,coordinates:{top:i.top,left:o+r},items:n,buttonColor:e.buttonColor,itemTemplate:this.option("itemTemplate"),buttonWidth:s-this.option("_appointmentGroupButtonOffset"),onAppointmentClick:this.option("onItemClick"),isCompact:!e.isAllDay&&this.invoke("supportCompactDropDownAppointments")})}.bind(this))},_sortAppointmentsByStartDate:function(t){t.sort(function(t,e){var n=0,i=new Date(this.invoke("getField","startDate",t.settings||t)).getTime(),a=new Date(this.invoke("getField","startDate",e.settings||e)).getTime();return i<a&&(n=-1),i>a&&(n=1),n}.bind(this))},_processRecurrenceAppointment:function(t,e,n){var i=this.invoke("getField","recurrenceRule",t),a={parts:[],indexes:[]};if(i){for(var o=t.settings||t,s=new Date(this.invoke("getField","startDate",o)),r=new Date(this.invoke("getField","endDate",o)),l=r.getTime()-s.getTime(),p=this.invoke("getField","recurrenceException",t),c=this.invoke("getStartViewDate"),d=this.invoke("getEndViewDate"),u=w.default.getDatesByRecurrence({rule:i,exception:p,start:s,end:r,min:c,max:d}),h=t.settings?1:u.length,m=0;m<h;m++){var f=(0,C.extend)({},t,!0);if(u[m]){var g=this._applyStartDateToObj(u[m],{});this._applyEndDateToObj(new Date(u[m].getTime()+l),g),f.settings=g}else f.settings=o;a.parts.push(f),n||this._processLongAppointment(f,a)}a.indexes.push(e)}return a},_processLongAppointment:function(t,e){var n=this.splitAppointmentByDay(t),i=n.length,a=this.invoke("getEndViewDate").getTime(),o=this.invoke("getStartViewDate").getTime(),s=this.invoke("getField","startDateTimeZone",t);if(e=e||{parts:[]},i>1){(0,C.extend)(t,n[0]);for(var r=1;r<i;r++){var l=this.invoke("getField","startDate",n[r].settings).getTime();(l=this.invoke("convertDateByTimezone",l,s))<a&&l>o&&e.parts.push(n[r])}}return e},_reduceRecurrenceAppointments:function(t,e){(0,v.each)(t,(function(t,n){e.splice(n-t,1)}))},_combineAppointments:function(t,e){e.length&&k.default.merge(t,e),this._sortAppointmentsByStartDate(t)},_applyStartDateToObj:function(t,e){return this.invoke("setField","startDate",e,t),e},_applyEndDateToObj:function(t,e){return this.invoke("setField","endDate",e,t),e},updateDraggablesBoundOffsets:function(){this.option("allowDrag")&&this.$element().find("."+J).each(function(t,e){var n=(0,a.default)(e),i=this._getItemData(n);this.invoke("isAllDay",i)||Z.default.getInstance(n).option("boundOffset",this._calculateBoundOffset())}.bind(this))},moveAppointmentBack:function(){var t=this._$currentAppointment,e=this._initialSize,n=this._initialCoordinates;t&&(n&&(u.default.move(t,n),delete this._initialSize),e&&(t.outerWidth(e.width),t.outerHeight(e.height),delete this._initialCoordinates))},focus:function(){var t=this._$currentAppointment;t&&(this.option("focusedElement",(0,T.getPublicElement)(t)),l.default.trigger(this.option("focusedElement"),"focus"))},splitAppointmentByDay:function(t){var e=t.settings||t,n=new Date(this.invoke("getField","startDate",e)),i=m.default.makeDate(n),a=m.default.makeDate(this.invoke("getField","endDate",e)),o=this.invoke("getField","startDateTimeZone",t),s=this.invoke("getField","endDateTimeZone",t),r=this.invoke("getEndViewDate"),l=this.invoke("getStartDayHour"),p=this.invoke("getEndDayHour"),c=this.invoke("appointmentTakesSeveralDays",t),d=[];for(i=this.invoke("convertDateByTimezone",i,o),a=this.invoke("convertDateByTimezone",a,s),i.getHours()<=p&&i.getHours()>=l&&!c&&(d.push(this._applyStartDateToObj(new Date(i),{appointmentData:t})),i.setDate(i.getDate()+1));c&&i.getTime()<a.getTime()-1&&i<r;){var u=new Date(i),h=new Date(i);this._checkStartDate(u,n,l),this._checkEndDate(h,a,p);var f=b.default.deepExtendArraySafe({},t,!0),g={};this._applyStartDateToObj(u,g),this._applyEndDateToObj(h,g),f.settings=g,d.push(f),i.setDate(i.getDate()+1),i.setHours(l)}return d},_checkStartDate:function(t,e,n){!m.default.sameDate(t,e)||t.getHours()<=n?t.setHours(n,0,0,0):t.setHours(e.getHours(),e.getMinutes(),e.getSeconds(),e.getMilliseconds())},_checkEndDate:function(t,e,n){!m.default.sameDate(t,e)||t.getHours()>n?t.setHours(n,0,0,0):t.setHours(e.getHours(),e.getMinutes(),e.getSeconds(),e.getMilliseconds())}}).include(B.default);(0,I.default)("dxSchedulerAppointments",at),n.exports=at}

