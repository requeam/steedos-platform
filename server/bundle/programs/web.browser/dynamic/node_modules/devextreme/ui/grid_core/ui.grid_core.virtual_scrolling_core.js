function module(e,t){"use strict";var i,n=f(e("../../core/renderer")),o=e("../../core/utils/window"),r,a=f(e("../../events/core/events_engine")),s,c=f(e("../../core/utils/browser")),u=e("../../core/utils/type"),l,h=f(e("../../animation/position")),d=e("../../core/utils/iterator"),p,g=f(e("../../core/class")),_=e("../../core/utils/deferred");function f(e){return e&&e.__esModule?e:{default:e}}var v="infinite",m="virtual",I=function(e){return"virtual"===e.option("scrolling.mode")||e._isVirtual},S=function(e){return"infinite"===e.option("scrolling.mode")&&!e._isVirtual},w,x,C,z,P,b,y,T,V;t.getPixelRatio=function(e){return e.devicePixelRatio||1},t.getContentHeightLimit=function(e){return e.msie?4e6:e.mozilla?8e6:15e6/t.getPixelRatio((0,o.getWindow)())},t.subscribeToExternalScrollers=function(e,t,i){var r,s=[],c=[],u=[];function l(t){var i=t.element?t.$element():t,n=h.default.offset(i);return n?t.scrollTop()-(n.top-e.offset().top):e.offset().top}function p(e){return function(){var i=e.scrollTop()-l(e);t(i=i>0?i:0)}}var g={on:function(e,t,i){e.on("scroll",i)},off:function(e,t,i){e.off("scroll",i)}};function _(e){var t="#document"===e.get(0).nodeName,i=e.data("dxScrollable"),r=g;if(i||(i=t&&(0,n.default)((0,o.getWindow)())||"auto"===e.css("overflowY")&&e,r=a.default,i)){var h=p(i);r.on(i,"scroll",h),c.push((function(e){var t=l(i),n=i.scrollTo?"scrollTo":"scrollTop";e-t>=0&&i[n](e+t)})),s.push(i),u.push((function(){r.off(i,"scroll",h)}))}}for(r=(i=i||e).parent();r.length;r=r.parent())_(r);return{scrollTo:function(e){(0,d.each)(c,(function(t,i){i(e)}))},dispose:function(){(0,d.each)(u,(function(e,t){t()}))}}},t.VirtualScrollController=g.default.inherit((w=function(e){var t=e._dataSource.pageSize(),i;if(e.option("scrolling.preventPreload"))return 0;var n=e._viewportSize;if(I(e)&&!1===e.option("legacyRendering")&&e.option("scrolling.removeInvisiblePages")){n=0;for(var o=e._viewportSize*e._viewportItemSize,r=e.getContentOffset(),a=e._position||0,s=e.virtualItemsCount(),c=e._dataSource.totalItemsCount(),u=s.begin;u<c&&!(r>=a+o);u++){var l;(r+=e._itemSizes[u]||e._viewportItemSize)>=a&&n++}}return t&&n>0?Math.ceil(n/t):1},x=function(e,t){var i=e.option("scrolling.preloadEnabled"),n=w(e);return n&&(t?n=i?1:0:(i&&n++,S(e)&&n--)),n},C=function(e){var t,i,n,o=-1,r=z(e),a=e._dataSource;return r<0?o=e._pageIndex:e._cache[e._pageIndex-r]?r>=0&&e._viewportSize>=0&&(r>0&&(i=(n=P(e)+1===a.pageCount()&&e._cache.length<x(e)+1)||e._pageIndex===r&&x(e,!0))&&(o=r-1),o<0&&(t=r+e._cache.length<=e._pageIndex+x(e))&&(o=r+e._cache.length)):(e._loadingPageIndex!==e._pageIndex||e._isVirtual)&&(o=e._pageIndex),o},z=function(e){return e._cache.length?e._cache[0].pageIndex:-1},P=function(e){return e._cache.length?e._cache[e._cache.length-1].pageIndex:-1},b=function(e,t,i){e._isChangedFiring=!0,t(i),e._isChangedFiring=!1},y=function(e,t,i){if(e._isDelayChanged)return e._isDelayChanged=!1,b(e,t,i),!0},T=function(e,t,i,n,o){var r=e._dataSource,a=r.items().slice(),s=(0,u.isObject)(i)?i:void 0,c="prepend"===i,l=r.viewportItems();i&&(0,u.isString)(i)&&!e._isDelayChanged&&(s={changeType:i,items:a},o&&(s.removeCount=o.itemsCount,s.removeCount&&r.correctCount&&(s.removeCount=r.correctCount(l,s.removeCount,c))));var h=o?o.itemsLength:0;h&&r.correctCount&&(h=r.correctCount(l,h,c)),"append"===i?(l.push.apply(l,a),o&&l.splice(0,h)):c?(l.unshift.apply(l,a),o&&l.splice(-h)):e._dataSource.viewportItems(a),r.updateLoading(),e._lastPageIndex=e.pageIndex(),e._isDelayChanged=n,n||b(e,t,s)},V=function(e,t){var i=e._dataSource;if(t===e.pageIndex()||!i.isLoading()&&t<i.pageCount()||!i.hasKnownLastPage()&&t===i.pageCount())return i.pageIndex(t),e._loadingPageIndex=t,(0,_.when)(i.load()).always((function(){e._loadingPageIndex=-1}))},{ctor:function(e,t,i){var n=this;this._dataSource=t,this.component=e,this._pageIndex=this._lastPageIndex=t.pageIndex(),this._viewportSize=0,this._viewportItemSize=20,this._viewportItemIndex=-1,this._itemSizes={},this._sizeRatio=1,this._items=[],this._cache=[],this._isVirtual=i,this._loadingPageIndex=-1},getItemSizes:function(){return this._itemSizes},option:function(){return this.component.option.apply(this.component,arguments)},virtualItemsCount:function(){var e,t,i,n=this,o=0;if(I(this))return(e=z(this))<0&&(e=this._dataSource.pageIndex()),t=e*this._dataSource.pageSize(),o=this._cache.length*this._dataSource.pageSize(),{begin:t,end:i=Math.max(0,this._dataSource.totalItemsCount()-o-t)}},setViewportPosition:function(e){var t=this,i=new _.Deferred,n=Math.min(t.option("scrolling.timeout")||0,t._dataSource.changingDuration());return n<t.option("scrolling.renderingThreshold")&&(n=t.option("scrolling.minTimeout")||0),clearTimeout(t._scrollTimeoutID),n>0?t._scrollTimeoutID=setTimeout((function(){t._setViewportPositionCore(e),i.resolve()}),n):(t._setViewportPositionCore(e),i.resolve()),i.promise()},getViewportPosition:function(){return this._position||0},getItemIndexByPosition:function(){for(var e,t=this,i=this._position,n=this.getItemSize(),o=0,r=0,a=Object.keys(this._itemSizes).concat(-1),s=0;s<a.length&&o<i;s++){var c=parseInt(a[s]),u=(i-o)/n;if(c<0||r+u<c){r+=u;break}o+=(u=c-r)*n,r+=u,r+=(o+=e=this._itemSizes[c])<i?1:(i-o+e)/e}return Math.round(50*r)/50},_setViewportPositionCore:function(e){this._position=e;var t=this.getItemIndexByPosition();return this.setViewportItemIndex(t)},setContentSize:function(e){var i=this,n=Array.isArray(e)&&e,o=i.virtualItemsCount();if(n&&(e=n.reduce((function(e,t){return e+t}),0)),i._contentSize=e,o){n&&n.forEach((function(e,t){i._itemSizes[o.begin+t]=e}));var r=(o.begin+o.end+i.itemsCount())*i._viewportItemSize,a=t.getContentHeightLimit(c.default);i._sizeRatio=r>a?a/r:1}},getItemSize:function(){return this._viewportItemSize*this._sizeRatio},getItemOffset:function(e,t){var i=this,n=i.virtualItemsCount(),o=e;if(!n)return 0;var r=0,a=i._dataSource.totalItemsCount();return Object.keys(i._itemSizes).forEach((function(n){o&&(t?n>=a-e:n<e)&&(r+=i._itemSizes[n],o--)})),Math.floor(r+o*i._viewportItemSize*i._sizeRatio)},getContentOffset:function(e){var t="end"===e,i=this.virtualItemsCount();return i?this.getItemOffset(t?i.end:i.begin,t):0},getVirtualContentSize:function(){var e=this,t=this.virtualItemsCount();return t?(t.begin+t.end)*this._viewportItemSize*this._sizeRatio+this._contentSize:0},getViewportItemIndex:function(){return this._viewportItemIndex},setViewportItemIndex:function(e){var t,i,n,o=this,r=this._dataSource.pageSize(),a=this._dataSource.pageCount(),s=I(this),c=S(this),u=this._dataSource.totalItemsCount(),l=this._viewportItemIndex<0;if(this._viewportItemIndex=e,r&&(s||c)&&u>=0)return this._viewportSize&&e+this._viewportSize>=u&&!this._isVirtual?this._dataSource.hasKnownLastPage()?(t=u%r,(n=a-1)>0&&t>0&&t<r/2&&n--):n=a:(n=Math.floor(e/r),i=a-1,n=Math.max(n,0),n=Math.min(n,i)),(this.pageIndex()!==n||l)&&this.pageIndex(n),this.load()},viewportItemSize:function(e){return void 0!==e&&(this._viewportItemSize=e),this._viewportItemSize},viewportSize:function(e){return void 0!==e&&(this._viewportSize=e),this._viewportSize},pageIndex:function(e){return I(this)||S(this)?(void 0!==e&&(this._pageIndex=e),this._pageIndex):this._dataSource.pageIndex(e)},beginPageIndex:function e(t){var e=z(this);return e<0&&(e=void 0!==t?t:this.pageIndex()),e},endPageIndex:function e(){var e=P(this);return e>0?e:this._lastPageIndex},pageSize:function(){return this._dataSource.pageSize()},load:function(){var e,t,i,n=this,o=n._dataSource;return I(n)||S(n)?(e=C(n))>=0&&(t=V(n,e))&&(i=new _.Deferred,t.done((function(){var e=n._delayDeferred;e?e.done(i.resolve).fail(i.reject):i.resolve()})).fail(i.reject),o.updateLoading()):i=o.load(),i||n._lastPageIndex===n.pageIndex()||n._dataSource.onChanged({changeType:"pageIndex"}),i||(new _.Deferred).resolve()},loadIfNeed:function(){var e=this;if((I(this)||S(this))&&!this._dataSource.isLoading()&&(!this._isChangedFiring||this._isVirtual)){var t=this.getViewportPosition();t>0?this._setViewportPositionCore(t):this.load()}},handleDataChanged:function(e,t){var i,n,o,r,a=this,s=a._dataSource,c=a._cache.length;if(t&&t.changes)b(a,e,t);else if(I(a)||S(a)){if((i=z(a))>=0&&(I(a)&&i+a._cache.length!==s.pageIndex()&&i-1!==s.pageIndex()&&(c=0,a._cache=[]),S(a)))if(0===s.pageIndex())a._cache=[];else if(s.pageIndex()<P(a))return void b(a,e,{changeType:"append",items:[]});var u;r={pageIndex:s.pageIndex(),itemsLength:s.items(!0).length,itemsCount:a.itemsCount(!0)},!a.option("legacyRendering")&&a.option("scrolling.removeInvisiblePages")&&I(a)?o=a._cache.length>Math.max(x(this)+(a.option("scrolling.preloadEnabled")?1:0),2):y(a,e,{isDelayed:!0}),i===s.pageIndex()+1?(o&&(u=a._cache.pop()),n="prepend",a._cache.unshift(r)):(o&&(u=a._cache.shift()),n="append",a._cache.push(r));var l=I(a)&&0===c;T(a,e,a._cache.length>1?n:void 0,l,u),a._delayDeferred=a.load().done((function(){y(a,e)&&a.load()}))}else T(a,e,t)},itemsCount:function e(t){var e=0;return!t&&I(this)?(0,d.each)(this._cache,(function(){e+=this.itemsCount})):e=this._dataSource.itemsCount(),e},reset:function(){this._cache=[],this._itemSizes={}},subscribeToWindowScrollEvents:function(e){var i=this;i._windowScroll=i._windowScroll||t.subscribeToExternalScrollers(e,(function(e){i.viewportItemSize()&&i.setViewportPosition(e)}))},dispose:function(){clearTimeout(this._scrollTimeoutID),this._windowScroll&&this._windowScroll.dispose(),this._windowScroll=null},scrollTo:function(e){this._windowScroll&&this._windowScroll.scrollTo(e)}}))}

