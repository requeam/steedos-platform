function module(e,o,t){"use strict";var n,i=f(e("../../core/renderer")),s,r=f(e("./ui.grid_core.modules")),a=e("../../core/utils/iterator"),d=e("./ui.grid_core.utils"),l=e("../../core/utils/common"),c=e("../../core/utils/type"),u=e("../../core/utils/deferred");function f(e){return e&&e.__esModule?e:{default:e}}var h="dx-row-focused",w=".dx-row.dx-row-focused",g="dx-cell-focus-disabled";o.FocusController=r.default.ViewController.inherit({init:function(){this._dataController=this.getController("data"),this._keyboardController=this.getController("keyboardNavigation")},optionChanged:function(e){"focusedRowIndex"===e.name?(this._focusRowByIndex(e.value),e.handled=!0):"focusedRowKey"===e.name?(this._focusRowByKey(e.value),e.handled=!0):"focusedColumnIndex"===e.name?e.handled=!0:"focusedRowEnabled"===e.name?e.handled=!0:this.callBase(e)},_focusRowByIndex:function(e){this.option("focusedRowEnabled")&&((e=void 0!==e?e:this.option("focusedRowIndex"))<0?this._resetFocusedRow():this._focusRowByIndexCore(e))},_focusRowByIndexCore:function(e){var o=this,t=this.getController("data"),n=t.pageSize(),i=function(){if(o._isValidFocusedRowIndex(e)){var n=Math.min(e-t.getRowIndexOffset(),t.items().length-1),i=t.getKeyByRowIndex(n);void 0===i||o.isRowFocused(i)||o.option("focusedRowKey",i)}};if(n>=0)if(this._isLocalRowIndex(e))i();else{var s=Math.floor(e/t.pageSize());(0,u.when)(t.pageIndex(s),t.waitReady()).done((function(){i()}))}},_isLocalRowIndex:function(e){var o=this.getController("data"),t;if(this.getController("keyboardNavigation")._isVirtualScrolling()){var n=Math.floor(e/o.pageSize()),i=o.virtualItemsCount(),s=i?i.begin:-1,r=o.getVisibleRows().length+o.getRowIndexOffset(),a=Math.ceil(r/o.pageSize());return s<=e&&a>n}return!0},_setFocusedRowKeyByIndex:function(e){var o=this.getController("data");if(this._isValidFocusedRowIndex(e)){var t=Math.min(e-o.getRowIndexOffset(),o.items().length-1),n=o.getKeyByRowIndex(t);void 0===n||this.isRowFocused(n)||this.option("focusedRowKey",n)}},_focusRowByKey:function(e){void 0===e?this._resetFocusedRow():this.navigateToRow(e)},_resetFocusedRow:function(){void 0===this.option("focusedRowKey")&&this.option("focusedRowIndex")<0||(this.option("focusedRowKey",void 0),this.getController("keyboardNavigation").setFocusedRowIndex(-1),this.option("focusedRowIndex",-1),this.getController("data").updateItems({changeType:"updateFocusedRow",focusedRowKey:void 0}))},_isValidFocusedRowIndex:function(e){var o,t=this.getController("data").getVisibleRows()[e];return!t||"data"===t.rowType||"group"===t.rowType},publicMethods:function(){return["navigateToRow","isRowFocused"]},navigateToRow:function(e){var o=this,t=this.getController("data"),n=this.option("focusedRowIndex"),i=new u.Deferred;if(void 0===e||!t.dataSource())return i.reject().promise();var s=o._getFocusedRowIndexByKey(e);return n>=0&&n===s?o._triggerUpdateFocusedRow(e,i):t.getPageIndexByKey(e).done((function(n){n<0?i.resolve(-1):n===t.pageIndex()?t.reload().done((function(){o.isRowFocused(e)?i.resolve(o._getFocusedRowIndexByKey(e)):o._triggerUpdateFocusedRow(e,i)})).fail(i.reject):t.pageIndex(n).done((function(){"virtual"===o.option("scrolling.rowRenderingMode")?setTimeout((function(){o._navigateToVirtualRow(e,i)})):o._triggerUpdateFocusedRow(e,i)})).fail(i.reject)})).fail(i.reject),i.promise()},_navigateToVirtualRow:function(e,o){var t=this,n=this.getController("data"),i=n._rowsScrollController,s=(0,d.getIndexByKey)(e,n.items(!0)),r=t.getView("rowsView").getScrollable();if(i&&r&&s>=0){var a=s+n.getRowIndexOffset()-n.getRowIndexDelta(),l=i.getItemOffset(a),c=function n(){t.component.off("contentReady",n),t._triggerUpdateFocusedRow(e,o)};t.component.on("contentReady",c),r.scrollTo({y:l})}},_triggerUpdateFocusedRow:function(e,o){var t=this.getController("data"),n=this._getFocusedRowIndexByKey(e);if(this._isValidFocusedRowIndex(n)){if(this.getController("keyboardNavigation").setFocusedRowIndex(n),this.option("focusedRowEnabled"))t.updateItems({changeType:"updateFocusedRow",focusedRowKey:e});else{var i=t.getRowIndexByKey(e);this._scrollToFocusedRow(this.getView("rowsView").getRow(i))}o&&o.resolve(n)}else o&&o.resolve(-1)},_getFocusedRowIndexByKey:function(e){var o=this.getController("data"),t=o.getRowIndexByKey(e);return t>=0?t+o.getRowIndexOffset():-1},_focusRowByKeyOrIndex:function(){var e=this,o=this.option("focusedRowKey"),t=this.option("focusedRowIndex"),n=this.getController("keyboardNavigation"),i=this.getController("data");if(void 0!==o){var s=i.getRowIndexByKey(o);s>=0?(n._isVirtualScrolling()&&(t=s+i.getRowIndexOffset()),n.setFocusedRowIndex(t),this._triggerUpdateFocusedRow(o)):this.navigateToRow(o).done((function(o){t>=0&&o<0&&e._focusRowByIndex()}))}else t>=0&&this.getController("focus")._focusRowByIndex(t)},isRowFocused:function(e){var o;if(void 0!==this.option("focusedRowKey"))return(0,l.equalByValue)(e,this.option("focusedRowKey"))},updateFocusedRow:function(e){var o,t,n=this,s=n._dataController.getRowIndexByKey(e.focusedRowKey),r=n.getView("rowsView");(0,a.each)(r.getTableElements(),(function(r,a){t=(0,i.default)(a),n._clearPreviousFocusedRow(t,s);var d=0===r;o=n._prepareFocusedRow(e.items[s],t,s),d&&n.getController("keyboardNavigation")._fireFocusedRowChanged(o)}))},_clearPreviousFocusedRow:function(e,o){var t,n=e.find(w);n.removeClass("dx-row-focused").removeClass("dx-cell-focus-disabled").removeAttr("tabindex"),n.children("td").removeAttr("tabindex"),0!==o&&(t=(0,i.default)(this.getView("rowsView").getRowElement(0))).removeClass("dx-cell-focus-disabled").removeAttr("tabIndex")},_prepareFocusedRow:function(e,o,t){var n,s=this.option("tabindex")||0;return!e||"data"!==e.rowType&&"group"!==e.rowType||((n=(0,i.default)(this.getView("rowsView")._getRowElements(o).eq(t))).addClass("dx-row-focused").attr("tabindex",s),this._scrollToFocusedRow(n)),n},_scrollToFocusedRow:function(e){var o,t=this,n=this.getView("rowsView"),i=n.element();if(i&&(o=e||i.find(w)).length>0){var s,r=o[0].getBoundingClientRect(),a=n.element()[0].getBoundingClientRect();r.bottom>a.bottom?s=r.bottom-a.bottom:r.top<a.top&&(s=r.top-a.top),s&&n.scrollTo({y:n._scrollTop+s})}}}),t.exports={defaultOptions:function(){return{focusedRowEnabled:!1,focusedRowKey:void 0,focusedRowIndex:-1,focusedColumnIndex:-1}},controllers:{focus:o.FocusController},extenders:{controllers:{keyboardNavigation:{init:function(){var e=this.option("focusedRowIndex"),o=this.option("focusedColumnIndex");this.option("focusedRowEnabled")&&(this.createAction("onFocusedRowChanging",{excludeValidators:["disabled","readOnly"]}),this.createAction("onFocusedRowChanged",{excludeValidators:["disabled","readOnly"]})),this.createAction("onFocusedCellChanging",{excludeValidators:["disabled","readOnly"]}),this.createAction("onFocusedCellChanged",{excludeValidators:["disabled","readOnly"]}),this.callBase(),this.setRowFocusType(),this._focusedCellPosition={},(0,c.isDefined)(e)&&(this._focusedCellPosition.rowIndex=this.option("focusedRowIndex")),(0,c.isDefined)(o)&&(this._focusedCellPosition.columnIndex=this.option("focusedColumnIndex"))},setFocusedRowIndex:function(e){this.callBase(e);var o=this.getController("data").getVisibleRows()[e];o&&o.inserted||this.option("focusedRowIndex",e)},setFocusedColumnIndex:function(e){this.callBase(e),this.option("focusedColumnIndex",e)},_escapeKeyHandler:function(e,o){!o&&this.option("focusedRowEnabled")?this.isCellFocusType()&&(this.setRowFocusType(),this._focus(this._getCellElementFromTarget(e.originalEvent.target),!0)):this.callBase(e,o)},_updateFocusedCellPosition:function(e,o){var t=this.option("focusedRowIndex"),n=this.option("focusedColumnIndex");this.callBase(e,o),this._fireFocusedCellChanged(e,n,t)}},editorFactory:{renderFocusOverlay:function(e,o){var t,n=this.getController("keyboardNavigation"),i=this.option("focusedRowEnabled"),s=this.getController("editing"),r="row"===n._getElementType(e);i&&n.isRowFocusType()&&!s.isEditing()?i&&r&&!e.hasClass("dx-row-focused")&&(t=n.getFirstValidCellInRow(e),n.focus(t)):this.callBase(e,o)}},columns:{getSortDataSourceParameters:function(){var e=this,o=this.callBase.apply(this,arguments),t=this.getController("data"),n=t._dataSource,i=t.store(),s=i&&i.key(),r=n&&n.remoteOperations()||{},a=Object.keys(r).every((function(e){return!r[e]}));if(this.option("focusedRowEnabled")&&s){var d=(s=Array.isArray(s)?s:[s]).filter((function(o){return!e.columnOption(o,"sortOrder")}));d.length&&(o=o||[],a?o.push({selector:n.getDataIndexGetter(),desc:!1}):d.forEach((function(e){return o.push({selector:e,desc:!1})})))}return o}},data:{_applyChange:function(e){if(!e||"updateFocusedRow"!==e.changeType)return this.callBase.apply(this,arguments)},_fireChanged:function(e){var o,t;this.option("focusedRowEnabled")&&this._dataSource&&((o="update"===e.changeType&&e.repaintChangesOnly&&e.changeTypes&&e.changeTypes.indexOf("remove")>=0)&&this.callBase(e),("refresh"===e.changeType||o)&&this.processUpdateFocusedRow());o||this.callBase(e)},processUpdateFocusedRow:function(){var e=this._prevPageIndex,o=this.pageIndex(),t=this._prevRenderingPageIndex||0,n=this._rowsScrollController?this._rowsScrollController.pageIndex():0,i=this._dataSource.operationTypes()||{},s=this.getController("focus"),r=i.reload,a=this.getController("keyboardNavigation")._isVirtualScrolling(),d=this.option("focusedRowKey"),l=void 0!==e&&e!==o,c=n!==t;this._prevPageIndex=o,this._prevRenderingPageIndex=n,r&&void 0!==d?s.navigateToRow(d).done((function(e){e<0&&s._focusRowByIndex()})):l?!a&&this.option("focusedRowIndex")>=0&&s._focusRowByIndex():c||s._focusRowByKeyOrIndex()},getPageIndexByKey:function(e){var o=this,t=new u.Deferred;return o.getGlobalRowIndexByKey(e).done((function(e){t.resolve(e>=0?Math.floor(e/o.pageSize()):-1)})).fail(t.reject),t.promise()},getGlobalRowIndexByKey:function(e){return this._dataSource.group()?this._calculateGlobalRowIndexByGroupedData(e):this._calculateGlobalRowIndexByFlatData(e)},_calculateGlobalRowIndexByFlatData:function(e,o,t){var n=this,i=new u.Deferred,s=n._dataSource,r=n._generateFilterByKey(e);return s.load({filter:n._concatWithCombinedFilter(r),skip:0,take:1}).done((function(a){a.length>0?(r=n._generateOperationFilterByKey(e,a[0],t),s.load({filter:n._concatWithCombinedFilter(r,o),skip:0,take:1,requireTotalCount:!0}).done((function(e,o){i.resolve(o.totalCount)}))):i.resolve(-1)})),i.promise()},_concatWithCombinedFilter:function(e,o){var t=this.getCombinedFilter();return(0,d.combineFilters)([e,t,o])},_generateOperationFilterByKey:function(e,o,t){var n=this,i=n._dataSource,s=n._generateFilterByKey(e,"<"),r=n._columnsController.getSortDataSourceParameters(!i.remoteOperations().filtering);if(t){var a=n._columnsController.getGroupDataSourceParameters(!i.remoteOperations().filtering);a&&(r=r?a.concat(r):a)}return r&&r.slice().reverse().forEach((function(e){var t,i,r=e.selector;i=(t="function"==typeof r?r:n._columnsController.columnOption(r,"selector"))?t(o):o[r],s=[[r,"=",i],"and",s],s=[[r,e.desc?">":"<",i],"or",s]})),s},_generateFilterByKey:function(e,o){var t,n=this._dataSource.key(),i=[];if(o||(o="="),Array.isArray(n))for(var s=0;s<n.length;++s)(t=e[n[s]])&&(i.length>0&&i.push("and"),i.push([n[s],o,t]));else i=[n,o,e];return i}}},views:{rowsView:{_createRow:function(e){var o=this.callBase(e);return this.option("focusedRowEnabled")&&e&&this.getController("focus").isRowFocused(e.key)&&o.addClass("dx-row-focused"),o},_checkRowKeys:function(e){if(this.callBase.apply(this,arguments),this.option("focusedRowEnabled")&&this.option("dataSource")){var o=this._dataController.store();o&&!o.key()&&this._dataController.fireError("E1042","Row focusing")}},_update:function(e){"updateFocusedRow"===e.changeType?this.option("focusedRowEnabled")&&this.getController("focus").updateFocusedRow(e):this.callBase(e)},updateFocusElementTabIndex:function(e){this.option("focusedRowEnabled")?this._setFocusedRowElementTabIndex():this.callBase(e)},_setFocusedRowElementTabIndex:function(){var e=this,o=e.option("focusedRowKey"),t=e.option("tabIndex"),n=e._dataController.getRowIndexByKey(o),i=e.option("focusedColumnIndex"),s,r=e.getCellElements(n>=0?n:0).eq(0).parent(),a=e.component.getController("data")._dataSource,d=a&&a.operationTypes();e._scrollToFocusOnResize=e._scrollToFocusOnResize||function(){e.getController("focus")._scrollToFocusedRow(r),e.resizeCompleted.remove(e._scrollToFocusOnResize)},r.length&&(r.attr("tabIndex",t),n>=0&&(i<0&&(i=0),n+=e.getController("data").getRowIndexOffset(),e.getController("keyboardNavigation").setFocusedCellPosition(n,i),d&&!d.paging&&(e.resizeCompleted.remove(e._scrollToFocusOnResize),e.resizeCompleted.add(e._scrollToFocusOnResize))))}}}}}}

