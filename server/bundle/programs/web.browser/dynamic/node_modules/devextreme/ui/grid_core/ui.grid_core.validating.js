function module(e,t,i){"use strict";var a,o=A(e("../../core/renderer")),n,l=A(e("../../events/core/events_engine")),r,d=A(e("./ui.grid_core.modules")),s=e("./ui.grid_core.utils"),u=e("../../core/utils/common"),c=e("../../core/utils/iterator"),g=e("../../core/utils/type"),h=e("../../core/utils/extend"),f=e("../widget/selectors"),p,v=A(e("../../localization/message")),_,m=A(e("../button")),w,x=A(e("../../events/pointer")),V,y=A(e("../validation_engine")),C,b=A(e("../validator")),I,E=A(e("../tooltip")),R,D=A(e("../overlay")),k,P=A(e("../themes")),B,M=A(e("../widget/ui.errors"));function A(e){return e&&e.__esModule?e:{default:e}}var T="invalid",W="revert-tooltip",F="rowsview",H="dx-invalid-message",O="invalid-message",S="dx-invalid-message-always",G="dx-revert-button",K="dx-highlight-outline",$="validator",N="__DX_INSERT_INDEX__",j=2,z="row",q="form",X="batch",U="cell",J="popup",L="dx-group-cell",Q=["popup","form"],Y="transparent",Z=d.default.Controller.inherit({init:function(){this._editingController=this.getController("editing"),this.createAction("onRowValidating")},_rowValidating:function(e,t){var i=this,a=t?t.brokenRules||t.brokenRule&&[t.brokenRule]:[],o,n={brokenRules:a,isValid:t?t.isValid:e.isValid,key:e.key,newData:e.data,oldData:e.oldData,errorText:this.getHiddenValidatorsErrorText(a)};return this.executeAction("onRowValidating",n),e.isValid=n.isValid,e.errorText=n.errorText,n},getHiddenValidatorsErrorText:function(e){var t=[];return(0,c.each)(e,(function(e,i){i.validator.$element().parent().length||t.push(i.message)})),t.join(", ")},validate:function(e){var t=this,i=!0,a=t._editingController;return e=e||"row"===a.getEditMode(),!t._isValidationInProgress&&(t._isValidationInProgress=!0,e?(0,c.each)(a._editData,(function(e,o){var n;o.type&&"remove"!==o.type&&((n=t.validateGroup(o)).isValid||(0,c.each)(n.brokenRules,(function(){var e=this.validator.option("adapter").getValue();void 0===e&&(e=null),this.column&&a.updateFieldValue({key:o.key,column:this.column},e,null,!0)})),i=i&&n.isValid)})):t._currentCellValidator&&(i=t.validateGroup(t._currentCellValidator._findGroup()).isValid),t._isValidationInProgress=!1,i)},validateGroup:function e(t){var i,a=this,e=y.default.getGroupConfig(t);return e&&e.validators.length&&(i=y.default.validateGroup(t)),this._rowValidating(t,i)},updateEditData:function(e){var t=this._editingController.getEditMode();-1===Q.indexOf(t)?(this.setDisableApplyValidationResults(!0),e.isValid=!y.default.getGroupConfig(e)||y.default.validateGroup(e).isValid,this.setDisableApplyValidationResults(!1)):e.isValid=!0},setValidator:function(e){this._currentCellValidator=e},getValidator:function(){return this._currentCellValidator},createValidator:function(e,t){var i,a,n,r,d=this,u=d._editingController,c=e.column,p=function(e){if(e.brokenRule&&(e.brokenRule.columnIndex=c.index,e.brokenRule.column=c),t&&!d.getDisableApplyValidationResults()){if(!e.isValid){var i=t.find(":focus");u.showHighlighting(t,!0),(0,f.focused)(i)||(l.default.trigger(i,"focus"),l.default.trigger(i,x.default.down))}t.toggleClass(d.addWidgetPrefix("invalid"),!e.isValid)}},v=function(){var t=c.calculateCellValue(i.data||{});return void 0!==t?t:e.value},_=c.showEditorAlways;if(c.validationRules&&Array.isArray(c.validationRules)&&c.validationRules.length&&!(0,g.isDefined)(c.command)&&((a=u.getIndexByKey(e.key,u._editData))<0&&(_||(_=(n=(r=d.getController("columns"))&&r.getVisibleColumns()||[]).some((function(e){return e.showEditorAlways}))),_&&(a=u._addEditData({key:e.key,oldData:e.data}))),a>=0)){if(t&&!t.length)return void M.default.log("E1050");i=u._editData[a];var m=t&&t.hasClass("dx-widget");t&&t.addClass(d.addWidgetPrefix("validator"));var w=new b.default(t||(0,o.default)("<div>"),{name:c.caption,validationRules:(0,h.extend)(!0,[],c.validationRules),validationGroup:i,adapter:m?null:{getValue:v,applyValidationResults:p},dataGetter:function(){return(0,s.createObjectWithChanges)(i.oldData,i.data)}});if(m){var V=w.option("adapter");V&&(V.getValue=v)}return w}},setDisableApplyValidationResults:function(e){this._disableApplyValidationResults=e},getDisableApplyValidationResults:function(){return this._disableApplyValidationResults}}),ee,te;i.exports={defaultOptions:function(){return{editing:{texts:{validationCancelChanges:v.default.format("dxDataGrid-validationCancelChanges")}}}},controllers:{validating:Z},extenders:{controllers:{editing:{_addEditData:function(e,t){var i,a=this,o=this.getController("validating"),n=this.callBase(e,t);return n>=0&&(i=this._editData[n],o.updateEditData(i)),n},_updateRowAndPageIndices:function(){var e=this,t=e.getView("rowsView").getTopVisibleItemIndex(),i=t;(0,c.each)(e._editData,(function(a,o){o.isValid||o.pageIndex===e._pageIndex||(o.pageIndex=e._pageIndex,"insert"===o.type?o.rowIndex=t:o.rowIndex=i,i++)}))},_needInsertItem:function(e){var t=this.callBase.apply(this,arguments);return t&&!e.isValid&&(t=e.key.pageIndex===this._pageIndex),t},processItems:function(e,t){var i,a,o=this,n=this._editData,l=this.getController("data"),r=function(e,t){var i=-1,a="insert"===e.type,o=e.key;return(0,c.each)(t,(function(e,t){if((0,u.equalByValue)(o,a?t:l.keyOf(t)))return i=e,!1})),i},d=function(t){var i,o={key:t.key},n;r(t,e)>=0||(t.rowIndex=t.rowIndex>a?t.rowIndex%a:t.rowIndex,i=t.rowIndex,o[N]=1,e.splice(i,0,o))};if(e=this.callBase(e,t),a=e.length,"batch"===this.getEditMode()&&"prepend"!==t&&"append"!==t)for(i=0;i<n.length;i++)n[i].type&&n[i].pageIndex===this._pageIndex&&n[i].key.pageIndex!==this._pageIndex&&d(n[i]);return e},processDataItem:function(e){var t,i,a=this,o=e.data[N],n=o?e.data.key:e.key,l=a.getEditMode();"batch"===l&&o&&n&&(t=(0,s.getIndexByKey)(n,a._editData))>=0&&"insert"!==(i=a._editData[t]).type&&(e.data=(0,h.extend)(!0,{},i.oldData,i.data),e.key=n),a.callBase.apply(a,arguments)},_createInvisibleColumnValidators:function(e){var t=this.getController("validating"),i=(0,u.grep)(this.getController("columns").getInvisibleColumns(),(function(e){return!e.isBand})),a=[];return-1===Q.indexOf(this.getEditMode())&&(0,c.each)(i,(function(i,o){e.forEach((function(e){var i;if("insert"===e.type?i=e.data:"update"===e.type&&(i=(0,s.createObjectWithChanges)(e.oldData,e.data)),i){var n=t.createValidator({column:o,key:e.key,value:o.calculateCellValue(i)});n&&a.push(n)}}))})),function(){a.forEach((function(e){e._dispose()}))}},_beforeSaveEditData:function(e,t){var i,a,o=this,n=o.callBase.apply(o,arguments),l=o.getController("validating");if(e)i="remove"===e.type||e.isValid,n=n||!i;else{var r=o._createInvisibleColumnValidators(this._editData);switch(a=l.validate(!0),r(),o._updateRowAndPageIndices(),o.getEditMode()){case"cell":a||(o._focusEditingCell(),n=!0);break;case"batch":a||(o._editRowIndex=-1,o._editColumnIndex=-1,o.getController("data").updateItems(),n=!0);break;case"row":case"popup":n=!a}}return n},_beforeEditCell:function(e,t,i){var a=this.callBase(e,t,i),o=this._rowsView._getCellElement(e,t),n=o&&o.data("dxValidator"),l=n&&n.option("adapter").getValue();if("cell"===this.getEditMode(this)&&(!n||void 0!==l&&n.validate().isValid))return a},_afterSaveEditData:function(){var e,t=this;if((0,c.each)(t._editData,(function(i,a){var o=t._showErrorRow(a);e=e||o})),e){var i=this._rowsView.getScrollable();i&&(i.update(),i.scrollToElement(e))}},_showErrorRow:function(e){var t,i=this.getController("errorHandling"),a=this.getController("data").items(),o=this.getIndexByKey(e.key,a);if(!e.isValid&&e.errorText&&o>=0)return t=this.getPopupContent(),i&&i.renderErrorRow(e.errorText,o,t)},updateFieldValue:function(e){var t=this,i=t.getEditMode();if(t.callBase.apply(t,arguments),"row"===i||"batch"===i&&e.column.showEditorAlways){var a=t.getController("validating").getValidator();a&&a.validate()}},showHighlighting:function(e,t){var i,a=!0;t||(i=e.data("dxValidator"))&&(a=i.validate().isValid),a&&this.callBase(e)},getEditDataByKey:function(e){return this._editData[(0,s.getIndexByKey)(e,this._editData)]}},editorFactory:(ee=function(e,t){var i=(0,o.default)(t).closest("tr").index(),a=(0,o.default)(e._rowsView.getRowElement(i)).first().children().filter(":not(.dx-hidden-cell)");return e._rowsView._getWidths(a).reduce((function(e,t){return e+t}),0)},te=function(e){var t=void 0,i=void 0;return e.some((function(a,o){if("transparent"===a.command)return t=0===o?-1:o,i=o===e.length-1?-1:o+a.colspan-1,!0})),{startColumnIndex:t,endColumnIndex:i}},{_showRevertButton:function(e,t){var i=this;if(t&&t.length){var a=(0,o.default)("<div>").addClass(this.addWidgetPrefix("revert-tooltip")).appendTo(e),n={animation:null,visible:!0,target:t,container:e,closeOnOutsideClick:!1,closeOnTargetScroll:!1,contentTemplate:function(){var e=(0,o.default)("<div>").addClass("dx-revert-button"),t={icon:"revert",hint:i.option("editing.texts.validationCancelChanges"),onClick:function(){i._editingController.cancelEditData()}};return new m.default(e,t).$element()},position:{my:"left top",at:"right top",of:t,offset:"1 0",collision:"flip",boundary:this._rowsView.element()},onPositioned:this._positionedHandler.bind(this)};return new E.default(a,n)}},_hideFixedGroupCell:function(e,t){var i,a,n,l=this._rowsView.isFixedColumns(),r=this._editingController.isFormEditMode();l&&!r&&(i=e.closest(".dx-row").next().data("options"))&&"group"===i.rowType&&(a=(0,o.default)(this._rowsView.getRowElement(i.rowIndex)).last(),(n=a.find(".dx-group-cell")).length&&"hidden"!==n.get(0).style.visibility&&(n.css("visibility","hidden"),t.onDisposing=function(){n.css("visibility","")}))},_positionedHandler:function(e,t){if(!e.component.__skipPositionProcessing){var i=(0,o.default)(e.element).hasClass(this.addWidgetPrefix("revert-tooltip")),a=!i&&this._rowsView.updateFreeSpaceRowHeight(),n=this._normalizeValidationMessagePositionAndMaxWidth(e,i,t);e.component.__skipPositionProcessing=!(!a&&!n),n?e.component.option(n):a&&e.component.repaint()}},_showValidationMessage:function(e,t,i,a){var n=this,l=e.find(".dx-highlight-outline"),r=P.default.isMaterial(),d=l.length&&!r?l:e,s=e.find(".dx-dropdowneditor-overlay").data("dxPopup"),u=s&&s.option("visible"),c=u?"top right":"top "+i,g=u?"top left":"bottom "+i,h=(0,o.default)("<div>").addClass("dx-invalid-message").addClass("dx-invalid-message-always").addClass(this.addWidgetPrefix("invalid-message")).text(t).appendTo(e),f={target:d,container:e,shading:!1,width:"auto",height:"auto",visible:!0,animation:!1,propagateOutsideClick:!0,closeOnOutsideClick:!1,closeOnTargetScroll:!1,position:{collision:"flip",boundary:this._rowsView.element(),boundaryOffset:"0 0",my:c,at:g},onPositioned:function(t){n._positionedHandler(t,u),n._shiftValidationMessageIfNeed(t.component.$content(),a&&a.$content(),e)}};this._hideFixedGroupCell(e,f),new D.default(h,f)},_normalizeValidationMessagePositionAndMaxWidth:function(e,t,i){var a=this._columnsController.getFixedColumns();if(a&&a.length){var n=void 0,l=!t&&ee(this,e.element),r,d=(t?e.component.overlayContent():e.component.$content()).outerWidth(!0),s=!t&&d>l,u=this._rowsView.getCellIndex((0,o.default)(e.element).closest("td")),c=te(a);return t||u!==c.startColumnIndex&&!s?u===c.endColumnIndex&&(n={collision:"none flip",my:"top right",at:t||i?"top left":"bottom right"},t&&(n.offset="-1 0")):n={collision:"none flip",my:"top left",at:i?"top right":"bottom left"},n&&{position:n,maxWidth:s?l-2:void 0}}},_shiftValidationMessageIfNeed:function(e,t,i){if(t){var a=e.offset(),o=t.offset();if(a.top===o.top&&a.left+e.width()>o.left){var n=t.width()+2;e.css("left",o.left<i.offset().left?-n:n)}}},_getTooltipsSelector:function(){var e=this.addWidgetPrefix("invalid-message"),t;return".dx-editor-cell ."+this.addWidgetPrefix("revert-tooltip")+", .dx-editor-cell ."+e+", .dx-cell-modified ."+e},init:function(){this.callBase(),this._editingController=this.getController("editing"),this._columnsController=this.getController("columns"),this._rowsView=this.getView("rowsView")},loseFocus:function(e){e||this.getController("validating").setValidator(null),this.callBase()},focus:function(e,t){var i,a,o=this,n=e&&e.closest(o._getFocusCellSelector()),l=n&&(n.data("dxValidator")||e.find("."+o.addWidgetPrefix("validator")).eq(0).data("dxValidator")),r=n&&n.closest(".dx-row").data("options"),d=r?o.getController("editing").getEditDataByKey(r.key):null,s=n&&n.closest("."+o.addWidgetPrefix("rowsview")).find(o._getTooltipsSelector()),u=n&&n.is("td")?n:null,c=!1,g=u&&o.getController("columns").getVisibleColumns()[u.index()];return arguments.length?(s&&s.remove(),l&&(o.getController("validating").setValidator(l),void 0!==l.option("adapter").getValue()&&((i=l.validate()).isValid||(t=!0,c=!0))),(i&&!i.isValid||d&&"update"===d.type&&!o._editingController.isSaving())&&"cell"===o._editingController.getEditMode()&&(a=o._showRevertButton(n,u?n.find(".dx-highlight-outline").first():n)),c&&u&&g&&i.brokenRule.message&&o._showValidationMessage(n,i.brokenRule.message,g.alignment||"left",a),!t&&o._rowsView.element()&&o._rowsView.updateFreeSpaceRowHeight(),o.callBase(e,t)):o.callBase()}})},views:{rowsView:{updateFreeSpaceRowHeight:function(e){var t,i,a,o=this,n=this.element(),l=n&&n.find("."+this.addWidgetPrefix("invalid-message")+" .dx-overlay-content");if(this.callBase(e),l&&l.length&&(t=this._getRowElements(),(i=(a=this._getFreeSpaceRowElements(e)).first())&&1===t.length&&(!i.is(":visible")||l.outerHeight()>i.outerHeight())))return a.show(),a.height(l.outerHeight()),!0},_formItemPrepared:function(e,t){var i=this;this.callBase.apply(this,arguments),(0,u.deferUpdate)((function(){var a=t.find(".dx-widget").first(),o;a.length&&!a.children().length||i.getController("validating").createValidator(e,a)}))},_cellPrepared:function(e,t){this.getController("editing").isFormEditMode()||this.getController("validating").createValidator(t,e),this.callBase.apply(this,arguments)}}}}}}

