function module(e,t,r){"use strict";var i,n=L(e("./ui.tree_list.core")),o,a=L(e("../widget/ui.errors")),s,d=L(e("../../core/utils/common")),l,h=L(e("../../core/utils/type")),u=e("../../core/utils/iterator"),c,f=L(e("../../core/utils/data")),p=e("../../core/utils/extend"),y,_=L(e("../grid_core/ui.grid_core.utils")),g,v=L(e("../../data/array_store")),I,m=L(e("../../data/query")),N,x=L(e("../grid_core/ui.grid_core.data_source_adapter")),K=e("../../core/utils/deferred"),O=e("../../data/store_helper");function L(e){return e&&e.__esModule?e:{default:e}}var k="id",B=x.default.inherit((C=function(e,t){var r=[];return t.forEach((function(t){var i=e.getNodeByKey(t);i&&i.children.forEach((function(e){r.push(e.key)}))})),r},{_createKeyGetter:function(){var e=this.getKeyExpr();return f.default.compileGetter(e)},_createKeySetter:function(){var e=this.getKeyExpr();return h.default.isFunction(e)?e:f.default.compileSetter(e)},_createParentIdGetter:function(){return f.default.compileGetter(this.option("parentIdExpr"))},createParentIdSetter:function(){var e=this.option("parentIdExpr");return h.default.isFunction(e)?e:f.default.compileSetter(e)},_createItemsGetter:function(){return f.default.compileGetter(this.option("itemsExpr"))},_createHasItemsGetter:function(){var e=this.option("hasItemsExpr");return e&&f.default.compileGetter(e)},_createHasItemsSetter:function(){var e=this.option("hasItemsExpr");return h.default.isFunction(e)?e:e&&f.default.compileSetter(e)},_updateIndexByKeyObject:function(e){var t=this;t._indexByKey={},(0,u.each)(e,(function(e,r){t._indexByKey[r.key]=e}))},_calculateHasItems:function(e,t){var r,i=this,n=t.storeLoadOptions.parentIds;return!this._hasItemsGetter||!n&&t.storeLoadOptions.filter||(r=this._hasItemsGetter(e.data)),void 0===r&&(r=!(this._isChildrenLoaded[e.key]||!t.remoteOperations.filtering||!n)||e.hasChildren),!!r},_createVisibleItemsByNodes:function(e,t){for(var r=this,i=[],n=0;n<e.length;n++)e[n].visible&&i.push(e[n]),(this.isRowExpanded(e[n].key,t)||!e[n].visible)&&e[n].hasChildren&&e[n].children.length&&(i=i.concat(this._createVisibleItemsByNodes(e[n].children,t)));return i},_convertItemToNode:function(e,t,r){var i,n,o=this._keyGetter(e),a=this._parentIdGetter(e);return i=r[a=h.default.isDefined(a)?a:t]=r[a]||{key:a,children:[]},(n=r[o]=r[o]||{key:o,children:[]}).data=e,n.parent=i,n},_createNodesByItems:function(e,t){var r,i=this,n=this.option("rootValue"),o={},a=this._nodeByKey={};if(t)for(r=0;r<t.length;r++)o[this._keyGetter(t[r])]=!0;for(r=0;r<e.length;r++){var s=this._convertItemToNode(e[r],n,a);if(void 0===s.key)return;s.visible=!t||!!o[s.key],s.parent&&s.parent.children.push(s)}var d=a[n]||{key:n,children:[]};return d.level=-1,d},_convertDataToPlainStructure:function(e,t,r){var i,n,o,a;if(this._itemsGetter&&!e.isConverted){r=r||[];for(var s=0;s<e.length;s++)n=_.default.createObjectWithChanges(e[s]),void 0===(i=this._keyGetter(n))&&(i=r.length+1,this._keySetter(n,i)),this._parentIdSetter(n,void 0===t?this.option("rootValue"):t),r.push(n),(a=this._itemsGetter(n))&&a.length&&(this._convertDataToPlainStructure(a,i,r),o=this.option("itemsExpr"),h.default.isFunction(o)||delete n[o]);return r.isConverted=!0,r}return e},_createIdFilter:function(e,t){for(var r=[],i=0;i<t.length;i++)r.push([e,"=",t[i]]);return _.default.combineFilters(r,"or")},_customizeRemoteOperations:function(e,t,r){this.callBase.apply(this,arguments),e.remoteOperations.paging=!1;var i=!1;this.option("autoExpandAll")&&(e.remoteOperations.sorting=!1,e.remoteOperations.filtering=!1,this._lastLoadOptions&&(!r.filtering||e.storeLoadOptions.filter)||e.isCustomLoading||(i=!0)),e.isCustomLoading||(this._isReload=this._isReload||t||r.reload,e.cachedStoreData||(this._isChildrenLoaded={}),this.option("expandNodesOnFiltering")&&(r.filtering||this._isReload&&e.storeLoadOptions.filter)&&(e.storeLoadOptions.filter?i=!0:e.collapseVisibleNodes=!0)),e.expandVisibleNodes=i},_getParentIdsToLoad:function(e){for(var t=[],r=0;r<e.length;r++){var i=this.getNodeByKey(e[r]);i&&i.hasChildren&&!i.children.length&&t.push(e[r])}return t},_handleDataLoading:function(e){var t,r,i,n=this.option("rootValue"),o=this.option("parentIdExpr"),a=this.option("filterMode"),s=e.storeLoadOptions.parentIds;s&&(e.isCustomLoading=!1),this.callBase.apply(this,arguments),e.remoteOperations.filtering&&!e.isCustomLoading&&("standard"!==a&&e.storeLoadOptions.filter||(t=e.collapseVisibleNodes?[]:this.option("expandedRowKeys"),s=[n].concat(t).concat(s||[]),(i=e.data?this._getParentIdsToLoad(s):s).length&&(e.cachedPagingData=void 0,e.data=void 0,e.mergeStoreLoadData=!0),e.storeLoadOptions.parentIds=i,r=this._createIdFilter(o,i),e.storeLoadOptions.filter=_.default.combineFilters([r,e.storeLoadOptions.filter])))},_generateParentInfoToLoad:function(e){var t,r=this,i={},n={},o=[],a=this.option("rootValue");for(t=0;t<e.length;t++)i[this._keyGetter(e[t])]=!0;for(t=0;t<e.length;t++){var s=this._parentIdGetter(e[t]);n[s]||i[s]||s===a||(n[s]=!0,o.push(s))}return{parentIdMap:n,parentIds:o}},_loadParents:function(e,t){var r=this,i,n,o,a,s=this,d=s._generateParentInfoToLoad(e),l=d.parentIds,h=d.parentIdMap,u=new K.Deferred,c=t.remoteOperations.filtering,f=s.option("maxFilterLengthInRequest"),y=c?t.storeLoadOptions:t.loadOptions;if(!l.length)return u.resolve(e);var _=l.map((function(e){return r.getNodeByKey(e)})).filter((function(e){return e}));return _.length===l.length?s._loadParents(e.concat(_.map((function(e){return e.data}))),t):(n=s._createIdFilter(s.getKeyExpr(),l),(o=encodeURI(JSON.stringify(n)).length)>f&&(n=function(e){return h[s._keyGetter(e)]},a=c),y=(0,p.extend)({},y,{filter:a?null:n}),(i=t.fullData?new v.default(t.fullData):s._dataSource.store()).load(y).done((function(r){r.length?(a&&(r=(0,m.default)(r).filter(n).toArray()),s._loadParents(e.concat(r),t).done(u.resolve).fail(u.reject)):u.resolve(e)})).fail(u.reject),u)},_updateHasItemsMap:function(e){var t=e.storeLoadOptions.parentIds;if(t)for(var r=0;r<t.length;r++)this._isChildrenLoaded[t[r]]=!0},_getKeyInfo:function(){return{key:function(){return"key"},keyOf:function(e){return e.key}}},_applyBatch:function(e){var t=this,r=[];e.forEach((function(e){"insert"===e.type?r=r.concat(t._applyInsert(e)):"remove"===e.type?r=r.concat(t._applyRemove(e)):"update"===e.type&&r.push({type:e.type,key:e.key,data:{data:e.data}})})),this.callBase(r)},_setHasItems:function(e,t){var r=this._hasItemsSetter;e.hasChildren=t,r&&e.data&&r(e.data,t)},_applyInsert:function(e){var t=this,r=[],i=this.parentKeyOf(e.data),n=this.getNodeByKey(i);if(n){var o=this.option("rootValue"),a=this._convertItemToNode(e.data,o,this._nodeByKey);if(a.hasChildren=!1,a.level=n.level+1,a.visible=!0,n.children.push(a),this._isChildrenLoaded[a.key]=!0,this._setHasItems(n,!0),(!n.parent||this.isRowExpanded(n.key))&&void 0!==e.index){var s=this.items().indexOf(n)+1;s+=e.index>=0?Math.min(e.index,n.children.length):n.children.length,r.push({type:e.type,data:a,index:s})}}return r},_applyRemove:function(e){var t=[],r=this.getNodeByKey(e.key),i=r.parent;if(i){var n=i.children.indexOf(r);n>=0&&(i.children.splice(n,1),i.children.length||this._setHasItems(i,!1),t.push(e),t=t.concat(this.getChildNodeKeys(e.key).map((function(t){return{type:e.type,key:t}}))))}return t},_handleDataLoaded:function(e){var t=e.data=this._convertDataToPlainStructure(e.data);!e.remoteOperations.filtering&&e.loadOptions.filter&&(e.fullData=(0,O.queryByOptions)((0,m.default)(e.data),{sort:e.loadOptions&&e.loadOptions.sort}).toArray()),this._updateHasItemsMap(e),this.callBase(e),t.isConverted&&this._cachedStoreData&&(this._cachedStoreData.isConverted=!0)},_fillNodes:function(e,t,r,i){i=i||0;for(var n=0;n<e.length;n++){var o=e[n];this._fillNodes(e[n].children,t,r,i+1),o.level=i,o.hasChildren=this._calculateHasItems(o,t),o.visible&&o.hasChildren&&t.expandVisibleNodes&&r.push(o.key),(o.visible||o.hasChildren)&&(o.parent.hasChildren=!0)}},_processTreeStructure:function(e,t){var r=e.data,i=e.storeLoadOptions.parentIds,n=[];if(i&&i.length||this._isReload){if(e.fullData&&e.fullData.length>e.data.length&&(r=e.fullData,t=t||e.data),this._rootNode=this._createNodesByItems(r,t),!this._rootNode)return void(e.data=(new K.Deferred).reject(a.default.Error("E1046",this.getKeyExpr())));this._fillNodes(this._rootNode.children,e,n),this._isNodesInitializing=!0,(e.collapseVisibleNodes||n.length)&&this.option("expandedRowKeys",n),this.executeAction("onNodesInitialized",{root:this._rootNode}),this._isNodesInitializing=!1,this._isReload=!1}r=this._createVisibleItemsByNodes(this._rootNode.children,e),e.data=r,this._totalItemsCount=r.length},_handleDataLoadedCore:function(e){var t,r=this,i=e.data,n=r.callBase,o=e.storeLoadOptions.filter||e.loadOptions.filter,a=r.option("filterMode"),s=e.storeLoadOptions.parentIds,d=o&&(!s||!s.length)&&"standard"!==a;if(!e.isCustomLoading){if(d){var l=e.data=new K.Deferred;return"smart"===a&&(t=i),r._loadParents(i,e).done((function(i){e.data=i,r._processTreeStructure(e,t),n.call(r,e),l.resolve(e.data)})).fail(l.reject)}r._processTreeStructure(e)}r.callBase(e)},init:function(e,t){this.callBase.apply(this,arguments);var r=this.option("dataStructure");this._keyGetter=this._createKeyGetter(),this._parentIdGetter=this._createParentIdGetter(),this._hasItemsGetter=this._createHasItemsGetter(),this._hasItemsSetter=this._createHasItemsSetter(),"tree"===r&&(this._itemsGetter=this._createItemsGetter(),this._keySetter=this._createKeySetter(),this._parentIdSetter=this.createParentIdSetter()),this._nodeByKey={},this._isChildrenLoaded={},this._totalItemsCount=0,this.createAction("onNodesInitialized")},getKeyExpr:function(){var e=this.store(),t=e&&e.key(),r=this.option("keyExpr");if(h.default.isDefined(t)&&h.default.isDefined(r)&&!d.default.equalByValue(t,r))throw a.default.Error("E1044");return t||r||"id"},keyOf:function(e){return this._keyGetter&&this._keyGetter(e)},parentKeyOf:function(e){return this._parentIdGetter&&this._parentIdGetter(e)},getRootNode:function(){return this._rootNode},totalItemsCount:function(){return this._totalItemsCount},isRowExpanded:function(e,t){if(t){var r=t.isExpandedByKey;return r||(r=t.isExpandedByKey={},this.option("expandedRowKeys").forEach((function(e){r[e]=!0}))),!!r[e]}var i;return _.default.getIndexByKey(e,this.option("expandedRowKeys"),null)>=0},_changeRowExpandCore:function(e){var t=this.option("expandedRowKeys"),r=_.default.getIndexByKey(e,t,null);r<0?t.push(e):t.splice(r,1),this.option("expandedRowKeys",t)},changeRowExpand:function(e){return this._changeRowExpandCore(e),this._isNodesInitializing?(new K.Deferred).resolve():this.load()},getNodeByKey:function(e){if(this._nodeByKey)return this._nodeByKey[e]},getNodeLeafKeys:function(){var e,t=this,r=[],i;return(t._rootNode?[t._rootNode.key]:[]).forEach((function(i){(e=t.getNodeByKey(i))&&n.default.foreachNodes([e],(function(e){!e.children.length&&r.push(e.key)}))})),r},getChildNodeKeys:function(e){var t=this.getNodeByKey(e),r=[];return t&&n.default.foreachNodes(t.children,(function(e){r.push(e.key)})),r},loadDescendants:function(e,t){var r,i=this,n=new K.Deferred,o=i.remoteOperations();return e=h.default.isDefined(e)?Array.isArray(e)?e:[e]:i.getNodeLeafKeys(),o.filtering&&e.length?((r=i._dataSource._createStoreLoadOptions()).parentIds=e,i.load(r).done((function(){if(!t){var r=C(i,e);if(r.length)return void i.loadDescendants(r,t).done(n.resolve).fail(n.reject)}n.resolve()})).fail(n.reject),n.promise()):n.resolve()},forEachNode:function(){var e,t,r=[];1===arguments.length?(e=arguments[0],r=(t=this.getRootNode())&&t.children||[]):2===arguments.length&&(e=arguments[1],r=arguments[0],r=Array.isArray(r)?r:[r]),n.default.foreachNodes(r,e)}})),C;r.exports={extend:function(e){B=B.inherit(e)},create:function(e){return new B(e)}}}

