function module(e,r,t){"use strict";var a=e("../../core/class"),s=e("../../core/utils/array"),o=e("../../core/utils/common").grep,i=e("../../core/utils/type").isDefined,n=e("../../core/utils/object"),c=e("../../core/utils/iterator"),u=e("../../core/utils/extend").extend,l=e("../../core/utils/array").inArray,d=e("../../data/query"),h=e("../../core/utils/data"),f=e("../../data/data_source/data_source"),g=e("../../core/utils/deferred"),p=g.when,v=g.Deferred,m=function(e){return e.valueExpr||"id"},R=function(e){return e.displayExpr||"text"},_=a.inherit({_wrapDataSource:function(e){return e instanceof f.DataSource?e:new f.DataSource({store:f.normalizeDataSourceOptions(e).store,pageSize:0})},_mapResourceData:function(e,r){var t=h.compileGetter(m(e)),a=h.compileGetter(R(e));return c.map(r,(function(e){var r={id:t(e),text:a(e)};return e.color&&(r.color=e.color),r}))},_isMultipleResource:function(e){var r=!1;return c.each(this.getResources(),function(t,a){var s;if(this.getField(a)===e)return r=a.allowMultiple,!1}.bind(this)),r},ctor:function(e){this.setResources(e)},getDataAccessors:function(e,r){var t=null;return c.each(this._dataAccessors[r],(function(r,a){if(e===r)return t=a,!1})),t},getField:function(e){return e.fieldExpr||e.field},setResources:function(e){this._resources=e,this._dataAccessors={getter:{},setter:{}},this._resourceFields=c.map(e||[],function(e){var r=this.getField(e);return this._dataAccessors.getter[r]=h.compileGetter(r),this._dataAccessors.setter[r]=h.compileSetter(r),r}.bind(this))},getResources:function(){return this._resources||[]},getResourcesData:function(){return this._resourcesData||[]},getEditors:function(){var e=[],r=this;return c.each(this.getResources(),(function(t,a){var s=r.getField(a),o=r._getResourceDataByField(s);e.push({editorOptions:{dataSource:o.length?o:r._wrapDataSource(a.dataSource),displayExpr:R(a),valueExpr:m(a)},dataField:s,editorType:a.allowMultiple?"dxTagBox":"dxSelectBox",label:{text:a.label||s}})})),e},_resourceLoader:{},getResourceDataByValue:function(e,r){var t=this,a=new v;return c.each(this.getResources(),(function(s,o){var i;if(t.getField(o)===e){var n=t._wrapDataSource(o.dataSource),c=m(o);return t._resourceLoader[e]||(t._resourceLoader[e]=n.load()),t._resourceLoader[e].done((function(s){var o=d(s).filter(c,r).toArray();delete t._resourceLoader[e],a.resolve(o[0])})).fail((function(){delete t._resourceLoader[e],a.reject()})),!1}})),a.promise()},setResourcesToItem:function(e,r){var t=this._dataAccessors.setter;for(var a in r)if(r.hasOwnProperty(a)){var o=r[a];t[a](e,this._isMultipleResource(a)?s.wrapToArray(o):o)}},getResourcesFromItem:function(e,r){var t=this,a=null;return i(r)||(r=!1),c.each(t._resourceFields,(function(o,i){c.each(e,(function(e,o){var n={};n[e]=o;var c=t.getDataAccessors(i,"getter")(n);if(c)return a||(a={}),1===c.length&&(c=c[0]),!r||r&&t._isMultipleResource(i)?t.getDataAccessors(i,"setter")(n,s.wrapToArray(c)):t.getDataAccessors(i,"setter")(n,c),u(a,n),!0}))})),a},loadResources:function(e){var r=new v,t=this,a=[];return c.each(this.getResourcesByFields(e),(function(e,r){var s=new v,o=t.getField(r);a.push(s),t._wrapDataSource(r.dataSource).load().done((function(e){s.resolve({name:o,items:t._mapResourceData(r,e),data:e})})).fail((function(){s.reject()}))})),a.length?(p.apply(null,a).done((function(){var e=Array.prototype.slice.call(arguments),a=function(e){return{name:e.name,items:e.items,data:e.data}};t._resourcesData=e,r.resolve(e.map(a))})).fail((function(){r.reject()})),r.promise()):(t._resourcesData=[],r.resolve([]))},getResourcesByFields:function(e){return o(this.getResources(),function(r){var t=this.getField(r);return l(t,e)>-1}.bind(this))},getResourceByField:function(e){return this.getResourcesByFields([e])[0]||{}},getResourceColor:function(e,r){var t=this.getResourceByField(e).valueExpr||"id",a=h.compileGetter(t),s=this.getResourceByField(e).colorExpr||"color",o=h.compileGetter(s),i,n=new v,c=this._getResourceDataByField(e),u=c.length;if(u){for(var l=0;l<u;l++)if(a(c[l])===r){i=o(c[l]);break}n.resolve(i)}else this.getResourceDataByValue(e,r).done((function(e){e&&(i=o(e)),n.resolve(i)})).fail((function(){n.reject()}));return n.promise()},getResourceForPainting:function(e){var r,t=this.getResources();return c.each(t,(function(e,t){if(t.useColorAsDefault)return r=t,!1})),r||(Array.isArray(e)&&e.length&&(t=this.getResourcesByFields(e)),r=t[t.length-1]),r},createResourcesTree:function(e){var r=0,t=t||0;function a(t,s,o,i){o=o||[];for(var n=0;n<t.items.length;n++){var c=t.items[n],u={name:t.name,value:c.id,title:c.text,data:t.data&&t.data[n],children:[],parent:i||null};o.push(u);var l=s+1;e[l]&&a.call(this,e[l],l,u.children,u),u.children.length||(u.leafIndex=r,r++)}return o}return a.call(this,e[0],0)},_hasGroupItem:function(e,r,t){var a=this.getDataAccessors(r,"getter")(e);return!!(a&&l(t,a)>-1)},_getResourceDataByField:function(e){for(var r=this.getResourcesData(),t=[],a=0,s=r.length;a<s;a++)if(r[a].name===e){t=r[a].data;break}return t},getResourceTreeLeaves:function(e,r,t){t=t||[];for(var a=0;a<e.length;a++)this._hasGroupItem(r,e[a].name,e[a].value)&&(i(e[a].leafIndex)&&t.push(e[a].leafIndex),e[a].children&&this.getResourceTreeLeaves(e[a].children,r,t));return t},groupAppointmentsByResources:function(e,r){var t=this.createResourcesTree(r),a={};return c.each(e,function(e,r){for(var s=this.getResourcesFromItem(r),o=this.getResourceTreeLeaves(t,s),i=0;i<o.length;i++)a[o[i]]||(a[o[i]]=[]),a[o[i]].push(n.deepExtendArraySafe({},r,!0))}.bind(this)),a},reduceResourcesTree:function(e,r,t){t=t?t.children:[];var a=this;return e.forEach((function(e,s){var o=!1,i=e.name,n=e.value,c=e.title,u=e.data,l=a.getDataAccessors(i,"getter");r.forEach((function(e){if(!o){var r=l(e);Array.isArray(r)?r.indexOf(n)>-1&&(t.push({name:i,value:n,title:c,data:u,children:[]}),o=!0):r===n&&(t.push({name:i,value:n,title:c,data:u,children:[]}),o=!0)}})),o&&e.children&&e.children.length&&a.reduceResourcesTree(e.children,r,t[s])})),t}});t.exports=_}

