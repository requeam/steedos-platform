function module(e,t){"use strict";var r=e("../../core/utils/deferred"),n=r.when,a=r.Deferred,o=e("../../data/utils"),u=e("../../data/query"),i=e("../../core/utils/date_serialization"),s=e("../../data/data_source/data_source"),l=e("../../data/custom_store"),c=e("../../core/utils/data"),f=e("../../core/class"),d=e("../../core/utils/common"),h=e("../../core/utils/type"),m=e("../../core/utils/iterator").each,v=e("./ui.pivot_grid.utils"),g=v.getFiltersByPath,p=v.setFieldProperty,y=e("../../data/array_store"),w="/./";t.LocalStore=f.inherit(function(){var e={year:function(e){return e&&e.getFullYear()},quarter:function(e){return e&&Math.floor(e.getMonth()/3)+1},month:function(e){return e&&e.getMonth()+1},day:function(e){return e&&e.getDate()},dayOfWeek:function(e){return e&&e.getDay()}};function t(e){return-1!==e.indexOf(".")?c.compileGetter(e):function(t){return t[e]}}function r(e){return function(t){var r=e(t);return!r||r instanceof Date||(r=i.deserializeDate(r)),r}}function f(n){m(n||[],(function(n,a){var o,u,i,s,l=a.dataField,c=a.levels;if(!a.selector){if(s=l?t(l):function(e){return e},c&&f(c),"date"===a.dataType){u=e[a.groupInterval];var d=r(s);o=function(e){var t=d(e);return u?u(t):t}}else"number"===a.dataType?(i=h.isNumeric(a.groupInterval)&&a.groupInterval>0&&a.groupInterval,o=function(e){var t=s(e);return h.isString(t)&&(t=Number(t)),i?Math.floor(t/i)*i:t}):o=s;v.setDefaultFieldValueFormatting(a),p(a,"selector",o)}}))}var S=function(e,t,r,n){var a=n[r];return a||(a={value:e,index:n.length++},n[r]=a,t.push(a)),a};function x(e,t,r,n,a){var o,u,i=t.dimensions[n],s=t.expandedPathsHash;i&&(o=i.selector(t.data),u=S(o,r,a=void 0!==a?a+w+o:o+"",t.childrenHash),e.push(u.index),(s&&s[a]||i.expanded)&&(u.children||(u.children=[]),x(e,t,u.children,n+1,a)))}function D(e,t,r,n){var a=[0],o=t.headerName===n?t.path.length:0,u="rows"===n?t.rowExpandedPaths:t.columnExpandedPaths,i;return x(a,{data:e,childrenHash:r[n+"Hash"],dimensions:t[n],expandedPathsHash:t.headerName!==n&&u&&u.hash},r[n],o),a}function _(e,t,r,n){var a,o,u,i,s=[],l=D(e,n,r,"rows"),c=D(e,n,r,"columns");for(o=0;o<l.length;o++)for(t[u=l[o]]=t[u]||[],a=0;a<c.length;a++)i=c[a],s.push(t[u][i]=t[u][i]||[]);return s}function P(e){if(e){var t=e.hash={};e.forEach((function(e){var r=e.map((function(e){return e+""})).join(w);t[r]=!0}))}}function C(e){e.rows=e.rows||[],e.columns=e.columns||[],e.filters=e.filters||[],P(e.columnExpandedPaths),P(e.rowExpandedPaths),f(e.columns),f(e.rows),f(e.values),f(e.filters)}function F(e){return"custom"===e.summaryType?(e.calculateCustomSummary=e.calculateCustomSummary||d.noop,{seed:function(){var t={summaryProcess:"start",totalValue:void 0};return e.calculateCustomSummary(t),t},step:function(t,r){return t.summaryProcess="calculate",t.value=r,e.calculateCustomSummary(t),t},finalize:function(t){return t.summaryProcess="finalize",delete t.value,e.calculateCustomSummary(t),t.totalValue}}):o.aggregators[e.summaryType]||o.aggregators.count}function O(e,t,r){for(var n=0;n<e.length;n++)for(var a=e[n],o=a.selector(r),u=F(a),i="function"==typeof u.seed,s=0;s<t.length;s++){var l=t[s];l.length<=n&&(l[n]=i?u.seed():u.seed),void 0===l[n]?l[n]=o:h.isDefined(o)&&(l[n]=u.step(l[n],o))}}function T(e,t){m(e,(function(e,r){var n=F(r);n.finalize&&m(t,(function(t,r){m(r,(function(t,r){r&&void 0!==r[e]&&(r[e]=n.finalize(r[e]))}))}))}))}function z(e,t){var r=e&&e.valueOf(),n=t&&t.valueOf();if(Array.isArray(e)){t=t||[];for(var a=0;a<e.length;a++)if((r=e[a]&&e[a].valueOf())!==(n=t[a]&&t[a].valueOf()))return!1;return!0}return r===n}function I(e,t){var r=[];return m(e,(function(e,n){r.push(n.selector(t))})),r}function b(e){var t=[];return m(e,(function(e,r){var n,a=r.filterValues||[],o;r.groupName&&h.isNumeric(r.groupIndex)||(n=function(e){for(var t=r.levels?I(r.levels,e):r.selector(e),n=!1,o=0;o<a.length;o++)if(z(a[o],t)){n=!0;break}return"exclude"===r.filterType?!n:n},a.length&&t.push(n))})),t}function A(e){var t=b(e.rows).concat(b(e.columns)).concat(b(e.filters)),r=e[e.headerName],n=e.path;return r&&t.push((function(e){for(var t,a=0;a<n.length;a++)if(t=r[a].selector(e),c.toComparable(t,!0)!==c.toComparable(n[a],!0))return!1;return!0})),function(e){for(var r=0;r<t.length;r++)if(!t[r](e))return!1;return!0}}function E(e,t,r){var n,o,u,i={columns:[],rows:[],columnsHash:{length:1},rowsHash:{length:1}},s=[],l=new a,c=0;function f(){for(var a=new Date,d=c;c<e.length;c++){if(c>d&&c%1e4==0&&new Date-a>=300)return r(c/e.length),void setTimeout(f,0);u=e[c],o(u)&&(n=_(u,s,i,t),O(t.values,n,u))}T(t.values,s),r(1),l.resolve({rows:i.rows,columns:i.columns,values:s,grandTotalRowIndex:0,grandTotalColumnIndex:0})}return o=A(t),f(),l}function H(e,t){var r=e.filter();return e.store()instanceof l&&r?(r=k(r,t),u(e.items()).filter(r).toArray()):e.items()}function N(e,t,r){var o=new a,u=function(r){e.store()instanceof y&&(r.storeLoadOptions.filter=k(r.storeLoadOptions.filter,t))};if(e.on("customizeStoreLoadOptions",u),!e.isLoaded()||r){var i=r?e.load():e.reload();n(i).done((function(){N(e,t).done((function(){o.resolve(H(e,t))})).fail(o.reject)})).fail(o.reject)}else o.resolve(H(e,t));return o.always((function(){e.off("customizeStoreLoadOptions",u)}))}function j(e,n){n.forEach((function(n){if(n.dataField&&"date"===n.dataType){var a=r(t(n.dataField));e[n.dataField]=function(e){return a(e)}}}))}function L(e){var t={};return Array.isArray(e)?j(t,e):e&&["rows","columns","filters"].forEach((function(r){e[r]&&j(t,e[r])})),t}function k(e,t){if(!Array.isArray(e))return e;e=e.slice(0),h.isString(e[0])&&(e[1]instanceof Date||e[2]instanceof Date)&&(e[0]=t[e[0]]);for(var r=0;r<e.length;r++)e[r]=k(e[r],t);return e}return{ctor:function(e){this._progressChanged=e.onProgressChanged||d.noop,this._dataSource=new s.DataSource(e),this._dataSource.paginate(!1)},getFields:function(e){var t=this,r=this._dataSource,n=new a;return N(r,L(e)).done((function(t){n.resolve(v.discoverObjectFields(t,e))})).fail(n.reject),n},key:function(){return this._dataSource.key()},load:function(e){var t=this,r=t._dataSource,o=new a;return C(e),N(r,L(e),e.reload).done((function(r){n(E(r,e,t._progressChanged)).done(o.resolve)})).fail(o.reject),o},filter:function(){var e=this._dataSource;return e.filter.apply(e,arguments)},supportSorting:function(){return!1},getDrillDownItems:function(e,t){t=t||{},C(e=e||{});for(var r,n=[],a=this._dataSource.items(),o=t.maxRowCount,u=t.customColumns,i=A(e),s=A({rows:g(e.rows,t.rowPath),columns:g(e.columns,t.columnPath),filters:[]}),l=0;l<a.length;l++){if(s(a[l])&&i(a[l])){if(u){r={};for(var c=0;c<u.length;c++)r[u[c]]=a[l][u[c]]}else r=a[l];n.push(r)}if(o>0&&n.length===o)break}return n}}}()).include(v.storeDrillDownMixin)}

