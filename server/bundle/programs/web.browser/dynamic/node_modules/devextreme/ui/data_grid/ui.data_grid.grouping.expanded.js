function module(t,e){"use strict";var n=t("../../core/utils/data"),o=t("../../data/utils"),i=t("../../core/utils/iterator"),r=t("../../core/utils/extend"),a=t("../../data/store_helper"),u=t("./ui.data_grid.core"),s=t("./ui.data_grid.grouping.core"),l=t("./ui.data_grid.utils"),f,p=c(t("../../data/query")),d=t("../../core/utils/deferred");function c(t){return t&&t.__esModule?t:{default:t}}var g=function(t,e){var n=new d.Deferred,o=(0,r.extend)({skip:0,take:1,requireTotalCount:!0},e);return t.load(o).done((function(t,e){n.resolve(e&&e.totalCount)})).fail(n.reject.bind(n)),n},h,m,k,v,I,C,x,G;e.GroupingHelper=s.GroupingHelper.inherit((h=function(t,e,n){return t.foreachGroups((function(t){if(!t.isExpanded)return e(t)}),!1,!1,n,!0)},m=function(t,e){var n=0,o=e||0;return e&&(h(t,(function(t){if(t.offset-n>=e)return!1;n+=t.count-1})),o+=n),o},k=function t(e,n,o,i,r,a){var u,s,l,f=0,p=!1;for(u=0;u<n.length;u++){if(void 0!==(s=n[u]).items){o.push(s.key);var d=e.findGroupInfo(o);d&&!d.isExpanded?(s.collapsedItems=s.items,s.items=null,i+=d.count,--a<0&&f++,r&&(p=!0)):s.items&&(l=t(e,s.items,o,i,r,a),r&&(l.offset-i>1?s.isContinuation=!0:p=!0),i=l.offset,(a=l.take)<0&&(s.items.length?s.isContinuationOnNextPage=!0:f++)),o.pop()}else r&&(p=!0),i++,--a<0&&f++;r=!1}return p&&n.splice(0,1),f&&n.splice(-f,f),{offset:i,take:a}},v=function(t,e){var n;if(t.length!==e.length)return!1;for(n=0;n<t.length;n++)if(!(0,o.keysEqual)(null,t[n],e[n]))return!1;return!0},I=function t(e,n,o,i,r){var a,u;if(n){for(a=0;a<n.length;a++)if("key"in(u=n[a])&&void 0!==u.items){o.push(u.key),r&&v(r.path,o)&&!u.isContinuation&&(r.offset=i);var s=e.findGroupInfo(o);s&&!u.isContinuation&&(s.offset=i),s&&!s.isExpanded?i+=s.count:i=t(e,u.items,o,i,r),o.pop()}else i++;return i}},C=function(t,e){var n,o;e.group&&(n=(0,u.normalizeSortingInfo)(e.group),o=(0,u.normalizeSortingInfo)(t.sort),t.sort=(0,a.arrangeSortingInfo)(n,o),delete e.group)},x=function(t,e,n){var o,i,r,a=(0,u.normalizeSortingInfo)(n||e.group),s=[];for(o=0;o<t.length;o++){for(r=[],i=0;i<=o;i++)r.push([a[i].selector,o===i?"<>":"=",t[i]]);s.push((0,u.combineFilters)(r))}return s=(0,u.combineFilters)(s,"or"),(0,u.combineFilters)([s,e.filter])},G=function t(e,n){var o,i=e.count||e.items.length;if(!e.count&&n>1)for(i=0,o=0;o<e.items.length;o++)i+=t(e.items[o],n-1);return i},{handleDataLoading:function(t){var e,n,o=this,a=t.storeLoadOptions,u=[],s=0,l=!1,f=t.loadOptions.group,p=0;C(a,t.loadOptions),t.group=t.group||f,t.isCustomLoading||((e=(0,r.extend)({},a)).skip=m(this,a.skip),e.skip&&e.take&&f&&(e.skip--,e.take++,l=!0),e.take&&f&&(n=e.take,e.take++),h(this,(function(t){if(t.offset>=e.skip+e.take+p)return!1;t.offset>=e.skip+p&&t.count&&(p+=t.count-1,u.push(t),s+=t.count)})),(0,i.each)(u,(function(){e.filter=x(this.path,e,f)})),t.storeLoadOptions=e,t.collapsedGroups=u,t.collapsedItemsCount=s,t.skip=e.skip||0,t.skipFirstItem=l,t.take=n)},handleDataLoaded:function(t,e){var o,i,r=this,s=t.data,l=t.collapsedGroups,f=(0,u.normalizeSortingInfo)(t.group),d=f.length;function c(t,e,o,i,r){if(t&&e.length&&o.length){var a,u,s=(0,n.toComparable)(e[0],!0);for(a=0;a<t.length&&(u=(0,n.toComparable)(t[a].key,!0),!(r>=i.offset||s===u));a++)r+=G(t[a],o.length);t.length&&s===u||t.splice(a,0,{key:e[0],items:[],count:1===e.length?i.count:void 0}),c(t[a].items,e.slice(1),o.slice(1),i,r)}}if(t.collapsedItemsCount&&t.extra&&t.extra.totalCount>=0&&(t.extra.totalCount+=t.collapsedItemsCount),e(t),d){if(i=(0,p.default)(s),(0,a.multiLevelGroup)(i,f).enumerate().done((function(t){s=t})),l)for(o=0;o<l.length;o++)c(s,l[o].path,f,l[o],t.skip);t.isCustomLoading||k(this,s,[],t.skip,t.skipFirstItem,t.take),t.data=s}},isGroupItemCountable:function(t){return null===t.items},updateTotalItemsCount:function(){var t=0;h(this,(function(e){e.count&&(t-=e.count-1)})),this.callBase(t)},changeRowExpand:function(t){var e,n=this,o=n._dataSource,i=o.beginPageIndex?o.beginPageIndex():o.pageIndex(),r=o.items(),a=m(n,i*o.pageSize()),u=n.findGroupInfo(t);return e=u&&!u.isExpanded?(new d.Deferred).resolve(u.count):g(o,{filter:(0,l.createGroupFilter)(t,{filter:o.filter(),group:o.group()})}),(0,d.when)(e).done((function(e){e=parseInt(e.length?e[0]:e),u?(I(n,r,[],a),u.isExpanded=!u.isExpanded,u.count=e):(I(n,r,[],a,u={offset:-1,count:e,path:t,isExpanded:!1}),u.offset>=0&&n.addGroupInfo(u)),n.updateTotalItemsCount()})).fail((function(){o.fireEvent("loadError",arguments)}))},allowCollapseAll:function(){return!1},refresh:function(t,e,n){var o=this,i=t.storeLoadOptions,r=o._dataSource;if(this.callBase.apply(this,arguments),e||n.reload)return h(o,(function(t){var e=g(r,{filter:(0,l.createGroupFilter)(t.path,i)}),n=g(r,{filter:(0,s.createOffsetFilter)(t.path,i)});return(0,d.when)(n,e).done((function(e,n){e=parseInt(e.length?e[0]:e),n=parseInt(n.length?n[0]:n),t.offset=e,t.count!==n&&(t.count=n,o.updateTotalItemsCount())}))}),!0)}}))}

