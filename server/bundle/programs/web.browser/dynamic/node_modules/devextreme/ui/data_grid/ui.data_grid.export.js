function module(t,e){"use strict";var o,n=I(t("../../core/renderer")),r,i=I(t("../../core/class")),l=t("../../core/utils/type"),a=t("../../core/utils/extend"),s=t("../../core/utils/position"),u,d=I(t("../../core/utils/array")),p,c=I(t("./ui.data_grid.core")),m,h=I(t("../grid_core/ui.grid_core.export_mixin")),x=t("../../exporter"),g,f=I(t("../../localization/message")),C,_=I(t("../button")),y,v=I(t("../list")),w,b=I(t("../context_menu")),E=t("../../core/utils/deferred");function I(t){return t&&t.__esModule?t:{default:t}}var S="dx-datagrid-export-menu",T="dx-datagrid-export-button",D="export-to",V="exportxlsx",F="exportselected",B="export-excel-button",G="dx-toolbar-item-auto-hide",R="dx-toolbar-hidden-button",A="dx-button",H=3;e.DataProvider=i.default.inherit({_getGroupValue:function(t){var e=this._options.groupColumns[t.groupIndex],o=c.default.getDisplayValue(e,t.key[t.groupIndex],t.data,t.rowType),n=e.caption+": "+c.default.formatValue(o,e),r=t.summaryCells;return r&&r[0]&&r[0].length&&(n+=" "+c.default.getGroupRowSummaryText(r[0],this._options.summaryTexts)),n},_correctCellIndex:function(t){return t},_initOptions:function(){var t=this._exportController,e=t._columnsController.getGroupColumns(),o=t.option("export.excelWrapTextEnabled");this._options={columns:t._getColumns(this._initialColumnWidthsByColumnIndex),groupColumns:e,items:t._selectionOnly?t._getSelectedItems():t._getAllItems(),getVisibleIndex:t._columnsController.getVisibleIndex.bind(t._columnsController),isHeadersVisible:t.option("showColumnHeaders"),summaryTexts:t.option("summary.texts"),customizeExportData:t.option("customizeExportData"),rtlEnabled:t.option("rtlEnabled"),wrapTextEnabled:(0,l.isDefined)(o)?o:!!t.option("wordWrapEnabled"),customizeExcelCell:t.option("export.customizeExcelCell")}},hasCustomizeExcelCell:function(){return(0,l.isDefined)(this._options.customizeExcelCell)},customizeExcelCell:function(t,e){this._options.customizeExcelCell&&(t.gridCell=e,(0,l.isDefined)(this._exportController)&&(0,l.isDefined)(this._exportController.component)&&(t.component=this._exportController.component),this._options.customizeExcelCell(t))},ctor:function(t,e){this._exportController=t,this._initialColumnWidthsByColumnIndex=e},getStyles:function(){var t=this._options.wrapTextEnabled,e=["center","left","right"].map((function(t){return{bold:!0,alignment:t,wrapText:!0}}));return this.getColumns().forEach((function(o){e.push({alignment:o.alignment||"left",format:o.format,wrapText:t,dataType:o.dataType})})),e.push({bold:!0,wrapText:!1,alignment:(0,s.getDefaultAlignment)(this._options.rtlEnabled)}),e},_getTotalCellStyleId:function(t){var e=this.getColumns()[t]&&this.getColumns()[t].alignment||"right";return["center","left","right"].indexOf(e)},getStyleId:function(t,e){return t<this.getHeaderRowCount()?0:this.isTotalCell(t-this.getHeaderRowCount(),e)?this._getTotalCellStyleId(e):this.isGroupRow(t-this.getHeaderRowCount())?3+this.getColumns().length:e+3},getColumns:function(t){var e=this._options.columns;return t?e:e[e.length-1]},getRowsCount:function(){return this._options.items.length+this.getHeaderRowCount()},getHeaderRowCount:function(){return this.isHeadersVisible()?this._options.columns.length-1:0},isGroupRow:function(t){return t<this._options.items.length&&"group"===this._options.items[t].rowType},getGroupLevel:function(t){var e=this._options.items[t-this.getHeaderRowCount()],o=e&&e.groupIndex;return e&&"totalFooter"===e.rowType?0:(0,l.isDefined)(o)?o:this._options.groupColumns.length},getCellType:function(t,e){var o=this.getColumns();if(t<this.getHeaderRowCount())return"string";if(t-=this.getHeaderRowCount(),e<o.length){var n=this._options.items.length&&this._options.items[t],r=o[e];return n&&"data"===n.rowType&&isFinite(n.values[this._correctCellIndex(e)])&&!(0,l.isDefined)(r.customizeText)?(0,l.isDefined)(r.lookup)?r.lookup.dataType:r.dataType:"string"}},ready:function(){var t,e=this;return e._initOptions(),t=this._options,(0,E.when)(t.items).done((function(o){t.customizeExportData&&t.customizeExportData(e.getColumns(e.getHeaderRowCount()>1),o),t.items=o})).fail((function(){t.items=[]}))},_convertFromGridGroupSummaryItems:function(t){var e=void 0;return(0,l.isDefined)(t)&&t.length>0&&(e=t.map((function(t){return{value:t.value,name:t.name}}))),e},getCellData:function(t,e){var o={cellSourceData:{},value:r},n,r,i,a,s,u,d=this.getColumns(),p=this._correctCellIndex(e),m;if(t<this.getHeaderRowCount())n=this.getColumns(!0)[t][e],o.cellSourceData.rowType="header",o.cellSourceData.column=n&&n.gridColumn,o.value=n&&n.caption;else if(t-=this.getHeaderRowCount(),u=this._options.items.length&&this._options.items[t])switch(s=u.values,o.cellSourceData.rowType=u.rowType,o.cellSourceData.column=d[e]&&d[e].gridColumn,u.rowType){case"groupFooter":case"totalFooter":p<s.length&&(r=s[p],(0,l.isDefined)(r)?(o.cellSourceData.value=r.value,o.cellSourceData.totalSummaryItemName=r.name,o.value=c.default.getSummaryText(r,this._options.summaryTexts)):o.cellSourceData.value=void 0);break;case"group":if(o.cellSourceData.groupIndex=u.groupIndex,e<1)o.cellSourceData.column=this._options.groupColumns[u.groupIndex],o.cellSourceData.value=u.key[u.groupIndex],o.cellSourceData.groupSummaryItems=this._convertFromGridGroupSummaryItems(u.summaryCells[0]),o.value=this._getGroupValue(u);else if(a=u.values[p],Array.isArray(a)){for(o.cellSourceData.groupSummaryItems=this._convertFromGridGroupSummaryItems(a),r="",i=0;i<a.length;i++)r+=(i>0?" \n ":"")+c.default.getSummaryText(a[i],this._options.summaryTexts);o.value=r}else o.cellSourceData.value=void 0;break;default:if(n=d[e]){var h=s[p],x=c.default.getDisplayValue(n,h,u.data,u.rowType);o.value=!isFinite(x)||n.customizeText?c.default.formatValue(x,n):x,o.cellSourceData.value=h}o.cellSourceData.data=u.data}return o},isHeadersVisible:function(){return this._options.isHeadersVisible},isTotalCell:function(t,e){var o,n=this._options.items[t],r=this._correctCellIndex(e),i=n.summaryCells&&n.summaryCells[r]&&n.summaryCells[r].length>0&&n.summaryCells[r][0].alignByColumn;return n&&"groupFooter"===n.rowType||"totalFooter"===n.rowType||i},getCellMerging:function(t,e){var o=this._options.columns,n=o[t]&&o[t][e];return n?{colspan:(n.colspan||1)-1,rowspan:(n.rowspan||1)-1}:{colspan:0,rowspan:0}},getFrozenArea:function(){var t=this;return{x:0,y:this.getHeaderRowCount()}}}),e.ExportController=c.default.ViewController.inherit({}).include(h.default).inherit({_getEmptyCell:function(){return{caption:"",colspan:1,rowspan:1}},_updateColumnWidth:function(t,e){t.width=e},_getColumns:function(t){var e,o,n,r,i=[],l=this._columnsController,s=l.getRowCount();for(e=0;e<=s;e++){i.push([]),r=l.getVisibleColumns(e,!0);var u=void 0;if(e===s)if(this._updateLockCount)u=t;else{var d=this._getColumnWidths(this._headersView,this._rowsView);if(d&&d.length){u={};for(var p=0;p<r.length;p++)u[r[p].index]=d[p]}}for(o=0;o<r.length;o++)n=(0,a.extend)({},r[o],{dataType:"datetime"===r[o].dataType?"date":r[o].dataType,gridColumn:r[o]}),this._needColumnExporting(n)&&(u&&this._updateColumnWidth(n,u[n.index]),i[e].push(n))}return r=i[s],(i=this._prepareItems(i.slice(0,-1))).push(r),i},_needColumnExporting:function(t){return!t.command&&(t.allowExporting||void 0===t.allowExporting)},_getFooterSummaryItems:function(t,e){var o,n,r,i,l=[],a=1,s=0;do{for(o=[],i=0;i<t.length;i++)a<(n=(r=t[i]).length)&&(a=n),o.push(r[s]);l.push({values:o,rowType:e?"totalFooter":"groupFooter"})}while(s++<a-1);return l},_hasSummaryGroupFooters:function(){var t,e=this.option("summary.groupItems");if((0,l.isDefined)(e))for(t=0;t<e.length;t++)if(e[t].showInGroupFooter)return!0;return!1},_getItemsWithSummaryGroupFooters:function(t){var e,o,n=[],r=[],i=[];for(o=0;o<t.length;o++)"groupFooter"===(e=t[o]).rowType?(i=this._getFooterSummaryItems(e.summaryCells),n=n.concat(r,i),r=[]):r.push(e);return n.length?n:r},_updateGroupValuesWithSummaryByColumn:function(t){var e,o,n,r,i,l,a,s=[];for(a=0;a<t.length;a++)if(o=(e=t[a]).summaryCells,"group"===e.rowType&&o&&o.length>1){for(r=e.values.length,l=1;l<o.length;l++)for(i=0;i<o[l].length;i++)(n=o[l][i])&&n.alignByColumn&&(Array.isArray(s[l-r])||(s[l-r]=[]),s[l-r].push(n));s.length>0&&(d.default.merge(e.values,s),s=[])}},_processUnExportedItems:function(t){var e,o,n,r,i,l,a=this._columnsController.getVisibleColumns(null,!0),s=this._columnsController.getGroupColumns();for(i=0;i<t.length;i++){for(e=t[i],n=[],r=[],l=0;l<a.length;l++)o=a[l],this._needColumnExporting(o)&&(e.values&&("group"!==e.rowType||n.length?n.push(e.values[l]):n.push(e.key[e.groupIndex])),e.summaryCells&&("group"!==e.rowType||r.length?r.push(e.summaryCells[l]):r.push(e.summaryCells[l-s.length+e.groupIndex])));n.length&&(e.values=n),r.length&&(e.summaryCells=r)}},_getAllItems:function(t){var e,o,n=this,r=new E.Deferred,i=this.getController("data"),a=i.footerItems(),s=a.length&&a[0],u=n.option("summary.totalItems");return(0,E.when)(t).done((function(t){i.loadAll(t).done((function(t,a){n._updateGroupValuesWithSummaryByColumn(t),n._hasSummaryGroupFooters()&&(t=n._getItemsWithSummaryGroupFooters(t)),e=s&&s.summaryCells,(0,l.isDefined)(a)&&u&&(e=i._getSummaryCells(u,a)),(o=s&&n._getFooterSummaryItems(e,!0))&&(t=t.concat(o)),n._processUnExportedItems(t),r.resolve(t)})).fail(r.reject)})).fail(r.reject),r},_getSelectedItems:function(){var t,e=this.getController("selection").getSelectedRowsData();return this._getAllItems(e)},_getColumnWidths:function(t,e){return t&&t.isVisible()?t.getColumnWidths():e.getColumnWidths()},init:function(){this._columnsController=this.getController("columns"),this._rowsView=this.getView("rowsView"),this._headersView=this.getView("columnHeadersView"),this.createAction("onExporting",{excludeValidators:["disabled","readOnly"]}),this.createAction("onExported",{excludeValidators:["disabled","readOnly"]}),this.createAction("onFileSaving",{excludeValidators:["disabled","readOnly"]})},callbackNames:function(){return["selectionOnlyChanged"]},getExportFormat:function(){return["EXCEL"]},getDataProvider:function(){var t=this._getColumnWidths(this._headersView,this._rowsView),o=void 0;if(t&&t.length){o={};for(var n=this._columnsController.getVisibleColumns(this._columnsController.getRowCount(),!0),r=0;r<n.length;r++)o[n[r].index]=t[r]}return new e.DataProvider(this,o)},exportToExcel:function(t){var e=this;this._selectionOnly=t,(0,x.export)(this.component.getDataProvider(),{fileName:this.option("export.fileName"),proxyUrl:this.option("export.proxyUrl"),format:"EXCEL",autoFilterEnabled:!!this.option("export.excelFilterEnabled"),rtlEnabled:this.option("rtlEnabled"),ignoreErrors:this.option("export.ignoreExcelErrors"),exportingAction:this.getAction("onExporting"),exportedAction:this.getAction("onExported"),fileSavingAction:this.getAction("onFileSaving")},x.excel.getData)},publicMethods:function(){return["getDataProvider","getExportFormat","exportToExcel"]},selectionOnly:function(t){if(!(0,l.isDefined)(t))return this._isSelectedRows;this._isSelectedRows=t,this.selectionOnlyChanged.fire()}}),c.default.registerModule("export",{defaultOptions:function(){return{export:{enabled:!1,fileName:"DataGrid",excelFilterEnabled:!1,excelWrapTextEnabled:void 0,proxyUrl:void 0,allowExportSelectedData:!1,ignoreExcelErrors:!0,texts:{exportTo:f.default.format("dxDataGrid-exportTo"),exportAll:f.default.format("dxDataGrid-exportAll"),exportSelectedRows:f.default.format("dxDataGrid-exportSelectedRows")}}}},controllers:{export:e.ExportController},extenders:{controllers:{editing:{callbackNames:function(){var t=this.callBase();return(0,l.isDefined)(t)?t.push("editingChanged"):["editingChanged"]},_updateEditButtons:function(){this.callBase(),this.editingChanged.fire(this.hasChanges())}}},views:{headerPanel:{_getToolbarItems:function(){var t=this.callBase();return this._appendExportItems(t)},_appendExportItems:function(t){var e=this,o=e.option("export");if(o.enabled){var r=[];o.allowExportSelectedData?r.push({template:function(t,o,r){var i=(0,n.default)(r);e._renderButton(t,i),e._renderExportMenu(i)},menuItemTemplate:function(t,o,r){e._renderList(t,(0,n.default)(r))},name:"exportButton",allowExportSelected:!0,location:"after",locateInMenu:"auto",sortIndex:30}):r.push({template:function(t,o,r){e._renderButton(t,(0,n.default)(r))},menuItemTemplate:function(t,o,r){e._renderButton(t,(0,n.default)(r),!0)},name:"exportButton",location:"after",locateInMenu:"auto",sortIndex:30}),t=t.concat(r),e._correctItemsPosition(t)}return t},_renderButton:function(t,e,o){var r=this,i=this._getButtonOptions(t.allowExportSelected),l=this._getButtonContainer().addClass("dx-datagrid-export-button").appendTo(e);if(o){var a=(0,n.default)("<div>").addClass("dx-toolbar-item-auto-hide");e.wrapInner(a).parent().addClass("dx-toolbar-menu-action dx-toolbar-menu-button dx-toolbar-hidden-button"),i.text=i.hint}this._createComponent(l,_.default,i)},_renderList:function(t,e){var o=this,r=o.option("export.texts"),i=[{template:function(t,e,r){o._renderFakeButton(t,(0,n.default)(r),"exportxlsx")},text:r.exportAll},{template:function(t,e,r){o._renderFakeButton(t,(0,n.default)(r),"exportselected")},text:r.exportSelectedRows,exportSelected:!0}];o._createComponent(e,v.default,{items:i,onItemClick:function(t){o._exportController.exportToExcel(t.itemData.exportSelected)},scrollingEnabled:!1})},_renderFakeButton:function(t,e,o){var r=(0,n.default)("<div>").addClass("dx-icon dx-icon-"+o),i=(0,n.default)("<span>").addClass("dx-button-text").text(t.text),l=(0,n.default)("<div>").addClass("dx-button-content").append(r).append(i),a=(0,n.default)("<div>").addClass("dx-button dx-button-has-text dx-button-has-icon dx-datagrid-toolbar-button").append(l),s=(0,n.default)("<div>").addClass("dx-toolbar-item-auto-hide").append(a);e.append(s).parent().addClass("dx-toolbar-menu-custom dx-toolbar-hidden-button")},_correctItemsPosition:function(t){t.sort((function(t,e){return t.sortIndex-e.sortIndex}))},_renderExportMenu:function(t){var e=this,o=t.find(".dx-button"),r=e.option("export.texts"),i=[{text:r.exportAll,icon:"exportxlsx"},{text:r.exportSelectedRows,exportSelected:!0,icon:"exportselected"}],l=(0,n.default)("<div>").appendTo(t);e._contextMenu=e._createComponent(l,b.default,{showEvent:"dxclick",items:i,cssClass:"dx-datagrid-export-menu",onItemClick:function(t){e._exportController.exportToExcel(t.itemData.exportSelected)},target:o,position:{at:"left bottom",my:"left top",offset:"0 3",collision:"fit",boundary:e._$parent,boundaryOffset:"1 1"}})},_isExportButtonVisible:function(){return this.option("export.enabled")},_getButtonOptions:function(t){var e,o=this,n=o.option("export.texts");return e=t?{hint:n.exportTo,icon:"export-to"}:{hint:n.exportAll,icon:"export-excel-button",onClick:function(){o._exportController.exportToExcel()}}},optionChanged:function(t){this.callBase(t),"export"===t.name&&(t.handled=!0,this._invalidate())},init:function(){var t=this;this.callBase(),this._exportController=this.getController("export"),this._editingController=this.getController("editing"),this._editingController.editingChanged.add((function(e){t.setToolbarItemDisabled("exportButton",e)}))},isVisible:function(){return this.callBase()||this._isExportButtonVisible()}}}}})}

