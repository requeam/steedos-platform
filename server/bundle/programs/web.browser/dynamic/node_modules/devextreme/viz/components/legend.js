function module(t,e){"use strict";var i=t("../core/utils"),n=t("../../core/utils/extend").extend,o=t("../../core/utils/iterator").each,r=t("../core/layout_element"),s=t("../../core/utils/type"),a=Number,h=Math,c=h.round,u=h.max,l=h.min,d=h.ceil,g=t("../../core/utils/object"),m=t("../../core/utils/common").noop,p=s.isDefined,f=s.isFunction,_=i.enumParser,v=i.normalizeEnum,x=n,y=10,b=2,k=5,I="center",L="right",w="left",z="top",O="bottom",B="horizontal",S="vertical",C="inside",A="outside",T="none",G="height",P="width",R=_([w,I,L]),D=_([z,O]),E=_([S,B]),H=_([w,L,z,O]),j=_([A,C]),F=_([w,I,L]);function M(t,e){if(t){var i=t.fill;return{fill:i===T?e:i,hatching:x({},t.hatching,{step:k,width:b})}}}function N(t){var e=t.margin;e=e>=0?{top:e=a(t.margin),bottom:e,left:e,right:e}:{top:e.top>=0?a(e.top):y,bottom:e.bottom>=0?a(e.bottom):y,left:e.left>=0?a(e.left):y,right:e.right>=0?a(e.right):y},t.margin=e}function U(t,e,i){var n,o,r=7,s=4;switch(t.itemTextPosition){case w:case L:n=e+7+i.width,o=u(e,i.height);break;case z:case O:n=u(e,i.width),o=e+4+i.height}return{width:n,height:o}}function W(t,e){var i={};return i.left=l(t.x,e.x),i.top=l(t.y,e.y),i.right=u(t.x+t.width,e.x+e.width),i.bottom=u(t.y+t.height,e.y+e.height),i}function Y(t,e,i,n){var o=e&&i[e[t]];o&&o.marker.smartAttr(o.states[n])}function q(t,e){return t?(N(t),t.horizontalAlignment=R(t.horizontalAlignment,L),t.verticalAlignment=D(t.verticalAlignment,t.horizontalAlignment===I?O:z),t.orientation=E(t.orientation,t.horizontalAlignment===I?B:S),t.itemTextPosition=H(t.itemTextPosition,t.orientation===B?O:L),t.position=j(t.position,A),t.itemsAlignment=F(t.itemsAlignment,null),t.hoverMode=v(t.hoverMode),t.customizeText=f(t.customizeText)?t.customizeText:function(){return this[e]},t.customizeHint=f(t.customizeHint)?t.customizeHint:m,t._incidentOccurred=t._incidentOccurred||m,t):null}function V(t,e){return t.rect(0,0,e,e)}function X(t,e){return t.circle(e/2,e/2,e/2)}function J(t){return"circle"===v(t)}function K(t,e,i){return e>=t.left&&e<=t.right&&i>=t.top&&i<=t.bottom}function Q(t,e,i,n){var o={x:0,y:0},r=0,s=0,a=0;if(a="y"===e.direction?n.top+n.bottom:n.left+n.right,t.forEach((function(t,i){var n=t[0],a=t.length;t.forEach((function(t,i){var n=t.offset||e.spacing;o[e.direction]+=t[e.measure]+(i!==a-1?n:0),r=u(r,o[e.direction])})),o[e.direction]=0,o[e.altDirection]+=n[e.altMeasure]+n.altOffset||e.altSpacing,s=u(s,o[e.altDirection])})),r+a>e.length)return e.countItem=Z(e,i),!0}function Z(t,e){return t.altCountItem++,d(e/t.altCountItem)}function $(t,e){var i=0;return o(t,(function(t,n){var o=n.offset||e.spacing;i+=n[e.measure]+o})),i}function tt(t,e){var i=0;return o(t,(function(t,n){i=u(i,$(n,e))})),i}function et(t,e,i){var n,o=$(t,e);switch(e.itemsAlignment){case L:n=i-o;break;case I:n=(i-o)/2;break;default:n=0}return n}function it(t){switch(t.itemTextPosition){case O:return{horizontal:I,vertical:z};case z:return{horizontal:I,vertical:O};case w:return{horizontal:L,vertical:I};case L:return{horizontal:w,vertical:I}}}function nt(t,e,i){var n={};return i%e.countItem==0&&(e.markerOffset?t.push([],[]):t.push([])),e.markerOffset?(n.firstLine=t[t.length-1],n.secondLine=t[t.length-2]):n.firstLine=n.secondLine=t[t.length-1],n}function ot(t,e){var i=0;o(t,(function(t,n){n&&(i=u(i,n[e]))})),o(t,(function(t,n){n&&(n[e]=i)}))}function rt(t){var e,i,n=t.length,o=t[0].length,r=[];for(e=0;e<o;e++)for(r[e]=[],i=0;i<n;i++)r[e][i]=t[i][e];return r}function st(t){switch(t){case z:case O:return I;case w:return L;case L:return w}}var at=function(t){return J(t)?X:V},ht=e.Legend=function(t){var e=this;this._renderer=t.renderer,this._legendGroup=t.group,this._backgroundClass=t.backgroundClass,this._itemGroupClass=t.itemGroupClass,this._textField=t.textField,this._getCustomizeObject=t.getFormatObject},ct;n(ht.prototype=g.clone(r.LayoutElement.prototype),{constructor:ht,getOptions:function(){return this._options},update:function(t,e){var i=this;return this._data=t,this._boundingRect={width:0,height:0,x:0,y:0},this._options=q(e,this._textField),this},draw:function(t,e){var i=this,n=this._options,o=this._renderer,r=this._data;return this._size={width:t,height:e},this.erase(),n&&n.visible&&r&&r.length?(this._insideLegendGroup=o.g().append(this._legendGroup),this._createBackground(),this._createItems(this._getItemData()),this._locateElements(n),this._finalUpdate(n),(this.getLayoutOptions().width>t||this.getLayoutOptions().height>e)&&this.freeSpace(),this):this},probeDraw:function(t,e){return this.draw(t,e)},_createItems:function(t){var e,n=this,r=n._options,s=r.markerSize,h=n._renderer,c=0,l=at(r.markerShape);n._markersId={},n._items=i.map(t,(function(t,i){var o=n._insideLegendGroup,d=a(t.size>0?t.size:s),g=t.states,m=g.normal,p=m.fill,f=l(h,d).attr({fill:p||r.markerColor||r.defaultColor,opacity:m.opacity}).append(o),_=n._createLabel(t,o),v={normal:{fill:p},hovered:M(g.hover,p),selected:M(g.selection,p)},x=_.getBBox();return void 0!==t.id&&(n._markersId[t.id]=i),e=U(r,d,x),c=u(c,e.height),n._createHint(t,_,f),{label:_,labelBBox:x,group:o,bBox:e,marker:f,markerSize:d,tracker:{id:t.id,argument:t.argument,argumentIndex:t.argumentIndex},states:v,itemTextPosition:r.itemTextPosition,markerOffset:0,bBoxes:[]}})),r.equalRowHeight&&o(n._items,(function(t,e){e.bBox.height=c}))},_getItemData:function(){var t=this._data;return this._options.inverted&&(t=t.slice().reverse()),t},_finalUpdate:function(t){this._adjustBackgroundSettings(t),this._setBoundingRect(t.margin)},erase:function(){var t=this,e=this._insideLegendGroup;return e&&e.dispose(),this._insideLegendGroup=this._x1=this._x2=this._y2=this._y2=null,this},_locateElements:function(t){this._moveInInitialValues(),this._locateRowsColumns(t)},_moveInInitialValues:function(){var t=this;this._legendGroup&&this._legendGroup.move(0,0),this._background&&this._background.attr({x:0,y:0,width:0,height:0})},applySelected:function(t){return Y(t,this._markersId,this._items,"selected"),this},applyHover:function(t){return Y(t,this._markersId,this._items,"hovered"),this},resetItem:function(t){return Y(t,this._markersId,this._items,"normal"),this},_createLabel:function(t,e){var n=this._getCustomizeObject(t),o=st(this._options.itemTextPosition),r=this._options.customizeText.call(n,n),s=p(t.textOpacity)?x({},this._options.font,{opacity:t.textOpacity}):this._options.font;return this._renderer.text(r,0,0).css(i.patchFontOptions(s)).attr({align:o}).append(e)},_createHint:function(t,e,i){var n=this._getCustomizeObject(t),o=this._options.customizeHint.call(n,n);p(o)&&""!==o&&(e.setTitle(o),i.setTitle(o))},_createBackground:function(){var t=this,e=this._options.position===C,i=this._options.backgroundColor,n=i||(e?this._options.containerBackgroundColor:T);(this._options.border.visible||(e||i)&&i!==T)&&(this._background=this._renderer.rect(0,0,0,0).attr({fill:n,class:this._backgroundClass}).append(this._insideLegendGroup))},_locateRowsColumns:function(t){var e,i=this,n=0,o=this._getItemsLayoutOptions(),r=this._items.length;do{e=[],this._createLines(e,o),this._alignLines(e,o),n++}while(Q(e,o,r,t.margin)&&n<r);this._applyItemPosition(e,o)},_createLines:function(t,e){o(this._items,(function(i,n){var o,r,s=nt(t,e,i),a={width:n.labelBBox.width,height:n.labelBBox.height,element:n.label,bBox:n.labelBBox,pos:it(e),itemIndex:i},h={width:n.markerSize,height:n.markerSize,element:n.marker,pos:{horizontal:I,vertical:I},bBox:{width:n.markerSize,height:n.markerSize,x:0,y:0},itemIndex:i},c=e.markerOffset?"altOffset":"offset";e.inverseLabelPosition?(o=a,r=h):(o=h,r=a),o[c]=e.labelOffset,s.secondLine.push(o),s.firstLine.push(r)}))},_alignLines:function(t,e){var i,n=e.altMeasure;if(o(t,r),n=e.measure,e.itemsAlignment){if(e.markerOffset)for(i=0;i<t.length;)o(rt([t[i++],t[i++]]),r)}else o(rt(t),r);function r(t,e){ot(e,n)}},_applyItemPosition:function(t,e){var i=this,n={x:0,y:0},s=tt(t,e);o(t,(function(t,a){var h=a[0],c=h.altOffset||e.altSpacing;n[e.direction]=et(a,e,s),o(a,(function(t,o){var s=o.offset||e.spacing,a=new r.WrapperLayoutElement(o.element,o.bBox),h=new r.WrapperLayoutElement(null,{x:n.x,y:n.y,width:o.width,height:o.height}),c=i._items[o.itemIndex];a.position({of:h,my:o.pos,at:o.pos}),c.bBoxes.push(h),n[e.direction]+=o[e.measure]+s})),n[e.altDirection]+=h[e.altMeasure]+c})),o(this._items,(function(t,e){var n=W(e.bBoxes[0].getLayoutOptions(),e.bBoxes[1].getLayoutOptions()),o=i._options.columnItemSpacing/2,r=i._options.rowItemSpacing/2;e.tracker.left=n.left-o,e.tracker.right=n.right+o,e.tracker.top=n.top-r,e.tracker.bottom=n.bottom+r}))},_getItemsLayoutOptions:function(){var t=this,e=this._options,i=e.orientation,n={itemsAlignment:e.itemsAlignment,orientation:e.orientation},o=this._size.width-(this._background?2*e.paddingLeftRight:0),r=this._size.height-(this._background?2*e.paddingTopBottom:0);return i===B?(n.length=o,n.spacing=e.columnItemSpacing,n.direction="x",n.measure=P,n.altMeasure=G,n.altDirection="y",n.altSpacing=e.rowItemSpacing,n.countItem=e.columnCount,n.altCountItem=e.rowCount,n.marginTextLabel=4,n.labelOffset=7,e.itemTextPosition!==O&&e.itemTextPosition!==z||(n.labelOffset=4,n.markerOffset=!0)):(n.length=r,n.spacing=e.rowItemSpacing,n.direction="y",n.measure=G,n.altMeasure=P,n.altDirection="x",n.altSpacing=e.columnItemSpacing,n.countItem=e.rowCount,n.altCountItem=e.columnCount,n.marginTextLabel=7,n.labelOffset=4,e.itemTextPosition!==L&&e.itemTextPosition!==w||(n.labelOffset=7,n.markerOffset=!0)),n.countItem||(n.altCountItem?n.countItem=d(this._items.length/n.altCountItem):n.countItem=this._items.length),e.itemTextPosition!==z&&e.itemTextPosition!==w||(n.inverseLabelPosition=!0),n.itemTextPosition=e.itemTextPosition,n.altCountItem=n.altCountItem||d(this._items.length/n.countItem),n},_adjustBackgroundSettings:function(t){if(this._background){var e=t.border,i=this._insideLegendGroup.getBBox(),n={x:c(i.x-t.paddingLeftRight),y:c(i.y-t.paddingTopBottom),width:c(i.width)+2*t.paddingLeftRight,height:c(i.height)+2*t.paddingTopBottom,opacity:t.backgroundOpacity};e.visible&&e.width&&e.color&&e.color!==T&&(n["stroke-width"]=e.width,n.stroke=e.color,n["stroke-opacity"]=e.opacity,n.dashStyle=e.dashStyle,n.rx=e.cornerRadius||0,n.ry=e.cornerRadius||0),this._background.attr(n)}},_setBoundingRect:function(t){if(this._insideLegendGroup){var e=this._insideLegendGroup.getBBox();e.height+=t.top+t.bottom,e.width+=t.left+t.right,e.x-=t.left,e.y-=t.top,this._boundingRect=e}},getActionCallback:function(t){var e=this;return e._options.visible?function(i){e[i](t.index)}:m},getLayoutOptions:function(){var t=this._options,e=this._insideLegendGroup?this._boundingRect:{width:0,height:0,x:0,y:0};return t?(e.verticalAlignment=t.verticalAlignment,e.horizontalAlignment=t.horizontalAlignment,t.orientation===B?(e.cutLayoutSide=t.verticalAlignment,e.cutSide="vertical"):t.horizontalAlignment===I?(e.cutLayoutSide=t.verticalAlignment,e.cutSide="vertical"):(e.cutLayoutSide=t.horizontalAlignment,e.cutSide="horizontal"),e.position={horizontal:t.horizontalAlignment,vertical:t.verticalAlignment},e):null},shift:function(t,e){var i=this,n={};return this._insideLegendGroup&&(this._insideLegendGroup.attr({translateX:t-this._boundingRect.x,translateY:e-this._boundingRect.y}),n=this._legendGroup.getBBox()),this._x1=n.x,this._y1=n.y,this._x2=n.x+n.width,this._y2=n.y+n.height,this},getPosition:function(){return this._options.position},coordsIn:function(t,e){return t>=this._x1&&t<=this._x2&&e>=this._y1&&e<=this._y2},getItemByCoord:function(t,e){var i=this._items,n=this._insideLegendGroup;t-=n.attr("translateX"),e-=n.attr("translateY");for(var o=0;o<i.length;o++)if(K(i[o].tracker,t,e))return i[o].tracker;return null},dispose:function(){var t=this;return this._legendGroup=this._insideLegendGroup=this._renderer=this._options=this._data=this._items=null,this},layoutOptions:function(){var t=this.getLayoutOptions();return{horizontalAlignment:this._options.horizontalAlignment,verticalAlignment:this._options.verticalAlignment,side:t.cutSide,priority:1}},measure:function(t){this.draw(t[0],t[1]);var e=this.getLayoutOptions();return[e.width,e.height]},move:function(t){this.shift(t[0],t[1])},freeSpace:function(){this._options._incidentOccurred("W2104"),this.erase()}}),e.plugin={name:"legend",init:function(){var t=this,i=this._renderer.g().attr({class:this._rootClassPrefix+"-legend"}).append(this._renderer.root);this._legend=new e.Legend({renderer:this._renderer,group:i,textField:"text",getFormatObject:function(t){return{item:t,text:t.argument}}}),this._layout.add(this._legend)},extenders:{_applyTilesAppearance:function(){var t=this;this._items.forEach((function(e){t._applyLegendItemStyle(e.id,e.getState())}))},_buildNodes:function(){this._createLegendItems()}},members:{_applyLegendItemStyle:function(t,e){var i=this._legend;switch(e){case"hover":i.applyHover(t);break;case"selection":i.applySelected(t);break;default:i.resetItem(t)}},_createLegendItems:function(){this._legend.update(this.getAllItems(),this._getOption("legend"))&&this._requestChange(["LAYOUT"])}},dispose:function(){this._legend.dispose()},customize:function(t){t.prototype._proxyData.push((function(t,e){if(this._legend.coordsIn(t,e)){var i=this._legend.getItemByCoord(t,e);if(i)return{id:i.id,type:"legend"}}})),t.addChange({code:"LEGEND",handler:function(){this._createLegendItems()},isThemeDependent:!0,option:"legend",isOptionChange:!0})}}}

