function module(e,t,n){"use strict";var l,i=b(e("../../core/renderer")),o,s=b(e("../../events/core/events_engine")),c,a=b(e("../data_grid/ui.data_grid.core")),r=e("./ui.grid_core.utils"),d=e("../../core/utils/type"),h=e("../../core/utils/iterator"),u=e("../../core/utils/extend"),f,p=b(e("../../core/utils/support")),m,C=b(e("../../events/click")),g,S=b(e("../../localization/message")),x=e("../../events/utils"),v,y=b(e("../../events/hold")),_,w=b(e("../selection/selection")),k=e("../../core/utils/deferred");function b(e){return e&&e.__esModule?e:{default:e}}var I="dx-editor-cell",A="dx-row",R="dx-selection",K="dx-select-checkbox",B="dx-select-checkboxes-hidden",D="dx-command-select",T="dx-selection-disabled",W="dx-data-row",F="selection.showCheckBoxesMode",V="selection.mode",E=function(e,t){var n=e.getController("selection"),l=e.getView("rowsView"),o=(0,i.default)(t.target).closest(".dx-data-row"),s=l.getRowIndex(o);s<0||("onLongTap"===e.option(F)?n.isSelectionWithCheckboxes()?n.stopSelectionWithCheckboxes():n.startSelectionWithCheckboxes():("onClick"===e.option(F)&&n.startSelectionWithCheckboxes(),"always"!==e.option(F)&&n.changeItemSelection(s,{control:!0})))},M,O,P;t.SelectionController=a.default.Controller.inherit((M=function(e,t){var n=0,l=e._dataController.store(),i=l&&l.key(),o=Array.isArray(i);if(!t.length)return!1;if(o&&Array.isArray(t[0])&&"and"===t[1]){for(var s=0;s<t.length;s++)if(Array.isArray(t[s])){if(t[s][0]!==i[n]||"="!==t[s][1])return!0;n++}return!1}return i!==t[0]},O=function(e,t){var n;t.component.getView("rowsView").renderSelectCheckBoxContainer((0,i.default)(e),t)},P=function(e,t){var n=t.column,l=(0,i.default)(e),o=t.component.getView("columnHeadersView");l.addClass("dx-editor-cell"),o._renderSelectAllCheckBox(l,n),o._attachSelectAllCheckBoxClickEvent(l)},{init:function(){this._dataController=this.getController("data"),this._selectionMode=this.option(V),this._isSelectionWithCheckboxes=!1,this._selection=this._createSelection(),this._updateSelectColumn(),this.createAction("onSelectionChanged",{excludeValidators:["disabled","readOnly"]})},_getSelectionConfig:function(){var e=this,t=this._dataController,n=this.option("selection")||{};return{selectedKeys:this.option("selectedRowKeys"),mode:this._selectionMode,deferred:n.deferred,maxFilterLengthInRequest:n.maxFilterLengthInRequest,selectionFilter:this.option("selectionFilter"),key:function(){return t&&t.key()},keyOf:function(e){return t&&t.keyOf(e)},dataFields:function(){return t.dataSource()&&t.dataSource().select()},load:function(e){return t.dataSource()&&t.dataSource().load(e)||(new k.Deferred).resolve([])},plainItems:function(){return t.items(!0)},isItemSelected:function(e){return e.selected},isSelectableItem:function(e){return e&&"data"===e.rowType&&!e.inserted},getItemData:function(e){return e&&(e.oldData||e.data||e)},filter:function(){return t.getCombinedFilter()},totalCount:function(){return t.totalCount()},onSelectionChanged:this._updateSelectedItems.bind(this)}},_updateSelectColumn:function(){var e=this.getController("columns"),t=this.isSelectColumnVisible();e.addCommandColumn({type:"selection",command:"select",visible:t,visibleIndex:-1,dataType:"boolean",alignment:"center",cssClass:"dx-command-select",width:"auto",cellTemplate:O,headerCellTemplate:P}),e.columnOption("command:select","visible",t)},_createSelection:function(){var e=this._getSelectionConfig();return new w.default(e)},_fireSelectionChanged:function(e){e&&this.executeAction("onSelectionChanged",e);var t=this.option("selection.deferred")?{selectionFilter:this.option("selectionFilter")}:{selectedRowKeys:this.option("selectedRowKeys")};this.selectionChanged.fire(t)},_updateCheckboxesState:function(e){var t=e.isDeferredMode,n=e.selectionFilter,l=e.selectedItemKeys,i=e.removedItemKeys;"onClick"===this.option(F)&&((t?n&&M(this,n):l.length>1)?this.startSelectionWithCheckboxes():(t?n&&!n.length:0===l.length&&i.length)&&this.stopSelectionWithCheckboxes())},_updateSelectedItems:function(e){var t,n=this,l=this.option("selection.deferred"),i=this._selection.selectionFilter(),o=this._dataController,s=o.items();if(s){var c=this.isSelectionWithCheckboxes(),a=this.getChangedItemIndexes(s);this._updateCheckboxesState({selectedItemKeys:e.selectedItemKeys,removedItemKeys:e.removedItemKeys,selectionFilter:i,isDeferredMode:l}),(a.length||c!==this.isSelectionWithCheckboxes())&&o.updateItems({changeType:"updateSelection",itemIndexes:a}),l?(this.option("selectionFilter",i),t={}):(e.addedItemKeys.length||e.removedItemKeys.length)&&(this._selectedItemsInternalChange=!0,this.option("selectedRowKeys",e.selectedItemKeys.slice(0)),this._selectedItemsInternalChange=!1,t={selectedRowsData:e.selectedItems.slice(0),selectedRowKeys:e.selectedItemKeys.slice(0),currentSelectedRowKeys:e.addedItemKeys.slice(0),currentDeselectedRowKeys:e.removedItemKeys.slice(0)}),this._fireSelectionChanged(t)}},getChangedItemIndexes:function(e){for(var t=this,n=[],l=this.option("selection.deferred"),i=0,o=e.length;i<o;i++){var s=e[i],c=this.isRowSelected(l?s.data:s.key);this._selection.isDataItem(s)&&s.isSelected!==c&&n.push(i)}return n},callbackNames:function(){return["selectionChanged"]},optionChanged:function(e){var t=this;switch(t.callBase(e),e.name){case"selection":var n=t._selectionMode;t.init();var l=t._selectionMode,i=t.option("selectedRowKeys");n!==l&&("single"===l?i.length>1&&(i=[i[0]]):"multiple"!==l&&(i=[])),t.selectRows(i).always((function(){t._fireSelectionChanged()})),t.getController("columns").updateColumns(),e.handled=!0;break;case"selectionFilter":this._selection.selectionFilter(e.value),e.handled=!0;break;case"selectedRowKeys":Array.isArray(e.value)&&!t._selectedItemsInternalChange&&t.component.getDataSource()&&t.selectRows(e.value),e.handled=!0}},publicMethods:function(){return["selectRows","deselectRows","selectRowsByIndexes","getSelectedRowKeys","getSelectedRowsData","clearSelection","selectAll","deselectAll","startSelectionWithCheckboxes","stopSelectionWithCheckboxes","isRowSelected"]},isRowSelected:function(e){return this._selection.isItemSelected(e)},isSelectColumnVisible:function(){return"multiple"===this.option(V)&&("always"===this.option(F)||"onClick"===this.option(F)||this._isSelectionWithCheckboxes)},_isOnePageSelectAll:function(){return"page"===this.option("selection.selectAllMode")},isSelectAll:function(){return this._selection.getSelectAllState(this._isOnePageSelectAll())},selectAll:function(){return"onClick"===this.option(F)&&this.startSelectionWithCheckboxes(),this._selection.selectAll(this._isOnePageSelectAll())},deselectAll:function(){return this._selection.deselectAll(this._isOnePageSelectAll())},clearSelection:function(){return this.selectedItemKeys([])},refresh:function(){var e=this.option("selectedRowKeys")||[];return!this.option("selection.deferred")&&e.length?this.selectedItemKeys(e):(new k.Deferred).resolve().promise()},selectedItemKeys:function(e,t,n,l){return this._selection.selectedItemKeys(e,t,n,l)},getSelectedRowKeys:function(){return this._selection.getSelectedItemKeys()},selectRows:function(e,t){return this.selectedItemKeys(e,t)},deselectRows:function(e){return this.selectedItemKeys(e,!0,!0)},selectRowsByIndexes:function(e){var t=this._dataController.items(),n=[];return Array.isArray(e)||(e=Array.prototype.slice.call(arguments,0)),(0,h.each)(e,(function(){var e=t[this];e&&"data"===e.rowType&&n.push(e.key)})),this.selectRows(n)},getSelectedRowsData:function(){return this._selection.getSelectedItems()},changeItemSelection:function(e,t){return t=t||{},this.isSelectionWithCheckboxes()&&(t.control=!0),this._selection.changeItemSelection(this._dataController.getRowIndexDelta()+e,t)},focusedItemIndex:function(e){var t=this;if(!(0,d.isDefined)(e))return this._selection._focusedItemIndex;this._selection._focusedItemIndex=e},isSelectionWithCheckboxes:function(){return"multiple"===this.option(V)&&("always"===this.option(F)||this._isSelectionWithCheckboxes)},startSelectionWithCheckboxes:function(){var e=this;return"multiple"===this.option(V)&&!this.isSelectionWithCheckboxes()&&(this._isSelectionWithCheckboxes=!0,this._updateSelectColumn(),!0)},stopSelectionWithCheckboxes:function(){var e=this;return!!this._isSelectionWithCheckboxes&&(this._isSelectionWithCheckboxes=!1,this._updateSelectColumn(),!0)}})),n.exports={defaultOptions:function(){return{selection:{mode:"none",showCheckBoxesMode:"onClick",allowSelectAll:!0,selectAllMode:"allPages",maxFilterLengthInRequest:1500,deferred:!1},selectionFilter:[],selectedRowKeys:[]}},controllers:{selection:t.SelectionController},extenders:{controllers:{data:{init:function(){var e=this.getController("selection"),t=this.option("selection.deferred");this.callBase.apply(this,arguments),t&&e._updateCheckboxesState({isDeferredMode:!0,selectionFilter:this.option("selectionFilter")})},_loadDataSource:function(){var e=this;return e.callBase().done((function(){e.getController("selection").refresh()}))},_processDataItem:function(e,t){var n=this,l=n.getController("selection"),i=l.isSelectColumnVisible(),o=t.isDeferredSelection=void 0===t.isDeferredSelection?this.option("selection.deferred"):t.isDeferredSelection,s=this.callBase.apply(this,arguments);if(s.isSelected=l.isRowSelected(o?s.data:s.key),i&&s.values)for(var c=0;c<t.visibleColumns.length;c++)if("select"===t.visibleColumns[c].command){s.values[c]=s.isSelected;break}return s},refresh:function(e){var t=this,n=new k.Deferred;return this.callBase.apply(this,arguments).done((function(){!e||e.selection?t.getController("selection").refresh().done(n.resolve).fail(n.reject):n.resolve()})).fail(n.reject),n.promise()},_handleDataChanged:function(e){this.callBase.apply(this,arguments),e&&"refresh"!==e.changeType||this._repaintChangesOnly||this.getController("selection").focusedItemIndex(-1)},_applyChange:function(e){var t=this;if(!e||"updateSelection"!==e.changeType)return this.callBase.apply(this,arguments);e.items.forEach((function(e,n){var l=t._items[n];l&&(l.isSelected=e.isSelected,l.values=e.values)}))},_endUpdateCore:function(){var e=this._changes,t=e.length>1&&e.every((function(e){return"updateSelection"===e.changeType}));if(t){var n=e.map((function(e){return e.itemIndexes||[]})).reduce((function(e,t){return e.concat(t)}));this._changes=[{changeType:"updateSelection",itemIndexes:n}]}this.callBase.apply(this,arguments)}},contextMenu:{_contextMenuPrepared:function(e){var t=e.event;t.originalEvent&&"dxhold"!==t.originalEvent.type||e.items&&e.items.length>0||E(this,t)}}},views:{columnHeadersView:{init:function(){var e=this;this.callBase(),this.getController("selection").selectionChanged.add(this._updateSelectAllValue.bind(this))},_updateSelectAllValue:function(){var e=this,t=this.element(),n=t&&t.find(".dx-select-checkbox");t&&n.length&&"multiple"===this.option("selection.mode")&&n.dxCheckBox("instance").option("value",this.getController("selection").isSelectAll())},_handleDataChanged:function(e){this.callBase(e),e&&"refresh"!==e.changeType||this._updateSelectAllValue()},_renderSelectAllCheckBox:function(e,t){var n,l=this,o=l.getController("selection");return n=(0,i.default)("<div>").appendTo(e).addClass("dx-select-checkbox"),l.setAria("label",S.default.format("dxDataGrid-ariaSelectAll"),e),l.getController("editorFactory").createEditor(n,(0,u.extend)({},t,{parentType:"headerRow",dataType:"boolean",value:o.isSelectAll(),editorOptions:{visible:l.option("selection.allowSelectAll")||!1!==o.isSelectAll()},tabIndex:-1,setValue:function(e,t){var n=l.option("selection.allowSelectAll");t.component.option("visible",n||!1!==t.component.option("value")),t.event&&o.isSelectAll()!==e&&(t.value&&!n?t.component.option("value",!1):t.value?o.selectAll():o.deselectAll(),t.event.preventDefault())}})),n},_attachSelectAllCheckBoxClickEvent:function(e){s.default.on(e,C.default.name,this.createAction((function(e){var t=e.event;(0,i.default)(t.target).closest(".dx-select-checkbox").length||s.default.trigger((0,i.default)(t.currentTarget).children(".dx-select-checkbox"),C.default.name),t.preventDefault()})))}},rowsView:{renderSelectCheckBoxContainer:function(e,t){"data"!==t.rowType||t.row.inserted?(0,r.setEmptyText)(e):(e.addClass("dx-editor-cell"),this._attachCheckBoxClickEvent(e),this.setAria("label",S.default.format("dxDataGrid-ariaSelectRow"),e),this._renderSelectCheckBox(e,t))},_renderSelectCheckBox:function(e,t){var n=(0,i.default)("<div>").addClass("dx-select-checkbox").appendTo(e);return this.getController("editorFactory").createEditor(n,(0,u.extend)({},t.column,{parentType:"dataRow",dataType:"boolean",lookup:null,value:t.value,tabIndex:-1,setValue:function(t,n){n&&n.event&&"keydown"===n.event.type&&s.default.trigger(e,C.default.name,n)},row:t.row})),n},_attachCheckBoxClickEvent:function(e){s.default.on(e,C.default.name,this.createAction((function(e){var t=this.getController("selection"),n=e.event,l=this.getRowIndex((0,i.default)(n.currentTarget).closest(".dx-row"));l>=0&&(t.startSelectionWithCheckboxes(),t.changeItemSelection(l,{shift:n.shiftKey}),(0,i.default)(n.target).closest(".dx-select-checkbox").length&&this.getController("data").updateItems({changeType:"updateSelection",itemIndexes:[l]}))})))},_update:function(e){var t=this,n=t.getTableElements();"updateSelection"===e.changeType?n.length>0&&((0,h.each)(n,(function(n,l){(0,h.each)(e.itemIndexes||[],(function(n,o){var s,c;e.items[o]&&(s=t._getRowElements((0,i.default)(l)).eq(o)).length&&(c=e.items[o].isSelected,s.toggleClass("dx-selection",void 0!==c&&c).find(".dx-select-checkbox").dxCheckBox("option","value",c),t.setAria("selected",c,s))}))})),t._updateCheckboxesClass()):t.callBase(e)},_createTable:function(){var e=this,t=e.option("selection.mode"),n=e.callBase.apply(e,arguments);return"none"!==t&&("onLongTap"!==e.option(F)&&p.default.touch||s.default.on(n,(0,x.addNamespace)(y.default.name,"dxDataGridRowsView"),".dx-data-row",e.createAction((function(t){E(e.component,t.event),t.event.stopPropagation()}))),s.default.on(n,"mousedown selectstart",e.createAction((function(e){var t=e.event;t.shiftKey&&t.preventDefault()})))),n},_createRow:function(e){var t,n=this.callBase(e);return e&&((t=!!e.isSelected)&&n.addClass("dx-selection"),this.setAria("selected",t,n)),n},_rowClick:function(e){var t=this,n=e.event,l=(0,i.default)(n.target).closest(".dx-selection-disabled").length;this.isClickableElement((0,i.default)(n.target))||(l||"multiple"===this.option(V)&&"always"===this.option(F)||this.getController("selection").changeItemSelection(e.rowIndex,{control:n.ctrlKey||n.metaKey,shift:n.shiftKey})&&(n.preventDefault(),e.handled=!0),this.callBase(e))},isClickableElement:function(e){var t;return!!e.closest(".dx-command-select").length},_renderCore:function(e){this.callBase(e),this._updateCheckboxesClass()},_updateCheckboxesClass:function(){var e=this.getTableElements(),t=this.getController("selection"),n=t.isSelectColumnVisible()&&!t.isSelectionWithCheckboxes();(0,h.each)(e,(function(e,t){(0,i.default)(t).toggleClass(B,n)}))}}}}}}

