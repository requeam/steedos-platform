function module(a,t,e){"use strict";var o,n=L(a("../../core/utils/callbacks")),i,r=L(a("../data_grid/ui.data_grid.core")),s=a("../../core/utils/common"),d,h=L(a("../../core/utils/type")),c=a("../../core/utils/iterator"),u=a("../../core/utils/extend"),l,g=L(a("../../data/array_store")),p,f=L(a("../../data/array_utils")),_=a("../../core/utils/deferred");function L(a){return a&&a.__esModule?a:{default:a}}e.exports=r.default.Controller.inherit(function(){function a(t,e){if(t&&(t=t.slice(0),e))for(var o=0;o<t.length;o++)t[o]=(0,u.extend)({key:t[o].key},t[o]),t[o].items=a(t[o].items,e-1);return t}function t(a,t){var e={};return t&&((e={sorting:!r.default.equalSortParameters(a.sort,t.sort),grouping:!r.default.equalSortParameters(a.group,t.group,!0),groupExpanding:!r.default.equalSortParameters(a.group,t.group)||t.groupExpand,filtering:!r.default.equalFilterParameters(a.filter,t.filter),pageIndex:a.pageIndex!==t.pageIndex,skip:a.skip!==t.skip,take:a.take!==t.take}).reload=e.sorting||e.grouping||e.filtering,e.paging=e.pageIndex||e.take),e}function e(a,t){h.default.isDefined(t)?(0,s.executeAsync)(a,t):a()}function o(){return{pages:{}}}function i(a){return a.cachedPagesData.pages[a.pageIndex]}function d(a,t){var e=a.pageIndex;void 0!==e&&(a.cachedPagesData.pages[e]=t)}return{init:function(a,t){var e=this;e._dataSource=a,e._remoteOperations=t||{},e._isLastPage=!a.isLastPage(),e._hasLastPage=!1,e._currentTotalCount=0,e._cachedPagesData={pages:{}},e._lastOperationTypes={},e.changed=(0,n.default)(),e.loadingChanged=(0,n.default)(),e.loadError=(0,n.default)(),e.customizeStoreLoadOptions=(0,n.default)(),e.changing=(0,n.default)(),e._dataChangedHandler=e._handleDataChanged.bind(e),e._dataLoadingHandler=e._handleDataLoading.bind(e),e._dataLoadedHandler=e._handleDataLoaded.bind(e),e._loadingChangedHandler=e._handleLoadingChanged.bind(e),e._loadErrorHandler=e._handleLoadError.bind(e),e._pushHandler=e._handlePush.bind(e),e._changingHandler=e._handleChanging.bind(e),a.on("changed",e._dataChangedHandler),a.on("customizeStoreLoadOptions",e._dataLoadingHandler),a.on("customizeLoadResult",e._dataLoadedHandler),a.on("loadingChanged",e._loadingChangedHandler),a.on("loadError",e._loadErrorHandler),a.on("changing",e._changingHandler),a.store().on("push",e._pushHandler),(0,c.each)(a,(function(a,t){!e[a]&&h.default.isFunction(t)&&(e[a]=function(){return this._dataSource[a].apply(this._dataSource,arguments)})}))},remoteOperations:function(){return this._remoteOperations},dispose:function(a){var t=this,e=this._dataSource;e.off("changed",this._dataChangedHandler),e.off("customizeStoreLoadOptions",this._dataLoadingHandler),e.off("customizeLoadResult",this._dataLoadedHandler),e.off("loadingChanged",this._loadingChangedHandler),e.off("loadError",this._loadErrorHandler),e.off("changing",this._changingHandler),e.store().off("push",this._pushHandler),a||e.dispose()},refresh:function(a,t,e){var o=this,n=this._dataSource;(t||e.reload)&&(this._currentTotalCount=0,this._isLastPage=!n.paginate(),this._hasLastPage=this._isLastPage)},resetCache:function(){this._cachedStoreData=void 0,this._cachedPagingData=void 0},resetPagesCache:function(){this._cachedPagesData={pages:{}}},_needClearStoreDataCache:function(){var a=this.remoteOperations(),e=t(this._lastLoadOptions||{},{}),o;return!Object.keys(a).every((function(t){return!e[t]||!a[t]}))},push:function(a,t){var e=this.store();this._needClearStoreDataCache()&&(this._cachedStoreData=void 0),this._cachedPagingData=void 0,this.resetPagesCache(),this._cachedStoreData&&f.default.applyBatch(e,this._cachedStoreData,a),t||this._applyBatch(a)},getDataIndexGetter:function(){var a=this;if(!this._dataIndexGetter){var t,e=this.store();this._dataIndexGetter=function(o){var n=a._cachedStoreData||[];if(!t){t={};for(var i=0;i<n.length;i++)t[(0,s.getKeyHash)(e.keyOf(n[i]))]=i}return t[(0,s.getKeyHash)(e.keyOf(o))]}}return this._dataIndexGetter},_getKeyInfo:function(){return this.store()},_applyBatch:function(a){var t=this._getKeyInfo(),e=this._dataSource,o=r.default.normalizeSortingInfo(this.group()).length;a=a.filter((function(a){return!e.paginate()||"insert"!==a.type||void 0!==a.index})),f.default.applyBatch(t,this._items,a,o,!0),f.default.applyBatch(t,e.items(),a,o,!0),a.splice(0,a.length)},_handlePush:function(a){this.push(a,!0)},_handleChanging:function(a){this.changing.fire(a),this._applyBatch(a.changes)},_customizeRemoteOperations:function(a,t,e){var o=this,n=this._cachedStoreData,i=this._cachedPagingData,r=this._cachedPagesData;a.storeLoadOptions.filter&&!a.remoteOperations.filtering&&(a.remoteOperations={}),t?(n=void 0,i=void 0,r={pages:{}}):(e.reload?(i=void 0,r={pages:{}}):(e.take||e.groupExpanding)&&(r={pages:{}}),(0,c.each)(e,(function(t,e){e&&a.remoteOperations[t]&&(n=void 0,i=void 0)}))),i&&(a.remoteOperations.paging=!1),a.cachedStoreData=n,a.cachedPagingData=i,a.cachedPagesData=r,a.isCustomLoading||(this._cachedStoreData=n,this._cachedPagingData=i,this._cachedPagesData=r)},_handleDataLoading:function(a){var e,o,n=this,i=n._dataSource,r=n._lastLoadOptions;n.customizeStoreLoadOptions.fire(a),a.delay=this.option("loadingTimeout"),a.originalStoreLoadOptions=a.storeLoadOptions,a.remoteOperations=(0,u.extend)({},this.remoteOperations());var s=!n.isLoaded()&&!n._isRefreshing;if(n.option("integrationOptions.renderedOnServer")&&!n.isLoaded()&&(a.delay=void 0),o=t(e=(0,u.extend)({pageIndex:n.pageIndex()},a.storeLoadOptions),r),n._customizeRemoteOperations(a,s,o),!a.isCustomLoading){var d=n._isRefreshing;a.pageIndex=i.pageIndex(),a.lastLoadOptions=e,a.operationTypes=o,n._isRefreshing=!0,(0,_.when)(d||n._isRefreshed||n.refresh(a,s,o)).done((function(){n._lastOperationId===a.operationId&&(n._isRefreshed=!0,n.load().always((function(){n._isRefreshed=!1})))})).fail((function(){i.cancel(a.operationId)})).always((function(){n._isRefreshing=!1})),i.cancel(n._lastOperationId),n._lastOperationId=a.operationId,n._isRefreshing&&i.cancel(n._lastOperationId)}this._handleDataLoadingCore(a)},_handleDataLoadingCore:function(a){var t=a.remoteOperations;a.loadOptions={};var e=a.cachedPagesData.extra,o={filter:!t.filtering,sort:!t.sorting,group:!t.grouping,summary:!t.summary,skip:!t.paging,take:!t.paging,requireTotalCount:e&&"totalCount"in e||!t.paging};(0,c.each)(a.storeLoadOptions,(function(t,e){o[t]&&(a.loadOptions[t]=e,delete a.storeLoadOptions[t])})),e&&(a.extra=e),a.data=i(a)||a.cachedStoreData},_handleDataLoaded:function(t){var e=this,o=t.loadOptions,n=t.remoteOperations&&!t.remoteOperations.paging,s=t.cachedPagesData,c=!1!==this.option("cacheEnabled")&&t.storeLoadOptions,l=c&&!t.isCustomLoading&&s&&(!n||t.storeLoadOptions.group)&&!this.option("legacyRendering"),p=c&&n,f=p&&!t.isCustomLoading;if(o){t.lastLoadOptions&&(this._lastLoadOptions=t.lastLoadOptions,Object.keys(t.operationTypes).forEach((function(a){e._lastOperationTypes[a]=e._lastOperationTypes[a]||t.operationTypes[a]}))),n&&(t.skip=o.skip,t.take=o.take,delete o.skip,delete o.take),o.group&&(o.group=t.group||o.group);var L=r.default.normalizeSortingInfo(t.storeLoadOptions.group||o.group).length;l&&i(t)||(p&&t.cachedPagingData?t.data=a(t.cachedPagingData,L):(f&&(this._cachedStoreData?t.mergeStoreLoadData&&(t.data=this._cachedStoreData=this._cachedStoreData.concat(t.data)):this._cachedStoreData=a(t.data,r.default.normalizeSortingInfo(t.storeLoadOptions.group).length)),new g.default(t.data).load(o).done((function(o){t.data=o,f&&(e._cachedPagingData=a(t.data,L))})).fail((function(a){t.data=(new _.Deferred).reject(a)}))),o.requireTotalCount&&n&&(t.extra=h.default.isPlainObject(t.extra)?t.extra:{},t.extra.totalCount=t.data.length),this._handleDataLoadedCore(t),l&&(s.extra=s.extra||(0,u.extend)({},t.extra),(0,_.when)(t.data).done((function(e){d(t,a(e,L))})))),t.storeLoadOptions=t.originalStoreLoadOptions}else this._dataSource.cancel(t.operationId)},_handleDataLoadedCore:function(a){a.remoteOperations&&!a.remoteOperations.paging&&Array.isArray(a.data)&&(void 0!==a.skip&&(a.data=a.data.slice(a.skip)),void 0!==a.take&&(a.data=a.data.slice(0,a.take)))},_handleLoadingChanged:function(a){this.loadingChanged.fire(a)},_handleLoadError:function(a){this.loadError.fire(a),this.changed.fire({changeType:"loadError",error:a})},_handleDataChanged:function(a){var t,e=this,o=this._dataSource,n=!1,i=this.itemsCount();this._isLastPage=!i||!this.pageSize()||i<this.pageSize(),this._isLastPage&&(this._hasLastPage=!0),o.totalCount()>=0?o.pageIndex()>=this.pageCount()&&(o.pageIndex(this.pageCount()-1),this.pageIndex(o.pageIndex()),this.resetPagesCache(),o.load(),n=!0):(t=o.pageIndex()*this.pageSize()+i,this._currentTotalCount=Math.max(this._currentTotalCount,t),0===i&&o.pageIndex()>=this.pageCount()&&(o.pageIndex(this.pageCount()-1),"infinite"!==this.option("scrolling.mode")&&(o.load(),n=!0))),n||(this._operationTypes=this._lastOperationTypes,this._lastOperationTypes={},this.component._optionCache={},this.changed.fire(a),this.component._optionCache=void 0)},_scheduleCustomLoadCallbacks:function(a){var t=this;t._isCustomLoading=!0,a.always((function(){t._isCustomLoading=!1}))},operationTypes:function(){return this._operationTypes},isLastPage:function(){return this._isLastPage},totalCount:function(){return parseInt(this._currentTotalCount||this._dataSource.totalCount())},itemsCount:function(){return this._dataSource.items().length},totalItemsCount:function(){return this.totalCount()},pageSize:function(){var a=this._dataSource;return arguments.length||a.paginate()?a.pageSize.apply(a,arguments):0},pageCount:function(){var a=this,t=this.totalItemsCount(),e=this.pageSize();return e&&t>0?Math.max(1,Math.ceil(t/e)):1},hasKnownLastPage:function(){return this._hasLastPage||this._dataSource.totalCount()>=0},loadFromStore:function(a){var t=this._dataSource,e=new _.Deferred;if(t)return t.store().load(a).done((function(a,t){a&&!Array.isArray(a)&&Array.isArray(a.data)&&(t=a,a=a.data),e.resolve(a,t)})).fail(e.reject),e},isCustomLoading:function(){return!!this._isCustomLoading},load:function(a){var t,o,n,i=this,r=i._dataSource,s=new _.Deferred;return a?(t=r.store(),n=r.loadOptions(),o={storeLoadOptions:a,isCustomLoading:!0},(0,c.each)(t._customLoadOptions()||[],(function(a,t){t in o.storeLoadOptions||(o.storeLoadOptions[t]=n[t])})),i._scheduleCustomLoadCallbacks(s),r._scheduleLoadCallbacks(s),i._handleDataLoading(o),e((function(){if(!r.store())return s.reject("canceled");(0,_.when)(o.data||i.loadFromStore(o.storeLoadOptions)).done((function(e,n){o.data=e,o.extra=n||{},i._handleDataLoaded(o),a.requireTotalCount&&void 0===o.extra.totalCount&&(o.extra.totalCount=t.totalCount(o.storeLoadOptions)),(0,_.when)(o.data,o.extra.totalCount).done((function(a,t){o.extra.totalCount=t,s.resolve(a,o.extra)})).fail(s.reject)})).fail(s.reject)}),i.option("loadingTimeout")),s.fail((function(){i.fireEvent("loadError",arguments)})).promise()):r.load()},reload:function(a){return a?this._dataSource.reload():this._dataSource.load()},getCachedStoreData:function(){return this._cachedStoreData}}}())}

