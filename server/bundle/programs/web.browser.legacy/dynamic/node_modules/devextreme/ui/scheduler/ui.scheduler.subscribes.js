function module(e,t,n){"use strict";var a,i=k(e("../../core/renderer")),r=e("../../core/utils/array"),o=k(r),s,u=k(e("./utils.recurrence")),c,p=k(e("../../core/utils/type")),l,g=k(e("../../core/utils/date")),d=e("../../core/utils/iterator"),h,f=k(e("../../animation/translator")),m=e("../../core/utils/common"),D=e("../../core/utils/extend"),_,y=k(e("../../localization/date")),A,T=k(e("./timezones/ui.scheduler.timezones")),S=e("../../core/utils/deferred");function k(e){return e&&e.__esModule?e:{default:e}}var v=60,w=g.default.dateToMilliseconds,b={isCurrentViewAgenda:function(){return"agenda"===this.option("currentView")},currentViewUpdated:function(e){this.option("currentView",e)},currentDateUpdated:function(e){this.option("currentDate",e)},setCellDataCacheAlias:function(e,t){this._workSpace.setCellDataCacheAlias(e,t)},needCoordinates:function(e){var t=this,n=e.appointmentData,a=e.startDate,i=this._getEndDate(n),r=this.fire("getField","recurrenceRule",n),o=this._getRecurrenceException(n),s=this._workSpace.getDateRange(),c=this.appointmentTakesAllDay(n),p=this.appointmentTakesAllDay(n)?g.default.trimTime(new Date(s[0])):s[0],l=e.originalStartDate||a,d=this.getLayoutManager().getRenderingStrategyInstance(),h=this.getFirstDayOfWeek(),f={rule:r,exception:o,start:l,end:i,min:p,max:s[1],firstDayOfWeek:h},m=u.default.getDatesByRecurrence(f),D=void 0;if(m.length?(D=m,m=m.map((function(e){return g.default.roundDateByStartDayHour(e,t._getCurrentViewOption("startDayHour"))}))):(m.push(a),D=m),d.needSeparateAppointment(c)){for(var _=m.length,y=[],A=[],T=0;T<_;T++){var S=d.endDate(n,{startDate:m[T]},!!r);y=g.default.getDatesOfInterval(m[T],S,{milliseconds:this.getWorkSpace().getIntervalDuration(c)}),A=A.concat(y)}m=A}var k=this._resourcesManager.getResourcesFromItem(n);c=this.appointmentTakesAllDay(n)&&this._workSpace.supportAllDayRow(),e.callback(this._getCoordinates(D,m,k,c))},isGroupedByDate:function(){return this.getWorkSpace().isGroupedByDate()},showAppointmentTooltip:function(e){e.skipDateCalculation=!0,e.$appointment=(0,i.default)(e.target);var t=e.data,n=this._getSingleAppointmentData(t,e);this.showAppointmentTooltip(t,e.target,n)},hideAppointmentTooltip:function(){this.hideAppointmentTooltip()},showAddAppointmentPopup:function(e){var t={};(0,d.each)(["startDate","endDate","allDay"],function(n,a){void 0!==e[a]&&(this.fire("setField",a,t,e[a]),delete e[a])}.bind(this)),this.showAppointmentPopup((0,D.extend)(t,e),!0)},showEditAppointmentPopup:function(e){var t=e.data;e.$appointment=(0,i.default)(e.target),e.skipHoursProcessing=!0;var n=this._getSingleAppointmentData(t,e),a=this.fire("getField","startDate",n);this.showAppointmentPopup(t,!1,n,a)},updateAppointmentAfterResize:function(e){var t=e.target,n=this._getSingleAppointmentData(t,e),a=this.fire("getField","startDate",n),i=(0,D.extend)(!0,{},e.data);this._convertDatesByTimezoneBack(!0,i),this._checkRecurringAppointment(t,n,a,function(){this._updateAppointment(t,i,(function(){this._appointments.moveAppointmentBack()}))}.bind(this))},updateAppointmentAfterDrag:function(e){var t=e.data,n=this._getUpdatedData(e),a=this._workSpace.getDroppableCellIndex(),i=this._workSpace.getCellIndexByCoordinates(e.coordinates),r=this.fire("getField","allDay",n),o=this.fire("getField","allDay",t),s=(0,D.extend)({},t,n),u=this._workSpace.supportAllDayRow()&&r,c=this._workSpace.getCellDataByCoordinates(e.coordinates,u),p=this._workSpace.supportAllDayRow()&&(o&&!r||!o&&r);a!==i||p?this._checkRecurringAppointment(t,s,c.startDate,function(){this._convertDatesByTimezoneBack(!0,n,s),this._updateAppointment(t,s,(function(){this._appointments.moveAppointmentBack()}))}.bind(this)):this._appointments.moveAppointmentBack()},deleteAppointment:function(e){e.$appointment=(0,i.default)(e.target);var t=e.data,n=this._getSingleAppointmentData(t,e),a=this.fire("getField","startDate",n);this._checkRecurringAppointment(t,n,a,function(){this.deleteAppointment(t)}.bind(this),!0)},getResourceForPainting:function(){return this._resourcesManager.getResourceForPainting(this._getCurrentViewOption("groups"))},getAppointmentColor:function(e){var t=this._resourcesManager,n=t.getResourceForPainting(this._getCurrentViewOption("groups")),a=(new S.Deferred).resolve().promise();if(n){for(var i=t.getField(n),r=e.groupIndex,s=this._workSpace._getCellGroups(r),u=o.default.wrapToArray(t.getDataAccessors(i,"getter")(e.itemData)),c=u.length?u[0]:void 0,p=0;p<s.length;p++)if(s[p].name===i){c=s[p].id;break}a=t.getResourceColor(i,c)}e.callback(a)},getHeaderHeight:function(){return this._header._$element&&parseInt(this._header._$element.outerHeight(),10)},getResourcesFromItem:function(e){e.callback(this._resourcesManager.getResourcesFromItem(e.itemData))},getBoundOffset:function(e){e.callback({top:-this.getWorkSpaceAllDayHeight()})},appointmentTakesAllDay:function(e){e.callback(this.appointmentTakesAllDay(e.appointment))},appointmentTakesSeveralDays:function(e){return this._appointmentModel.appointmentTakesSeveralDays(e)},appointmentFocused:function(){this._workSpace.restoreScrollTop()},getResizableAppointmentArea:function(e){var t=void 0,n=e.allDay,a=this._getCurrentViewOption("groups"),i;if(a&&a.length){if(n||this.getLayoutManager().getRenderingStrategyInstance()._needHorizontalGroupBounds()){var r=this._workSpace.getGroupBounds(e.coordinates);t={left:r.left,right:r.right,top:0,bottom:0}}if(this.getLayoutManager().getRenderingStrategyInstance()._needVerticalGroupBounds(n)&&this._workSpace._isVerticalGroupedWorkSpace()){var o=this._workSpace.getGroupBounds(e.coordinates);t={left:0,right:0,top:o.top,bottom:o.bottom}}}e.callback(t)},needRecalculateResizableArea:function(){return this.getWorkSpace().needRecalculateResizableArea()},getDraggableAppointmentArea:function(e){e.callback(this.getWorkSpaceScrollableContainer())},getAppointmentGeometry:function(e){return this.getLayoutManager().getRenderingStrategyInstance().getAppointmentGeometry(e)},isAllDay:function(e){return this.getLayoutManager().getRenderingStrategyInstance().isAllDay(e)},getDeltaTime:function(e,t,n){return this.getLayoutManager().getRenderingStrategyInstance().getDeltaTime(e,t,n)},getCompactAppointmentGroupMaxWidth:function(e){return this.getLayoutManager().getRenderingStrategyInstance().getCompactAppointmentGroupMaxWidth(this._getViewCountConfig().intervalCount,e)},getStartDate:function(e,t){return this._getStartDate(e,t)},getCellWidth:function(){return this._cellWidth},getCellHeight:function(){return this._cellHeight},getResizableStep:function(){var e=this._cellWidth,t=this.getWorkSpace();return t.isGroupedByDate()?t._getGroupCount()*e:e},getEndDate:function(e,t){return this._getEndDate(e,t)},getRenderingStrategy:function(){return this._getAppointmentsRenderingStrategy()},needCorrectAppointmentDates:function(){return this.getRenderingStrategyInstance().needCorrectAppointmentDates()},getRenderingStrategyDirection:function(){return this.getRenderingStrategyInstance().getDirection()},getWorkSpaceDateTableOffset:function(){return this.getWorkSpaceDateTableOffset()},getDateTableWidth:function(){return this._workSpace.getDateTableWidth()},getTimePanelWidth:function(){return this._workSpace.getTimePanelWidth()},correctAppointmentCoordinates:function(e){var t=e.allDay,n=e.isFixedContainer?-1:1,a,i,r,o,s,u=-this.getWorkSpaceScrollableScrollTop(t)+(t?0:this.getWorkSpaceAllDayOffset())+this.getWorkSpaceHeaderPanelHeight(),c=-this.getWorkSpaceScrollableScrollLeft()-this.getWorkSpaceDateTableOffset();e.callback({top:e.coordinates.top+n*u,left:e.coordinates.left+n*c})},allDayPanelToggled:function(){this._appointments.updateDraggablesBoundOffsets()},formatDates:function(e){var t=e.startDate,n=e.endDate,a=e.formatType,i={DATETIME:function(){var e="mediumdatemediumtime",a,i;return y.default.format(t,e)+" - "+(t.getDate()===n.getDate()?y.default.format(n,"shorttime"):y.default.format(n,e))},TIME:function(){return y.default.format(t,"shorttime")+" - "+y.default.format(n,"shorttime")},DATE:function(){var e="monthAndDay",a,i,r;return y.default.format(t,"monthAndDay")+(n.getTime()-t.getTime()>w("day")||n.getDate()!==t.getDate()?" - "+y.default.format(n,"monthAndDay"):"")}};e.callback(i[a]())},getFullWeekAppointmentWidth:function(e){var t=e.groupIndex,n=this._workSpace.getGroupWidth(t);e.callback(n)},getMaxAppointmentWidth:function(e){var t=this._workSpace.getCellCountToLastViewDate(e.date);e.callback(t*this._workSpace.getCellWidth())},updateAppointmentStartDate:function(e){var t=e.appointment,n=this._workSpace.getStartViewDate(),a=new Date(e.startDate),i=this._getCurrentViewOption("startDayHour"),r=void 0;this.appointmentTakesAllDay(t)?r=g.default.normalizeDate(a,n):(a<n&&(a=n),r=g.default.normalizeDate(e.startDate,new Date(a))),r=g.default.roundDateByStartDayHour(r,i),e.callback(r)},updateAppointmentEndDate:function(e){var t=new Date(e.endDate),n=this._getCurrentViewOption("endDayHour"),a=this._getCurrentViewOption("startDayHour"),i=t;t.getHours()>=n?i.setHours(n,0,0,0):a>0&&60*t.getHours()+t.getMinutes()<60*a&&(i=new Date(i.getTime()-w("day"))).setHours(n,0,0,0),e.callback(i)},renderDropDownAppointments:function(e){this._dropDownAppointments.render(e,this)},supportCompactDropDownAppointments:function(){return this._workSpace._supportCompactDropDownAppointments()},getGroupCount:function(){return this._workSpace._getGroupCount()},mapAppointmentFields:function(e){var t={appointmentData:e.itemData,appointmentElement:e.itemElement};return e.itemData&&(t.targetedAppointmentData=this.fire("getTargetedAppointmentData",e.itemData,e.itemElement,e.itemIndex)),t},getOffsetByAllDayPanel:function(e){return this._workSpace._getOffsetByAllDayPanel(e)},getGroupTop:function(e){return this._workSpace._getGroupTop(e)},updateResizableArea:function(){var e=this.$element().find(".dx-scheduler-appointment.dx-resizable"),t=(0,m.grep)(e,(function(e){var t,n=(0,i.default)(e).dxResizable("instance"),a=n.option("area");return(0,r.inArray)(n.option("handles"),["right left","left right"])>-1&&p.default.isPlainObject(a)}));(0,d.each)(t,function(e,t){var n=(0,i.default)(t),a=f.default.locate(n),r=this._appointments._getItemData(n),o=this._appointments._calculateResizableArea({left:a.left},r);n.dxResizable("instance").option("area",o)}.bind(this))},recurrenceEditorVisibilityChanged:function(e){this.recurrenceEditorVisibilityChanged(e)},getField:function(e,t){if(p.default.isDefined(this._dataAccessors.getter[e]))return this._dataAccessors.getter[e](t)},setField:function(e,t,n){if(p.default.isDefined(this._dataAccessors.setter[e])){var a=this.option(e+"Expr").split("."),i=a[0];if(void 0===t[i]&&a.length>1){var r=function(e){for(var t={},n=t,a=e.length-1,i=1;i<a;i++)n=n[e[i]]={};return t}(a);t[i]=r}return this._dataAccessors.setter[e](t,n),t}},prerenderFilter:function(){var e=this.getWorkSpace().getDateRange(),t=this._resourcesManager.getResourcesData(),n=void 0;return!this.option("showAllDayPanel")&&this._workSpace.supportAllDayRow()&&(n=!1),this._appointmentModel.filterLoadedAppointments({startDayHour:this._getCurrentViewOption("startDayHour"),endDayHour:this._getCurrentViewOption("endDayHour"),min:e[0],max:e[1],resources:t,allDay:n,firstDayOfWeek:this.getFirstDayOfWeek(),recurrenceException:this._getRecurrenceException.bind(this)},this._subscribes.convertDateByTimezone.bind(this))},dayHasAppointment:function(e,t,n){return this.dayHasAppointment(e,t,n)},createResourcesTree:function(){return this._resourcesManager.createResourcesTree(this._loadedResources)},getResourceTreeLeaves:function(e,t){return this._resourcesManager.getResourceTreeLeaves(e,t)},createReducedResourcesTree:function(){var e=this._resourcesManager.createResourcesTree(this._loadedResources);return this._resourcesManager.reduceResourcesTree(e,this.getFilteredItems())},groupAppointmentsByResources:function(e){var t={0:e},n=this._getCurrentViewOption("groups");n&&n.length&&this._resourcesManager.getResourcesData().length&&(t=this._resourcesManager.groupAppointmentsByResources(e,this._loadedResources));var a=0;(0,d.each)(this._loadedResources,(function(e,t){e?a*=t.items.length:a=t.items.length}));for(var i=0;i<a;i++){var r=i.toString();t[r]||(t[r]=[])}return t},getAgendaRows:function(e){var t=this._layoutManager.getRenderingStrategyInstance(),n=t.calculateRows.bind(t),a=new S.Deferred;function i(t){var r=n(t,e.agendaDuration,e.currentDate);this._dataSourceLoadedCallback.remove(i),a.resolve(r)}return this._dataSourceLoadedCallback.add(i),a.promise()},getAgendaVerticalStepHeight:function(){return this.getWorkSpace().getAgendaVerticalStepHeight()},getAgendaDuration:function(){return this._getCurrentViewOption("agendaDuration")},getStartViewDate:function(){return this.getStartViewDate()},getEndViewDate:function(){return this.getEndViewDate()},getMaxAppointmentsPerCell:function(){return this.getMaxAppointmentsPerCell()},forceMaxAppointmentPerCell:function(){return this.forceMaxAppointmentPerCell()},agendaIsReady:function(e,t,n){var a=this.getAppointmentsInstance()._itemElements(),i=0;a.css("marginBottom",t);for(var r=function(e,t){var r=t+i-1;a.eq(r).css("marginBottom",n),i+=t},o=0;o<e.length;o++)(0,d.each)(e[o],r)},getTimezone:function(){return this._getTimezoneOffsetByOption()},getClientTimezoneOffset:function(e){return e=e||new Date,T.default.getClientTimezoneOffset(e)},convertDateByTimezone:function(e,t){e=new Date(e);var n=this._subscribes.getComplexOffsets(this,e,t);return e=this._subscribes.translateDateToAppointmentTimeZone(e,n),e=this._subscribes.translateDateToCommonTimeZone(e,n)},convertDateByTimezoneBack:function(e,t){e=new Date(e);var n=this._subscribes.getComplexOffsets(this,e,t);return e=this._subscribes.translateDateToAppointmentTimeZone(e,n,!0),e=this._subscribes.translateDateToCommonTimeZone(e,n,!0)},translateDateToAppointmentTimeZone:function(e,t,n){var a=n?-1:1,i=e.getTime()-a*t.client*w("hour");return new Date(i+a*t.appointment*w("hour"))},translateDateToCommonTimeZone:function(e,t,n){var a=n?-1:1;if("number"==typeof t.common){var i=t.common-t.appointment,r=(i<0?-1:1)*Math.floor(Math.abs(i)),o=i%1;e.setHours(e.getHours()+a*r),e.setMinutes(e.getMinutes()+a*o*60)}return e},getComplexOffsets:function(e,t,n){var a=-this.getClientTimezoneOffset(t)/w("hour"),i=e._getTimezoneOffsetByOption(t),r=e._calculateTimezoneByValue(n,t);return"number"!=typeof r&&(r=a),{client:a,common:i,appointment:r}},getDaylightOffset:function(e,t){return e.getTimezoneOffset()-t.getTimezoneOffset()},getTimezonesDisplayName:function(){return T.default.getTimezonesDisplayName()},getTimezoneDisplayNameById:function(e){return T.default.getTimezoneDisplayNameById(e)},getSimilarTimezones:function(e){return T.default.getSimilarTimezones(e)},getTimezonesIdsByDisplayName:function(e){return T.default.getTimezonesIdsByDisplayName(e)},getTargetedAppointmentData:function(e,t,n,a){var r=(0,i.default)(t),o=this._getSingleAppointmentData(e,{skipDateCalculation:!0,$appointment:r,skipHoursProcessing:!0,startDate:a}),s={};return(0,D.extend)(!0,s,e,o),this._convertDatesByTimezoneBack(!1,s),p.default.isDefined(n)||(n=r.data(this._appointments._itemIndexKey())),t&&this.setTargetedAppointmentResources(s,t,n),s},getAppointmentDurationInMs:function(e){var t=e.startDate,n=e.endDate,a=e.allDay,i=n.getTime()-t.getTime(),r=w("day"),o=this._workSpace.getVisibleDayDuration(),s=0;if(a){var u;s=Math.ceil(i/r)*o}else{var c=!g.default.sameDate(t,new Date(n.getTime()-1)),p=Math.floor(i/r),l=void 0;if(c){var d=r-o;l=i-(p?p*r:d);var h=this.option("startDayHour")*w("hour"),f=n-g.default.trimTime(n);f<h&&(p&&(l-=d),l+=h-f)}else l=i%r;l>o&&(l=o),s=p*o+l}e.callback(s)},fixWrongEndDate:function(e,t,n){return this._appointmentModel.fixWrongEndDate(e,t,n)},getEndDayHour:function(){return this.option("endDayHour")},getStartDayHour:function(){return this.option("startDayHour")}};n.exports=b}

