function module(e,t){"use strict";var n,o=m(e("../../core/renderer")),a,i=m(e("./ui.data_grid.core")),r=e("./ui.data_grid.grouping.expanded"),l=e("./ui.data_grid.grouping.collapsed"),u,s=m(e("../../localization/message")),p,d=m(e("./ui.data_grid.data_source_adapter")),g=e("../../core/utils/type"),c=e("../../core/utils/iterator"),h,f=m(e("../../core/devices")),x=e("../../core/utils/deferred");function m(e){return e&&e.__esModule?e:{default:e}}var _="dx-datagrid-group-panel",v="dx-group-panel-message",w="dx-group-panel-item",C="dx-toolbar-label",G="dx-datagrid-expand",I="dx-group-row",E={init:function(){this.callBase.apply(this,arguments),this._initGroupingHelper()},_initGroupingHelper:function(e){var t=this._grouping,n=this.option("grouping.autoExpandAll"),o=this.option("focusedRowEnabled"),a=e?e.remoteOperations:this.remoteOperations(),i;!(a.filtering&&a.sorting&&a.paging)||a.grouping||!n&&o?(!t||t instanceof r.GroupingHelper)&&(this._grouping=new l.GroupingHelper(this)):(!t||t instanceof l.GroupingHelper)&&(this._grouping=new r.GroupingHelper(this))},totalItemsCount:function(){var e=this,t=this.callBase();return t>0&&this._dataSource.group()&&this._dataSource.requireTotalCount()?t+this._grouping.totalCountCorrection():t},itemsCount:function(){return this._dataSource.group()?this._grouping.itemsCount()||0:this.callBase.apply(this,arguments)},allowCollapseAll:function(){return this._grouping.allowCollapseAll()},isGroupItemCountable:function(e){return this._grouping.isGroupItemCountable(e)},isRowExpanded:function(e){var t=this._grouping.findGroupInfo(e);return t?t.isExpanded:!this._grouping.allowCollapseAll()},collapseAll:function(e){return this._collapseExpandAll(e,!1)},expandAll:function(e){return this._collapseExpandAll(e,!0)},_collapseExpandAll:function(e,t){var n,o=this,a=this._dataSource,r=a.group(),l=i.default.normalizeSortingInfo(r||[]);if(l.length){for(n=0;n<l.length;n++)void 0===e||e===n?l[n].isExpanded=t:r&&r[n]&&(l[n].isExpanded=r[n].isExpanded);a.group(l),this._grouping.foreachGroups((function(n,o){void 0!==e&&e!==o.length-1||(n.isExpanded=t)}),!1,!0),this.resetPagesCache()}return!0},refresh:function(){return this.callBase.apply(this,arguments),this._grouping.refresh.apply(this._grouping,arguments)},changeRowExpand:function(e){var t=this,n=this._dataSource;if(n.group())return n.beginLoading(),this._lastLoadOptions&&(this._lastLoadOptions.groupExpand=!0),this._changeRowExpandCore(e).always((function(){n.endLoading()}))},_changeRowExpandCore:function(e){return this._grouping.changeRowExpand(e)},_hasGroupLevelsExpandState:function(e,t){if(e&&Array.isArray(e))for(var n=0;n<e.length;n++)if(e[n].isExpanded===t)return!0},_customizeRemoteOperations:function(e,t,n){var o=e.remoteOperations;e.storeLoadOptions.group?(o.grouping&&!e.isCustomLoading&&(o.groupPaging&&!this._hasGroupLevelsExpandState(e.storeLoadOptions.group,!0)||(o.paging=!1)),o.grouping||o.sorting&&o.filtering&&!e.isCustomLoading&&!this._hasGroupLevelsExpandState(e.storeLoadOptions.group,!1)||(o.paging=!1)):!e.isCustomLoading&&o.paging&&n.grouping&&this.resetCache(),this.callBase.apply(this,arguments)},_handleDataLoading:function(e){return this.callBase(e),this._initGroupingHelper(e),this._grouping.handleDataLoading(e)},_handleDataLoaded:function(e){return this._grouping.handleDataLoaded(e,this.callBase.bind(this))},_handleDataLoadedCore:function(e){return this._grouping.handleDataLoadedCore(e,this.callBase.bind(this))}};d.default.extend(E);var b={init:function(){var e=this;this.callBase(),this.createAction("onRowExpanding"),this.createAction("onRowExpanded"),this.createAction("onRowCollapsing"),this.createAction("onRowCollapsed")},_beforeProcessItems:function(e){var t=this._columnsController.getGroupColumns();return(e=this.callBase(e)).length&&t.length&&(e=this._processGroupItems(e,t.length)),e},_processItem:function(e,t){return(0,g.isDefined)(e.groupIndex)&&(0,g.isString)(e.rowType)&&0===e.rowType.indexOf("group")?(e=this._processGroupItem(e,t),t.dataIndex=0):e=this.callBase.apply(this,arguments),e},_processGroupItem:function(e){return e},_processGroupItems:function(e,t,n){var o,a,i,r,l=this,u=this._columnsController.getGroupColumns(),s=u[u.length-t];if(n||(n={collectContinuationItems:"virtual"!==(o=this.option("scrolling.mode"))&&"infinite"!==o,resultItems:[],path:[],values:[]}),r=n.resultItems,n.data&&(!n.collectContinuationItems&&n.data.isContinuation||r.push({rowType:"group",data:n.data,groupIndex:n.path.length-1,isExpanded:!!n.data.items,key:n.path.slice(0),values:n.values.slice(0)})),e)if(0===t)r.push.apply(r,e);else for(a=0;a<e.length;a++)(i=e[a])&&"items"in i?(n.data=i,n.path.push(i.key),n.values.push(s&&s.deserializeValue&&!s.calculateDisplayValue?s.deserializeValue(i.key):i.key),this._processGroupItems(i.items,t-1,n),n.data=void 0,n.path.pop(),n.values.pop()):r.push(i);return r},publicMethods:function(){return this.callBase().concat(["collapseAll","expandAll","isRowExpanded","expandRow","collapseRow"])},collapseAll:function(e){var t=this._dataSource;t&&t.collapseAll(e)&&(t.pageIndex(0),t.reload())},expandAll:function(e){var t=this._dataSource;t&&t.expandAll(e)&&(t.pageIndex(0),t.reload())},changeRowExpand:function(e){var t=this,n=t.isRowExpanded(e),o={key:e,expanded:n};return t.executeAction(n?"onRowCollapsing":"onRowExpanding",o),o.cancel?(new x.Deferred).resolve():(0,x.when)(t._changeRowExpandCore(e)).done((function(){o.expanded=!n,t.executeAction(n?"onRowCollapsed":"onRowExpanded",o)}))},_changeRowExpandCore:function(e){var t,n=this,o=this._dataSource;if(o)return t=new x.Deferred,(0,x.when)(o.changeRowExpand(e)).done((function(){n.load().done(t.resolve).fail(t.reject)})).fail(t.reject),t},isRowExpanded:function(e){var t=this._dataSource;return t&&t.isRowExpanded(e)},expandRow:function(e){return this.isRowExpanded(e)?(new x.Deferred).resolve():this.changeRowExpand(e)},collapseRow:function(e){return this.isRowExpanded(e)?this.changeRowExpand(e):(new x.Deferred).resolve()},optionChanged:function(e){"grouping"===e.name&&(e.name="dataSource"),this.callBase(e)}},R=function(e,t){var n=this._columnsController;switch(t.itemData.value){case"group":var o=n._dataSource.group()||[];n.columnOption(e.dataField,"groupIndex",o.length);break;case"ungroup":n.columnOption(e.dataField,"groupIndex",-1);break;case"ungroupAll":this.component.clearGrouping()}},y={_getToolbarItems:function(){var e=this.callBase();return this._appendGroupingItem(e)},_appendGroupingItem:function(e){var t=this,n=!1,a=function(e){t._updateGroupPanelContent((0,o.default)(e.itemElement).find(".dx-datagrid-group-panel")),n&&t.renderCompleted.fire(),n=!0};if(t._isGroupPanelVisible()){var i={html:"<div class='dx-datagrid-group-panel'></div>",name:"groupPanel",onItemRendered:a,location:"before",locateInMenu:"never",sortIndex:1};e.push(i)}return e},_isGroupPanelVisible:function(){var e,t=this.option("groupPanel");return t&&"auto"===(e=t.visible)&&(e="desktop"===f.default.current().deviceType),e},_renderGroupPanelItems:function(e,t){var n=this;e.empty(),(0,c.each)(t,(function(t,o){n._createGroupPanelItem(e,o)}))},_createGroupPanelItem:function(e,t){return(0,o.default)("<div>").addClass(t.cssClass).addClass("dx-group-panel-item").data("columnData",t).appendTo(e).text(t.caption)},_columnOptionChanged:function(e){if(!this._requireReady&&!i.default.checkChanges(e.optionNames,["width","visibleWidth"])){var t=this.element(),n=t&&t.find(".dx-datagrid-group-panel");n&&n.length&&(this._updateGroupPanelContent(n),this.renderCompleted.fire())}this.callBase()},_updateGroupPanelContent:function(e){var t=this,n=this.getController("columns").getGroupColumns(),a=this.option("groupPanel");this._renderGroupPanelItems(e,n),a.allowColumnDragging&&!n.length&&((0,o.default)("<div>").addClass("dx-group-panel-message").text(a.emptyPanelText).appendTo(e),e.closest(".dx-toolbar-label").css("maxWidth","none"),this.updateToolbarDimensions())},allowDragging:function(e){var t=this.option("groupPanel");return this._isGroupPanelVisible()&&t.allowColumnDragging&&e&&e.allowGrouping},getColumnElements:function(){var e=this.element();return e&&e.find(".dx-group-panel-item")},getColumns:function(){return this.getController("columns").getGroupColumns()},getBoundingRect:function(){var e,t=this,n=this.element();return n&&n.find(".dx-datagrid-group-panel").length?{top:(e=n.offset()).top,bottom:e.top+n.height()}:null},getName:function(){return"group"},getContextMenuItems:function(e){var t,n=this,a=this.option("grouping.contextMenuEnabled"),i=(0,o.default)(e.targetElement).closest(".dx-group-panel-item");if(i.length&&(e.column=i.data("columnData")),a&&e.column){var r=e.column,l;if(!(0,g.isDefined)(r.allowGrouping)||r.allowGrouping){var u=(0,g.isDefined)(r.groupIndex)&&r.groupIndex>-1,s=this.option("grouping.texts"),p=R.bind(this,r);t=[{text:s.ungroup,value:"ungroup",disabled:!u,onItemClick:p},{text:s.ungroupAll,value:"ungroupAll",onItemClick:p}]}}return t},isVisible:function(){return this.callBase()||this._isGroupPanelVisible()},optionChanged:function(e){"groupPanel"===e.name?(this._invalidate(),e.handled=!0):this.callBase(e)}};t.GroupingHeaderPanelExtender=y;var A={getContextMenuItems:function(e){var t,n=this,o;if(this.option("grouping.contextMenuEnabled")&&e.row&&"group"===e.row.rowType){var a,i=this._columnsController.columnOption("groupIndex:"+e.row.groupIndex);if(i&&i.allowGrouping){var r=this.option("grouping.texts"),l=R.bind(this,i);(t=[]).push({text:r.ungroup,value:"ungroup",onItemClick:l},{text:r.ungroupAll,value:"ungroupAll",onItemClick:l})}}return t},_rowClick:function(e){var t=this,n=this.option("grouping.expandMode"),a,i="infinite"!==this.option("scrolling.mode")&&"rowClick"===n&&(0,o.default)(e.event.target).closest(".dx-group-row").length,r=(0,o.default)(e.event.target).closest(".dx-datagrid-expand").length;(i||r)&&this._changeGroupRowState(e),this.callBase(e)},_changeGroupRowState:function(e){var t=this.getController("data"),n=t.items()[e.rowIndex],o=this._columnsController.columnOption("groupIndex:"+n.groupIndex,"allowCollapsing");("data"===n.rowType||"group"===n.rowType&&!1!==o)&&(t.changeRowExpand(n.key),e.event.preventDefault(),e.handled=!0)}},D={getContextMenuItems:function(e){var t=this,n=this.option("grouping.contextMenuEnabled"),o=this.callBase(e);if(n&&e.row&&("header"===e.row.rowType||"detailAdaptive"===e.row.rowType)){var a=e.column;if(!a.command&&(!(0,g.isDefined)(a.allowGrouping)||a.allowGrouping)){var i=this.option("grouping.texts"),r=(0,g.isDefined)(a.groupIndex)&&a.groupIndex>-1,l=R.bind(this,a);(o=o||[]).push({text:i.groupByThisColumn,value:"group",beginGroup:!0,disabled:r,onItemClick:l}),a.showWhenGrouped&&o.push({text:i.ungroup,value:"ungroup",disabled:!r,onItemClick:l}),o.push({text:i.ungroupAll,value:"ungroupAll",onItemClick:l})}}return o}};i.default.registerModule("grouping",{defaultOptions:function(){return{grouping:{autoExpandAll:!0,allowCollapsing:!0,contextMenuEnabled:!1,expandMode:"buttonClick",texts:{groupContinuesMessage:s.default.format("dxDataGrid-groupContinuesMessage"),groupContinuedMessage:s.default.format("dxDataGrid-groupContinuedMessage"),groupByThisColumn:s.default.format("dxDataGrid-groupHeaderText"),ungroup:s.default.format("dxDataGrid-ungroupHeaderText"),ungroupAll:s.default.format("dxDataGrid-ungroupAllText")}},groupPanel:{visible:!1,emptyPanelText:s.default.format("dxDataGrid-groupPanelEmptyText"),allowColumnDragging:!0}}},extenders:{controllers:{data:b,columns:{_getExpandColumnOptions:function(){var e=this.callBase.apply(this,arguments);return e.cellTemplate=i.default.getExpandCellTemplate(),e}}},views:{headerPanel:y,rowsView:A,columnHeadersView:D}}})}

