function module(e,t,o){"use strict";var r=e("../../core/renderer"),n=e("../../events/core/events_engine"),i=e("../../core/utils/type").isDefined,a=e("../../core/utils/extend").extend,s=e("../../core/utils/iterator").each,l,d=e("../../events/utils").addNamespace,c=e("../../core/component_registrator"),u=e("../../core/dom_component"),g=e("../../events/drag"),f=e("../widget/swatch_container").getSwatchContainer,p="dxSortable",h="dx-sortable",v=2,m=20,_=10;function x(e,t,o){var n=r(e),i=n.offset();if(t>=i.left&&t<=i.left+n.outerWidth(!0)&&o>=i.top&&o<=i.top+n.outerHeight(!0))return!0}function C(e,t,o){return!i(t.posHorizontal)||(o?e>t.posHorizontal:e<t.posHorizontal)}function b(e,t){var o=-1,n=t.get(0);return s(e,(function(t,i){var a=r(i);if(a.attr("item-group")&&a.attr("item-group")===e.eq(t-1).attr("item-group")||o++,i===n)return!1})),o===e.length?-1:o}function S(e,t){var o;return s(t,(function(){x(this,e.pageX,e.pageY)&&(o=r(this))})),o}function I(e,t,o){for(var r=[],n=[],i=0;i<e.length;i+=n.length)if((n=e.eq(i)).attr("item-group")&&(n=o.find("[item-group='"+n.attr("item-group")+"']")),n.is(":visible")){var a={item:n,index:r.length,posHorizontal:t?void 0:(n.last().outerWidth(!0)+n.last().offset().left+n.offset().left)/2};a.posVertical=t?(n.last().offset().top+n.offset().top+n.last().outerHeight(!0))/2:n.last().outerHeight(!0)+n.last().offset().top,r.push(a)}return r}function E(e){var t=null,o=e.scrollTop(),r=e.$element(),n=r.offset().top,i=r.height(),a=0;function s(e){o=e.scrollOffset.top}function l(){d(),e.scrollTo(o+=a),t=setTimeout(l,_)}function d(){clearTimeout(t)}function c(e){if(e.pageY<=n+m)a=-v;else{if(!(e.pageY>=n+i-m))return a=0,void d();a=v}l()}return e.on("scroll",s),{moveIfNeed:c,element:function(){return r},dispose:function(){d(),e.off("scroll",s)}}}var H=u.inherit({_getDefaultOptions:function(){return a(this.callBase(),{onChanged:null,onDragging:null,itemRender:null,groupSelector:null,itemSelector:".dx-sort-item",itemContainerSelector:".dx-sortable",sourceClass:"dx-drag-source",dragClass:"dx-drag",targetClass:"dx-drag-target",direction:"vertical",allowDragging:!0,groupFilter:null,useIndicator:!1})},_renderItem:function(e,t){var o,r=this.option("itemRender");return r?o=r(e,t):(o=e.clone()).css({width:e.width(),height:e.height()}),o},_renderIndicator:function(e,t,o,r){var n=e.outerHeight(!0),i=e.outerWidth(!0),a=e.offset().top-o.offset().top,s=e.offset().left-o.offset().left;this._indicator.css({position:"absolute",top:r&&t?a+n:a,left:r&&!t?s+i:s}).toggleClass("dx-position-indicator-horizontal",!t).toggleClass("dx-position-indicator-vertical",!!t).toggleClass("dx-position-indicator-last",!!r).height("").width("").appendTo(o),t?this._indicator.width(i):this._indicator.height(n)},_renderDraggable:function(e){this._$draggable&&this._$draggable.remove(),this._$draggable=this._renderItem(e,"drag").addClass(this.option("dragClass")).appendTo(f(e)).css({zIndex:1e6,position:"absolute"})},_detachEventHandlers:function(){var e=[g.move,g.start,g.end,g.enter,g.leave,g.drop].join(" ");n.off(this._getEventListener(),d(e,"dxSortable"))},_getItemOffset:function(e,t,o){for(var r=0;r<t.length;r++){var n,i=o.pageY<t[r].posVertical;if(e?n=i:i&&!(n=C(o.pageX,t[r],this.option("rtlEnabled")))&&t[r+1]&&t[r+1].posVertical>t[r].posVertical&&(n=!0),n)return t[r]}},_getEventListener:function(){var e=this.option("groupSelector"),t=this.$element();return e?t.find(e):t},_attachEventHandlers:function(){var e,t,o,i,a,l,c,u=this,f=u.option("itemSelector"),p=u.option("itemContainerSelector"),h=u.option("groupSelector"),v=u.option("sourceClass"),m=u.option("targetClass"),_=u.option("onDragging"),x=u.option("groupFilter"),C=u.$element(),H=null,w=-1,$=function(){a=[],s(e,(function(e,t){a.push(r(t).offset())}))},D=function(){return h?x?r(h).filter(x):C.find(h):C},T=function(){H&&H.dispose(),H=null},z=function(){var r={sourceGroup:l,sourceIndex:t,sourceElement:e,targetGroup:i.attr("group"),targetIndex:i.find(f).index(o)};_&&_(r),r.cancel&&(i=void 0)};if(u._detachEventHandlers(),u.option("allowDragging")){var B=u._getEventListener();n.on(B,d(g.start,"dxSortable"),f,(function(n){var i=(e=r(n.currentTarget)).closest(h);l=i.attr("group"),t=b((h?i:C).find(f),e),e.attr("item-group")&&(e=i.find("[item-group='"+e.attr("item-group")+"']")),u._renderDraggable(e),o=u._renderItem(e,"target").addClass(m),e.addClass(v),$(),c=D(),u._indicator=r("<div>").addClass("dx-position-indicator")})),n.on(B,d(g.move,"dxSortable"),(function(n){var d,g,h,_,x,C,b,$=[];if(e)if(w=-1,u._indicator.detach(),s(u._$draggable,(function(e,t){r(t).css({top:a[e].top+n.offset.y,left:a[e].left+n.offset.x})})),i&&i.removeClass(m),(i=S(n,c))&&z(),i&&H&&i.get(0)!==H.element().get(0)&&T(),H&&H.moveIfNeed(n),i){!H&&i.attr("allow-scrolling")&&(H=E(i.dxScrollable("instance"))),i.addClass(m),h=(g=i.find(p)).find(f);var D=i.closest(".dx-sortable").data("dxSortable"),B=D.option("useIndicator");if($=I(h,x="vertical"===(D||u).option("direction"),g),C=u._getItemOffset(x,$,n)){if(d=C.item,b=$[C.index-1]&&$[C.index-1].item,d.hasClass(v)||b&&b.hasClass(v)&&b.is(":visible"))return void o.detach();if(w=C.index,!B)return void o.insertBefore(d);var G=i.attr("group")!==l,O=w===t,V=w===t+1;if(G)return void u._renderIndicator(d,x,i,u.option("rtlEnabled")&&!x);O||V||u._renderIndicator(d,x,i,u.option("rtlEnabled")&&!x)}else{if((_=h.last()).is(":visible")&&_.hasClass(v))return;g.length&&(w=$.length?$[$.length-1].index+1:0),B?h.length&&u._renderIndicator(_,x,i,!u.option("rtlEnabled")||x):o.appendTo(g)}}else o.detach()})),n.on(B,d(g.end,"dxSortable"),(function(){if(T(),e){var r=u.option("onChanged"),n={sourceIndex:t,sourceElement:e,sourceGroup:l,targetIndex:w,removeSourceElement:!0,removeTargetElement:!1,removeSourceClass:!0};i&&(i.removeClass(m),n.targetGroup=i.attr("group"),(l!==n.targetGroup||w>-1)&&(r&&r(n),n.removeSourceElement&&e.remove())),u._indicator.detach(),n.removeSourceClass&&e.removeClass(v),e=null,u._$draggable.remove(),u._$draggable=null,n.removeTargetElement&&o.remove(),o.removeClass(m),o=null}}))}},_init:function(){this.callBase(),this._attachEventHandlers()},_render:function(){this.callBase(),this.$element().addClass("dx-sortable")},_dispose:function(){var e=this;e.callBase.apply(e,arguments),e._$draggable&&e._$draggable.detach(),e._indicator&&e._indicator.detach()},_optionChanged:function(e){var t=this;switch(e.name){case"onDragging":case"onChanged":case"itemRender":case"groupSelector":case"itemSelector":case"itemContainerSelector":case"sourceClass":case"targetClass":case"dragClass":case"allowDragging":case"groupFilter":case"useIndicator":this._attachEventHandlers();break;case"direction":break;default:this.callBase(e)}}});c("dxSortable",H),o.exports=H}

