function module(e,t,a){"use strict";var r=e("../../core/renderer"),i=e("../../events/core/events_engine"),n=e("../../data/array_store"),o=e("../../events/click"),l=e("../../core/utils/common").noop,d=e("../../core/utils/type").isDefined,s=e("../../core/utils/array").inArray,c=e("../../core/utils/extend").extend,u=e("../../core/utils/iterator"),h=e("../../localization/message"),f=e("../../core/component_registrator"),g=e("../widget/ui.widget"),p=e("../grid_core/ui.grid_core.header_filter_core"),m=e("../grid_core/ui.grid_core.column_state_mixin"),_=e("../grid_core/ui.grid_core.sorting_mixin"),x=e("./ui.pivot_grid.utils"),v=e("./ui.sortable"),S=e("../../core/utils/deferred").Deferred,C=u.each,y=1,w="<div>",F=p.HeaderFilterView.inherit({_getSearchExpr:function(e){return e.useDefaultSearchExpr=!0,this.callBase(e)}}),b=function(e,t){var a=[],r=!!t.groupName,i="exclude"===t.filterType;t.filterValues&&C(t.filterValues,(function(e,t){a.push(Array.isArray(t)?t.join("/"):t&&t.valueOf())})),x.foreachTree(e,(function(e){var t,n=e[0],o=x.createPath(e),l=r?u.map(e,(function(e){return e.text})).reverse().join("/"):n.text;n.value=r?o.slice(0):n.key||n.value,t=r?o.join("/"):n.value&&n.value.valueOf(),n.children&&(n.items=n.children,n.children=null),p.updateHeaderFilterItemSelectionState(n,n.key&&s(l,a)>-1||s(t,a)>-1,i)}))};function D(e,t){var a=t;return d(t.groupIndex)&&(a=e.getAreaFields(t.area,!0)[t.areaIndex]),a}function E(e){return e=e||{},JSON.stringify([e.fields,e.columnExpandedPaths,e.rowExpandedPaths])}var O=g.inherit(m).inherit(_).inherit(p.headerFilterMixin).inherit({_getDefaultOptions:function(){return c(this.callBase(),{allowFieldDragging:!0,applyChangesMode:"instantly",state:null,headerFilter:{width:252,height:325,searchTimeout:500,texts:{emptyValue:h.format("dxDataGrid-headerFilterEmptyValue"),ok:h.format("dxDataGrid-headerFilterOK"),cancel:h.format("dxDataGrid-headerFilterCancel")}}})},_init:function(){this.callBase(),this._headerFilterView=new F(this),this._refreshDataSource(),this.subscribeToEvents()},_refreshDataSource:function(){var e=this.option("dataSource");e&&e.fields&&e.load&&(this._dataSource=e)},_optionChanged:function(e){switch(e.name){case"dataSource":this._refreshDataSource();break;case"applyChangesMode":break;case"state":if(this._skipStateChange||!this._dataSource)break;"instantly"===this.option("applyChangesMode")&&E(this._dataSource.state())!==E(e.value)?this._dataSource.state(e.value):(this._clean(!0),this._renderComponent());break;case"headerFilter":case"allowFieldDragging":this._invalidate();break;default:this.callBase(e)}},renderField:function(e,t){var a=this,i=r(w).addClass("dx-area-field-content").text(e.caption||e.dataField),n=r(w).addClass("dx-area-field").addClass("dx-area-box").data("field",e).append(i),o=D(this._dataSource,e);return"data"!==e.area&&(e.allowSorting&&this._applyColumnState({name:"sort",rootElement:n,column:{alignment:this.option("rtlEnabled")?"right":"left",sortOrder:"desc"===e.sortOrder?"desc":"asc"},showColumnLines:t}),this._applyColumnState({name:"headerFilter",rootElement:n,column:{alignment:this.option("rtlEnabled")?"right":"left",filterValues:o.filterValues,allowFiltering:o.allowFiltering&&!e.groupIndex},showColumnLines:t})),e.groupName&&n.attr("item-group",e.groupName),n},_clean:function(){},_render:function(){this.callBase(),this._headerFilterView.render(this.$element())},renderSortable:function(){var e=this;e._createComponent(e.$element(),v,c({allowDragging:e.option("allowFieldDragging"),itemSelector:".dx-area-field",itemContainerSelector:".dx-area-field-container",groupSelector:".dx-area-fields",groupFilter:function(){var t=e._dataSource,a=r(this).closest(".dx-sortable"),i=a.data("dxPivotGrid"),n=a.data("dxPivotGridFieldChooser");return i?i.getDataSource()===t:!!n&&n.option("dataSource")===t},itemRender:function(e,t){var a;if(e.hasClass("dx-area-box")?(a=e.clone(),"drag"===t&&C(e,(function(e,t){a.eq(e).css("width",parseInt(r(t).outerWidth(),10)+1)}))):a=r(w).addClass("dx-area-field").addClass("dx-area-box").text(e.text()),"drag"===t){var i=r(w);return C(a,(function(e,t){var a=r("<div>").addClass("dx-pivotgrid-fields-container").addClass("dx-widget").append(r(t));i.append(a)})),i.children()}return a},onDragging:function(e){var t=e.sourceElement.data("field"),a=e.targetGroup;e.cancel=!1,!0===t.isMeasure?"column"!==a&&"row"!==a&&"filter"!==a||(e.cancel=!0):!1===t.isMeasure&&"data"===a&&(e.cancel=!0)},useIndicator:!0,onChanged:function(t){var a=e._dataSource,r=t.sourceElement.data("field");t.removeSourceElement=!!t.sourceGroup,e._adjustSortableOnChangedArgs(t),r&&e._applyChanges([D(a,r)],{area:t.targetGroup,areaIndex:t.targetIndex})}},e._getSortableOptions()))},_processDemandState:function(e){var t=this,a="instantly"===this.option("applyChangesMode"),r=this._dataSource;if(a)e(r,a);else{var i=r.state();r.state(this.option("state"),!0),e(r,a),r.state(i,!0)}},_applyChanges:function(e,t){var a=this;a._processDemandState((function(r,i){e.forEach((function(e){var a=e.index;r.field(a,t)})),i?r.load():a._changedHandler()}))},_adjustSortableOnChangedArgs:function(e){e.removeSourceElement=!1,e.removeTargetElement=!0,e.removeSourceClass=!1},_getSortableOptions:function(){return{direction:"auto"}},subscribeToEvents:function(e){var t=this,a=function(e){var a=r(e.currentTarget).data("field"),i=c(!0,{},D(t._dataSource,a)),o=r(e.target).hasClass("dx-header-filter"),l=t._dataSource;o?t._headerFilterView.showHeaderFilterMenu(r(e.currentTarget),c(i,{type:i.groupName?"tree":"list",encodeHtml:t.option("encodeHtml"),dataSource:{useDefaultSearch:!0,load:function(e){var t=e.userData;if(t.store)return t.store.load(e);var a=new S;return l.getFieldValues(i.index).done((function(r){t.store=new n(r),t.store.load(e).done(a.resolve).fail(a.reject)})).fail(a.reject),a},postProcess:function(e){return b(e,i),e}},apply:function(){t._applyChanges([i],{filterValues:this.filterValues,filterType:this.filterType})}})):a.allowSorting&&"data"!==a.area&&t._applyChanges([a],{sortOrder:"desc"===a.sortOrder?"asc":"desc"})};e?i.on(e,o.name,".dx-area-field.dx-area-box",a):i.on(t.$element(),o.name,".dx-area-field.dx-area-box",a)},_initTemplates:l,addWidgetPrefix:function(e){return"dx-pivotgrid-"+e}});f("dxPivotGridFieldChooserBase",O),a.exports=O}

