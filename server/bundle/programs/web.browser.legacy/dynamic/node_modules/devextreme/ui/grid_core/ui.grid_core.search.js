function module(e,t,a){"use strict";var i,r=g(e("../../core/renderer")),n,l=g(e("../../core/dom_adapter")),s=e("../../core/utils/type"),h=e("../../core/utils/data"),o=e("../../core/utils/iterator"),c=e("./ui.grid_core.utils"),u,d=g(e("../../localization/message")),f,p=g(e("../../data/query"));function g(e){return e&&e.__esModule?e:{default:e}}var x="search-panel",m="search-text",_=700,T,v;function P(e){return(0,s.isDefined)(e.allowSearch)?e.allowSearch:e.allowFiltering}function S(e,t){var a=e.lookup;return a?e.parseValue.call(a,t):e.parseValue?e.parseValue(t):t}a.exports={defaultOptions:function(){return{searchPanel:{visible:!1,width:160,placeholder:d.default.format("dxDataGrid-searchPanelPlaceholder"),highlightSearchText:!0,highlightCaseSensitive:!1,text:"",searchVisibleColumnsOnly:!1}}},extenders:{controllers:{data:(v=function(e,t){var a,i,r,n,l=e._columnsController.getColumns(),s=e.option("searchPanel.searchVisibleColumnsOnly"),o=[];if(!t)return null;function u(e){var t,a,r=(0,h.compileGetter)(n.valueExpr);for(t=0;t<e.length;t++)a=r(e[t]),o.push(i.createFilterExpression(a,null,"search"))}for(a=0;a<l.length;a++)i=l[a],s&&!i.visible||P(i)&&i.calculateFilterExpression&&(n=i.lookup,r=S(i,t),n&&n.items?(0,p.default)(n.items).filter(i.createFilterExpression.call({dataField:n.displayExpr,dataType:n.dataType,calculateFilterExpression:i.calculateFilterExpression},r,null,"search")).enumerate().done(u):void 0!==r&&o.push(i.createFilterExpression(r,null,"search")));return(0,c.combineFilters)(o,"or")},{publicMethods:function(){return this.callBase().concat(["searchByText"])},_calculateAdditionalFilter:function(){var e=this,t=this.callBase(),a=v(this,this.option("searchPanel.text"));return(0,c.combineFilters)([t,a])},searchByText:function(e){this.option("searchPanel.text",e)},optionChanged:function(e){var t=this;switch(e.fullName){case"searchPanel.text":case"searchPanel":this._applyFilter(),e.handled=!0;break;default:this.callBase(e)}}})},views:{headerPanel:(T=function(e){return e.option("searchPanel")},{_getToolbarItems:function(){var e=this.callBase();return this._prepareSearchItem(e)},_prepareSearchItem:function(e){var t=this,a=t.getController("data"),i=T(t);if(i&&i.visible){var n={template:function(e,n,l){var s=(0,r.default)("<div>").addClass(t.addWidgetPrefix("search-panel")).appendTo(l);t.getController("editorFactory").createEditor(s,{width:i.width,placeholder:i.placeholder,parentType:"searchPanel",value:t.option("searchPanel.text"),updateValueTimeout:700,setValue:function(e){a.searchByText(e)},editorOptions:{inputAttr:{"aria-label":d.default.format("dxDataGrid-ariaSearchInGrid")}}}),t.resize()},name:"searchPanel",location:"after",locateInMenu:"never",sortIndex:40};e.push(n)}return e},_getSearchTextEditor:function(){var e=this.element(),t=e.find("."+this.addWidgetPrefix("search-panel")).filter((function(){return(0,r.default)(this).closest(".dx-datagrid-header-panel").is(e)}));return t.length?t.dxTextBox("instance"):null},isVisible:function(){var e=T(this);return this.callBase()||e&&e.visible},optionChanged:function(e){if("searchPanel"===e.name){if("searchPanel.text"===e.fullName){var t=this._getSearchTextEditor();t&&t.option("value",e.value)}else this._invalidate();e.handled=!0}else this.callBase(e)}}),rowsView:{init:function(){this.callBase.apply(this,arguments),this._searchParams=[]},_getFormattedSearchText:function(e,t){var a=S(e,t),i=(0,c.getFormatOptionsByColumn)(e,"search");return(0,c.formatValue)(a,i)},_getStringNormalizer:function(){var e=this.option("searchPanel.highlightCaseSensitive");return function(t){return e?t:t.toLowerCase()}},_findHighlightingTextNodes:function(e,t,a){var i,n,l=this,s=t.parent(),h=this._getStringNormalizer(),o=h(a);return s.length?e&&(n=this._columnsController.getVisibleIndex(e.index),i=s.children("td").eq(n).find("*")):s=(0,r.default)("<div>").append(t),i=(i=i&&i.length?i:s.find("*")).filter((function(e,t){for(var a=(0,r.default)(t).contents(),i=0;i<a.length;i++){var n=a.get(i);return 3===n.nodeType&&h(n.textContent||n.nodeValue).indexOf(o)>-1}}))},_highlightSearchTextCore:function(e,t){var a=this,i=(0,r.default)("<span>").addClass(this.addWidgetPrefix("search-text")),n=e.text(),s=e[0],h=this._getStringNormalizer(),o=h(n).indexOf(h(t));if(o>=0)return s.textContent?s.textContent=n.substr(0,o):s.nodeValue=n.substr(0,o),e.after(i.text(n.substr(o,t.length))),e=(0,r.default)(l.default.createTextNode(n.substr(o+t.length))).insertAfter(i),this._highlightSearchTextCore(e,t)},_highlightSearchText:function(e,t,a){var i=this,n=this._getStringNormalizer(),l=i.option("searchPanel.text");if(t&&a&&(l=l&&i._getFormattedSearchText(a,l)),l&&i.option("searchPanel.highlightSearchText")){var s=i._findHighlightingTextNodes(a,e,l);(0,o.each)(s,(function(e,a){(0,o.each)((0,r.default)(a).contents(),(function(e,a){t?n((0,r.default)(a).text())===n(l)&&(0,r.default)(this).replaceWith((0,r.default)("<span>").addClass(i.addWidgetPrefix("search-text")).text((0,r.default)(a).text())):i._highlightSearchTextCore((0,r.default)(a),l)}))}))}},_renderCore:function(){this.callBase.apply(this,arguments),this.option("rowTemplate")&&(this.option("templatesRenderAsynchronously")?(clearTimeout(this._highlightTimer),this._highlightTimer=setTimeout(function(){this._highlightSearchText(this._getTableElement())}.bind(this))):this._highlightSearchText(this._getTableElement()))},_updateCell:function(e,t){var a=t.column,i,r="string"!==(a.lookup&&a.lookup.dataType||a.dataType);P(a)&&(this.option("templatesRenderAsynchronously")?(this._searchParams.length||(clearTimeout(this._highlightTimer),this._highlightTimer=setTimeout(function(){this._searchParams.forEach(function(e){this._highlightSearchText.apply(this,e)}.bind(this)),this._searchParams=[]}.bind(this))),this._searchParams.push([e,r,a])):this._highlightSearchText(e,r,a)),this.callBase(e,t)},dispose:function(){clearTimeout(this._highlightTimer),this.callBase()}}}}}}

