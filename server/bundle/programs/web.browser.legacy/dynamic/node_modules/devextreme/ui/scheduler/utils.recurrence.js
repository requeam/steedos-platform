function module(e,t,n){"use strict";var r=e("../../core/errors"),a=e("../../core/utils/extend").extend,i=e("../../core/utils/iterator").each,u=e("../../core/utils/array").inArray,o=e("../../core/utils/type").isDefined,s=e("../../core/utils/date"),f=s.dateToMilliseconds,c=4,y={secondly:"seconds",minutely:"minutes",hourly:"hours",daily:"days",weekly:"weeks",monthly:"months",yearly:"years"},l={bysecond:function(e,t){e.setSeconds(t)},byminute:function(e,t){e.setMinutes(t)},byhour:function(e,t){e.setHours(t)},bymonth:function(e,t){e.setMonth(t)},bymonthday:function(e,t){if(t<0){var n=new Date(e),r;g(n,1,-1),n.getDate()>=Math.abs(t)?g(e,1,t):g(e,2,t)}else e.setDate(t),S(e,t)},byday:function(e,t,n,r,a){var i=e.getDay(),u=m[n];t+=t>=u==u>i?7:0,e.setDate(e.getDate()-i+t)},byweekno:function(e,t,n){var r=new Date(e),a=new Date(r.setMonth(0,1)),i=a.getDay()-m[n],u=a.getTime()-i*f("day"),o;i+1>4?e.setTime(u+7*t*f("day")):e.setTime(u+7*(t-1)*f("day"));var s=(e.getTimezoneOffset()-a.getTimezoneOffset())*f("minute");s&&e.setTime(e.getTime()+s)},byyearday:function(e,t){e.setMonth(0,1),e.setDate(t)}},g=function(e,t,n){var r=new Date(e);e.setMonth(e.getMonth()+t),e.getMonth()-r.getMonth()>t&&e.setDate(n+1),e.setDate(n+1)},d={bysecond:function(e){return e.getSeconds()},byminute:function(e){return e.getMinutes()},byhour:function(e){return e.getHours()},bymonth:function(e){return e.getMonth()},bymonthday:function(e){return e.getDate()},byday:function(e){return e.getDay()},byweekno:function(e,t){var n,r=new Date(e),a=4-r.getDay()+m[t]-1,i=f("day");e.getDay()<m[t]&&(a-=7),r.setHours(0,0,0),r.setDate(r.getDate()+a);var u=new Date(r.getFullYear(),0,1),o=(u.getTimezoneOffset()-r.getTimezoneOffset())*f("minute");return n=1+(r-u+o)/i,Math.ceil(n/7)},byyearday:function(e){var t=new Date(e.getFullYear(),0,0),n=e.getTimezoneOffset()-t.getTimezoneOffset(),r=e-t-n*f("minute"),a=f("day");return Math.floor(r/a)}},v=["freq","interval","byday","byweekno","byyearday","bymonth","bymonthday","count","until","byhour","byminute","bysecond","bysetpos","wkst"],h=["DAILY","WEEKLY","MONTHLY","YEARLY","SECONDLY","MINUTELY","HOURLY"],m={SU:0,MO:1,TU:2,WE:3,TH:4,FR:5,SA:6},D={0:"SU",1:"MO",2:"TU",3:"WE",4:"TH",5:"FR",6:"SA"},b,T=function(e){var t=[];return e.rule&&(t=k(e)),!!t.length},p=function(e){var t=e.interval,n=e.freq,r={},a=y[n.toLowerCase()];return"MONTHLY"===n&&e.byday&&(a=y.daily),r[a]=t,r},w=function(e,t){for(var n=[],r=0,a=e.length;r<a;r++)n[r]=j(e[r],t);return n},M=function(e,t){var n=!1;if(!t)return n;for(var r=t.split(","),a=w(r,e),i=/\d{8}$/,u=0,o=a.length;u<o;u++)if(r[u].match(i)){var s=A(e,a[u]);0===s.years&&0===s.months&&0===s.days&&(n=!0)}else e.getTime()===a[u].getTime()&&(n=!0);return n},O=function(e,t,n,r,a){var i,u=!0;return n=n.getTime(),r.until&&r.until.getTime()<n&&(n=r.until.getTime()),r.count&&a===r.count&&(u=!1),(i=e.getTime()<=n)&&u},k=function(e){var t,n=[],r=H(e.rule),a={},u=r.rule,o=e.start;if(!r.isValid||!u.freq)return n;u.interval=p(u),t=$(u,e.firstDayOfWeek);var s=e.end?e.end.getTime()-e.start.getTime():f("day"),c={exception:e.exception,min:e.min,dateRules:t,rule:u,recurrenceStartDate:o,recurrenceEndDate:e.end,duration:s};if(t.length&&u.count){var y=0;_(t,new Date(o),new Date(o),u).forEach((function(t,n){t<e.max&&(y++,a=Y(y,a,t,n,c,!0))}))}else X(t,new Date(o),u).forEach((function(t,n){for(var r=0;O(t,o,e.max,u,r);)r++,a=Y(r,a,t,n,c),t=R(t,o,u,n)}));return u.bysetpos&&i(a,(function(e,t){a[e]=E(t,u.bysetpos)})),i(a,(function(e,t){n=n.concat(t)})),n.sort((function(e,t){return e-t})),n},Y=function(e,t,n,r,a,i){return t[e]||(t[e]=[]),N(n,r,a,i)&&t[e].push(n),t},N=function(e,t,n,r){if(!M(e,n.exception)){var a=s.sameDate(e,n.recurrenceEndDate)&&n.recurrenceEndDate.getTime()>e.getTime()?n.recurrenceEndDate.getTime()-e.getTime():n.duration;if(e.getTime()>=n.recurrenceStartDate.getTime()&&e.getTime()+a>n.min.getTime())return r||te(e,[n.dateRules[t]],n.rule.wkst)}return!1},E=function(e,t){var n=[];return t.split(",").forEach((function(t){var r=(t=Number(t))>0?t-1:e.length+t;e[r]&&n.push(e[r])})),n},S=function(e,t){e.getDate()!==t&&e.setDate(t)},R=function(e,t,n,r){var a=new Date(e),i=!0;if(e=s.addInterval(e,n.interval),"MONTHLY"===n.freq&&!n.byday){var u=t.getDate();n.bymonthday&&(u=Number(n.bymonthday.split(",")[r]))<0&&(a.setMonth(a.getMonth()+1,1),l.bymonthday(a,u),e=a,i=!1),i&&S(e,u)}if("YEARLY"===n.freq){if(n.byyearday){var o=Number(n.byyearday.split(",")[r]);l.byyearday(e,o)}var f=$(n);for(var c in f[r])l[c]&&l[c](e,f[r][c],n.wkst)}return e},A=function(e,t){return{years:e.getFullYear()-t.getFullYear(),months:e.getMonth()-t.getMonth(),days:e.getDate()-t.getDate(),hours:e.getHours()-t.getHours(),minutes:e.getMinutes()-t.getMinutes(),seconds:e.getSeconds()-t.getSeconds()}},H=function(e){var t={rule:{},isValid:!1};return e&&(t.rule=C(e),t.isValid=I(t.rule,e)),t},L=[],I=function(e,t){return!(Z(e)||-1===u(e.freq,h)||F(e)||U(e)||W(e)||x(e)||z(e)||q(e))||(B(t),!1)},q=function(e){var t=!1,n=e.until;return void 0===n||n instanceof Date||(t=!0),t},F=function(e){var t=!1,n=e.count;return n&&"string"==typeof n&&(t=!0),t},x=function(e){var t=!1,n=e.bymonthday;return n&&isNaN(parseInt(n))&&(t=!0),t},z=function e(t){var e=!1,n=t.bymonth;return n&&isNaN(parseInt(n))&&(e=!0),e},U=function(e){var t=!1,n=e.interval;return n&&"string"==typeof n&&(t=!0),t},W=function(e){var t=K(e),n=!1;return i(t,(function(e,t){if(!m.hasOwnProperty(t))return n=!0,!1})),n},Z=function(e){var t=!1;return i(e,(function(e){if(-1===u(e,v))return t=!0,!1})),t},B=function(e){-1===u(e,L)&&(r.log("W0006",e),L.push(e))},C=function(e){for(var t={},n=e.split(";"),r=0,a=n.length;r<a;r++){var i=n[r].split("="),u=i[0].toLowerCase(),o=i[1];t[u]=o}var s=parseInt(t.count);if(isNaN(s)||(t.count=s),t.interval){var f=parseInt(t.interval);isNaN(f)||(t.interval=f)}else t.interval=1;return t.freq&&t.until&&(t.until=j(t.until)),t},j=function(e,t){if("string"!=typeof e)return e;var n=e.match(/(\d{4})(\d{2})(\d{2})(T(\d{2})(\d{2})(\d{2}))?(Z)?/);if(!n)return null;var r=void 0!==n[8],a=t?t.getTimezoneOffset():re.getTimeZoneOffset(),i=new(Function.prototype.bind.apply(Date,V(n)));return a*=6e4,r&&(i=new Date(i.getTime()-a)),i},V=function(e){return e.shift(),void 0===e[3]?e.splice(3):(e.splice(3,1),e.splice(6)),e[1]--,e.unshift(null),e},K=function(e){var t=[];return e.byday&&(t=Array.isArray(e.byday)?e.byday:e.byday.split(",")),t},P=function(e){var t=6e4*re.getTimeZoneOffset();return(e=new Date(e.getTime()+t)).getFullYear()+("0"+(e.getMonth()+1)).slice(-2)+("0"+e.getDate()).slice(-2)+"T"+("0"+e.getHours()).slice(-2)+("0"+e.getMinutes()).slice(-2)+("0"+e.getSeconds()).slice(-2)+"Z"},$=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=[];if(o(t)&&(e.fdow=t),e.wkst||(e.wkst=o(t)?D[t]:"MO"),e.byweekno&&!e.byday){for(var r=Object.keys(m),a=0;a<m[e.wkst];a++)r.push(r.shift());e.byday=r.join(",")}for(var i in l)if(e[i]){var u=e[i].split(","),s=G(i,u);n=n.length?Q(s,n):s}return n},G=function(e,t){for(var n=[],r=0,a=t.length;r<a;r++){var i={};i[e]=J(e,t[r]),n.push(i)}return n},J=function(e,t){var n=parseInt(t);return"bymonth"===e&&(n-=1),"byday"===e&&(n=m[t]),n},Q=function(e,t){for(var n=[],r=0,i=e.length;r<i;r++)for(var u=0,o=t.length;u<o;u++)n.push(a({},e[r],t[u]));return n},X=function(e,t,n){for(var r=[],a=0,i=e.length;a<i;a++){var u=e[a],o=ee(t,e,n.wkst);for(var s in u)l[s]&&l[s](o,u[s],n.wkst,n.freq,n.fdow);Array.isArray(o)?r=r.concat(o):r.push(new Date(o))}return r.length||r.push(t),r},_=function(e,t,n,r){for(var a=[],i=r.count,u=0,o=ee(t,e,r.wkst);u<i;){for(var f=X(e,o,r),c=[],y=0;y<f.length;y++)f[y].getTime()>=n.getTime()&&c.push(f[y]);var l=c.length,g=(u+=l)-i;for(u>i&&c.splice(l-g,g),y=0;y<c.length;y++)a.push(c[y]);var d=r.interval;"days"===Object.keys(d)[0]&&(d={weeks:1}),o=s.addInterval(o,d)}return a},ee=function(e,t,n){var r=new Date(e),a=r.getDay();return t.length&&o(t[0].byday)?r.setDate(r.getDate()-a+m[n]-(a<m[n]?7:0)):r.setDate(1),r},te=function(e,t,n){for(var r=!1,a=0;a<t.length;a++){var i=t[a],u=!0;for(var o in i){var s="bymonthday"===o&&i[o]<0;d[o]&&!s&&i[o]!==d[o](e,n)&&(u=!1)}r=r||u}return r||!t.length},ne,re={getRecurrenceString:function(e){if(e&&e.freq){var t="";for(var n in e){var r=e[n];"interval"===n&&r<2||("until"===n&&(r=P(r)),t+=n+"="+r+";")}return(t=t.substring(0,t.length-1)).toUpperCase()}},getRecurrenceRule:H,getAsciiStringByDate:P,getDatesByRecurrence:k,dateInRecurrenceRange:T,getDateByAsciiString:j,daysFromByDayRule:K,getTimeZoneOffset:function(){return(new Date).getTimezoneOffset()}};n.exports=re}

