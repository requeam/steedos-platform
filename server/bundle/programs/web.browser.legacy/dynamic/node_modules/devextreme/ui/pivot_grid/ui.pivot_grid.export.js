function module(t,e){"use strict";var n=t("../../core/class"),o=t("../../core/utils/type").isDefined,r=t("../../core/utils/extend").extend,i=t("../../core/utils/iterator").each,s=t("../../format_helper"),l=t("../../localization/number"),a=t("../../exporter"),c=a.excel,u="string",g=t("../grid_core/ui.grid_core.export_mixin"),p=t("../../core/utils/deferred"),h=p.when,f=p.Deferred,m=0,d=1,_=2,x=100;function v(t){if(t&&t.customizeText)return"string";if(t.dataType)return t.dataType;if(t.format){if(1===l.parse(s.format(1,t.format)))return"number";if(s.format(new Date,t.format))return"date"}return u}e.ExportMixin=r({},g,{exportToExcel:function(){var t=this;a.export(this.getDataProvider(),{fileName:this.option("export.fileName"),proxyUrl:this.option("export.proxyUrl"),format:"EXCEL",rtlEnabled:this.option("rtlEnabled"),ignoreErrors:this.option("export.ignoreExcelErrors"),exportingAction:this._actions.onExporting,exportedAction:this._actions.onExported,fileSavingAction:this._actions.onFileSaving},c.getData)},_getLength:function(t){var e,n=t[0].length,o=0;for(e=0;e<n;e++)o+=t[0][e].colspan||1;return o},_correctCellsInfoItemLengths:function(t,e){for(var n=0;n<t.length;n++)for(;t[n].length<e;)t[n].push({});return t},_calculateCellInfoItemLength:function(t){for(var e=0,n=0;n<t.length;n++)e+=o(t[n].colspan)?t[n].colspan:1;return e},_getAllItems:function(t,e,n){var i,s,l,a=n,c=this._getLength(e),u=t.length;if(t.length>0&&t[0].length>0&&n.length>0&&0===n[0].length){var g=this._calculateCellInfoItemLength(t[0]);g>0&&(a=this._correctCellsInfoItemLengths(n,g))}for(l=t.concat(a),s=0;s<e.length;s++)for(i=e[s].length-1;i>=0;i--)o(l[s+u])||(l[s+u]=[]),l[s+u].splice(0,0,r({},e[s][i]));return l[0].splice(0,0,r({},this._getEmptyCell(),{alignment:this._options.rtlEnabled?"right":"left",colspan:c,rowspan:u})),this._prepareItems(l)},getDataProvider:function(){var t=this,n=this._dataController,o=new f;return n.beginLoading(),setTimeout((function(){var e=r(!0,[],n.getColumnsInfo(!0)),i=r(!0,[],n.getRowsInfo(!0)),s=n.getCellsInfo(!0);o.resolve(t._getAllItems(e,i,s)),n.endLoading()})),new e.DataProvider({items:o,rtlEnabled:this.option("rtlEnabled"),dataFields:this.getDataSource().getAreaFields("data"),customizeExcelCell:this.option("export.customizeExcelCell")})}}),e.DataProvider=n.inherit({ctor:function(t){this._options=t,this._styles=[]},ready:function(){var t=this,e=t._options,n=e.dataFields;return h(e.items).done((function(o){var s,l=o[o[0][0].rowspan-1],a={alignment:e.rtlEnabled?"left":"right"};t._styles=[{alignment:"center",dataType:"string"},{alignment:e.rtlEnabled?"right":"left",dataType:"string"}],n.length?n.forEach((function(e){t._styles.push(r({},a,{format:e.format,dataType:v(e)}))})):t._styles.push(a),i(l,(function(t,e){e.width=100})),e.columns=l,e.items=o}))},getColumns:function(){return this._options.columns},getRowsCount:function(){return this._options.items.length},getGroupLevel:function(){return 0},getCellMerging:function(t,e){var n=this._options.items,o=n[t]&&n[t][e];return o?{colspan:o.colspan-1,rowspan:o.rowspan-1}:{colspan:0,rowspan:0}},getFrozenArea:function(){var t=this._options.items;return{x:t[0][0].colspan,y:t[0][0].rowspan}},getCellType:function(t,e){var n=this._styles[this.getStyleId(t,e)];return n&&n.dataType||"string"},getCellData:function(t,e){var n={},o=this._options.items,r=o[t]&&o[t][e]||{};return"string"===this.getCellType(t,e)?n.value=r.text:n.value=r.value,n},getStyles:function(){return this._styles},getStyleId:function(t,e){var n=this._options.items,o=n[0][0].rowspan,r=n[0][0].colspan,i=n[t]&&n[t][e]||{};return 0===e&&0===t?0:e>=r&&t<o?0:t>=o&&e<r?1:2+(i.dataIndex||0)},hasCustomizeExcelCell:function(){return o(this._options.customizeExcelCell)},customizeExcelCell:function(t){this._options.customizeExcelCell&&this._options.customizeExcelCell(t)}})}

