function module(e,t,i){"use strict";var n,a=D(e("../../core/renderer")),r,o=D(e("../../core/dom_adapter")),d,l=D(e("../../core/class")),u,s=D(e("../../events/core/events_engine")),c,f=D(e("../widget/ui.widget")),p,m=D(e("../../core/component_registrator")),h=e("../../core/utils/extend"),x,_=D(e("../../localization/message")),v,g=D(e("./utils")),b,C=D(e("../../core/utils/deferred")),O=e("../../core/utils/type"),y,B=D(e("../tree_view")),E,F=D(e("../popup")),V=e("../overlay/utils"),k,T=D(e("../shared/ui.editor_factory_mixin")),w=e("../../events/utils");function D(e){return e&&e.__esModule?e:{default:e}}var A="dx-filterbuilder",I="dx-filterbuilder-group",G="dx-filterbuilder-group-item",M="dx-filterbuilder-group-content",W="dx-filterbuilder-group-operations",H="dx-filterbuilder-group-operation",N="dx-filterbuilder-action",K="dx-filterbuilder-action-icon",P="dx-icon-plus",S="dx-icon-remove",z="dx-filterbuilder-text",q="dx-filterbuilder-text-part",R="dx-filterbuilder-text-separator",L="dx-filterbuilder-text-separator-empty",$="dx-filterbuilder-item-field",U="dx-filterbuilder-item-operation",J="dx-filterbuilder-item-value",j="dx-filterbuilder-item-value-text",Q="dx-filterbuilder-overlay",X="dx-filterbuilder-operations",Y="dx-filterbuilder-fields",Z="dx-filterbuilder-add-condition",ee="dx-state-active",te="dx-filterbuilder-menu-custom-operation",ie="filterBuilder",ne="dx-state-disabled",ae="tab",re="enter",oe="escape",de=[{name:"onEditorPreparing",config:{excludeValidators:["designMode","disabled","readOnly"],category:"rendering"}},{name:"onEditorPrepared",config:{excludeValidators:["designMode","disabled","readOnly"],category:"rendering"}},{name:"onValueChanged",config:{excludeValidators:["disabled","readOnly"]}}],le={and:"and",or:"or",notAnd:"!and",notOr:"!or"},ue=l.default.inherit(T.default),se=function(e,t,i){if(Array.isArray(t)){var n=t.length-1;e.empty(),t.forEach((function(t,r){(0,a.default)("<span>").addClass("dx-filterbuilder-text-part").text(t).appendTo(e),r!==n&&(0,a.default)("<span>").addClass("dx-filterbuilder-text-separator").text(i&&i.valueSeparator?i.valueSeparator:"|").addClass("dx-filterbuilder-text-separator-empty").appendTo(e)}))}else t?e.text(t):e.text(_.default.format("dxFilterBuilder-enterValueText"))},ce=f.default.inherit({_getDefaultOptions:function(){return(0,h.extend)(this.callBase(),{onEditorPreparing:null,onEditorPrepared:null,onValueChanged:null,fields:[],defaultGroupOperation:"and",groupOperations:["and","or","notAnd","notOr"],maxGroupLevel:void 0,value:null,allowHierarchicalFields:!1,groupOperationDescriptions:{and:_.default.format("dxFilterBuilder-and"),or:_.default.format("dxFilterBuilder-or"),notAnd:_.default.format("dxFilterBuilder-notAnd"),notOr:_.default.format("dxFilterBuilder-notOr")},customOperations:[],filterOperationDescriptions:{between:_.default.format("dxFilterBuilder-filterOperationBetween"),equal:_.default.format("dxFilterBuilder-filterOperationEquals"),notEqual:_.default.format("dxFilterBuilder-filterOperationNotEquals"),lessThan:_.default.format("dxFilterBuilder-filterOperationLess"),lessThanOrEqual:_.default.format("dxFilterBuilder-filterOperationLessOrEquals"),greaterThan:_.default.format("dxFilterBuilder-filterOperationGreater"),greaterThanOrEqual:_.default.format("dxFilterBuilder-filterOperationGreaterOrEquals"),startsWith:_.default.format("dxFilterBuilder-filterOperationStartsWith"),contains:_.default.format("dxFilterBuilder-filterOperationContains"),notContains:_.default.format("dxFilterBuilder-filterOperationNotContains"),endsWith:_.default.format("dxFilterBuilder-filterOperationEndsWith"),isBlank:_.default.format("dxFilterBuilder-filterOperationIsBlank"),isNotBlank:_.default.format("dxFilterBuilder-filterOperationIsNotBlank")}})},_optionChanged:function(e){switch(e.name){case"onEditorPreparing":case"onEditorPrepared":case"onValueChanged":this._initActions();break;case"customOperations":this._initCustomOperations(),this._invalidate();break;case"fields":case"defaultGroupOperation":case"maxGroupLevel":case"groupOperations":case"allowHierarchicalFields":case"groupOperationDescriptions":case"filterOperationDescriptions":this._invalidate();break;case"value":var t=this._disableInvalidateForValue;t||(this._initModel(),this._invalidate()),this._disableInvalidateForValue=!1,this.executeAction("onValueChanged",{value:e.value,previousValue:e.previousValue}),this._disableInvalidateForValue=t;break;default:this.callBase(e)}},getFilterExpression:function(){var e=this._getNormalizedFields(),t=(0,h.extend)(!0,[],this._model);return g.default.getFilterExpression(g.default.getNormalizedFilter(t),e,this._customOperations,ie)},_getNormalizedFields:function(){return g.default.getNormalizedFields(this.option("fields"))},_updateFilter:function(){this._disableInvalidateForValue=!0;var e=(0,h.extend)(!0,[],this._model),t=g.default.getNormalizedFilter(e),i=g.default.getNormalizedFilter(this._getModel(this.option("value")));JSON.stringify(i)!==JSON.stringify(t)&&this.option("value",t),this._disableInvalidateForValue=!1,this._fireContentReadyAction()},_init:function(){this._initCustomOperations(),this._initModel(),this._initEditorFactory(),this._initActions(),this.callBase()},_initEditorFactory:function(){this._editorFactory=new ue},_initCustomOperations:function(){this._customOperations=g.default.getMergedOperations(this.option("customOperations"),this.option("filterOperationDescriptions.between"))},_getModel:function(e){return g.default.convertToInnerStructure(e,this._customOperations)},_initModel:function(){this._model=this._getModel(this.option("value"))},_initActions:function(){var e=this;e._actions={},de.forEach((function(t){e._actions[t.name]=e._createActionByOption(t.name,t.config)}))},executeAction:function(e,t){var i=this._actions[e];return i&&i(t)},_initMarkup:function(){this.$element().addClass("dx-filterbuilder"),this.callBase(),this._createGroupElementByCriteria(this._model).appendTo(this.$element())},_createConditionElement:function(e,t){return(0,a.default)("<div>").addClass("dx-filterbuilder-group").append(this._createConditionItem(e,t))},_createGroupElementByCriteria:function(e,t){for(var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=this._createGroupElement(e,t,i),a=n.find(".dx-filterbuilder-group-content"),r=g.default.getGroupCriteria(e),o=0;o<r.length;o++){var d=r[o];g.default.isGroup(d)?this._createGroupElementByCriteria(d,r,i+1).appendTo(a):g.default.isCondition(d)&&this._createConditionElement(d,r).appendTo(a)}return n},_createGroupElement:function(e,t,i){var n=this,r=(0,a.default)("<div>").addClass("dx-filterbuilder-group-item"),o=(0,a.default)("<div>").addClass("dx-filterbuilder-group-content"),d=(0,a.default)("<div>").addClass("dx-filterbuilder-group").append(r).append(o);return null!=t&&this._createRemoveButton((function(){g.default.removeItem(t,e),d.remove(),n._updateFilter()})).appendTo(r),this._createGroupOperationButton(e).appendTo(r),this._createAddButton((function(){var t=g.default.createEmptyGroup(n.option("defaultGroupOperation"));g.default.addItem(t,e),n._createGroupElement(t,e,i+1).appendTo(o),n._updateFilter()}),(function(){var t=n.option("fields")[0],i=g.default.createCondition(t,n._customOperations);g.default.addItem(i,e),n._createConditionElement(i,e).appendTo(o),n._updateFilter()}),i).appendTo(r),d},_createButton:function(e){return(0,a.default)("<div>").text(e)},_createGroupOperationButton:function(e){var t=this,i=this._getGroupOperations(e),n=g.default.getGroupMenuItem(e,i),a=n.text,r=i&&i.length<2?this._createButton(a).addClass("dx-state-disabled"):this._createButtonWithMenu({caption:a,menu:{items:i,displayExpr:"text",keyExpr:"value",onItemClick:function(i){n!==i.itemData&&(g.default.setGroupValue(e,i.itemData.value),r.html(i.itemData.text),n=i.itemData,t._updateFilter())},onContentReady:function(e){e.component.selectItem(n)},cssClass:"dx-filterbuilder-group-operations"}});return r.addClass("dx-filterbuilder-text").addClass("dx-filterbuilder-group-operation").attr("tabindex",0)},_createButtonWithMenu:function(e){var t=this,i=function(){t.$element().find("."+ee).removeClass(ee),t.$element().find(".dx-overlay .dx-treeview").remove(),t.$element().find(".dx-overlay").remove()},n=this.option("rtlEnabled"),r=function(e){return function(t){e(t),"dxclick"===t.event.type&&i()}},o=n?"right":"left",d=this._createButton(e.caption);return(0,h.extend)(e.menu,{focusStateEnabled:!0,selectionMode:"single",onItemClick:r(e.menu.onItemClick),onHiding:function(e){d.removeClass(ee)},position:{my:o+" top",at:o+" bottom",offset:"0 1",of:d,collision:"flip"},animation:null,onHidden:function(){i()},cssClass:"dx-filterbuilder-overlay "+e.menu.cssClass,rtlEnabled:n}),e.popup={onShown:function(t){var i=(0,a.default)(t.component.content()).find(".dx-treeview"),n=i.dxTreeView("instance");s.default.on(i,"keyup keydown",(function(i){var n=(0,w.normalizeKeyName)(i);("keydown"===i.type&&"tab"===n||"keyup"===i.type&&("escape"===n||"enter"===n))&&(t.component.hide(),s.default.trigger(e.menu.position.of,"focus"))})),n.focus(),n.option("focusedElement",null)}},this._subscribeOnClickAndEnterKey(d,(function(){i(),t._createPopupWithTreeView(e,t.$element()),d.addClass(ee)})),d},_hasValueButton:function(e){var t=g.default.getCustomOperation(this._customOperations,e[1]);return t?!1!==t.hasValue:null!==e[2]},_createOperationButtonWithMenu:function(e,t){var i=this,n=this,r=g.default.getAvailableOperations(t,this.option("filterOperationDescriptions"),this._customOperations),o=g.default.getOperationFromAvailable(g.default.getOperationValue(e),r),d=this._createButtonWithMenu({caption:o.text,menu:{items:r,displayExpr:"text",onItemRendered:function(e){e.itemData.isCustom&&(0,a.default)(e.itemElement).addClass("dx-filterbuilder-menu-custom-operation")},onContentReady:function(e){e.component.selectItem(o)},onItemClick:function(a){if(o!==a.itemData){o=a.itemData,g.default.updateConditionByOperation(e,o.value,n._customOperations);var r=d.siblings().filter(".dx-filterbuilder-item-value");n._hasValueButton(e)?(0!==r.length&&r.remove(),n._createValueButton(e,t).appendTo(d.parent())):r.remove(),d.html(o.text),i._updateFilter()}},cssClass:"dx-filterbuilder-operations"}}).addClass("dx-filterbuilder-text").addClass("dx-filterbuilder-item-operation").attr("tabindex",0);return d},_createOperationAndValueButtons:function(e,t,i){this._createOperationButtonWithMenu(e,t).appendTo(i),this._hasValueButton(e)&&this._createValueButton(e,t).appendTo(i)},_createFieldButtonWithMenu:function(e,t,i){var n=this,a=this,r=this.option("allowHierarchicalFields"),o=g.default.getItems(e,r),d=g.default.getField(i.name||i.dataField,o),l=function(e,t){return r?g.default.getCaptionWithParents(e,t):e.caption},u=this._createButtonWithMenu({caption:l(d,o),menu:{items:o,dataStructure:"plain",displayExpr:"caption",onItemClick:function(e){if(d!==e.itemData){d=e.itemData,t[0]=d.name||d.dataField,t[2]="object"===d.dataType?null:"",g.default.updateConditionByOperation(t,g.default.getDefaultOperation(d),a._customOperations),u.siblings().filter(".dx-filterbuilder-text").remove(),a._createOperationAndValueButtons(t,d,u.parent());var i=l(d,e.component.option("items"));u.html(i),n._updateFilter()}},onContentReady:function(e){e.component.selectItem(d)},cssClass:"dx-filterbuilder-fields"}}).addClass("dx-filterbuilder-text").addClass("dx-filterbuilder-item-field").attr("tabindex",0);return u},_createConditionItem:function(e,t){var i=this,n=(0,a.default)("<div>").addClass("dx-filterbuilder-group-item"),r=this._getNormalizedFields(),o=g.default.getField(e[0],r);return this._createRemoveButton((function(){g.default.removeItem(t,e),n.remove(),i._updateFilter()})).appendTo(n),this._createFieldButtonWithMenu(r,e,o).appendTo(n),this._createOperationAndValueButtons(e,o,n),n},_getGroupOperations:function(e){var t=this.option("groupOperations"),i=this.option("groupOperationDescriptions");return t&&t.length||(t=[g.default.getGroupValue(e).replace("!","not")]),t.map((function(e){return{text:i[e],value:le[e]}}))},_createRemoveButton:function(e){var t=(0,a.default)("<div>").addClass(K).addClass("dx-icon-remove").addClass("dx-filterbuilder-action").attr("tabindex",0);return this._subscribeOnClickAndEnterKey(t,e),t},_createAddButton:function(e,t,i){var n=void 0,a=this.option("maxGroupLevel");return(0,O.isDefined)(a)&&i>=a?(n=this._createButton(),this._subscribeOnClickAndEnterKey(n,t)):n=this._createButtonWithMenu({menu:{items:[{caption:_.default.format("dxFilterBuilder-addCondition"),click:t},{caption:_.default.format("dxFilterBuilder-addGroup"),click:e}],displayExpr:"caption",onItemClick:function(e){e.itemData.click()},cssClass:"dx-filterbuilder-add-condition"}}),n.addClass(K).addClass("dx-icon-plus").addClass("dx-filterbuilder-action").attr("tabindex",0)},_createValueText:function(e,t,i){var n=this,r=(0,a.default)("<div>").html("&nbsp;").addClass("dx-filterbuilder-item-value-text").attr("tabindex",0).appendTo(i),o=e[2],d=g.default.getCustomOperation(n._customOperations,e[1]);return!d&&t.lookup?g.default.getCurrentLookupValueText(t,o,(function(e){se(r,e)})):C.default.when(g.default.getCurrentValueText(t,o,d)).done((function(e){se(r,e,d)})),n._subscribeOnClickAndEnterKey(r,(function(a){"keyup"===a.type&&a.stopPropagation(),n._createValueEditorWithEvents(e,t,i)})),r},_updateConditionValue:function(e,t,i){var n;e[2]!==t&&(e[2]=t),i(),this._updateFilter()},_addDocumentKeyUp:function(e,t){var i=o.default.getDocument(),n=function(e){a||r?r=!1:t(e)};s.default.on(i,"keyup",n);var a=!1,r=!1,d=e.find("input");s.default.on(d,"compositionstart",(function(){a=!0})),s.default.on(d,"compositionend",(function(){a=!1,r=!0})),s.default.on(d,"keydown",(function(e){229!==e.which&&(r=!1)})),this._documentKeyUpHandler=n},_addDocumentClick:function(e,t){var i=this,n=o.default.getDocument(),a=function(n){i._isFocusOnEditorParts(e,n.target)||(s.default.trigger(e.find("input"),"change"),t())};s.default.on(n,"dxpointerdown",a),this._documentClickHandler=a},_isFocusOnEditorParts:function(e,t){var i=t||o.default.getActiveElement();return(0,a.default)(i).closest(e.children()).length||(0,a.default)(i).closest(".dx-dropdowneditor-overlay").length},_removeEvents:function(){var e=o.default.getDocument();(0,O.isDefined)(this._documentKeyUpHandler)&&s.default.off(e,"keyup",this._documentKeyUpHandler),(0,O.isDefined)(this._documentClickHandler)&&s.default.off(e,"dxpointerdown",this._documentClickHandler)},_dispose:function(){this._removeEvents(),this.callBase()},_createValueEditorWithEvents:function(e,t,i){var n=this,a=e[2],r=function(){return i.empty(),n._removeEvents(),n._createValueText(e,t,i)},o=function(){n._updateConditionValue(e,a,(function(){r()}))},d={value:""===a?null:a,filterOperation:g.default.getOperationValue(e),setValue:function(e){a=null===e?"":e},closeEditor:o,text:i.text()};i.empty();var l=this._createValueEditor(i,t,d);s.default.trigger(l.find("input").not(":hidden").eq(0),"focus"),this._removeEvents(),this._addDocumentClick(l,o),this._addDocumentKeyUp(l,(function(t){var o=(0,w.normalizeKeyName)(t);if("tab"===o){if(n._isFocusOnEditorParts(l))return;n._updateConditionValue(e,a,(function(){r(),t.shiftKey&&s.default.trigger(i.prev(),"focus")}))}"escape"===o&&s.default.trigger(r(),"focus"),"enter"===o&&n._updateConditionValue(e,a,(function(){s.default.trigger(r(),"focus")}))})),this._fireContentReadyAction()},_createValueButton:function(e,t){var i=(0,a.default)("<div>").addClass("dx-filterbuilder-text").addClass("dx-filterbuilder-item-value");return this._createValueText(e,t,i),i},_createValueEditor:function(e,t,i){var n=(0,a.default)("<div>").attr("tabindex",0).appendTo(e),r=g.default.getCustomOperation(this._customOperations,i.filterOperation),o=r&&r.editorTemplate?r.editorTemplate:t.editorTemplate,d;o?this._getTemplate(o).render({model:(0,h.extend)({field:t},i),container:n}):this._editorFactory.createEditor.call(this,n,(0,h.extend)({},t,i,{parentType:ie}));return n},_createPopupWithTreeView:function(e,t){var i=this,n=(0,a.default)("<div>").addClass(e.menu.cssClass).appendTo(t);this._createComponent(n,F.default,{onHiding:e.menu.onHiding,onHidden:e.menu.onHidden,rtlEnabled:e.menu.rtlEnabled,position:e.menu.position,animation:e.menu.animation,contentTemplate:function(t){var n=(0,a.default)("<div>");return i._createComponent(n,B.default,e.menu),n},maxHeight:function(){return(0,V.getElementMaxHeightByWindow)(e.menu.position.of)},visible:!0,focusStateEnabled:!1,closeOnOutsideClick:!0,onShown:e.popup.onShown,shading:!1,width:"auto",height:"auto",showTitle:!1})},_subscribeOnClickAndEnterKey:function(e,t){s.default.on(e,"dxclick",t),s.default.on(e,"keyup",(function(e){"enter"===(0,w.normalizeKeyName)(e)&&t(e)}))}});(0,m.default)("dxFilterBuilder",ce),i.exports=ce,i.exports.renderValueText=se}

