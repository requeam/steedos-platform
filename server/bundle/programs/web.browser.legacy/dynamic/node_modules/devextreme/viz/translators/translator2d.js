function module(t,e){"use strict";var n=t("../../core/utils/extend").extend,i=t("../../core/utils/iterator").each,a=t("./range").Range,s=t("./category_translator"),r=t("./interval_translator"),o=t("./datetime_translator"),u=t("./logarithmic_translator"),l=t("../core/utils"),c=t("../../core/utils/type"),h=l.getLog,v=l.getPower,g=c.isDefined,f=t("../../core/utils/math").adjust,_=Math.abs,d=["width","height","left","top","bottom","right"],b,p=t("../../core/utils/date").addInterval,m={to:function(t){var e=this._canvasOptions.startPoint+(this._options.conversionValue?t:Math.round(t));return e>this._canvasOptions.endPoint?this._canvasOptions.endPoint:e},from:function(t){return t-this._canvasOptions.startPoint}},V=function(t){return i(d,(function(e,n){t[n]=parseInt(t[n])||0})),t},k=function(t){var e={};return t.forEach((function(t,n){e[t.valueOf()]=n})),e},M=function(t){function e(e,n){!g(t[e])&&g(t[n])&&(t[e]=t[n])}return t instanceof a||(t=new a(t)),e("minVisible","min"),e("maxVisible","max"),t};function O(t,e){var n,i,a,s,r="logarithmic"===e.axisType?function(t){return h(t,e.base)}:function(t){return t},o=[],u=t.length,l=0;for(s=0;s<u;s++)i=r((n=t[s]).from),l+=(a=r(n.to))-i,o.push({trFrom:i,trTo:a,from:n.from,to:n.to,length:l,cumulativeWidth:n.cumulativeWidth});return o}function x(t){var e=t.min,n=t.max,i=t.minVisible,a=t.maxVisible,s;return"logarithmic"===t.axisType&&(a=h(a,t.base),i=h(i,t.base),e=h(e,t.base),n=h(n,t.base)),{base:t.base,rangeMin:e,rangeMax:n,rangeMinVisible:i,rangeMaxVisible:a}}function P(t){return{isStartSide:t?function(t,e,n,i){return t<=e[e.length-1][i]}:function(t,e,n,i){return t<e[0][n]},isEndSide:t?function(t,e,n,i){return t>e[0][n]}:function(t,e,n,i){return t>=e[e.length-1][i]},isInBreak:t?function(t,e,n,i){return t>e[i]&&t<=e[n]}:function(t,e,n,i){return t>=e[n]&&t<e[i]},isBetweenBreaks:t?function(t,e,n,i,a){return t>=e[a]&&t<n[i]}:function(t,e,n,i,a){return t<e[i]&&t>=n[a]},getLength:t?function(t,e){return e.length-t.length}:function(t){return t.length},getBreaksSize:t?function(t,e){return e.cumulativeWidth-t.cumulativeWidth}:function(t){return t.cumulativeWidth}}}e.Translator2D=b=function(t,e,n){this.update(t,e,n)},b.prototype={constructor:b,reinit:function(){var t=this,e=t._options,i=t._businessRange,a=i.categories||[],c={},h=t._prepareCanvasOptions(),v=l.getCategoriesInfo(a,i.minVisible,i.maxVisible).categories,g=v.length;if(i.isEmpty())c=m;else switch(i.axisType){case"logarithmic":c=u;break;case"semidiscrete":c=r,h.ratioOfCanvasRange=h.canvasLength/(p(h.rangeMaxVisible,e.interval)-h.rangeMinVisible);break;case"discrete":c=s,t._categories=a,h.interval=t._getDiscreteInterval(e.addSpiderCategory?g+1:g,h),t._categoriesToPoints=k(a,h.invert),g&&(h.startPointIndex=t._categoriesToPoints[v[0].valueOf()],t.visibleCategories=v);break;default:"datetime"===i.dataType&&(c=o)}(t._oldMethods||[]).forEach((function(e){delete t[e]})),t._oldMethods=Object.keys(c),n(t,c),t._conversionValue=e.conversionValue?function(t){return t}:function(t){return Math.round(t)},t.sc={},t._checkingMethodsAboutBreaks=[P(!1),P(t.isInverted())],t._translateBreaks(),t._calculateSpecialValues()},_translateBreaks:function(){var t,e,n,i,a=this._breaks,s=this._options.breaksSize;if(void 0!==a)for(t=0,i=a.length;t<i;t++)e=a[t],n=this.translate(e.to),e.end=n,e.start=e.gapSize?n:this.isInverted()?n+s:n-s},_checkValueAboutBreaks:function(t,e,n,i,a){var s,r,o,u,l={length:0,breaksSize:void 0,inBreak:!1},c=t[t.length-1];if(a.isStartSide(e,t,n,i))return l;if(a.isEndSide(e,t,n,i))return{length:c.length,breaksSize:c.cumulativeWidth,inBreak:!1};for(s=0,r=t.length;s<r;s++){if(o=t[s],u=t[s-1],a.isInBreak(e,o,n,i)){l.inBreak=!0,l.break=o;break}if(u&&a.isBetweenBreaks(e,o,u,n,i)){l={length:a.getLength(u,c),breaksSize:a.getBreaksSize(u,c),inBreak:!1};break}}return l},isInverted:function(){return!(this._options.isHorizontal^this._businessRange.invert)},_getDiscreteInterval:function(t,e){var n=t-(this._options.stick?1:0);return n>0?e.canvasLength/n:e.canvasLength},_prepareCanvasOptions:function(){var t=this,e=this._businessRange,n=this._canvasOptions=x(e),i=this._canvas,a=this._breaks,s=void 0;return this._options.isHorizontal?(n.startPoint=i.left,s=i.width,n.endPoint=i.width-i.right,n.invert=e.invert):(n.startPoint=i.top,s=i.height,n.endPoint=i.height-i.bottom,n.invert=!e.invert),this.canvasLength=n.canvasLength=n.endPoint-n.startPoint,n.rangeDoubleError=Math.pow(10,v(n.rangeMax-n.rangeMin)-v(s)-2),n.ratioOfCanvasRange=n.canvasLength/(n.rangeMaxVisible-n.rangeMinVisible),void 0!==a&&(n.ratioOfCanvasRange=(n.canvasLength-a[a.length-1].cumulativeWidth)/(n.rangeMaxVisible-n.rangeMinVisible-a[a.length-1].length)),n},updateCanvas:function(t){this._canvas=V(t),this.reinit()},updateBusinessRange:function(t){var e=this,n=t.breaks||[];this._businessRange=M(t),this._breaks=n.length?O(n,this._businessRange):void 0,this.reinit()},update:function(t,e,i){var a=this;this._options=n(this._options||{},i),this._canvas=V(e),this.updateBusinessRange(t)},getBusinessRange:function(){return this._businessRange},getEventScale:function(t){return t.deltaScale||1},getCanvasVisibleArea:function(){return{min:this._canvasOptions.startPoint,max:this._canvasOptions.endPoint}},_calculateSpecialValues:function(){var t=this,e=this._canvasOptions,n=e.startPoint,i=e.endPoint,a=this._businessRange,s=a.minVisible,r=a.maxVisible,o=n+e.canvasLength/2,u=void 0;if(s<0&&r>0&&s!==r&&(u=this.translate(0,1)),!g(u)){var l=a.invert^(s<0&&r<=0);u=this._options.isHorizontal?l?i:n:l?n:i}this.sc={canvas_position_default:u,canvas_position_left:n,canvas_position_top:n,canvas_position_center:o,canvas_position_middle:o,canvas_position_right:i,canvas_position_bottom:i,canvas_position_start:e.invert?i:n,canvas_position_end:e.invert?n:i}},translateSpecialCase:function(t){return this.sc[t]},_calculateProjection:function(t){var e=this._canvasOptions;return e.invert?e.endPoint-t:e.startPoint+t},_calculateUnProjection:function(t){var e=this._canvasOptions;return e.invert?e.rangeMaxVisible.valueOf()-t:e.rangeMinVisible.valueOf()+t},getMinBarSize:function(t){var e=this.getCanvasVisibleArea(),n=this.from(e.min+t);return _(this.from(e.min)-(g(n)?n:this.from(e.max)))},checkMinBarSize:function(t,e,n){return _(t)<e?t>=0?e:-e:t},translate:function(t,e){var n=this.translateSpecialCase(t);return g(n)?Math.round(n):isNaN(t)?null:this.to(t,e)},getInterval:function(){var t=this._canvasOptions,e=this._businessRange.interval;return isFinite(e)?Math.round(t.ratioOfCanvasRange*e):Math.round(t.endPoint-t.startPoint)},zoom:function(t,e,n){var i=this._canvasOptions;if(i.rangeMinVisible.valueOf()===i.rangeMaxVisible.valueOf()&&0!==t)return this.zoomZeroLengthRange(t,e);var a=i.startPoint,s=i.endPoint,r=this.isInverted(),o=(a+t)/e,u=(s+t)/e;n=n||{};var l=this.to(r?n.endValue:n.startValue),c=this.to(r?n.startValue:n.endValue),h=void 0,v=void 0;return l>o&&(u-=o-l,o=l,h=r?n.endValue:n.startValue),c<u&&(o-=u-c,u=c,v=r?n.startValue:n.endValue),c-l<u-o&&(o=l,u=c),e=(a+(t=(s-a)*o/(u-o)-a))/o||1,{min:g(h)?h:f(this.from(o,1)),max:g(v)?v:f(this.from(u,-1)),translate:f(t),scale:f(e)}},zoomZeroLengthRange:function(t,e){var n=this._canvasOptions,i=n.rangeMin,a=n.rangeMax,s=(a.valueOf()!==i.valueOf()?a.valueOf()-i.valueOf():_(n.rangeMinVisible.valueOf()-i.valueOf()))/n.canvasLength,r=c.isDate(a)||c.isDate(i),o="logarithmic"===this._businessRange.axisType,u=n.rangeMinVisible.valueOf()-s,l=n.rangeMaxVisible.valueOf()+s;return{min:u=o?f(Math.pow(n.base,u)):r?new Date(u):u,max:l=o?f(Math.pow(n.base,l)):r?new Date(l):l,translate:t,scale:e}},getMinScale:function(t){return t?1.1:.9},getScale:function(t,e){var n=this._canvasOptions;return n.rangeMax===n.rangeMin?1:(t=g(t)?this._fromValue(t):n.rangeMin,e=g(e)?this._fromValue(e):n.rangeMax,(n.rangeMax-n.rangeMin)/Math.abs(t-e))},isValid:function(t){var e=this._canvasOptions;return null!==(t=this._fromValue(t))&&!isNaN(t)&&t.valueOf()+e.rangeDoubleError>=e.rangeMin&&t.valueOf()-e.rangeDoubleError<=e.rangeMax},getCorrectValue:function(t,e){var n,i=this,a=this._breaks;return t=this._fromValue(t),this._breaks&&!0===(n=this._checkValueAboutBreaks(a,t,"trFrom","trTo",this._checkingMethodsAboutBreaks[0])).inBreak?this._toValue(e>0?n.break.trTo:n.break.trFrom):this._toValue(t)},to:function(t,e){var n=this.getBusinessRange();if(g(n.maxVisible)&&g(n.minVisible)&&n.maxVisible.valueOf()===n.minVisible.valueOf())return g(t)&&n.maxVisible.valueOf()===t.valueOf()?this.translateSpecialCase(0===t&&this._options.shiftZeroValue?"canvas_position_default":"canvas_position_middle"):null;t=this._fromValue(t);var i=this,a=this._canvasOptions,s=this._breaks,r={length:0},o=0;return void 0!==s&&(r=this._checkValueAboutBreaks(s,t,"trFrom","trTo",this._checkingMethodsAboutBreaks[0]),o=g(r.breaksSize)?r.breaksSize:0),!0===r.inBreak?e>0?r.break.start:e<0?r.break.end:null:this._conversionValue(this._calculateProjection((t-a.rangeMinVisible-r.length)*a.ratioOfCanvasRange+o))},from:function(t,e){var n=this,i=this._breaks,a={length:0},s=this._canvasOptions,r=s.startPoint,o=0;return void 0!==i&&(a=this._checkValueAboutBreaks(i,t,"start","end",this._checkingMethodsAboutBreaks[1]),o=g(a.breaksSize)?a.breaksSize:0),!0===a.inBreak?e>0?this._toValue(a.break.trTo):e<0?this._toValue(a.break.trFrom):null:this._toValue(this._calculateUnProjection((t-r-o)/s.ratioOfCanvasRange+a.length))},isValueProlonged:!1,getRange:function(){return[this._toValue(this._canvasOptions.rangeMin),this._toValue(this._canvasOptions.rangeMax)]},getScreenRange:function(){return[this._canvasOptions.startPoint,this._canvasOptions.endPoint]},add:function(t,e,n){return this._add(t,e,(this._businessRange.invert?-1:1)*n)},_add:function(t,e,n){return this._toValue(this._fromValue(t)+e*n)},_fromValue:function(t){return null!==t?Number(t):null},_toValue:function(t){return null!==t?Number(t):null}}}

