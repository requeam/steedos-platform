function module(n,e,t){"use strict";var a=n("../../core/utils/type"),o=n("../../core/utils/extend"),i=n("../core/utils"),r=n("../../events/core/wheel"),s,u=d(n("../../events/transform")),c,l=d(n("../../events/drag"));function d(n){return n&&n.__esModule?n:{default:n}}var f=".zoomAndPanNS",m=l.default.start+f,g=l.default.move+f,v=l.default.end+f,x=u.default.pinchstart+f,p=u.default.pinch+f,h=u.default.pinchend+f,A="dxc-scroll-start"+f,y="dxc-scroll-move"+f,z="dxc-scroll-end"+f,E=300,_=5,D=Math.min,T=Math.max,R=Math.abs;function C(n){return{x:n.left,y:n.top,width:n.width-n.left-n.right,height:n.height-n.top-n.bottom}}function P(n,e){var t=e.x,a=e.y;return t>=n.x&&t<=n.width+n.x&&a>=n.y&&a<=n.height+n.y}function V(n,e){return e&&(n=n.sort((function(n,t){return n===e?-1:t===e?1:0}))),n}function Z(n){return!n.getTranslator().getBusinessRange().isEmpty()}t.exports={name:"zoom_and_pan",init:function(){var n=this,e=this._renderer;function t(n){n.originalEvent&&t(n.originalEvent);try{n.cancel=!0}catch(n){return}}function s(e,a,o){var i=e.options,r=e.actionData,s=[];i.argumentAxis[a]&&s.push(n.getArgumentAxis()),i.valueAxis[a]&&(s=s.concat(r.valueAxes)),s.reduce((function(n,e){return n||(Z(e)?e.handleZooming(null,{end:!0},o,a).isPrevented:n)}),!1)&&t(o)}function u(e,t,r,s,u){function c(n,e,r,u,c){var l={zoomed:!1};return e&&n.filter(Z).forEach((function(n){var e=n.getOptions(),d=n.visualRange(),f=n.getTranslator().getEventScale(u),m=-s(u,c,r,f);l=(0,o.extend)(!0,l,n.getTranslator().zoom(m,f,n.getZoomBounds()));var g=n.adjustRange((0,i.getVizRangeObject)([l.min,l.max])),v=n.isZoomingLowerLimitOvercome(t,f,g);if((0,a.isDefined)(d)&&d.startValue.valueOf()===g.startValue.valueOf()&&d.endValue.valueOf()===g.endValue.valueOf()){if("touch"===u.pointerType&&"discrete"===e.type){var x=n.isExtremePosition(!1),p=n.isExtremePosition(!0),h=f>1&&!v,A=f<1&&(!x||!p),y=1===f&&!(x&&(m<0&&!e.inverted||m>0&&e.inverted)||p&&(m>0&&!e.inverted||m<0&&e.inverted));l.enabled=h||A||y}}else n.handleZooming(v?null:g,{start:!0,end:!0},u,t),v||(l.zoomed=!0,l.deltaTranslate=m-l.translate)})),l}function l(n,e,t,a){t.zoomed&&(e.offset[a]=(n.offset?n.offset[a]:e.offset[a])+t.deltaTranslate)}function d(n,e,t,a){t.zoomed&&(e.center[a]=n[a]+t.deltaTranslate)}var f=n.option("rotated"),m=e.actionData,g=e.options,v={},x={};m.fallback||(v=c(n._argumentAxes,g.argumentAxis[t],f?"y":"x",r,m),x=c(m.valueAxes,g.valueAxis[t],f?"x":"y",r,m),n._requestChange(["VISUAL_RANGE"]),l(r,m,v,f?"y":"x"),l(r,m,x,f?"x":"y"));var p=u(r);return d(p,m,v,f?"y":"x"),d(p,m,x,f?"x":"y"),v.zoomed||x.zoomed||(m.center=p),v.zoomed||x.zoomed||m.fallback||v.enabled||x.enabled}function c(e,t,a,o){function i(n,e,a,i,r,s){var u=!1;return e&&n.forEach((function(n){var e=s&&n!==s,c=i.scale||1,l=n.getTranslator().zoom(-o(i,r,a,c),c,n.getZoomBounds()),d={startValue:l.min,endValue:l.max},f=n.isZoomingLowerLimitOvercome(t,c,d);n.handleZooming(f?null:d,{start:!0,end:e},i,t),f?n.handleZoomEnd():u=!0})),u}var r=n.option("rotated"),s=e.actionData,u=e.options,c=!0;if(s.fallback)c&=i(n._argumentAxes,u.argumentAxis[t],r?"y":"x",a,s,n.getArgumentAxis()),c|=i(s.valueAxes,u.valueAxis[t],r?"x":"y",a,s);else{var l=[];u.argumentAxis[t]&&l.push(n.getArgumentAxis()),u.valueAxis[t]&&(l=l.concat(s.valueAxes)),l.filter(Z).forEach((function(n){n.handleZooming(null,{start:!0},a,t)})),c=c&&l.length}c&&n._requestChange(["VISUAL_RANGE"])}function l(e,t){var o=n._argumentAxes.filter((function(n){return P(C(n.getCanvas()),e)}));return{fallback:n._lastRenderingTime>E,cancel:!o.length||!(0,a.isDefined)(t),action:t,curAxisRect:o.length&&C(o[0].getCanvas()),valueAxes:o.length&&n._valueAxes.filter((function(n){return P(C(n.getCanvas()),e)})),offset:{x:0,y:0},center:e,startCenter:e}}function d(n,t){var a=e.getRootOffset();return{x:D(T(t.pageX-a.left,n.x),n.width+n.x),y:D(T(t.pageY-a.top,n.y),n.height+n.y)}}function _(n){var t=e.getRootOffset(),a=n.pointers[0].pageX,o=n.pointers[1].pageX,i=n.pointers[0].pageY,r=n.pointers[1].pageY;return{x:D(a,o)+R(o-a)/2-t.left,y:D(i,r)+R(r-i)/2-t.top}}function b(n){var t=e.getRootOffset();return{x:n.pageX-t.left,y:n.pageY-t.top}}function O(n,e,t){return n.offset[t]-e.offset[t]}function w(e){e.preventDefault(),e.stopPropagation(),n._tracker.stopCurrentHandling()}var S={dragStartHandler:function(n){var t=S.options,o="touch"===n.pointerType,r=t.argumentAxis.pan||t.valueAxis.pan,u=t.argumentAxis.zoom||t.valueAxis.zoom,c=(0,a.isDefined)(t.panKey)&&n[(0,i.normalizeEnum)(t.panKey)+"Key"],f=t.dragToZoom,m=void 0,g;o?t.allowTouchGestures&&r&&(m=!S.panningVisualRangeEnabled()||S.skipEvent?null:"pan"):f&&r&&c?m="pan":!f&&r?m="pan":f&&u&&(m="zoom");var v=l(b(n),m);if(v.cancel)return S.skipEvent=!1,void(n.cancel=!0);S.actionData=v,w(n),"zoom"===m?(v.startCoords=d(v.curAxisRect,n),v.rect=e.rect(0,0,0,0).attr(t.dragBoxStyle).append(e.root)):s(S,"pan",n)},dragHandler:function(e){var a=n.option("rotated"),o=S.options,i=S.actionData,r="touch"===e.pointerType;if(i&&(!r||S.panningVisualRangeEnabled()))if("zoom"===i.action){w(e);var s=i.curAxisRect,c=i.startCoords,l=d(s,e),f=o.argumentAxis.zoom,m=o.valueAxis.zoom,g={x:D(c.x,l.x),y:D(c.y,l.y),width:R(c.x-l.x),height:R(c.y-l.y)};f&&m||(!f&&!a||!m&&a?(g.x=s.x,g.width=s.width):(g.y=s.y,g.height=s.height)),i.rect.attr(g)}else if("pan"===i.action){var v=u(S,"pan",e,O,(function(n){return n.offset}));r?(S.defineTouchBehavior(!v,e),!v&&S.panningVisualRangeEnabled()&&(t(e),S.skipEvent=!0,S.actionData=null)):w(e)}},dragEndHandler:function(e){var t=n.option("rotated"),a=S.options,o=S.actionData,i="touch"===e.pointerType;if(o&&(!i||S.panningVisualRangeEnabled())){if((!i||!S.actionData.isNative)&&w(e),"zoom"===o.action){var r=function(n,t,a,i,r,s){n=V(n,s);var u=r[a],c=i[a],l=!1;return t&&R(u-c)>5&&n.some((function(n){var t=n.getTranslator();if(!t.getBusinessRange().isEmpty()){var a=s&&n!==s,i=[t.from(c),t.from(u)],r=n.isZoomingLowerLimitOvercome(o.action,t.getMinScale(!0),i),d=n.handleZooming(r?null:i,{start:!!a,end:!!a},e,o.action);return r?n.handleZoomEnd():l=!0,s&&d.isPrevented}})),l},s=d(o.curAxisRect,e),u=r(n._argumentAxes,a.argumentAxis.zoom,t?"y":"x",o.startCoords,s,n.getArgumentAxis()),l;(r(o.valueAxes,a.valueAxis.zoom,t?"x":"y",o.startCoords,s)||u)&&n._requestChange(["VISUAL_RANGE"]),o.rect.dispose()}else"pan"===o.action&&c(S,"pan",e,O);S.actionData=null}},pinchStartHandler:function(n){w(n);var e=l(_(n),"zoom");e.isNative=!S.panningVisualRangeEnabled(),e.cancel?t(n):(S.actionData=e,s(S,"zoom",n))},pinchHandler:function(n){if(S.actionData&&S.actionData.isNative&&n.deltaScale<=1&&(S.defineTouchBehavior(!0,n),S.actionData=null),S.actionData){var e=u(S,"zoom",n,(function(n,e,t,a){return _(n)[t]-e.center[t]+(e.center[t]-e.center[t]*a)}),_);S.defineTouchBehavior(!e,n)}},pinchEndHandler:function(n){S.actionData&&(!S.actionData.isNative&&w(n),c(S,"zoom",n,(function(n,e,t,a){return e.center[t]-e.startCenter[t]+(e.startCenter[t]-e.startCenter[t]*a)})),S.actionData=null)},cleanup:function(){e.root.off(f),S.actionData&&S.actionData.rect&&S.actionData.rect.dispose(),S.actionData=null,e.root.css({"touch-action":"","-ms-touch-action":""})},setup:function(a){if(S.cleanup(),a.argumentAxis.pan||e.root.on(A,t),!a.argumentAxis.none||!a.valueAxis.none){S.options=a;var o=n.option("rotated");(a.argumentAxis.zoom||a.valueAxis.zoom)&&a.allowMouseWheel&&e.root.on(r.name+f,(function(e){function t(n,t,a,o){n=V(n,o);var i=!1;return n.some((function(n){var r=n.getTranslator();if(!r.getBusinessRange().isEmpty()){var s=o&&n!==o,u=r.getMinScale(a>0),c=r.zoom(-(t-t*u),u,n.getZoomBounds()),l={startValue:c.min,endValue:c.max},d=n.isZoomingLowerLimitOvercome("zoom",u,l),f=n.handleZooming(d?null:l,{start:!!s,end:!!s},e,"zoom");return d?n.handleZoomEnd():i=!0,o&&f.isPrevented}})),!!i}var i=b(e),r=!1,s=void 0,u;if(a.valueAxis.zoom){if(0===(s=n._valueAxes.filter((function(n){return P(C(n.getCanvas()),i)}))).length){var c=n._valueAxes.reduce((function(n,e){return!n&&e.coordsIn(i.x,i.y)&&(n=e.getCanvas()),n}),null);c&&(s=n._valueAxes.filter((function(n){return P(C(n.getCanvas()),{x:c.left,y:c.top})})))}r|=t(s,o?i.x:i.y,e.delta)}a.argumentAxis.zoom&&(r|=n._argumentAxes.some((function(n){return!(!P(C(n.getCanvas()),i)&&!n.coordsIn(i.x,i.y))}))&&t(n._argumentAxes,o?i.y:i.x,e.delta,n.getArgumentAxis()));r&&(n._requestChange(["VISUAL_RANGE"]),S.panningVisualRangeEnabled(s)&&w(e))})),a.allowTouchGestures&&((a.argumentAxis.zoom||a.valueAxis.zoom)&&e.root.on(x,{immediate:!0},S.pinchStartHandler).on(p,S.pinchHandler).on(h,S.pinchEndHandler),S.setTouchAction(!1)),e.root.on(m,{immediate:!0},S.dragStartHandler).on(g,S.dragHandler).on(v,S.dragEndHandler),a.argumentAxis.pan&&e.root.on(A,(function(n){S.actionData={valueAxes:[],offset:{x:0,y:0},center:{x:0,y:0}},w(n),s(S,"pan",n)})).on(y,(function(n){w(n),u(S,"pan",n,O,(function(n){return n.offset}))})).on(z,(function(n){w(n),c(S,"pan",n,O),S.actionData=null}))}},defineTouchBehavior:function(n,e){S.setTouchAction(n),S.actionData&&(S.actionData.isNative=n),n||w(e)},setTouchAction:function(n){var t=S.options;if(t.allowTouchGestures){var a=n?"":"none";n||(t.argumentAxis.zoom||t.valueAxis.zoom||(a="pinch-zoom"),t.argumentAxis.pan||t.valueAxis.pan||(a="pan-x pan-y")),e.root.css({"touch-action":a,"-ms-touch-action":a})}},panningVisualRangeEnabled:function(e){if(e&&e.length)return e.some((function(n){return!n.isExtremePosition(!1)||!n.isExtremePosition(!0)}));var t=n._valueAxes.some((function(n){return!n.isExtremePosition(!1)||!n.isExtremePosition(!0)})),a=n._argumentAxes.some((function(n){return!n.isExtremePosition(!1)||!n.isExtremePosition(!0)}));return t||a}};this._zoomAndPan=S},members:{_setupZoomAndPan:function(){this._zoomAndPan.setup(this._themeManager.getOptions("zoomAndPan"))}},dispose:function(){this._zoomAndPan.cleanup()},customize:function(n){n.addChange({code:"ZOOM_AND_PAN",handler:function(){this._setupZoomAndPan()},isThemeDependent:!0,isOptionChange:!0,option:"zoomAndPan"})}}}

