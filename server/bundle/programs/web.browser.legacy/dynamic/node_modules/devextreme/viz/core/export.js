function module(t,e){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.plugin=e.ExportMenu=e.getMarkup=e.exportFromMarkup=void 0;var o=t("../../core/utils/extend"),n=t("../../core/utils/window"),r=t("./utils"),i,s=g(t("../../exporter")),a,u=g(t("../../localization/message")),p=t("../../core/utils/type"),d,h=g(t("../themes")),l,c=g(t("../../events/hover")),f,_=g(t("../../events/pointer"));function g(t){return t&&t.__esModule?t:{default:t}}var v=s.default.image,x=s.default.svg,m=s.default.pdf,b=[_.default.down,_.default.move].join(" "),w=35,y=[[9,12,26,12,26,14,9,14],[9,17,26,17,26,19,9,19],[9,22,26,22,26,24,9,24]],E=4,O=120,S=8,k=15,M=30,C=1,G=10,L=2,T=3,P="PNG",A=[P,"JPEG","GIF"],B=["PDF","SVG"],F="dx-export-menu",D="export-element-type",z="export-element-format",I=/data-backgroundcolor="([^"]*)"/;function N(){var t=v.testFormats(A);return{unsupported:t.unsupported,supported:t.supported.concat(B)}}function R(t,e,o){if(o=o||N(),t=String(t).toUpperCase(),-1!==o.supported.indexOf(t))return t;-1!==o.unsupported.indexOf(t)&&e&&e("W2108",[t])}function X(t){return"SVG"===t?x.getData:"PDF"===t?m.getData:v.getData}function U(t,e){var o=(0,n.getWindow)().document,r=o.createElement("iframe");r.onload=W(t,e),r.style.visibility="hidden",r.style.position="fixed",r.style.right="0",r.style.bottom="0",o.body.appendChild(r)}function W(t,e){return function(){var e=this,o=this.contentWindow,n=o.document.createElement("img");o.document.body.appendChild(n);var r=function(){e.parentElement.removeChild(e)};n.addEventListener("load",(function(){o.focus(),o.print(),r()})),n.addEventListener("error",r),n.src=t}}function Y(t,e,o){var n=w-O,r=w+E+C+o*M,i={rect:{width:O-2*C,height:M,x:n+C,y:r},text:{x:n+(t.rtl?O-k:k),y:r+M-S}};return"printing"===e&&(i.separator={stroke:t.button.default.borderColor,"stroke-width":C,cursor:"pointer",sharp:"v",d:"M "+n+" "+(r+M-C)+" L "+(n+O)+" "+(r+M-C)}),i}function j(t,e,o){var n={},i=o.type,s=o.format,a=Y(e,i,o.itemIndex),u=(0,r.patchFontOptions)(e.font);u["pointer-events"]="none";var p=t.g().attr({class:F+"-list-item"});n[D]=i,s&&(n[z]=s);var d=t.rect();d.attr(a.rect).css({cursor:"pointer","pointer-events":"all"}).data(n),d.on(c.default.start+".export",(function(){return d.attr({fill:e.button.hover.backgroundColor})})).on(c.default.end+".export",(function(){return d.attr({fill:null})})),d.append(p);var h=t.text(o.text).css(u).attr(a.text).append(p);return"printing"===i&&t.path(null,"line").attr(a.separator).append(p),{g:p,rect:d,resetState:function(){return d.attr({fill:null})},fixPosition:function(){var t=h.getBBox();h.move(a.text.x-t.x-(e.rtl?t.width:0))}}}function V(t,e){var o=[];return e.printingEnabled&&o.push(j(t,e,{type:"printing",text:u.default.format("vizExport-printingButtonText"),itemIndex:o.length})),o=e.formats.reduce((function(o,n){return o.push(j(t,e,{type:"exporting",text:u.default.getFormatter("vizExport-exportButtonText")(n),format:n,itemIndex:o.length})),o}),o)}function J(t){var e=I.exec(t);return e?e[1]:void 0}var q=e.exportFromMarkup=function(t,e){e.format=R(e.format)||P,e.fileName=e.fileName||"file",e.exportingAction=e.onExporting,e.exportedAction=e.onExported,e.fileSavingAction=e.onFileSaving,e.margin=(0,p.isDefined)(e.margin)?e.margin:10,e.backgroundColor=(0,p.isDefined)(e.backgroundColor)?e.backgroundColor:J(t),s.default.export(t,e,X(e.format))},H=e.getMarkup=function(t){var e=[],o=0,n=0,r=[],i="";return t.forEach((function(t){var i=t.getSize(),s=t.option("backgroundColor")||h.default.getTheme(t.option("theme")).backgroundColor;s&&-1===r.indexOf(s)&&r.push(s),e.push(t.svg().replace("<svg",'<g transform="translate(0,'+o+')" ').replace("</svg>","</g>")),o+=i.height,n=Math.max(n,i.width)})),1===r.length&&(i='data-backgroundcolor="'+r[0]+'" '),"<svg "+i+'height="'+o+'" width="'+n+'" version="1.1" xmlns="http://www.w3.org/2000/svg">'+e.join("")+"</svg>"},K=e.ExportMenu=function(t){var e=this._renderer=t.renderer;this._incidentOccurred=t.incidentOccurred,this._exportTo=t.exportTo,this._print=t.print,this._shadow=e.shadowFilter("-50%","-50%","200%","200%",2,6,3),this._shadow.attr({opacity:.8}),this._group=e.g().attr({class:F,"hidden-for-export":!0}).linkOn(e.root,{name:"export-menu",after:"peripheral"}),this._buttonGroup=e.g().attr({class:F+"-button"}).append(this._group),this._listGroup=e.g().attr({class:F+"-list"}).append(this._group),this._overlay=e.rect(-O+w,w+E,O,0),this._overlay.attr({"stroke-width":C,cursor:"pointer",rx:4,ry:4,filter:this._shadow.id}),this._overlay.data({"export-element-type":"list"}),this.validFormats=N(),this._subscribeEvents()};function Q(t,e,o,n){return(n||e.format)&&(n=R(n||e.format,t._incidentOccurred)),{format:n||P,fileName:o||e.fileName||"file",proxyUrl:e.proxyUrl,backgroundColor:e.backgroundColor,width:t._canvas.width,height:t._canvas.height,margin:e.margin,forceProxy:e.forceProxy,exportingAction:t._createActionByOption("onExporting"),exportedAction:t._createActionByOption("onExported"),fileSavingAction:t._createActionByOption("onFileSaving")}}(0,o.extend)(K.prototype,{getLayoutOptions:function(){if(this._hiddenDueToLayout)return{width:0,height:0,cutSide:"vertical",cutLayoutSide:"top"};var t=this._buttonGroup.getBBox();return t.cutSide="vertical",t.cutLayoutSide="top",t.height+=10,t.position={vertical:"top",horizontal:"right"},t.verticalAlignment="top",t.horizontalAlignment="right",t},probeDraw:function(){this._fillSpace(),this.show()},shift:function(t,e){this._group.attr({translateY:this._group.attr("translateY")+e})},draw:function(t,e,o){this._group.move(t-w-2-3+o.left,Math.floor(e/2-w/2));var n=this.getLayoutOptions();return(n.width>t||n.height>e)&&this.freeSpace(),this},show:function(){this._group.linkAppend()},hide:function(){this._group.linkRemove()},setOptions:function(t){var e=this;this._options=t,t.formats?t.formats=t.formats.reduce((function(t,o){return(o=R(o,e._incidentOccurred,e.validFormats))&&t.push(o),t}),[]):t.formats=this.validFormats.supported.slice(),t.printingEnabled=void 0===t.printingEnabled||t.printingEnabled,t.enabled&&(t.formats.length||t.printingEnabled)?(this.show(),this._updateButton(),this._updateList(),this._hideList()):this.hide()},dispose:function(){this._unsubscribeEvents(),this._group.linkRemove().linkOff(),this._group.dispose(),this._shadow.dispose()},layoutOptions:function(){return this._options.enabled&&{horizontalAlignment:"right",verticalAlignment:"top",weak:!0}},measure:function(){return this._fillSpace(),[w+2,w]},move:function(t){this._group.attr({translateX:Math.round(t[0]),translateY:Math.round(t[1])})},_fillSpace:function(){this._hiddenDueToLayout=!1,this.show()},freeSpace:function(){this._incidentOccurred("W2107"),this._hiddenDueToLayout=!0,this.hide()},_hideList:function(){this._listGroup.remove(),this._listShown=!1,this._setButtonState("default"),this._menuItems.forEach((function(t){return t.resetState()}))},_showList:function(){this._listGroup.append(this._group),this._listShown=!0,this._menuItems.forEach((function(t){return t.fixPosition()}))},_setButtonState:function(t){var e=this._options.button[t];this._button.attr({stroke:e.borderColor,fill:e.backgroundColor}),this._icon.attr({fill:e.color})},_subscribeEvents:function(){var t=this;this._renderer.root.on(_.default.up+".export",(function(e){var o=e.target[D];o?"button"===o?t._listShown?(t._setButtonState("default"),t._hideList()):(t._setButtonState("focus"),t._showList()):"printing"===o?(t._print(),t._hideList()):"exporting"===o&&(t._exportTo(e.target[z]),t._hideList()):t._button&&t._hideList()})),this._listGroup.on(b,(function(t){return t.stopPropagation()})),this._buttonGroup.on(_.default.enter,(function(){return t._setButtonState("hover")})),this._buttonGroup.on(_.default.leave,(function(){return t._setButtonState(t._listShown?"focus":"default")})),this._buttonGroup.on(_.default.down+".export",(function(){return t._setButtonState("active")}))},_unsubscribeEvents:function(){this._renderer.root.off(".export"),this._listGroup.off(),this._buttonGroup.off()},_updateButton:function(){var t=this._renderer,e=this._options,o={"export-element-type":"button"};this._button||(this._button=t.rect(0,0,w,w).append(this._buttonGroup),this._button.attr({rx:4,ry:4,fill:e.button.default.backgroundColor,stroke:e.button.default.borderColor,"stroke-width":1,cursor:"pointer"}),this._button.data(o),this._icon=t.path(y).append(this._buttonGroup),this._icon.attr({fill:e.button.default.color,cursor:"pointer"}),this._icon.data(o),this._buttonGroup.setTitle(u.default.format("vizExport-titleMenuText")))},_updateList:function(){var t=this._options,e=t.button.default,o=this._listGroup,n=V(this._renderer,t);this._shadow.attr({color:t.shadowColor}),this._overlay.attr({height:n.length*M+2*C,fill:e.backgroundColor,stroke:e.borderColor}),o.clear(),this._overlay.append(o),n.forEach((function(t){return t.g.append(o)})),this._menuItems=n}});var Z=e.plugin={name:"export",init:function(){var t=this;this._exportMenu=new e.ExportMenu({renderer:this._renderer,incidentOccurred:this._incidentOccurred,print:function(){return t.print()},exportTo:function(e){return t.exportTo(void 0,e)}}),this._layout.add(this._exportMenu)},dispose:function(){this._exportMenu.dispose()},members:{_getExportMenuOptions:function(){return(0,o.extend)({},this._getOption("export"),{rtl:this._getOption("rtlEnabled",!0)})},_disablePointerEvents:function(){var t=this._renderer.root.attr("pointer-events");return this._renderer.root.attr({"pointer-events":"none"}),t},exportTo:function(t,e){var o=this,n=this._exportMenu,r=Q(this,this._getOption("export")||{},t,e);n&&n.hide();var i=this._disablePointerEvents();s.default.export(this._renderer.root.element,r,X(r.format)).done((function(){o._renderer.root.attr({"pointer-events":i})})),n&&n.show()},print:function(){var t=this,e=this._exportMenu,o=Q(this,this._getOption("export")||{});o.exportingAction=null,o.exportedAction=null,o.margin=0,o.format="PNG",o.forceProxy=!0,o.fileSavingAction=function(t){U("data:image/png;base64,"+t.data,{__test:o.__test}),t.cancel=!0};var n=this._disablePointerEvents();e&&e.hide(),s.default.export(this._renderer.root.element,o,X(o.format)).done((function(){t._renderer.root.attr({"pointer-events":n})})),e&&e.show()}},customize:function(t){var e=t.prototype;t.addChange({code:"EXPORT",handler:function(){this._exportMenu.setOptions(this._getExportMenuOptions()),this._change(["LAYOUT"])},isThemeDependent:!0,isOptionChange:!0,option:"export"}),e._optionChangesMap.onExporting="EXPORT",e._optionChangesMap.onExported="EXPORT",e._optionChangesMap.onFileSaving="EXPORT"}}}

